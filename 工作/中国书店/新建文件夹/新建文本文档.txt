CREATE OR REPLACE Procedure PROC_SX_JSKHTH_XTW3
--接收客户退货数据
(errno   Out Number,
 errtext Out Char)

 As

    v_kcsm        t_kcsm%Rowtype;
    ls_hq_hythq   Char(4);


    ls_hqbh       Char(4);
    ls_flqxmc     varchar2(60);
    s_hw          Char(20);

    v_rows        number;

    v_errtext     varchar2(500);
    v_errno       number;
    v_tpid        number;
    v_thzxid      varchar2(16);
    v_thzxmc      varchar2(16);
    v_dm  varchar2(60);
e_userdefinedexception Exception;

Begin

    -- 2011-11-18 升级
    -- 2010-04-07 yangyi:
    -- 对于存储区上架的也和退货库上架的一样, 也要按退货库的货区,货位来处理
    -- 为便于数据的处理，将存储区上架的也先视为去退货库上架的数据。
    -- 首先在t_ghdw_hythqhw表中，将存储区内划分的小货区视作特殊的货源，建立货源与货位的对应关系。
    -- 并将这些特殊货源所对应的特殊货位，统一归属于退货库中一个特殊的大区。
    -- 这些特殊货位上的容器不需要与货位进行绑定。在一次分流时，所有去往存储区的实物，
    -- 都将被分流到这个特殊大区所对应的若干个容器中，二次分流时，
    -- 再根据存储区的货区分流到相应的特殊货位容器中。二次分流时（也就是退货库上架操作时），
    -- 对于特殊货位的数据，需要写入t_pmsjrwb，在写此表之前，再重新取得存储区的货区和货位。
    -- 参见相关过程proc_sx_th_sj中写t_pmsjrwb时的语句

    -- 2010-04-12 yangyi:
    -- 考虑到某些货主在备货库只涉及一个货区的, 这些货主的销退如果是返架的,应直接写t_pmsjrwb
    --
    -- 比如音像货主,虽然没有设置货源退货库,但备货库货区可能分为多个
    -- 对于这种情况, 还是要到退货库先上架,以实现分流的目的
    -- 再比如第三方货主, 没有设置货源退货库, 在备货库货只涉及一个区
    -- 对于这种情况, 就不必到退货库先上架了, 应直接写t_pmsjrwb.

    -- 在物流接收预分数据时将物流的flowid保存到t_fjrwb_sl表中, 为后期商流接收退货数据时,
    -- 根据该字段从t_fjrwb_sl中得到djly

    -- 2015-12-23 yangyi:
    -- 由于税率的不同，存在一个预退批次对应多个销退批次的现象
    -- 所以，改为按ytpch+dh来进行接收处理了
    errno   := 0;
    errtext := 'OK';

    --select 1 into v_rows  from t_lock where proc='PROC_SX_JSKHTH_XTW3' for update nowait;
    update t_lock set zt='1'  where proc='PROC_SX_JSKHTH_XTW3' and zt='0';
    if sql%notfound then
       errno   := -1;
       errtext := '正运行';
    end if ; 
    commit;
    For c1 In (Select ytpch, dh, ywbmbh From t_fjrwb_sl Where yflbj = '0' Group By ytpch,dh,ywbmbh)
    Loop

/*        select count(*) into v_rows from t_ycl_ytpch where ytpch=c1.ytpch;
        if v_rows >0 then
            update t_ycl_ytpch set err='1' ,errrq=sysdate where ytpch=c1.ytpch;
            insert into  t_fjrwb_wl select *    From t_fjrwb_sl f
            Where ytpch = c1.ytpch And dh=c1.dh and ywbmbh=c1.ywbmbh;
            commit;
            continue;
        end if ;*/

        Insert Into t_fjrwb
            (FLOWID_FJRWB, YWLX, YSXM, GHDWH, HQBH, YWBMBH, CYBH, KFBH, ID, DBBZ, XBBZ,
             GKH, MDXM, YWSL, SYLX, ZJXS, THZK, FLQXMC, HW, SJSL, FLQX, YWPCH, SL, YFLBJ,
             FLOWID_XHDYTSJ_QDB, DH, GBTH, ZL, CGYJ, KTS, PCH, FJFS, YCLBJ, XTPCH, YTPCH,
             BH, ZRKFBH, XSZK, DBDH, XSZJXS, GBSL, PSSL, TJRQ, GBCZYBH, RECE_RQ, REASON,
             ISBN, SM, DJ, YDCS, sylx_xt, flowid_fjrwb_sl, xxsl, pk)

            Select
             sq_fjrwb_log.Nextval, YWLX, YSXM, GHDWH, HQBH, YWBMBH, CYBH, KFBH, ID,
             case nvl(dbbz,4) when 0 then 4 else nvl(dbbz,4) end ,
             case nvl(xbbz,10) when 0 then 10 else nvl(xbbz,10) end ,
            null ,
              '', YWSL, SYLX, ZJXS, THZK, FLQXMC, HW, 0, FLQX, YWPCH, SL, '0',
             FLOWID_XHDYTSJ_QDB, DH, GBTH, ZL, CGYJ, KTS, PCH, '1', YCLBJ, XTPCH, YTPCH,
             BH, ZRKFBH, XSZK, DBDH, XSZJXS, 0 , PSSL, TJRQ, GBCZYBH, Sysdate, REASON,
             ISBN, SM, DJ, YDCS, sylx_xt, FLOWID_FJRWB, xxsl, FLOWID_FJRWB
              From t_fjrwb_sl f
             Where ytpch = c1.ytpch And dh=c1.dh and ywbmbh=c1.ywbmbh;

             select trim(dm) into v_dm from t_dm where dh=c1.dh;

        -- 对于存储区上架或者退货库上架的, 要取得货区编号和分流去向名称
        begin

           For c2 In (Select  kts ,ywbmbh,cybh,flowid_fjrwb,flqx,id,ghdwh,dh,flowid_fjrwb_sl
                         From t_fjrwb
                        Where ytpch = c1.ytpch And dh=c1.dh and ywbmbh=c1.ywbmbh)
           Loop
                v_thzxid:=c2.ywbmbh||c2.flqx;
                Select * Into v_kcsm From t_kcsm Where id = c2.id;
                If c2.flqx = 'ST' Then

                    select count(*) into v_rows from T_GHDW_LDHW
                    where ywbm=c2.ywbmbh   and ghdw =c2.ghdwh;
                    if v_rows=0 then

                       Select  min(hqbh) into ls_hqbh   From t_ghdw_hythqhw
                         Where ghdwh = c2.ghdwh And ywbmbh = c2.ywbmbh ;

                       select trim(mc) into ls_flqxmc  from    t_ghdw where bh=c2.ghdwh;


                       if ls_hqbh is null then

                          errno:=-1;
                          errtext:=ls_flqxmc||'货源没有绑定货位！'||c2.ywbmbh||','||c2.ghdwh;
                          Raise e_userdefinedexception;
                       end if;
                       --v_thzxid:=v_thzxid||'y'||ls_hqbh;
                       v_thzxid:=v_thzxid||'H'||trim(ls_hqbh);
                       v_thzxmc:='退货区,'||trim(ls_hqbh);
                    else
                       --v_thzxid:=v_thzxid||'n'||c2.ghdwh;
                       v_thzxid:=v_thzxid||'D'||c2.ghdwh||'N';
                       v_thzxmc:='社退,'||trim(c2.ghdwh);
                    end if ;

                  insert into t_tree
                  (tbid, tbname, pid, pname, note, id, cs,czy,lf,rt,rid ,dm)
                  values
                  (c2.flowid_fjrwb, 't_fjrwb', c2.flowid_fjrwb_sl, 't_fjrwb_sl',
                  '退货分流指令,'||trim(ls_flqxmc), c2.id,
                   c2.kts ,'0001',1,2,c2.flowid_fjrwb,ls_flqxmc);
                  /*    Update t_fjrwb
                       Set hqbh = Trim(ls_hq_hythq), flqxmc = Trim(ls_hqmc_hythq),
                           hw = Trim(ls_hw_hythq), zl = v_kcsm.zl
                     Where flowid_fjrwb = c2.flowid_fjrwb;*/

                Elsif c2.flqx = 'CC' Then


                    -- 取得相应品种存储区上架的货区编号
                    proc_get_hqbh3(c2.kts,'XT',v_kcsm.id,v_kcsm.dbbz,v_kcsm.xbbz,
                                  c2.ywbmbh,c2.cybh,
                                  ls_hqbh,ls_flqxmc,s_hw,
                                  v_errno,v_errtext);
                    If v_errno < 0 Then
                       -- Rollback;
                       errno:=v_errno;
                       errtext:=v_errtext;
                       Raise e_userdefinedexception;
                    End If;
                    v_thzxid:=v_thzxid||trim(ls_hqbh);
                     v_thzxmc:='上架,'||trim(ls_hqbh);

                  insert into t_tree
                  (tbid, tbname, pid, pname, note, id, cs,czy,lf,rt,rid,dm )
                  values
                  (c2.flowid_fjrwb, 't_fjrwb', c2.flowid_fjrwb_sl, 't_fjrwb_sl',
                  '退货分流指令,库房上架'||trim(ls_flqxmc), c2.id,
                   c2.kts ,'0001',1,2,c2.flowid_fjrwb,v_dm);
                else
                  --JT
                    v_thzxid:=v_thzxid||c2.dh;
                    v_thzxmc:='拒退,'||trim(c2.dh);

                  insert into t_tree
                  (tbid, tbname, pid, pname, note, id, cs,czy,lf,rt,rid ,dm)
                  values
                  (c2.flowid_fjrwb, 't_fjrwb', c2.flowid_fjrwb_sl, 't_fjrwb_sl',
                  '退货分流指令,'||v_thzxmc, c2.id,
                   c2.kts ,'0001',1,2,c2.flowid_fjrwb,v_dm);
                End If;

               Update t_fjrwb
                Set hqbh = ls_hqbh, flqxmc = ls_flqxmc, hw = s_hw, zl = v_kcsm.zl,
                    thzxid=v_thzxid,thzxmc=v_thzxmc
                Where flowid_fjrwb = c2.flowid_fjrwb;

            End Loop;


/*
         Update t_fjrwb
           Set sm = (Select sm From t_kcsm Where id = t_fjrwb.id),
               isbn = (Select isbn From t_kcsm Where id = t_fjrwb.id),
               dj = (Select dj From t_kcsm Where id = t_fjrwb.id), hqbh = '999',
               zl = v_kcsm.zl
         Where ytpch = c1.ytpch And dh=c1.dh And ywlx = 'JT';*/

        Update t_fjrwb_sl Set yflbj = '1', tjrq = Sysdate Where
        ytpch = c1.ytpch And dh=c1.dh and ywbmbh=c1.ywbmbh;

         select min(tpid) into v_tpid from t_khthbj  where     bjlsh =c1.ytpch;
        update t_khthbj set recvrq=sysdate ,zt='3' ,msg=null,
        zcs=(select sum(ywsl) from t_fjrwb where ysxm=c1.ytpch )  where   bjlsh =c1.ytpch;
         update t_khthtp_state  set recvflrq=sysdate ,msg=null  where   tpid=v_tpid and recvflrq is null;

     /*     insert into t_ycl_ytpch
          (ytpch, rq, err)
         values
          (c1.ytpch, sysdate , '0');*/

        Commit;

        Exception
              When e_userdefinedexception Then
              Rollback;

         select min(tpid)into v_tpid from t_khthbj  where   bjlsh =c1.ytpch;
        update t_khthbj set zt='2',msg=trim(errtext)   where bjlsh =c1.ytpch;
         update t_khthtp_state  set zt='2',msg=trim(errtext)    where   tpid=v_tpid;
         commit;
        end;

    End Loop;


  for tp in(   select distinct tpid from t_khthbj where zt='3')
   loop
       select count(*) into v_rows from t_khthbj where tpid=tp.tpid and (zt='1' or zt='2');
       if v_rows=0 then
        update t_khthtp_state  set   zt='3',msg=null where   tpid=tp.tpid and (zt='1' or zt='2');
       end if;
   end loop;
   update t_lock set zt='0'  where proc='PROC_SX_JSKHTH_XTW3';
Exception
    When Others Then
        errno   := Sqlcode;
        errtext := 'PROC_SX_JSKHTH_XTW3' || Sqlerrm;
        Rollback;
    update t_lock set zt='0'  where proc='PROC_SX_JSKHTH_XTW3';
End PROC_SX_JSKHTH_XTW3;

CREATE OR REPLACE Procedure "PROC_KFZYDD_XTW" --库房作业调度
    --在调度进行时。首先调用订数分配函数，然后再调用本过程，这个是总过程，通过本过程调用
    --在调度完之后，在增加一个判断过程：如果是手工拣选，要判断是否有立库的，如果有立库的，则要首先将立库库存转移到
    --存储库，然后对手工拣选的恢复任务，等转移结束后，在进行调度。
    --另外两个过程进行调度
    -- 高架区只负责普通订单的拣选, 对于高架区的任务,
    -- 不需要并包, 一次调度只形成一个虚拟的包件,
    -- 后期高架区实际下架回告时, 再形成真正的包件.
(v_YWBMBH1 Char,
 v_CZYBH   Char,
 --v_kflx char,
 --v_KFBH CHAR,
 v_lxbh Char, --调度类型 FH,ST,ZY,PF
 --v_CJBZ CHAR,  --成件标准，１＝体积，２＝码洋
 V_THFS  Char, --退货方式，如果是FH类型的，可以为空
 v_cybh  Char, --储运编号
 v_ddfs  Char, ----  AP = 按店调度   AD =  按单调度  ，退货、转移等都是按单调度
 ERRNO   Out Number,
 ERRTEXT Out Char) As
    d_ltjs      Number(10, 2); --零头件数
    i_rwxdfs    Number(10); --在下达任务的时候，是一包一单还是一单多包，主要涉及发运，如果是一单多包的话就要把该单全部配完才能发运0=一单一包，1=一单多包
    p_jxfs      Char(2);
    p_bzxx      Number(5, 2);
    p_bzsx      Number(5, 2);
    p_wbjs      Number(5, 2);
    p_pzjs      Number(5);
    p_qsclfs    Char;
    v_bj        Number(5);
    p_bjlsh     Char(12);
    p_xsdh      Char(12);
    p_lhqhw     Char(20);
    p_dh        Char(6);
    p_cybh      Char(6);
    d_sdhrq     Date;
    p_tihfs     Char(2);
    p_xjdbj     Char(1);
    p_cgyj      Char(12);
    ldc_id      Number(10);
    ldc_cs      Number(10);
    ldc_my      Number(9, 2);
    ldc_sy      Number(9, 2);
    p_ltztj     Number(9, 2);
    p_kflx_gp   Char(2);
    ldc_szhythq Number(10);
    v_rows      Number(10);
    V_CJBZ      Char(1);
    d_sjjs      Number(10, 2);
    v_id_agvhz number;
    v_id_jhtask number;
    d_mybz      Number(9, 2);
    V_KFBH      Char(6);
    V_KFLX      Char(2);
    V_YWBMBH    Char(6);
    -- v_dh         Char(6);
    --  v_yxj        Char(1);
    s_tihfs      Char(2);
    s_xgbj       Char(2);
    p_phbz       Char(30);
    v_pftp       t_pf_temp%Rowtype;
    v_flowid_1   Number(10);
    v_zyczybh    Char(60);
    v_qshqbh     Char(6);
    v_thfs_temp  Char(2);
    v_phbz_count Number(10);
    v_bdbj       Char(1);

    d_fhyxj      Char(1);
    v_zpz        Number;
    v_zcs        Number;
    v_zmy        Number;
    v_zsy        Number;
    v_sjjs       Number;
    v_dm varchar2(60);
    tmpVar   Number;
    v_djrows Number;
    v_count  Number;
    v_czyname varchar2(20);
    v_jllx number;
    v_bz varchar2(60);
    v_isgz char(1);
Begin
    tmpVar := 0;
    -- 取得按单拣选时的最大单据码洋：
    Select NVL(Min(SYS_VALUE), 20000)
      Into d_mybz
      From T_SYSSET
     Where SYS_ITEM = 'MAXDJMY';
    ------------------------判断调度终止条件---------------------------------
    Select Count(*)
      Into V_ROWS
      From T_KFZYDD_ZY
     Where CZYBH <> v_czybh /*And ywbmbh = v_ywbmbh1*/;
    If v_rows > 0 Then
        select min(name) into v_zyczybh from t_user u,t_kfzydd_zy z
             where   z.czybh = u.usr_id   and  z.CZYBH <> v_czybh ;
        errno   := -111;
        errtext := '调度程序只能有一个人执行，现在' || v_zyczybh || '已经在调度中，请稍候';
        Rollback;
        Return;
    End If;
    select trim(name) into v_czyname from t_user where usr_id=v_CZYBH;
/*    Select Count(*)
      Into V_ROWS
      From T_KFZYDD_ZY
     Where CZYBH = v_CZYBH And ywbmbh <> v_ywbmbh1;
    If V_ROWS > 0 Then
        Select Min(dm)
          Into v_zyczybh
          From t_dm
         Where Exists
         (Select * From t_kfzydd_zy Where czybh = v_CZYBH And ywbmbh = t_dm.dh);
        errno   := -111;
        errtext := '您在' || v_zyczybh || '的调度未执行完毕，请稍候';
        Rollback;
        Return;
    End If;*/
    ------------------------判断调度终止条件---------------------------------
    --如果是按店调度的，出现第二个界面，操作员可以选择计算后的任务是否继续调度，
    --如果不调度，前台程序要将t_pf_temp.xz根据条件更改为0，表示该单据不再继续调度。
    --下面的存储过程是对于取消的任务进行恢复。
    --对于按店调度中的不满足的数据放在t_pf_temp_qs_xtw表中，供第二个界面显示。
    If v_ddfs = 'AP' Then
        PROC_KFZYDD_CANCEL_XTW(v_CZYBH, v_LXbh, ERRNO, ERRTEXT);
        If ERRNO <> 0 Then
            Rollback;
            Return;
        End If;
        Select Count(*) Into v_rows From t_pf_temp Where pfczybh = v_czybh;
        If Trim(v_lxbh) = 'FH' And V_ROWS <= 0 Then
            Delete From t_fhrwb Where ddczybh = v_czybh;
        End If;
        Delete From T_KFZYDD_ZY
         Where CZYBH = v_czybh /* and ywbmbh=v_ywbmbh1*/
        ;
        If v_rows <= 0 Then
            update T_KFZYDD set running='0' , finishdate=sysdate where running='1' and czybh=v_CZYBH;
            errno   := 0;
            errtext := '下达完毕，所有任务全部返回商流';
            Return;
        End If;
    End If;
    v_bj := -12;
    --   2012-11-15 先屏蔽 待音像商品开始下达时开始调度
    --先按T_PF_TEMP中的非图书商品进行一次按单调度处理适用于图书音像业务部门合并到一起的情况
    /* If v_lxbh = 'FH' Or v_lxbh = 'ST' Then
        For C_YWBM_YX In (Select YWBMBH, dh, cybh, YXDBJ
                            From T_PF_TEMP
                           Where pfczybh = v_czybh And (qsclfs <> '2' And qsclfs <> '3') And
                                 Exists (Select 1
                                    From t_dm
                                   Where dh = t_pf_temp.ywbmbh And kflx = 'YX') And
                                 ywbmbh = v_ywbmbh1
                           Group By ywbmbh, dh, cybh, YXDBJ
                           Order By ywbmbh, dh, cybh, YXDBJ)
        Loop
            PROC_KFZYDD_LV_YINXIANG(V_CZYBH,
                                    C_YWBM_YX.YWBMBH,
                                    C_YWBM_YX.DH,
                                    v_lxbh,
                                    0,
                                    p_cybh,
                                    d_mybz,
                                    errno,
                                    errtext);
            If errno <> 0 Then
                errtext :=errno|| 'PROC_KFZYDD_LV_YINXIANG:' || trim(errtext);
                Rollback;
                Return;
            End If;
        End Loop;
    End If;*/
    -- AP 就是以店为单位来调度, 一次调度可能涉及多张原始单据
    -- AD 就是以单据为单位来调度.
    -- 按何种方式拣选, 是根据货主来定义的(t_sysset), 分为 "按单拣选" 和 "按件拣选"
    v_bj := -13;
    For C_YWBM In (Select YWBMBH, dh, cybh
                     From T_PF_TEMP
                    Where PFCZYBH = V_CZYBH
                   -- and ywbmbh=v_ywbmbh1
                    Group By ywbmbh, dh, CYBH
                    Order By ywbmbh, dh, cybh)
    Loop
        -- 根据货主从参数表取得拣选方式,包装下线,包装上线,尾件标准,
        Select JXFS, BZXX, BZSX, WSJS, PZJS
          Into p_JXFS, p_BZXX, p_BZSX, p_WBJS, p_PZJS
          From T_YWBMJXFS
         Where YWBMBH = c_ywbm.ywbmbh;
        If P_JXFS Is Null   Then
            P_JXFS := 'AJ';
        End If;
        ----------------------------------------------------------------------------------------
        --      P_JXFS := 'SG'; -- 2015-12-30 YANGYI: 为特殊报废处理，暂时将拣选方式固定为手工
        --                      -- 2015-12-31 yangyi: 特殊处理完毕后，将此屏蔽掉了
        ----------------------------------------------------------------------------------------

        --取得最短送达日期和最高发货优先级, 为写t_dfbj做准备, 后期, 为制定发运计划做准备
        Select Max(flowid_fhrw), substrB(nvl(Min(phbz), ''), 1, 30), Min(sdhrq),
               Min(fhyxj),max(bdbj)
          Into v_flowid_1, p_phbz, d_sdhrq, d_fhyxj,v_bdbj
          From t_pf_temp
         Where pfczybh = v_czybh And dh = c_ywbm.dh And ywbmbh = c_ywbm.ywbmbh;
        Select * Into v_pftp From t_pf_temp Where flowid_fhrw = v_flowid_1;
        Select Count(Distinct phbz)
          Into v_phbz_count
          From t_pf_temp
         Where pfczybh = v_czybh And dh = c_ywbm.dh And ywbmbh = c_ywbm.ywbmbh;
        V_YWBMBH := C_YWBM.YWBMBH;
        p_dh     := c_ywbm.dh;
        -- 当发货按店调度时, 为相应店置最近调度时间:
        If v_ddfs = 'AP' And v_lxbh = 'FH' Then
            Update t_dm
               Set xdrq = Sysdate
             Where dh = p_dh And Exists
             (Select * From t_dm_ywbm Where dh = t_dm.dh And ywbmbh = v_ywbmbh);
        End If;
        -- 根据货主从参数设置表取得该货主的成件类型，1=按体积判断，2=按码洋判断
        Select TO_CHAR(NVL(SYS_VALUE, 1))
          Into V_CJBZ
          From T_SYSSET
         Where SYS_YWBMBH = V_YWBMBH And SYS_ITEM = 'CJLX';
        -- 根据货主从参数设置表取得该货主是否设置了货源退货库, 为后期判断退货调度不够件包件的去向
        Select sys_value
          Into ldc_szhythq
          From t_sysset
         Where sys_item = 'SZHYTHQ' And sys_ywbmbh = v_ywbmbh;
        Select nvl(kflx, '00') Into p_kflx_gp From t_dm Where dh = v_ywbmbh;
        -- 2010-05-31 yangyi:
        -- 根据货主从参数表取得成单方式: 0=一包一单 / 1=一单多包 系统目前只能处理一包一单的情况:
        -- 所以, 在这里将其置死为0
        Select nvl(sys_value, 0)
          Into i_rwxdfs
          From t_sysset
         Where sys_item = 'RWXDFS' And sys_ywbmbh = v_ywbmbh;
        i_rwxdfs := 0;
        p_qsclfs := Trim(v_pftp.qsclfs);
        p_cybh   := Trim(v_pftp.cybh);
        p_tihfs  := Trim(v_pftp.fyfsh);
        v_kfbh   := Trim(v_pftp.kfbh);
        Select KFLX Into V_KFLX From T_DM Where DH = V_KFBH;
        If V_LXBH = 'FH' Then
            PROC_GET_LHQHW(p_CYBH, V_YWBMBH, p_DH, V_LXBH, p_LHQHW, ERRNO, ERRTEXT);
            If errno <> 0 Then
                errtext := 'PROC_GET_LHQHW:' || errtext;
                Rollback;
                Return;
            End If;
        End If;
        If v_lxbh = 'ST' Or V_LXBH = 'SC' Then
            P_LHQHW := 'HG';
        End If;
        p_qsclfs := Trim(p_qsclfs);
        If   Trim(p_qsclfs) Is Null Then
            p_qsclfs := '1';
        End If;
        -- 2010-05-16 add by yangyi:
        -- 先将高架区的下架任务处理掉:
        -- 高架区只负责普通订单的拣选, 对于高架区的任务,
        -- 不需要并包, 一次调度只形成一个虚拟的包件,
        -- 后期高架区实际下架回告时, 再形成真正的包件.
        -- 在订数分配过程中, 需要控制一下特殊订单或者异型大宗的不要从高架库下架
        -- 2010-06-06 YANGYI: 改为按phbz分单
        -- 因为可能是按门市来进行包件合并,
        -- 连锁店系统已经控制, 如果是以门市为单位订货的,
        -- 则不论是什么情况都会自动将门市简称拼到备注的后边
        -- 只有发货的才考虑按phbz来分单
        -- 所以, 非发货的将phbz清除
        If v_lxbh <> 'FH' Then
            Update t_pf_temp
               Set phbz = ''
             Where pfczybh = v_czybh And ywbmbh = v_ywbmbh And dh = p_dh;
        End If;
        Select Count(*)
          Into v_rows
          From t_pf_temp
         Where pfczybh = v_czybh And ywbmbh = v_ywbmbh And dh = p_dh;
        If v_rows > 0 Then
            -- 这个判断也是2010-05-17加的 按业务类型取得单据号 一单多包时, 才需要生成单据号
            If i_rwxdfs = 1 Then
                If v_lxbh = 'FH' Then
                    dlgetlsh(v_ywbmbh, 'XS', 'XS', P_XSDH);
                Elsif V_LXBH = 'ST' Then
                    dlgetlsh(v_ywbmbh, 'ST', 'ST', P_XSDH);
                Elsif V_LXBH = 'ZY' Then
                    dlgetlsh(v_ywbmbh, 'ZY', 'ZY', P_XSDH);
                Else
                    dlgetlsh(v_ywbmbh, 'BF', 'BF', P_XSDH);
                End If;
            End If;
            If (V_LXBH = 'FH' Or V_LXBH = 'ST' Or V_LXBH = 'ZY') And V_KFLX = 'LK' And
               p_jxfs = 'AJ' And (p_qsclfs <> '2' And p_qsclfs <> '3') Then
                -- 单品够整件的单独成件:
                PROC_KFZYDD_ZJPF_XTW(v_YWBMBH, v_CZYBH, p_dh, v_kflx, v_KFBH, v_lxbh,
                                     v_CJBZ, p_xsdh, p_LHQHW, p_cybh, ERRNO, ERRTEXT);
                If errno <> 0 Then
                    errtext := 'PROC_KFZYDD_ZJPF_XTW:' || Trim(errtext);
                    Rollback;
                    Return;
                End If;
                v_bj := -225;
                -- 货区整件成包处理
                proc_kfzydd_hqzj(v_YWBMBH, v_CZYBH, p_dh, v_kflx, v_KFBH, v_lxbh, v_CJBZ,
                                 p_xsdh, p_LHQHW, p_cybh, ERRNO, ERRTEXT);
                If errno <> 0 Then
                    errtext := ERRNO || 'proc_kfzydd_hqzj:' || Trim(errtext);
                    Rollback;
                    Return;
                End If;
                -- 零头并包处理
                PROC_KFZYDD_LTBB_XTW(v_YWBMBH, v_CZYBH, p_dh, v_kflx, v_KFBH, v_lxbh,
                                     v_CJBZ, p_xsdh, p_LHQHW, p_cybh, ERRNO, ERRTEXT);
                If errno <> 0 Then
                    errtext := 'PROC_KFZYDD_LTBB_XTW:' || Trim(errtext);
                    Rollback;
                    Return;
                End If;
            Elsif (  p_qsclfs = '3' Or p_jxfs = 'SG' or v_bdbj='1' or v_bdbj='2') /*and p_jxfs ='AJ'*/
             Then
                --特殊需求的，全部采用手工方式
                v_bj := 2;
               -- proc_get_bjlsh('FH', V_YWBMBH, p_bjlsh, errno, errtext);
                -- 一单一包包时, 单据号=包件号
                If i_rwxdfs = 0 Then
                    P_xsdh := to_char(p_bjlsh);
                End If;
                If ERRNO <> 0 Then
                    Rollback;
                    Return;
                End If;
              if v_bdbj='2' then
                --馆配
                  select sq_agvhz.nextval into v_id_agvhz from dual ;
                  select trim(dm) into v_dm from t_dm where dh=p_dh;

                  Insert Into T_AGV_RW_XT
                      (FLOWID_XJ, PH, ID, LXBH, JXFS, KFBH, YWBMBH, DH, PHDH, XSDH, TIHFS,
                       QSHQBH, HQBH, HWH, PXHW, CYBH, YSSL, SYLX, ZJXS, DBBZ, XBBZ, DJLY,
                       ZRCYBH, LHQHW, ZK, cgyj, sdhrq, zl, qsclfs, xszq, cgyj_kh, zrhw, pk,zrhq,zddh)
                      Select FLOWID_FHRW, YSDJH, ID, V_LXBH, 'AD', KFBH, YWBMBH, DH, null,
                             null, FYFSH, HQBH, HQBH, HW, HW, CYBH, DJSL, SYLX, ZJXS, DBBZ,
                             XBBZ, DJLY, ZRCYBH, p_LHQHW, FHZK, cgyj, sdhrq, zl, p_qsclfs,
                             xszq, cgyj_kh, to_char(rq, 'yyyy-mm-dd hh24:mi:ss'), pk,v_id_agvhz,trim(zddh)
                        From T_PF_TEMP
                       Where PFCZYBH = V_czybh And YWBMBH = V_YWBMBH And dh = p_dh;

                 insert into t_tree
                  (tbid, tbname, pid, pname, note, id, cs,czy,lf,rt,rid ,dm)
                  select
                  FLOWID_FHRW, 't_agv_rw_xt', null, 'no',
                  '馆配下架,'||v_dm||'任务号'||v_id_agvhz, id, djsl ,V_czybh,1,2,FLOWID_FHRW,v_dm
                   from T_PF_TEMP
                   Where PFCZYBH = V_czybh And YWBMBH = V_YWBMBH And dh = p_dh;

                  Select   Min(fhyxj), Min(jllx)
                    Into   d_fhyxj, v_jllx
                    From t_pf_temp
                   Where pfczybh = v_czybh And ywbmbh = v_ywbmbh And dh = p_dh;

                  Select   trim(min(phbz))
                      Into   v_bz
                      From t_pf_temp
                     Where pfczybh = v_czybh And ywbmbh = v_ywbmbh
                      And dh = p_dh and phbz is not null;



                   insert into t_agvhz
                   (flowid,  lxbh, customid,  kfbh, ywbmbh,  createdate,
                    createczybh, createczyname, yxj,jlhq,bdbj,isgp,isgz,bz,xjqx)
                  values
                    (v_id_agvhz,  v_lxbh,  p_dh, v_kfbh, v_YWBMBH,sysdate,  v_CZYBH,  v_czyname,
                    d_fhyxj,v_jllx,v_bdbj,decode(v_bdbj,'2','1','0'),'0',v_bz,'ZP');
              else
                   For c_bz2 In (Select Distinct  nvl(ysdjh1,'ysdjh1') ysdjh1,zddh
                                From t_pf_temp
                               Where PFCZYBH = V_czybh And YWBMBH = V_YWBMBH And dh = p_dh) loop

                     select sq_agvhz.nextval into v_id_agvhz from dual ;

                      Insert Into T_AGV_RW_XT
                          (FLOWID_XJ, PH, ID, LXBH, JXFS, KFBH, YWBMBH, DH, PHDH, XSDH, TIHFS,
                           QSHQBH, HQBH, HWH, PXHW, CYBH, YSSL, SYLX, ZJXS, DBBZ, XBBZ, DJLY,
                           ZRCYBH, LHQHW, ZK, cgyj, sdhrq, zl, qsclfs, xszq, cgyj_kh, zrhw, pk,zrhq,zddh)
                          Select FLOWID_FHRW, YSDJH, ID, V_LXBH, 'AD', KFBH, YWBMBH, DH, null,
                                 null, FYFSH, HQBH, HQBH, HW, HW, CYBH, DJSL, SYLX, ZJXS, DBBZ,
                                 XBBZ, DJLY, ZRCYBH, p_LHQHW, FHZK, cgyj, sdhrq, zl, p_qsclfs,
                                 xszq, cgyj_kh, to_char(rq, 'yyyy-mm-dd hh24:mi:ss'), pk,v_id_agvhz,trim(zddh)
                            From T_PF_TEMP
                           Where PFCZYBH = V_czybh And YWBMBH = V_YWBMBH And dh = p_dh and
                            nvl(ysdjh1,'ysdjh1')=c_bz2.ysdjh1 and zddh=c_bz2.zddh;

                   if   V_LXBH = 'FH' then
                     select trim(dm) into v_dm from t_dm where dh= c_bz2.zddh;
                   elsif  V_LXBH = 'ST' then
                     select trim(mc) into v_dm from t_ghdw where bh= c_bz2.zddh;
                   end if;

                  insert into t_tree
                  (tbid, tbname, pid, pname, note, id, cs,czy,lf,rt,rid,dm )
                  select
                  FLOWID_FHRW, 't_agv_rw_xt', null, 'no',
                  '特殊下架,'||v_dm||'任务号'||v_id_agvhz, id, djsl ,V_czybh,1,2,FLOWID_FHRW,v_dm
                   from T_PF_TEMP
                   Where PFCZYBH = V_czybh And YWBMBH = V_YWBMBH And dh = p_dh 
                   and zddh=c_bz2.zddh  and nvl(ysdjh1,'ysdjh1')=c_bz2.ysdjh1;

                      Select   Min(fhyxj), Min(jllx)
                        Into   d_fhyxj, v_jllx
                        From t_pf_temp
                       Where pfczybh = v_czybh And ywbmbh = v_ywbmbh And dh = p_dh
                        and nvl(ysdjh1,'ysdjh1')=c_bz2.ysdjh1 and zddh=c_bz2.zddh ;

                      Select   trim(min(phbz))
                          Into   v_bz
                          From t_pf_temp
                         Where pfczybh = v_czybh And ywbmbh = v_ywbmbh
                          And dh = p_dh and nvl(ysdjh1,'ysdjh1')=c_bz2.ysdjh1 and zddh=c_bz2.zddh and phbz is not null;

                       v_isgz:='0' ;
                       if v_lxbh='FH' and c_bz2.zddh<> p_dh then
                         v_isgz:='1' ;
                       end if;

                       insert into t_agvhz
                       (flowid,  lxbh, customid,  kfbh, ywbmbh,  createdate,
                        createczybh, createczyname, yxj,jlhq,bdbj,isgp,isgz,bz,xjqx,zddh)
                      values
                        (v_id_agvhz,  v_lxbh,  p_dh, v_kfbh, v_YWBMBH,sysdate,  v_CZYBH,  v_czyname,
                        d_fhyxj,v_jllx,v_bdbj,decode(v_bdbj,'2','1','0'),v_isgz,v_bz,v_lxbh,c_bz2.zddh);

                   end loop;


              end if ;



            Else
                p_JXFS := 'AD';




                For c_bz2 In (Select Distinct nvl(fhyxj, 'C') fhyxj, nvl(jllx, 0) jllx,zddh
                                From t_pf_temp
                               Where PFCZYBH = V_czybh And YWBMBH = V_YWBMBH And dh = p_dh)
                Loop

                   if   V_LXBH = 'FH' then
                     select trim(dm) into v_dm from t_dm where dh=c_bz2.zddh;
                   elsif  V_LXBH = 'ST' then
                     select trim(mc) into v_dm from t_ghdw where bh=c_bz2.zddh;
                   end if;
                 select sq_agvhz.nextval into v_id_agvhz from dual ;
                  insert into t_tree
                  (tbid, tbname, pid, pname, note, id, cs,czy,lf,rt,rid ,dm)
                   select  FLOWID_FHRW, 't_agv_rw_xt', null, 'no',
                          '调度下架,'||v_dm||'任务号'||v_id_agvhz, id, djsl ,V_czybh,1,2,FLOWID_FHRW,v_dm
                     From t_pf_temp
                       Where pfczybh = v_czybh And ywbmbh = v_ywbmbh And
                                dh = p_dh And nvl(jllx, 0) = c_bz2.jllx And
                                           nvl(fhyxj, 'C') = c_bz2.fhyxj and zddh=c_bz2.zddh;

                    v_count := 0;


                    if  v_lxbh = 'FH' then
                       v_djrows := 200;
                    else
                        v_djrows := 200;
                    end if;


                   
                    -- select sq_jhtask.nextval into v_id_jhtask from dual ;
                        insert into t_agvhz
                         (flowid,  lxbh, customid,  kfbh, ywbmbh,  createdate,
                           createczybh, createczyname, yxj,jlhq,bdbj,isgp,xjqx,zddh)
                       values
                         (v_id_agvhz,  v_lxbh,  p_dh, v_kfbh, v_YWBMBH,sysdate,
                          v_CZYBH,  v_czyname, c_bz2.fhyxj,c_bz2.jllx,'0','0',v_lxbh,c_bz2.zddh);


                          For c_id_lt In (Select flowid_fhrw
                                      From t_pf_temp
                                     Where pfczybh = v_czybh And ywbmbh = v_ywbmbh And
                                           dh = p_dh And nvl(jllx, 0) = c_bz2.jllx And
                                           nvl(fhyxj, 'C') = c_bz2.fhyxj and zddh=c_bz2.zddh
                                     Order By hw)
                          Loop
                              v_count := v_count + 1;

                              If v_count > v_djrows Then

                                 select sq_agvhz.nextval into v_id_agvhz from dual ;

                                   v_isgz:='0' ;
                                   if v_lxbh='FH' and c_bz2.zddh<> p_dh then
                                     v_isgz:='1' ;
                                   end if;

                                   insert into t_agvhz
                                     (flowid,  lxbh, customid,  kfbh, ywbmbh,  createdate,
                                       createczybh, createczyname, yxj,jlhq,bdbj,isgp,isgz,xjqx,zddh)
                                   values
                                     (v_id_agvhz,  v_lxbh,  p_dh, v_kfbh, v_YWBMBH,sysdate,
                                      v_CZYBH,  v_czyname, c_bz2.fhyxj,c_bz2.jllx,'0','0',v_isgz,v_lxbh,c_bz2.zddh);
                                  v_count := 1;
                              End If;


                              Insert Into T_AGV_RW_XT
                                  (FLOWID_XJ, PH, ID, LXBH, JXFS, KFBH, YWBMBH, DH, PHDH, XSDH,
                                   TIHFS, QSHQBH, HQBH, HWH, PXHW, CYBH, YSSL, SYLX, ZJXS, DBBZ,
                                   XBBZ, DJLY, ZRCYBH, LHQHW, ZK, cgyj, sdhrq, zl, qsclfs, xszq,
                                   cgyj_kh, DBDH, zrhw, pk,ln_zp,zrhq,zddh)
                                  Select FLOWID_FHRW, YSDJH, ID, v_lxbh, 'AD', KFBH, YWBMBH, DH,
                                         null, null, FYFSH, HQBH, HQBH, HW,
                                         HW, CYBH, DJSL, SYLX, ZJXS, DBBZ, XBBZ, DJLY, ZRCYBH,
                                         P_LHQHW, FHZK, cgyj, sdhrq, zl, Trim(QSCLFS), xszq,
                                         cgyj_kh, '0', to_char(sysdate, 'yyyy-mm-dd hh24:mi:ss'), pk,fhyxj,v_id_agvhz,trim(zddh)
                                    From t_Pf_Temp
                                   Where PFCZYBH = v_czybh And YWBMBH = v_YWBMBH And dh = p_dh And
                                         flowid_fhrw = c_id_lt.flowid_fhrw;




                              Delete From t_pf_temp
                               Where PFCZYBH = v_czybh And YWBMBH = v_YWBMBH And dh = p_dh And
                                     flowid_fhrw = c_id_lt.flowid_fhrw;

                          End Loop;
                  --  End If;

                End Loop;
            End If;
            ldc_my := 0;
            ldc_cs := 0;
            v_bj   := -51;
            --对小件进行并包,要考虑接力标准
            d_ltjs  := 0;
            p_ltztj := 0;
            If p_JXFS = 'AJ' Then
                For c_bb3 In (Select nvl(tihfs, '01') tihfs, nvl(xgbj, '9') xgbj,
                                     nvl(zb, 'AAAA') zb, Sum(sjjs) ltjs
                                From t_dfbj_xd
                               Where nvl(sjjs, 0) < p_bzxx And YWBMBH = V_YWBMBH And
                                     jxfs = 'AJ'
                               Group By tihfs, xgbj, zb)
                Loop
                    s_tihfs := c_bb3.tihfs;
                    s_xgbj  := c_bb3.xgbj;
                    d_ltjs  := c_bb3.ltjs;
                    If d_ltjs Is Null Then
                        d_ltjs := 0;
                    End If;
                    If d_ltjs >= p_bzxx And d_ltjs <= p_bzsx Then
                        --所有零头之和够包装下线
                        Select Max(bjlsh), Min(sdhrq), Min(fhyxj), Sum(zpz), Sum(zcs),
                               Sum(zmy), Sum(zsy), Sum(sjjs)
                          Into p_bjlsh, d_sdhrq, d_fhyxj, v_zpz, v_zcs, v_zmy, v_zsy,
                               v_sjjs
                          From t_dfbj_xd
                         Where nvl(sjjs, 0) < p_bzxx And YWBMBH = V_YWBMBH And
                               jxfs = 'AJ' And Trim(nvl(xgbj, '9')) = Trim(s_xgbj) And
                               nvl(tihfs, '01') = s_tihfs And nvl(zb, 'AAAA') = c_bb3.zb;
                        Update t_dfbj_xd
                           Set zpz = v_zpz, zcs = v_zcs, zmy = v_zmy, zsy = v_zsy,
                               sjjs = v_sjjs, sdhrq = d_sdhrq, fhyxj = d_fhyxj
                         Where bjlsh = p_bjlsh;
                        For c_bb In (Select *
                                       From t_dfbj_xd
                                      Where nvl(sjjs, 0) < p_bzxx And YWBMBH = V_YWBMBH And
                                            Trim(nvl(xgbj, '9')) = Trim(s_xgbj) And
                                            nvl(tihfs, '01') = s_tihfs And
                                            bjlsh <> p_bjlsh And
                                            nvl(zb, 'AAAA') = c_bb3.zb And jxfs = 'AJ'
                                      Order By sjjs)
                        Loop
                            If i_rwxdfs = 0 Then
                                -- 0=一单一包，1=一单多包
                                Update t_agv_rw_xt_xd
                                   Set xsdh = p_bjlsh, phdh = p_bjlsh, sdhrq = d_sdhrq
                                 Where phdh = c_bb.bjlsh And YWBMBH = V_YWBMBH;
                            Else
                                Update t_agv_rw_xt_xd
                                   Set phdh = p_bjlsh, sdhrq = d_sdhrq
                                 Where phdh = c_bb.bjlsh And YWBMBH = V_YWBMBH;
                            End If;
                            Delete From t_dfbj_xd Where bjlsh = c_bb.bjlsh;
                        End Loop;
                    End If;
                    -- 大于0小于下限的包件(尾包),并到一个合适的包里去
                    If d_ltjs > 0 And d_ltjs < p_bzxx Then
                        -- 找一个能放下小尾件的包件
                        -- 2010-11-24 yangyi:
                        -- 在查找合适的包件时，增加一个p_wbjs，这个参数一般<=0.2
                        -- 其目的是将小于0.2的尾件并到某一个包件中
                        Select Min(sjjs)
                          Into d_sjjs
                          From t_dfbj_xd
                         Where nvl(sjjs, 0) <= (p_bzsx + p_wbjs - d_ltjs) And jxfs = 'AJ' And
                               YWBMBH = V_YWBMBH And Trim(nvl(xgbj, '0')) = Trim(s_xgbj) And
                               nvl(zb, 'AAAA') = c_bb3.zb And nvl(tihfs, '01') = s_tihfs And
                               nvl(sjjs, 0) >= p_bzxx;
                        If d_sjjs Is Null Or d_sjjs = 0 Then
                            Exit;
                        End If;
                        -- 找到这个包件号
                        Select Min(BJLSH)
                          Into P_BJLSH
                          From T_DFBJ_XD
                         Where SJJS = d_sjjs And JXFS = 'AJ' And YWBMBH = V_YWBMBH And
                               nvl(tihfs, '01') = s_tihfs And
                               Trim(nvl(xgbj, '0')) = Trim(s_xgbj) And
                               nvl(zb, 'AAAA') = c_bb3.zb;
                        If Trim(p_bjlsh) Is Not Null Then
                            -- 把这些小包件都筛出来
                            For c_bb1 In (Select *
                                            From t_dfbj_xd
                                           Where nvl(sjjs, 0) <= p_bzxx /*(p_bzsx - d_ltjs)*/
                                                 And YWBMBH = V_YWBMBH And
                                                 Trim(nvl(xgbj, '0')) = Trim(s_xgbj) And
                                                 nvl(zb, 'AAAA') = c_bb3.zb And
                                                 jxfs = 'AJ' And
                                                 nvl(tihfs, '01') = s_tihfs And
                                                 bjlsh <> p_bjlsh --2013-01-16 modify by lv
                                           Order By sjjs)
                            Loop
                                -- 累加到合适的包件上
                                Update T_DFBJ_XD
                                   Set ZPZ = NVL(ZPZ, 0) + NVL(C_BB1.ZPZ, 0),
                                       ZCS = NVL(ZCS, 0) + NVL(C_BB1.ZCS, 0),
                                       ZMY = NVL(ZMY, 0) + NVL(C_BB1.ZMY, 0),
                                       ZSY = NVL(ZSY, 0) + NVL(C_BB1.ZSY, 0),
                                       SJJS = NVL(SJJS, 0) + NVL(C_BB1.SJJS, 0),
                                       sdhrq = least(c_bb1.sdhrq, sdhrq),
                                       fhyxj = least(c_bb1.fhyxj, fhyxj)
                                 Where BJLSH = P_BJLSH And YWBMBH = V_YWBMBH;
                                -- 删除被合并的小尾件
                                Delete From T_DFBJ_XD
                                 Where BJLSH = C_BB1.BJLSH And YWBMBH = V_YWBMBH;
                                -- 改变任务表中的包件号
                                If i_rwxdfs = 0 Then
                                    --update t_dfbj_xd set ywpc = p_bjlsh,bjlsh = p_bjlsh where bjlsh = c_bb1.bjlsh;
                                    Update t_agv_rw_xt_xd
                                       Set xsdh = p_bjlsh, phdh = p_bjlsh,
                                           sdhrq = least(c_bb1.sdhrq, sdhrq)
                                     Where phdh = c_bb1.bjlsh And YWBMBH = V_YWBMBH;
                                Else
                                    --      update t_dfbj_xd set bjlsh = p_bjlsh where bjlsh = c_bb1.bjlsh;
                                    -- 一单多包的应该还要修改整单的sdhrq/fhyxj,
                                    -- 山西没有一单多包, 所以先不考虑这些了
                                    Update t_agv_rw_xt_xd
                                       Set phdh = p_bjlsh,
                                           sdhrq = least(c_bb1.sdhrq, sdhrq)
                                     Where phdh = c_bb1.bjlsh And YWBMBH = V_YWBMBH;
                                End If;
                            End Loop;
                        End If;
                    End If;
                End Loop;
            End If;
            ----不够一件的，要进行主配,这个是山东馆配的需求
            If v_lxbh = 'FH' And Trim(p_kflx_gp) = 'GP' Then
                For c_end In (Select bjlsh, Sum(sjjs) sjjs From t_dfbj_xd Group By bjlsh)
                Loop
                    Select Count(Distinct dh)
                      Into ldc_cs
                      From t_agv_rw_xt_xd
                     Where phdh = c_end.bjlsh;
                    If c_end.sjjs >= p_bzxx And ldc_cs = 1 Then
                        Update t_agv_rw_xt_xd Set dbdh = '1' Where phdh = c_end.bjlsh;
                        --update t_agv_rw_xt_bak set dbdh ='1' where phdh = :s_phdh;
                    Else
                        Update t_agv_rw_xt_xd Set dbdh = '0' Where phdh = c_end.bjlsh;
                        --update t_agv_rw_xt_bak set dbdh ='0' where phdh = :s_phdh;
                    End If;
                End Loop;
            End If;
            --    v_thfs_temp := v_thfs;
            ----20100225 徐同文修改，由于山西取消了尾包进入暂存区并包功能，所以将退货方式都修改成1
            v_thfs_temp := '1';
            --对于库区的退货，有暂存区的货主单位，对于包件体积小于设定值的则去暂存区进行并包
            If V_LXBH = 'ST' And
               (v_kflx <> 'YB' And ldc_szhythq = 1 And V_thfs_temp <> '1') Then
                For cur_dfbj In (Select bjlsh
                                   From t_dfbj_xd
                                  Where sjjs < p_bzxx And YWBMBH = V_YWBMBH)
                Loop
                    Select Count(*)
                      Into v_rows
                      From t_agv_rw_xt_xd
                     Where phdh = cur_dfbj.bjlsh And YWBMBH = V_YWBMBH And Exists
                     (Select hw
                              From t_hwdy
                             Where hw = t_agv_rw_xt_xd.hwh And hwlx = '2');
                    If v_rows <= 0 Then
                        --如果该包件配货任务的货位有在大货量区的就不并件
                        Update t_dfbj_xd
                           Set hw = 'NO', YWPC = CUR_DFBJ.BJLSH
                         Where bjlsh = cur_dfbj.bjlsh And YWBMBH = V_YWBMBH;
                        Update t_agv_rw_xt_xd
                           Set lhqhw = 'NO', XSDH = CUR_DFBJ.BJLSH
                         Where phdh = cur_dfbj.bjlsh And YWBMBH = V_YWBMBH;
                    End If;
                End Loop;
            End If;
            If v_phbz_count = 1 Then
                Update t_dfbj_xd Set zb = p_phbz;
            End If;
            Insert Into t_dfbj
                Select a.* From t_dfbj_xd a Where YWBMBH = V_YWBMBH;
            v_bj := -61;
            -- 2010-04-14 add by yangyi:
            -- 因为在零头并包时是按优先级先排序的,所以这里要重新置一下起始货区
            For c_qshq In (Select * From t_dfbj_xd Where ywbmbh = v_ywbmbh)
            Loop
                --2012-10-17 modify by lv 山东起始货区从大号开始 山西起始货区从小号开始
                --2015-07-20 modify by yangyi 河北起始货区从小号开始
                Select Min(hqbh)
                  Into v_qshqbh
                  From t_agv_rw_xt_xd
                 Where phdh = c_qshq.bjlsh;
                Update t_agv_rw_xt_xd Set qshqbh = v_qshqbh Where phdh = c_qshq.bjlsh;
            End Loop;
            -- end add
            Insert Into t_agv_rw_xt
                Select * From t_agv_rw_xt_xd Where YWBMBH = V_YWBMBH;
            Delete From t_pf_temp
             Where t_pf_temp.pfczybh = v_czybh And ywbmbh = v_ywbmbh And dh = p_dh;
            Delete From T_PF_TEMP_QS_XTW Where PFCZYBH = v_CZYBH;
            Delete From t_dfbj_xd Where YWBMBH = V_YWBMBH;
            Delete From t_agv_rw_xt_xd Where YWBMBH = V_YWBMBH;
        End If;
        If Trim(v_lxbh) = 'FH' Then
          update t_fhrwb  set dd_date=sysdate
                 Where ddczybh = v_czybh And YWBMBH = V_YWBMBH And dh = p_dh;
        /*    Insert Into t_fhrwb_bak
                Select flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl, fhzk, sylx, zjxs, djly,
  qsts, phbz, yxdbj, fyfsh, fhfs, dj, kjxbj, fhyxj, qsds, xdbz_xhclbj, xdbz_qsclbj, ddczybh, rq,
   sdhrq, qsclfs, yxrq, cgyj, dbdh, usr_id, xtpch, ytpch, xszq, cgyj_kh, thl, bdbj, dd_date, ysdjh1,
   zddh, sl
                  From t_fhrwb b
                 Where ddczybh = v_czybh And YWBMBH = V_YWBMBH And dh = p_dh;*/
           insert into t_fhrwb_bak
          (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl, fhzk, sylx, zjxs, djly,
          qsts, phbz, yxdbj, fyfsh, fhfs, dj, kjxbj, fhyxj, qsds, xdbz_xhclbj, xdbz_qsclbj, ddczybh, rq, sdhrq,
           qsclfs, yxrq, cgyj, dbdh, usr_id, xtpch, ytpch, xszq, cgyj_kh, thl, bdbj, sl, dd_date,
            ysdjh1, zddh)
          select flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl, fhzk, sylx, zjxs, djly,
          qsts, phbz, yxdbj, fyfsh, fhfs, dj, kjxbj, fhyxj, qsds, xdbz_xhclbj, xdbz_qsclbj, ddczybh, rq, sdhrq,
           qsclfs, yxrq, cgyj, dbdh, usr_id, xtpch, ytpch, xszq, cgyj_kh, thl, bdbj, sl, dd_date,
            ysdjh1, zddh from t_fhrwb
            Where ddczybh = v_czybh And YWBMBH = V_YWBMBH And dh = p_dh;

            Delete From t_fhrwb
             Where ddczybh = v_czybh And YWBMBH = V_YWBMBH And dh = p_dh;
        Elsif Trim(v_lxbh) = 'ST' Then

         update t_thjh  set dd_date=sysdate
                 Where  ddczybh = v_czybh And YWBMBH = V_YWBMBH;

           Insert Into t_thjh_bak(flowid, ywpch, hybh, cybh, kfbh, ywbmbh, id, thcs, thzk, usr_id, jhrq,
   bz, czybh, zyjhbj, czybh1, zwthrq, yxbz, sys, sl, sylx, zjxs, bj, shbj, yfbbj,
   ysbbj, thjzrq, ybth, ddczybh, cgyj, thfs, dd_date,   dj)

                Select  flowid, ywpch, hybh, cybh, kfbh, ywbmbh, id, thcs, thzk, usr_id, jhrq,
   bz, czybh, zyjhbj, czybh1, zwthrq, yxbz, sys, sl, sylx, zjxs, bj, shbj, yfbbj,
   ysbbj, thjzrq, ybth, ddczybh, cgyj, thfs, dd_date,   dj
                  From t_thjh t
                 Where t.ddczybh = v_czybh And t.YWBMBH = V_YWBMBH;

            Delete From t_thjh Where ddczybh = v_czybh And YWBMBH = V_YWBMBH;
        Elsif Trim(v_lxbh) = 'BF' Then
            Insert Into T_BFJHMX_BAK
                Select b.*, Sysdate From T_BFJHMX b Where DDCZYBH = V_CZYBH;
            Delete From T_BFJHMX Where DDCZYBH = V_CZYBH;
        Else
            Insert Into T_ZYJH_BAK
                Select z.*, Sysdate From T_ZYJH z Where z.DDCZYBH = V_CZYBH;
            Delete From T_ZYJH Where DDCZYBH = V_CZYBH;
        End If;
    End Loop;

    update t_agvhz a
      set (yssl,  zpz, zmy, picktimes, resttimes,currenthq) =
          (select sum(yssl),
                  count(distinct x.id),
                  sum(dj * yssl),
                  count(*),
                  count(*),min(hqbh)
             from t_agv_rw_xt x, t_kcsm s
            where x.id = s.id
              and x.zrhq = a.flowid)
    where yssl = 0;

    v_bj := -75;
    --待出库的箱子
/*  -- insert into t_outputrqh select   distinct trim(zpxyrqh) from t_zprw where ln_zp_no is null and ln_zp_hw is null ;
   --备份
 --  insert into t_outputrqh_record select   distinct trim(zpxyrqh),sysdate from t_zprw where ln_zp_no is null and ln_zp_hw is null ;

  update t_zprw t  set (ln_zp_no,ln_zp_hw)=(select line,hw from t_Line_Zp_Hw2 where dh=t.dh and ontransline='1' and rownum=1)
  where ln_zp_no is null and ln_zp_hw is null ;
  --没有分配主配货位的不出库
  delete t_outputrqh where exists (select 1    from t_zprw where ln_zp_no is null and ln_zp_hw is null and rqh=trim(zpxyrqh)) ;
  delete t_outputrqh_record where exists (select 1    from t_zprw where ln_zp_no is null and ln_zp_hw is null and rqh=trim(zpxyrqh)) ;

  insert into t_nozphw
  select distinct dh from t_zprw where ln_zp_no is null and ln_zp_hw is null ;*/

    Delete From T_KFZYDD_ZY
     Where CZYBH = v_czybh /*and ywbmbh=v_ywbmbh1*/
    ;
     update T_KFZYDD set running='0' , finishdate=sysdate where running='1' and czybh=v_CZYBH;
    --20110513 增加
    --由于存在fhrwb没有删除干净的情况，因此在此处补上一刀
    If Trim(v_lxbh) = 'FH' Then
       update t_fhrwb  set dd_date=sysdate
                 Where ddczybh = v_czybh ;
        /*Insert Into t_fhrwb_bak
            Select flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl, fhzk, sylx, zjxs, djly,
  qsts, phbz, yxdbj, fyfsh, fhfs, dj, kjxbj, fhyxj, qsds, xdbz_xhclbj, xdbz_qsclbj, ddczybh, rq,
   sdhrq, qsclfs, yxrq, cgyj, dbdh, usr_id, xtpch, ytpch, xszq, cgyj_kh, thl, bdbj, dd_date, ysdjh1,
   zddh, sl  From t_fhrwb b Where b.ddczybh = v_czybh;*/
      insert into t_fhrwb_bak
          (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl, fhzk, sylx, zjxs, djly,
          qsts, phbz, yxdbj, fyfsh, fhfs, dj, kjxbj, fhyxj, qsds, xdbz_xhclbj, xdbz_qsclbj, ddczybh, rq, sdhrq,
           qsclfs, yxrq, cgyj, dbdh, usr_id, xtpch, ytpch, xszq, cgyj_kh, thl, bdbj, sl, dd_date,
            ysdjh1, zddh)
          select flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl, fhzk, sylx, zjxs, djly,
          qsts, phbz, yxdbj, fyfsh, fhfs, dj, kjxbj, fhyxj, qsds, xdbz_xhclbj, xdbz_qsclbj, ddczybh, rq, sdhrq,
           qsclfs, yxrq, cgyj, dbdh, usr_id, xtpch, ytpch, xszq, cgyj_kh, thl, bdbj, sl, dd_date,
            ysdjh1, zddh from t_fhrwb
            Where ddczybh = v_czybh ;

        Delete From t_fhrwb Where ddczybh = v_czybh;
    Elsif Trim(v_lxbh) = 'ST' Then
        --2013-05-09 modify by lv 去掉And YWBMBH = V_YWBMBH
        update t_thjh  set dd_date=sysdate
                 Where ddczybh = v_czybh ;

          Insert Into t_thjh_bak(flowid, ywpch, hybh, cybh, kfbh, ywbmbh, id, thcs, thzk, usr_id, jhrq,
   bz, czybh, zyjhbj, czybh1, zwthrq, yxbz, sys, sl, sylx, zjxs, bj, shbj, yfbbj,
   ysbbj, thjzrq, ybth, ddczybh, cgyj, thfs, dd_date, dj)

                Select  flowid, ywpch, hybh, cybh, kfbh, ywbmbh, id, thcs, thzk, usr_id, jhrq,
   bz, czybh, zyjhbj, czybh1, zwthrq, yxbz, sys, sl, sylx, zjxs, bj, shbj, yfbbj,
   ysbbj, thjzrq, ybth, ddczybh, cgyj, thfs, dd_date,   dj
                  From t_thjh t
                 Where t.ddczybh = v_czybh ;


        Delete From t_thjh Where ddczybh = v_czybh;
    Elsif Trim(v_lxbh) = 'BF' Then
        Insert Into T_BFJHMX_BAK
            Select b.*, Sysdate From T_BFJHMX b Where DDCZYBH = V_CZYBH;
        Delete From T_BFJHMX Where DDCZYBH = V_CZYBH;
    Else
        Insert Into T_ZYJH_BAK
            Select z.*, Sysdate From T_ZYJH z Where z.DDCZYBH = V_CZYBH;
        Delete From T_ZYJH Where DDCZYBH = V_CZYBh;
    End If;
    errno   := 0;
    errtext := 'OK';
Exception
    When Others Then
        ERRNO   := -1; --'PROC_KFZYDD_XTW' || Sqlerrm||
        ERRTEXT := 'PROC_KFZYDD_XTW:' || v_bj || '%' || Sqlerrm || v_YWBMBH1 || ',' ||
                   v_CZYBH || ',' || v_lxbh || ',' || V_THFS || ',' || v_cybh || ',' ||
                   v_ddfs || ',' || tmpVar;
        Rollback;
End PROC_KFZYDD_XTW;

CREATE OR REPLACE PROCEDURE "PROC_JT_XJ" --据退下架：写t-dfbj
 (p_rqh char,  -- 下架容器号
 p_czybh char, -- 下架操作员
 p_bzrbh char, -- 包装人(在下架同时确定)
 errno out number,
 errtext out char)

 as

 v_rows number(10);
 v_dfbj t_dfbj_jt%rowtype;
 ls_lhqhw char(20);
 v_jtbjjh number;
 v_bj     number;
 v_zmy    number;
 v_zzl    number;
 v_bzjzl  number;
 v_bzjmy  number;

 begin

 select count(*) into v_rows from t_dfbj_jt where rqh = p_rqh;
 if v_rows<= 0 then
 errno:= -1;
 errtext:= '该容器没有要下架的据退任务!!!';
 return;
 end if;

 select count(*) into v_rows from t_khthmx_jt where rqh = p_rqh and bjlsh is not null;
 if v_rows<= 0 then
 errno:= -1;
 errtext:= '该容器没有要下架的拒退任务!!!';
 return;
 end if;

 v_bj := 1;

 select * into v_dfbj from t_dfbj_jt where rqh = p_rqh;

 -- PROC_GET_FHLHQHW(v_dfbj.dh,ls_lhqhw,errno,errtext);
 -- 2010-05-19 屏蔽上边的语句改为如下:
 -- 按山西方式修改了过程 proc_get_fhlhqhw:
 proc_get_fhlhqhw(v_dfbj.fhbmbh,v_dfbj.ywbmbh,v_dfbj.zzbh,'FH','01',ls_lhqhw,errno,errtext);
 if errno <> 0 then
 rollback;
 return;
 end if;
 ls_lhqhw := trim(ls_lhqhw);

 -- 2010-04-12 yangyi add:
 -- 增加系统参数: 拒退包件是否校核, 0=不需要校核, 1=需要校核
 -- 如果不需要校核,则在下架时输入包装人, 确认后, 转入t_dfbj时置已包装标记和包装人
 -- 如果需要校核,则在下架时不必输入包装人, 确认后, 转入t_dfbj时不再置已包装标记和包装人了
 -- 待包装校核时再做处理
 v_bj := 2;
 select nvl(min(sys_value),0) into v_jtbjjh
 from t_sysset where sys_item='JTBJJH' and sys_ywbmbh=v_dfbj.fhbmbh;

 --如果拒退包件不需要校核, 则必须提供合法的包装人:
 if v_jtbjjh=0 then
 select count(*) into v_rows from t_user where usr_id=p_bzrbh;
 if v_rows=0 then
 errno:= -1;
 errtext:= '包装人编号不存在!';
 return;
 end if;
 end if;

 -- 2010-10-18 yangyi: 取得标准件重量(公斤), 为按码洋估算拒退包件的重量()
 select nvl(min(sys_value),25) into v_bzjzl from t_sysset where sys_item='BZJZL';
 select nvl(min(sys_value),900) into v_bzjmy from t_sysset where sys_item='GPBJBZ';
 select zmy into v_zmy from t_dfbj_jt where rqh=p_rqh;
 v_zzl := round(v_zmy/v_bzjmy*v_bzjzl*1000,0); -- 转换成(克)

 --更新理货区货位, 并置已包装标记
 --如果拒退包件不需要校核, 则直接置已包装标记=1，否则置已包装标记=0
 if v_jtbjjh=0 then
 update t_dfbj_jt set hw = ls_lhqhw, ybzbj='1' where rqh = p_rqh;
 else
 update t_dfbj_jt set hw = ls_lhqhw, ybzbj='0' where rqh = p_rqh;
 end if;

 --插入t_dfbj, 为交接, 理货, 发运做准备
 insert into t_dfbj (
 bjlsh, rqh, wcbj, pfrq, ywbmbh, ywpc, dh, gkh, hw,
 agvbj, ybzbj, bjfjbj, tph, lhrq, czybh,
 zpz, zcs, zmy, zsy, zzl, bzjs, fhbmbh, fyjhpc,
 fyjhrq, fyjhpc1, jhrh, fyfsh, ch, yh, ywqrpc,
 yqrjs, yjsje, zzbh, zzbh1, ktbj, ktjkfs, ktpch, ktrq,
 kt_czybh, zb, tihfs, xgbj, fxjb, fyjb, ln_zp_no,
 sjjs, sum_xhao, kfbh, jxfs, ywlx, frrq, ttxh, djbj,
 xjdbj, fyrh, jhczybh, jhrq, jhrqh, cydw, cyr,
 cyr_tele, cyrq, jkpzrq, psjs, shrq, ssjs, tylx, tynr,
 tyr, tyr_tele, tyrq, sdhrq, lx, yrq, fhyxj, fyth_czybh,
  jhpch, fytph, js, cgyj, lhbj, cybh, bzr, jjbj, jsjs )
 select bjlsh, rqh, wcbj, pfrq, ywbmbh, ywpc, dh, gkh, hw,
 agvbj, ybzbj, bjfjbj, tph, lhrq, czybh,
 zpz, zcs, zmy, zsy, v_zzl, bzjs, fhbmbh, fyjhpc,
 fyjhrq, fyjhpc1, jhrh, fyfsh, ch, yh, ywqrpc,
 yqrjs, yjsje, zzbh, zzbh1, ktbj, ktjkfs, ktpch, ktrq,
 kt_czybh, zb, tihfs, xgbj, fxjb, fyjb, ln_zp_no,
 bzjs, sum_xhao, kfbh, 'AJ', ywlx, frrq, 1, '1',
 xjdbj, fyrh, p_bzrbh, SYSDATE, jhrqh, cydw, cyr,
 cyr_tele, cyrq, jkpzrq, psjs, shrq, ssjs, tylx, tynr,
 tyr, tyr_tele, tyrq, SYSDATE+10, lx, yrq, fhyxj, fyth_czybh,
  jhpch, fytph, bzjs, cgyj, lhbj, cybh, p_bzrbh, jjbj, jsjs
 from t_dfbj_jt
 where rqh = p_rqh;

 /*  insert into t_dfbj select * from t_dfbj_jt where rqh = p_rqh;*/
 -- update t_khthmx_jt set bjlsh = d_bjlsh where rqh = p_rqh and bjlsh is null;
 delete from t_dfbj_jt where rqh = p_rqh;

 proc_write_gzl('JTXJ',p_czybh,v_dfbj.zpz,v_dfbj.zcs,1,v_dfbj.zmy,
 't_dfbj_jt',v_dfbj.bjlsh,v_dfbj.ywbmbh,'PROC_JT_XJ',
 errno,errtext);
 if errno<>0 then
 rollback;
 return;
 end if;

 --如果拒退包件不需要校核, 则记包装人工作量
 if v_jtbjjh=0 then
 proc_write_gzl('XJBZ',p_bzrbh,v_dfbj.zpz,v_dfbj.zcs,1,v_dfbj.zmy,
  't_dfbj_jt',v_dfbj.bjlsh,v_dfbj.ywbmbh,'PROC_JT_XJ',
 errno,errtext);
 if errno<>0 then
 rollback;
 return;
 end if;
 end if;

 errno := 0;
 errtext:='OK';

 EXCEPTION
 when others then
 errno := -1 ;
 errtext:= SQLERRM||v_bj;
 rollback;
 end ;

CREATE OR REPLACE Procedure "PROC_CANCEL_CBRW"
(p_czybh            Char,--登录人
 p_flowid            CHAR,--任务号
 errno           Out Number,
 errtext         Out Varchar2) As
    v_rows number;
Begin

  -- 先判断登录人是否为管理员
  select count(*) into v_rows from t_group_user  where groupbh =1
  and user_id=p_czybh;
  if  v_rows=0  then

  -- 更新相关任务表
    UPDATE T_SPLITBAGTASK SET
           zt='1',SPLITDATE='' ,SPLITCZYBH='',SPLITCZYNAME=''
           where  flowid_tldjhz=p_flowid and zt='2';
    if sql%notfound then
       errno   := -1;
       errtext := '未更新，请刷新重试！';
       Return;
    end if ;
  end if;


    ERRNO   := 0;
    ERRTEXT := 'ok';
    Return;
Exception
    When Others Then
        ERRNO   := -1;
        ERRTEXT := 'PROC_CANCEL_CBRW' || Sqlerrm;
        Rollback;
        Return;
End PROC_CANCEL_CBRW;
CREATE OR REPLACE Procedure RF_THSJ -- 说明：
    -- 为便于电子标签系统的判断及提示，所有容器的异常判断返回值都是 -1
(p_flowid   In Number, --原容器
 p_mdrqh    In Char, --目的箱号
 p_hw   In Char, --主配线号
 p_id    In Char, --品种号
 p_cfbj  In Char, --拆分标记，1=拆分，默认是0
 p_sjsl    In Number,
 p_czy   In Char,
 errno   Out Number,
 errtext Out Varchar) As

 v_allflowid number;
    v_one_sys  t_dfbj.zsy%Type;

    v_one_mys  t_dfbj.zmy%Type;
    v_bjlsh    number;
    v_bj       Number;

    v_cys    Number(9); --差异数

    flowid  Number(10);
    v_mdrqh Char(20);
    v_bccs   Number(10); -- 本次册数
    v_sjsl   Number(10);
    v_rows     Number;
    v_flowid   number;
    v_zy varchar2(60);
    v_ghdwh char(6);
     a_ywpch     Char(12);
    v_lkkf      Char(6);
    b_ywpch     Char(12);
    v_dj number;
    v_mxid number;
    v_zrcs number;
Begin
    -- 2015-08-18 yangyi:
    If p_sjsl < 0 Then
        ERRNO   := 1;
        ERRTEXT := '上架数量必须大于等于0!';
        Return;
    End If;

   select sum(ywsl-hgcs) -p_sjsl into v_rows   From t_fjrwsjb
     Where id_thsjhz=p_flowid  And id = p_id and hw=p_hw;
      If v_rows < 0 Then
          ERRNO   := -1;
          ERRTEXT := '输入的数量不能大于原始数量';
        Return;
      End If;

      if v_rows=0 and p_cfbj ='1' then
          ERRNO   := -1;
          ERRTEXT := '拆分数量和原数量相同';
        Return;
      end if ;
    ---------------------
    -- 2011-11-18 升级
    -- 2008-07-08 add by yangyi:
    -- 调用统一过程判断容器合法：
    v_one_mys := 0;
    proc_chkrqh2(p_mdrqh, 't_ghdw_hythqhw,t_hykchz', errno, errtext);
    If errno <> 0 Then
        errno := -1;
        Return;
    End If;
    select min(hw) into v_zy   from t_ghdw_hythqhw where rqh=p_mdrqh and  hw<>p_hw;
    if v_zy is not null then
       errno := -1;
       errtext:='箱号被用于货位'||v_zy;
       Return;
    end if ;


    if  p_sjsl>0 then
      select dj into v_dj from t_kcsm where id=p_id;

      Select    min(rqh),min(ghdwh)
        Into  v_mdrqh,v_ghdwh
        From t_ghdw_hythqhw
       Where hw = p_hw;
      If  v_mdrqh is null Then
          -- 如果主配货位上没有绑定容器，则用当前容器自动做绑定：
          v_bj := 2;

          Update t_ghdw_hythqhw
             Set rqh = p_mdrqh
           Where hw=p_hw and rqh is null;
           if sql%notfound then
              select rqh into v_mdrqh from  t_ghdw_hythqhw where
              hw = p_hw ;
              errno   := -1;
              errtext := '货位上已经有容器' || v_mdrqh  ;

              Return;
           end if;

         insert into t_rqzy
          (bh, zydate, czy, tbname, tableid, note,qx,zylx)
         values(   p_mdrqh, sysdate, null, 't_ghdw_hythqhw',
         trim(p_hw), '退货区'||trim(p_hw)||'绑定','THKBD','q');

         select sq_hykchz.nextval into v_flowid from  dual;
         insert into t_hykchz
         (id, rqh,  createdate, zpz, zcs, zmy, ghdw,  hw)
         values
         (v_flowid, p_mdrqh, sysdate,  0, 0, 0 ,v_ghdwh,p_hw  );

         insert into t_rqzy
         (bh, zydate, czy, tbname, tableid, note,qx,zylx)
         select   p_mdrqh, sysdate, null, 't_hykchz',
         v_flowid,  trim(mc)||'的校核任务' ,'THK','s'  from
         t_ghdw where bh=v_ghdwh;
      Else
          If Trim(v_mdrqh) <> Trim(p_mdrqh) Then
              errno   := -1;
              errtext := '应放入' || v_mdrqh || '容器中!店号：' ||v_ghdwh ;
              Rollback;
              Return;
          End If;

          select tableid into v_flowid from t_rqzy where tbname='t_hykchz' and bh= p_mdrqh;
      End If;

    end if ;

    select count(*) into v_rows from t_fjrwsjb
    Where id_thsjhz=p_flowid  And id = p_id and hw=p_hw
    and ghdwh<>v_ghdwh;
    if v_rows> 0 then
      errno   := -1;
      errtext := '任务中的供货商和货位绑定的供货商不一致' ;
      Rollback;
      Return;
    end if;
v_bj := 1.1;
    Select dh Into v_lkkf From t_dm Where lxbh='2' And kflx='LK' And rownum=1;
    v_sjsl := p_sjsl;
    For c1 In (Select  t.* , ywsl-hgcs rwsl
                 From t_fjrwsjb t
                Where id_thsjhz=p_flowid  And id = p_id and hw=p_hw and ywsl-hgcs >0)
    Loop
        v_bj := 4;


        v_bj := 5;
        If v_sjsl > c1.rwsl Then
            v_bccs := c1.rwsl;
            v_cys  := 0;
           -- v_sjsl := v_sjsl - v_bccs; -- 累减本次回告总数
        Else
            v_bccs := v_sjsl;
            v_cys  := c1.rwsl - v_bccs;
           -- v_sjsl := 0;
        End If;
        V_SJSL := V_SJSL -v_bccs;
        select ALL_FLOWID.Nextval into  v_allflowid from dual;
        
        proc_makedjh('2002', 'ZR', a_ywpch, errno, errtext);
        If errno <> 0 Then
            Rollback;
            Return;
        End If; 
        if p_cfbj='1' then 
          v_zrcs :=v_bccs;
        else
          v_zrcs :=c1.rwsl;
        end if ;
        Insert Into T_CRKLS
            (FLOWID_CRKLS, ID, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH, CRKCS,
             CRKSY, SYLX, ZK_JG, ZJXS, BZ, sl, flowid_wl, pk)
        Values
            (ALL_FLOWID.Nextval, c1.ID, a_ywpch, a_ywpch, Sysdate, 'ZR', '2002',
             v_lkkf/*c1.LYBH*/, c1.CYBH, c1.YWBMBH, v_zrcs,
             round( v_zrcs *c1.zjxs*c1.thzk/100,2)/*V_ONE_SYS*/,
             c1.SYLX,
             c1.THZK, c1.ZJXS, 'THZY', c1.sl, c1.flowid, c1.pk);
                 
        If v_bccs > 0 Then

          Update t_hykchz
              Set   zcs = zcs + v_bccs, zmy = zmy + v_dj*v_bccs
             Where id=v_flowid;
            If Sql%Notfound Then
                 errno   := -1;
                errtext := '更新出错！';
                 rollback;
                return;
            End If;
          
          Insert Into T_HYKCSL
              (ID, YWBMBH, CYBH, KFBH, DBBZ, XBBZ, KCCS, ZYCS, HW, GHDWH, XM, SYLX,
               ZJXS, SJLY, THZK, FLOWID, YWPC, BJLSH, SL, Zl, Cgyj, Yscs, pk,SOURCEID,SOURCEtable)
          Values
              (c1.ID, c1.YWBMBH, c1.CYBH, c1.KFBH, c1.DBBZ, c1.XBBZ,
               v_bccs, 0, p_hw, c1.GHDWH, p_mdrqh, c1.SYLX, c1.ZJXS, c1.YWLX1,
               c1.THZK, v_allflowid, null,v_flowid, c1.sl  , c1.zl,
               null, c1.yscs, c1.pk,c1.flowid,'t_fjrwsjb');
           -- End If;
             insert into t_tree
             (tbid, tbname, pid, pname, note, id, cs,czy )
              values
             (v_allflowid, 't_hykcsl', c1.flowid, 't_fjrwsjb',
              '退货暂存区上架,货位'||trim(p_hw)||'箱号'||p_mdrqh, c1.id,
               v_bccs ,p_czy);

         

              Update t_fjrwsjb  Set   hgcs = hgcs+v_bccs
               Where flowid = c1.flowid;

        End If;

        If v_cys > 0 and p_cfbj ='0' Then

          select ALL_FLOWID.NEXTVAL into v_mxid from  dual;
           insert into t_tree
           (tbid, tbname, pid, pname, note, id, cs,czy )
            values
           (v_mxid, 't_wl_zyls', c1.flowid, 't_fjrwsjb',
            '退货上架差异,'||c1.GHDWH, c1.id,
             v_cys ,p_czy);

           /* proc_makedjh('2002', 'ZR', a_ywpch, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;

            Insert Into T_CRKLS
            (FLOWID_CRKLS, ID, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH, CRKCS,
             CRKSY, SYLX, ZK_JG, ZJXS, BZ, sl, flowid_wl, pk)
            Values
                (ALL_FLOWID.Nextval, c1.ID, a_ywpch, a_ywpch, Sysdate, 'ZR', c1.KFBH,
                 v_lkkf , c1.CYBH, c1.YWBMBH, -v_cys,
                 round(-v_cys*c1.zjxs*c1.thzk/100,2) ,
                 c1.SYLX,
                 c1.THZK, c1.ZJXS, 'THZY', c1.sl, c1.flowid, c1.pk);

                 -- 2007-08-08 yangyi add: 写差错表
            proc_makedjh('2002','ZC',a_ywpch,errno,errtext);
            if errno <> 0 then
              rollback;
              return;
            end if;

            INSERT INTO T_CRKLS (FLOWID_CRKLS,ID,YWPCH,YSPCH,CRKRQ,YWLX,
                                  KFBH,LYBH,CYBH,YWBMBH,
                                  CRKCS,CRKSY,SYLX,ZK_JG,ZJXS)
            VALUES (all_flowid.nextval,c1.ID,a_ywpch,a_ywpch,SYSDATE,'ZC',
                    c1.kfbh,'2001',c1.CYBH,c1.YWBMBH, -v_cys ,
                    ROUND(-v_cys*c1.ZJXS*c1.THZK/100,2),c1.SYLX,c1.THZK,c1.ZJXS);
*/
        /*    proc_makedjh(c1.KFBH,'ZR',B_ywpch,errno,errtext);
            if errno <> 0 then
                rollback;
                return;
            end if;

            INSERT INTO T_CRKLS (FLOWID_CRKLS,ID,YWPCH,YSPCH,CRKRQ,YWLX,
                  KFBH,LYBH,CYBH,YWBMBH,
                  CRKCS,CRKSY,SYLX,ZK_JG,ZJXS)
            VALUES (all_flowid.nextval,c1.ID,B_YWPCH,B_YWPCH,SYSDATE,'ZR',
                  '2001',c1.kfbh,c1.CYBH,c1.YWBMBH,  -v_cys,
                  ROUND(-v_cys*c1.ZJXS*c1.THZK/100,2),c1.SYLX,c1.THZK,c1.ZJXS);*/

      /*      insert into t_wl_zyls(flowid,id,ckkf,rkkf,cybh,ywbmbh,yssl,sjsl,cgyj,lx,ghdwh,zypch,zk,zjxs,sylx,rq)
                values(v_mxid,c1.id,c1.kfbh,'2001',c1.cybh,c1.ywbmbh,
                -v_cys, -v_cys,'','SZ',c1.Ghdwh,a_ywpch,c1.thzk,c1.zjxs,c1.sylx,sysdate);*/


            proc_cycl(c1.ywbmbh, '2002'/*c1.kfbh*/, c1.id, -v_cys, c1.djbh, '退货上架',
                  p_czy, '', c1.cybh, c1.ghdwh, 'ST', c1.THZK, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;

       end if ;

         Insert Into t_agv_rw_xt_bak
              (flowid_xj, ph, id, lxbh, ln_zp, kfbh, ywbmbh, cybh, dh, phdh, xsdh,
               tihfs, xhao, qshqbh, hqbh, hwh, pxhw, zrhq, zrhw, yssl, sl, zk, sylx,
               zjxs, cltz, xjrq, xjczybh, wcbj, ysczybh, dbbz, xbbz, cwh, jxfs, djly,
               dbdh, zrcybh, sjsl, lhqhw, xdrq, zl, sdhrq, cgyj, xszq, qsclfs,
               cgyj_kh,  pk)
          Values
              (v_allflowid, p_flowid, c1.id, 'ZP', '', Trim(c1.kfbh),
               Trim(c1.ywbmbh), Trim(c1.cybh), Trim(c1.ghdwh), p_flowid,
              p_flowid, '01', p_mdrqh, '901',
              '901', null, '', '', '', v_bccs
               /*c1.yssl*/, c1.sl, c1.thzk, c1.sylx, c1.zjxs, 1, Sysdate,
               p_czy, '0', c1.czybh, c1.dbbz, c1.xbbz, '', 'AJ',
               null, Null, '', v_bccs, '', Sysdate, c1.zl, null,
               c1.CGYJ, null, '0', null,   c1.flowid);


       if v_bccs=0 and p_cfbj='1' then
          exit;
       end if ;

    End Loop;

    if p_cfbj='1' then
      insert into t_fjrwsjb_bak
        (flowid, ywlx, xm, kfbh, ghdwh, id, ywsl, ywbmbh, cybh, rwrq, czybh,
        ywlx1, dbbz, xbbz, zjxs, sylx, thzk, cwh, gh, ykfbh, lybh, hqbh, hw,
        sjhw, flqxmc, hwxh, hgcs, djbh, sxh, yskc, jxsx, bz,
        sjczybh, zxbj, bjlsh, jhcs, zl, cgyj, yscs, sl, pk, czybh2, sourceid,
         sourcetable, id_thsjhz, id_thsjhz_old)
       select
        flowid, ywlx, xm, kfbh, ghdwh, id, ywsl, ywbmbh, cybh, rwrq, czybh,
        ywlx1, dbbz, xbbz, zjxs, sylx, thzk, cwh, gh, ykfbh, lybh, hqbh, hw,
        sjhw, flqxmc, hwxh, hgcs, djbh, sxh, yskc, jxsx, bz,
        sjczybh, zxbj, bjlsh, jhcs, zl, cgyj, yscs, sl, pk, czybh2, sourceid,
         sourcetable, id_thsjhz, id_thsjhz_old
         from    t_fjrwsjb  where
         id_thsjhz=p_flowid  And id = p_id and hw=p_hw and ywsl=hgcs;

       delete t_fjrwsjb where  id_thsjhz=p_flowid
       And id = p_id and hw=p_hw and ywsl=hgcs;

    else
      insert into t_fjrwsjb_bak
          (flowid, ywlx, xm, kfbh, ghdwh, id, ywsl, ywbmbh, cybh, rwrq, czybh,
          ywlx1, dbbz, xbbz, zjxs, sylx, thzk, cwh, gh, ykfbh, lybh, hqbh, hw,
          sjhw, flqxmc, hwxh, hgcs, djbh, sxh, yskc, jxsx, bz,
          sjczybh, zxbj, bjlsh, jhcs, zl, cgyj, yscs, sl, pk, czybh2, sourceid,
           sourcetable, id_thsjhz, id_thsjhz_old)
         select
          flowid, ywlx, xm, kfbh, ghdwh, id, ywsl, ywbmbh, cybh, rwrq, czybh,
          ywlx1, dbbz, xbbz, zjxs, sylx, thzk, cwh, gh, ykfbh, lybh, hqbh, hw,
          sjhw, flqxmc, hwxh, hgcs, djbh, sxh, yskc, jxsx, bz,
          sjczybh, zxbj, bjlsh, jhcs, zl, cgyj, yscs, sl, pk, czybh2, sourceid,
           sourcetable, id_thsjhz, id_thsjhz_old

           from   t_fjrwsjb where id_thsjhz=p_flowid
             And id = p_id and hw=p_hw ;

         delete t_fjrwsjb where id_thsjhz=p_flowid
         And id = p_id and hw=p_hw; --and ywsl=hgcs;
    end if ;

    if p_sjsl >0 then
      null;
   /*  insert into t_gzltimes
             (czybh,   cs, my, id_job, proc, tablename, tablepk)
             values
             (c1.zpczybh, p_sjsl, p_sjsl*v_dj, 'ZPBZ', 'RF_RFBZ2', 't_zprw', c1.flowid_zp);

        update t_zprwhz set sjsl=sjsl+p_sjsl
        where flowid=c1.Id_zprwhz;*/
    end if ;

    -- 2006-12-02 add by yangyi:
    -- 记工作量
 /*   If c1.dbbz * c1.xbbz >= 1 Then
        v_js := round(p_sjsl / c1.dbbz / c1.xbbz, 2);
    Else
        v_js := 0;
    End If;*/
  /*  proc_write_gzl('THSJ', p_czy, 1, p_sjsl, v_js, v_one_mys, 't_zprw', '',
                   p_ywbmbh, 'rf_rfbz', errno, errtext);
    If errno <> 0 Then
        Rollback;
        Return;
    End If;*/


    select count(*) into v_rows from t_fjrwsjb where  id_thsjhz = p_flowid;
    if v_rows=0 then
        update t_thsjhz set finishdate=sysdate,finished=1,zt='2'
        where flowid=p_flowid;

        delete t_rqzy where tbname='t_thsjhz' and tableid=p_flowid;
/*
        insert into t_gzl2
       (czybh,    pz, js, id_job, proc, tablename, tablepk)
       select zpczy,zpz,0,'ZPBZ','RF_RFBZ2','t_zprwhz',c1.Id_zprwhz from
        t_zprwhz where flowid=c1.Id_zprwhz;*/

    end if;



    errno := 0;
    errtext :='ok';
Exception
    When Others Then
        errno   := v_bj;
        errtext := Sqlerrm ||  ','   || p_mdrqh || ',' ||    v_bj;
        Rollback;
End;
create or replace procedure PROC_ADDTLDJHZ(
p_djr char,
p_shr char,
p_shrq date,
p_ysdw char,
p_ghdw char,
p_bz char,
p_ysjs number,
p_ssjs number,
p_yh   char,
p_hw   char,
p_djlx char,
p_ywbmbh char,
p_djsl number,
p_quick char,
p_normal  char,
ERRNO   Out Number,
ERRTEXT Out Char
)
as
 v_flowid number(10);
begin
  select all_flowid.nextval into v_flowid from dual ;
/*  insert into t_tldjhz_local(flowid_tldjhz ,createrq  )
values(flowid,   sysdate);*/

  insert into t_wlsh (shrq,ysjs,ssjs,wldh,id_wlgs,dh ,shhw,
  id,djlx,ywbmbh, shczy,bz,djsl,sj_flag,  kl_flag,zt)
 values(p_shrq,p_ysjs,p_ssjs,p_yh,p_ysdw,p_ghdw,
 p_hw, v_flowid, p_djlx,p_ywbmbh, p_djr,p_bz,p_djsl,p_quick,p_normal,'0' );

/*   insert into t_tldjhz (tlrq,ysjs,ssjs,yh,fhr,dh ,xchw,
  flowid_tldjhz,djlx,ywbmbh,cybh,shr,shr1,bz,djsl,sj_flag,lrtj ,tlch,lhbj,kl_flag,shbj)
 values(p_shrq,p_ysjs,p_ssjs,p_yh,p_ysdw,p_ghdw,
 p_hw, flowid, p_djlx,p_ywbmbh,'3001',p_djr,p_shr,p_bz,p_djsl,p_quick,'0','SJXX','1',p_normal,'2');*/

   insert into t_tldjhz (tlrq,ysjs,ssjs, dh ,
      flowid_tldjhz,djlx,ywbmbh,cybh,TLLRYBH  ,djsl, shbj,id_wlfh ,xchw,kl_flag,yh)
    select shrq,ysjs,ssjs, dh ,
    id,djlx,ywbmbh,'3001' ,shczy  ,djsl, '2',id_wlfh, shhw,kl_flag,wldh 
     from  t_wlsh where id=v_flowid;
     
 if p_djlx ='DH' then

   insert into t_tldjhz_state (flowid_tldjhz,insertdate,js)values(v_flowid,sysdate,p_ssjs);
   
 end if;
exception
  when others then
    ERRNO:=-1;
    ERRTEXT:='PROC_ADDTLDJHZ'||sqlerrm;
    rollback;
end PROC_ADDTLDJHZ;
CREATE OR REPLACE Procedure RF_CREATE_WLFL_XTW5
-- 当到货拆包台选中一条到货记录后,
    -- 调此过程生成ID, 同时生成物流分流数据
(p_flowid_dhmx In Number,
 p_flowid number,

 errno         Out Number,
 errtext       Out Varchar2) As

v_id char(19);
v_rows number;
v_pass char(1);
v_sjcs number;
v_cbname varchar2(10);
    v_dhmx tmp_dhmx%Rowtype;
    v_ywbmbh char(6);
    v_fllx  char(2);

    v_bj   Number;
    v_hqbh      Char(4);
    v_flqxmc    varChar2(60);
     v_hw       Char(20);

    v_dhzxid varchar2(30);
    v_nxtzxid varchar2(30);
    v_isgz char(1);
    v_isgp char(1);
    v_zddh char(6);
    
Begin

    errno   := 0;
    errtext := 'ok';

    select id, pass into v_id,v_pass  from    tmp_dhmx
    where flowid_dhmx = p_flowid_dhmx;
    if v_pass='3' then
       return;
    end if ;

    if v_pass ='0' then

      If v_id Is Null Then
        errno   := 0;
        errtext := 'id为空';
        Return;
      End If;

      update tmp_dhmx a set(dbbz,xbbz,zl)=(select dbbz,xbbz,zl from t_kcsm where id=a.id)
       where flowid_dhmx=p_flowid_dhmx;

      update  tmp_dhmx set pass='1'   where flowid_dhmx = p_flowid_dhmx and pass='0';

      v_pass:='1';


    end if ;

    select * into v_dhmx from tmp_dhmx where flowid_dhmx = p_flowid_dhmx;
    select ywbmbh,fllx into v_ywbmbh,v_fllx from t_wlsh where id =p_flowid;
    select splitczyname into v_cbname from t_splitbagtask where flowid_tldjhz=p_flowid;
    
    if v_pass ='1' then

       insert into t_dh_yfsj
      (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx,ywbmbh,
      flqxmc, detailqx,  cgyj, cgyj_kh,djly,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch,xh)
        select   flowid_yfsj,  flowid, flowid_dj, dh, v_dhmx.id, yfsl, 0, 'FH',v_ywbmbh, null, null,
          ysdjh, trim(cgyj_kh) ,DJLY,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch,0
       from t_sl_yfsj  Where flowid = p_flowid_dhmx;



        select v_dhmx.yssl- nvl(sum(yfsl),0) into v_sjcs from t_dh_yfsj
        where  flowid_dhmx = p_flowid_dhmx ;


       insert into t_dh_yfsj
        (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx, ywbmbh,
          flqxmc, detailqx, hw,  xh)
        values
        (all_flowid.Nextval,p_flowid_dhmx,v_dhmx.flowid_dj,null,v_dhmx.id,
        v_sjcs,0,'CC',v_ywbmbh,null,null,null ,2);

        update t_dh_yfsj set zddh=dh where flowid_dhmx = p_flowid_dhmx and zddh is null ;

       update  tmp_dhmx set pass='2'   where flowid_dhmx = p_flowid_dhmx and pass='1';

       v_pass:='2';

       commit;
    end if ;


    if v_fllx ='GP' then
      v_isgp:='1';
    elsif  v_fllx='PT' then
      v_isgp:='0';
    end if;

/*发货去向：ywbmbh（货主），flqx（FH），成包类型（G柜组 || 馆配P || 门店D），
成包编号6位（柜组号 || 图书馆号 || 店号），是否单独成单（Y|| N）,单号||空

播撒去向：ywbmbh（货主），flqx（ZP），播撒线号2位。
计算去向线号时，要根据规则，查询下一个环节（RF播撒）使用的去向在播撒线上存不存在货位。
下一环节去向计算方法，ywbmbh（货主），成包类型（G柜组 || 馆配P || 门店D），
成包编号6位（柜组号 || 图书馆号 || 店号），是否单独成单（N）

上架去向：ywbmbh（货主），flqx（CC），货区编号*/

    for cur in (select dh,flqx,zddh,tdpch,ddcdbj ,flowid,yfsl from t_dh_yfsj
       where flowid_dhmx=p_flowid_dhmx and dhzxid is null ) loop

      v_dhzxid:=v_ywbmbh||cur.flqx;

      if cur.flqx='FH' then

        if v_fllx='GP' then
           v_isgz:='0';
           v_dhzxid:=v_dhzxid||'P';
           v_zddh:=cur.zddh;


        elsif v_fllx='PT' then

            Select Count(*)   Into v_rows  From  t_guizu_fl
              Where dh =cur.dh And  enable = '1';
             if v_rows >0 and v_ywbmbh='000001' then
                v_isgz:='1';
                v_dhzxid:=v_dhzxid||'G';

                Select min(gzbh) into v_zddh
                 From  t_guizu_fl c
                Where flbh=v_dhmx.fl And dh = cur.dh;
                if v_zddh is null then
                  select min(gzbh) into v_zddh  from t_guizu_fl  where  dh=cur.dh;
                end if ;
             else

                v_isgz:='0';
                v_dhzxid:=v_dhzxid||'D';
                v_zddh:=cur.dh;

             end if;
        end if;
        v_dhzxid:=v_dhzxid||v_zddh;
        if cur.ddcdbj ='1' then

          v_dhzxid:=v_dhzxid||'Y'||trim(cur.tdpch);

        else

          v_dhzxid:=v_dhzxid||'N';

        end if ;
        select trim(dm) into v_flqxmc from t_dm where dh=v_zddh;
        update  t_dh_yfsj set isgp=v_isgp ,isgz=v_isgz, dhzxid=v_dhzxid,zddh=v_zddh ,
        flqxmc= v_flqxmc
        where flowid =cur.flowid;
      end if;

      if cur.flqx='CC' then

          proc_get_hqbh3(cur.yfsl, 'DH', v_dhmx.id, v_dhmx.dbbz, v_dhmx.xbbz,
                      v_ywbmbh, '3001', v_hqbh, v_flqxmc, v_hw, errno,
                      errtext);
          if v_hqbh is null then
            v_dhzxid:='';
          else
            v_dhzxid:=v_ywbmbh||'CC'||trim(v_hqbh);
          end if ;
          update  t_dh_yfsj set isgp='0' ,isgz='0', dhzxid=v_dhzxid,zddh=cur.dh ,
          nxtzxid=null,hqbh=trim(v_hqbh),flqxmc=trim(v_flqxmc) where flowid=cur.flowid;

      end if ;

    end loop;


    select count(*) into v_rows  from t_dh_yfsj t where  FLOWID_DHMX = p_flowid_dhmx
    and flqx='CC' and dhzxid is null;
    if v_rows >0 then
      errno:=-1;
      errtext:='没有找到储备库上架货区'||errtext;
      return;
    end if;

   update  tmp_dhmx set pass='3'  where FLOWID_DHMX = p_flowid_dhmx ;

   insert into t_tree
     (tbid, tbname, pid, pname, note, id, cs,  orderno, lf,rt,rid,dm)
   select
    t.flowid, 't_dh_yfsj', flowid_yfsj, 
    't_sl_yfsj', '到货分流指令,'||t.flqxmc||',任务号'||p_flowid||',拆包人'||v_cbname, t.id,
     t.yfsl,  trim(s.ysdjh),1,2,t.flowid,
      (select trim(dm) from t_dm where dh=t.zddh)
   from t_dh_yfsj t left join t_sl_yfsj s
   on t.flowid=s.flowid_yfsj  where  FLOWID_DHMX = p_flowid_dhmx;

Exception
    When Others Then
        errno   := -1; --执行失败
        errtext := 'RF_CREATE_WLFL_XTW5' || Sqlerrm ;
        Rollback;
End;
CREATE OR REPLACE Procedure PROC_KFZYDD_CANCEL_XTW
---按店调度，选择
(P_CZYBH Char,
 P_LXbh  Char,
 ERRNO   Out Number,
 ERRTEXT Out Char) As
		V_PF    T_PF_TEMP%Rowtype;
		--V_PF_QS T_PF_TEMP_QS_XTW%Rowtype;
		v_qs    t_pf_temp_qs_xtw%Rowtype;
		v_rows  Number;
    v_rows3 Number;
    v_rows1 Number;
    v_rows2 Number;
    v_bj    Number;
Begin
    -- 这个过程是在发货调度到一半的时候, 弹出个窗口, 显示出按客户汇总的已调度情况, 让用户选择哪些店参与调度
    -- 用户不论是点[确认]还是[放弃], C#中都会按原始单据来调用这个过程, 其目的有两点:
    -- 1. 将调度时生成的缺书, 尽量恢复到t_fhrwb中, 恢复不了的, 就写t_wl_bmzdj中
    -- 2. 将未选的单据全部恢复到t_fhrwb中.
    -- 下边这个循环c33是专门处理缺书的, 由于在调度时,只判了t_ltkf,没判t_pmsjrwb
    -- 所以在写不满足单据之前, 又判断了一下t_psjrwb中相应品种到底有没有任务,
    -- 如果有,再将缺书信息恢复回t_fhrwb(不写ddczybh, 为最后不被删除掉), t_fhrwb原记录累减一下
    v_bj := -1;
    Select Count(*) Into v_rows1 From t_pf_temp_QS_XTW Where Pfczybh = p_czybh;
    Select Count(*) Into v_rows2 From t_pf_temp Where Pfczybh = p_czybh;
    For c33 In (Select distinct flowid_fhrw From t_pf_temp_QS_XTW Where Pfczybh = p_czybh)
    Loop
        Select * Into v_qs From t_pf_temp_qs_xtw Where flowid_fhrw = c33.flowid_fhrw;
        Select nvl(Sum(yssl), 0)
          Into v_rows
          From t_pmsjrwb
         Where id = v_qs.id And ywbmbh = v_qs.ywbmbh;
        -- 2010-06-29 add by yangyi:
        -- 有可能在二次下达时, 已经上架了
        If v_rows = 0 Then
            Select nvl(Sum(nvl(kccs, 0) - nvl(zycs, 0)), 0)
              Into v_rows
              From t_ltkf l,t_hwdy w,t_hqdy q
             Where l.hw=w.hw and w.hqbh=q.bh  and
              hqlx not in  (decode(Trim(P_LXbh),'FH','DT','xx'))
             and l.id = v_qs.id And l.ywbmbh = v_qs.ywbmbh;
        End If;
        -- end add
        v_bj := -11;
        -- select count(*) into v_rows3 from t_dm where dh=v_qs.ywbmbh and lxbh='1' and kflx='TS';
        If v_rows > 0 Then
            Update T_FHRWB
               Set DJSL = NVL(DJSL, 0) + v_qs.djsl,usr_id=P_CZYBH
             Where YSDJH = V_QS.YSDJH And ID = V_QS.ID And DH = V_QS.DH And
                   FHZK = V_QS.FHZK And NVL(FHFS, 'SS') = NVL(V_QS.FHFS, 'SS') And
                   FHYXJ = V_QS.FHYXJ And DDCZYBH Is Null And
                   NVL(CGYJ, 'SS') = NVL(V_QS.CGYJ, 'SS') And
                   NVL(CGYJ_KH, 'SS') = NVL(V_QS.CGYJ_KH, 'SS');
            If Sql%Notfound Then
                Insert Into T_FHRWB
                    (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL,
                     FHZK, SYLX, ZJXS, DJLY, QSTS, FHFS, DDCZYBH, FYFSH, DJ, cgyj, sdhrq,
                     xszq, qsclfs, fhyxj, cgyj_kh, thl, PHBZ, rq,usr_id,bdbj,zddh,ysdjh1)
                    Select FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ,
                           XBBZ, DJSL, FHZK, SYLX, ZJXS, DJLY, QSTS, FHFS, '', FYFSH, DJ,
                           cgyj, sdhrq, xszq, QSCLFS, fhyxj, cgyj_kh, 2, PHBZ, rq,P_CZYBH,bdbj,zddh,ysdjh1
                      From T_PF_TEMP_QS_XTW
                     Where FLOWID_FHRW = V_QS.FLOWID_FHRW /*and qsclfs<>0*/
                    ;
                -------------2014-07-25 by lun 陈工说加上qsclfs<>0可以使得出版社不满足的单子撤销后不会重复出现在调度界面
            End If;
            Delete From t_pf_temp_qs_xtw Where flowid_fhrw = v_qs.flowid_fhrw;
            /*       -- 2010-05-26 yangyi add:
            -- 将t_fhrwb中的占用记录累减掉相应的数量,
            -- 以便最后根据t_fhrwb写t_fhrwb_bak时, 用实际数来写
            UPDATE T_FHRWB SET DJSL = NVL(DJSL,0) - v_qs.djsl
            WHERE YSDJH = V_QS.YSDJH AND ID = V_QS.ID AND DH = V_QS.DH AND  FHZK = V_QS.FHZK AND
            NVL(FHFS,'SS') = NVL(V_QS.FHFS,'SS') AND FHYXJ = V_QS.FHYXJ AND DDCZYBH=p_czybh AND
            NVL(CGYJ,'SS') = NVL(V_QS.CGYJ,'SS') AND NVL(CGYJ_KH,'SS') = NVL(V_QS.CGYJ_KH,'SS');
            */
        End If;
    End Loop;
    -- 下边这个循环c1是专门用于恢复调度一半时又不选的单据,
    -- 对于这部分单据所对应的缺书, 要全部恢复到t_fhrwb中, 所以就没再判断t_pmsjrwb中是否有相应的ID
    -- 粗看感觉上下两个循环中都有对缺书恢复的语句, 会不会重复了?
    -- 细看才发现上边的恢复如果成功了,就将删缺书数据删掉了, 所以不会重的.
    -- 在正常调度时, 如果数据写到了t_pf_temp中, 说明t_fhrwb中的相应数据已经清除了, t_ltkf/t_kcsl也已经占用上了.
    -- 将t_pf_temp中当前操作员生成的且未选中的数据恢复到t_fhrwb中, 并解除对t_ltkf/t_kcsl的占用为下次调度做准备
    v_bj := -13;
    For C1 In (Select * From T_PF_TEMP Where PFCZYBH = P_CZYBH And XZ = 0)
    Loop
        Select * Into V_PF From T_PF_TEMP Where FLOWID_FHRW = C1.FLOWID_FHRW;
        --将操作员取消的返回任务表 ，并更改库存占用
        Update T_FHRWB
           Set DJSL = NVL(DJSL, 0) + V_PF.DJSL
         Where YSDJH = V_PF.YSDJH And ID = V_PF.ID And DH = V_PF.DH And FHZK = V_PF.FHZK And
               NVL(FHFS, 'SS') = NVL(V_PF.FHFS, 'SS') And FHYXJ = V_PF.FHYXJ And
               NVL(CGYJ, 'SS') = NVL(V_PF.CGYJ, 'SS') And
               NVL(CGYJ_KH, 'SS') = NVL(V_PF.CGYJ_KH, 'SS') And DDCZYBH Is Null;
        If Sql%Notfound Then
            Insert Into T_FHRWB
                (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK,
                 SYLX, ZJXS, DJLY, QSTS, FHFS, DDCZYBH, FYFSH, DJ, cgyj, sdhrq, xszq,
                 qsclfs, fhyxj, cgyj_kh, thl, PHBZ, rq,sl,usr_id,bdbj,zddh)
                Select ALL_FLOWID.Nextval, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ,
                       DJSL, FHZK, SYLX, ZJXS, DJLY, QSTS, FHFS, '', FYFSH, DJ, cgyj,
                       sdhrq, xszq, QSCLFS, fhyxj, cgyj_kh, 3 /*thl*/, PHBZ, rq,
                       (select nvl(sl,10)   from t_kcsm where id=T_PF_TEMP.id),P_CZYBH,bdbj,zddh
                  From T_PF_TEMP
                 Where FLOWID_FHRW = V_PF.FLOWID_FHRW;
        End If;
        v_bj := -14;
        --将该原始单号的缺书返回任务表(这部分表示取消下达)
      /*  For C_QS In (Select *
                       From T_PF_TEMP_QS_XTW
                      Where PFCZYBH = P_CZYBH And YSDJH = V_PF.YSDJH And dh = v_pf.dh)
        Loop
            Select *
              Into V_PF_QS
              From T_PF_TEMP_QS_XTW
             Where FLOWID_FHRW = C_QS.FLOWID_FHRW;
            Update T_FHRWB
               Set DJSL = NVL(DJSL, 0) + V_PF_QS.DJSL
             Where YSDJH = V_PF_QS.YSDJH And ID = V_PF_QS.ID And DH = V_PF_QS.DH And
                   FHZK = V_PF_QS.FHZK And NVL(FHFS, 'SS') = NVL(V_PF_QS.FHFS, 'SS') And
                   FHYXJ = V_PF_QS.FHYXJ And DDCZYBH Is Null And
                   NVL(CGYJ, 'SS') = NVL(V_PF_QS.CGYJ, 'SS') And
                   NVL(CGYJ_KH, 'SS') = NVL(V_PF_QS.CGYJ_KH, 'SS');
            If Sql%Notfound Then
                Insert Into T_FHRWB
                    (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL,
                     FHZK, SYLX, ZJXS, DJLY, QSTS, FHFS, DDCZYBH, FYFSH, DJ, cgyj, sdhrq,
                     xszq, qsclfs, fhyxj, cgyj_kh, thl, PHBZ, rq)
                    Select ALL_FLOWID.Nextval, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ,
                           XBBZ, DJSL, FHZK, SYLX, ZJXS, DJLY, QSTS, FHFS, '', FYFSH, DJ,
                           cgyj, sdhrq, xszq, QSCLFS, fhyxj, cgyj_kh, 1, PHBZ, rq
                      From T_PF_TEMP_QS_XTW
                     Where FLOWID_FHRW = V_PF_QS.FLOWID_FHRW;
            End If;
            Delete From T_PF_TEMP_QS_XTW
             Where PFCZYBH = P_CZYBH And YSDJH = V_PF_QS.YSDJH And
                   FLOWID_FHRW = V_PF_QS.FLOWID_FHRW;
        End Loop;*/

        /*     INSERT INTO T_FHRWB  (  FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH,DBBZ, XBBZ,DJSL,FHZK,SYLX,ZJXS,DJLY,
        QSTS,  FHFS, DDCZYBH,FYFSH,DJ,cgyj,sdhrq,xszq,qsclfs,fhyxj,cgyj_kh,thl,PHBZ)
        SELECT ALL_FLOWID.NEXTVAL, YSDJH, DH, ID, KFBH, YWBMBH, CYBH,DBBZ, XBBZ,DJSL,FHZK,SYLX,ZJXS,DJLY,
        QSTS,  FHFS, '',FYFSH,DJ,cgyj,sdhrq,xszq,qsclfs,fhyxj,cgyj_kh,thl,PHBZ
        FROM T_PF_TEMP_QS_XTW
        WHERE PFCZYBH = P_CZYBH AND YSDJH = V_PF.YSDJH;*/
        -- 2010-07-15 yangyi:
        -- 恢复占用时, 对于高架库, 不应附加dbbz,xbbz,zl的条件
        -- 因为它可能随时在变化, 否则, 就有可能update不着了
/*        v_bj := -15;
        If Trim(V_PF.HW) = 'GMSAREA' Then
            Update T_LTKF
               Set ZYCS = NVL(ZYCS, 0) - V_PF.DJSL
             Where ID = V_PF.ID And HW = V_PF.HW And KFBH = V_PF.KFBH And
                   YWBMBH = V_PF.YWBMBH And CYBH = V_PF.CYBH;
        Else*/
            Update T_LTKF
               Set ZYCS = NVL(ZYCS, 0) - V_PF.DJSL
             Where ID = V_PF.ID And HW = V_PF.HW And KFBH = V_PF.KFBH And
                   DBBZ = V_PF.DBBZ And XBBZ = V_PF.XBBZ And YWBMBH = V_PF.YWBMBH And
                   ZL = V_PF.ZL And CYBH = V_PF.CYBH;
      --  End If;
        v_bj := -15;
        Update t_kcsl
           Set zycs = nvl(zycs, 0) - v_pf.djsl
         Where ID = V_PF.ID And KFBH = V_PF.KFBH And YWBMBH = V_PF.YWBMBH And
               CYBH = V_PF.CYBH;
    End Loop;
    /*   --将该原始单号的缺书返回任务表(这部分表示取消下达)
    INSERT INTO T_FHRWB  (  FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH,DBBZ, XBBZ,DJSL,FHZK,SYLX,ZJXS,DJLY,
    QSTS,  FHFS, DDCZYBH,FYFSH,DJ,cgyj,sdhrq,xszq,qsclfs,fhyxj,cgyj_kh,thl,PHBZ)
    SELECT ALL_FLOWID.NEXTVAL, YSDJH, DH, ID, KFBH, YWBMBH, CYBH,DBBZ, XBBZ,DJSL,FHZK,SYLX,ZJXS,DJLY,
    QSTS,  FHFS, '',FYFSH,DJ,cgyj,sdhrq,xszq,qsclfs,fhyxj,cgyj_kh,thl,PHBZ
    FROM T_PF_TEMP_QS_XTW
    WHERE PFCZYBH = P_CZYBH \*AND YSDJH = V_PF.YSDJH *\and
    not exists(select * from t_pf_temp where ysdjh = t_pf_temp_qs_xtw.ysdjh );
    DELETE FROM T_PF_TEMP_QS_XTW WHERE PFCZYBH = P_CZYBH \*AND YSDJH = V_PF.YSDJH*\ and
    not exists(select * from t_pf_temp where ysdjh = t_pf_temp_qs_xtw.ysdjh );
    */
    --20110613增加
    --发现xz=0的在t_fhrwb中没有删除掉
    v_bj := -15;
    Delete t_fhrwb
     Where ddczybh = P_CZYBH And
           FLOWID_FHRW In
           (Select FLOWID_FHRW From t_pf_temp Where XZ = 0 And PFCZYBH = P_CZYBH);
    Delete From T_PF_TEMP Where XZ = 0 And PFCZYBH = P_CZYBH;
    v_bj := -16;
    --2011-11-07 modify by lv 将pfczybh插入到rkbh中
    --2011-11-07 modify by lv 为第三方物流修改
   -- t_wl_bmzdj
    Insert Into t_wl_bmzdj
        (ysdjh, ywbmbh, dh, ckbh, rkbh, id, cs, sjkcs, qsclfs, lx, FLOWID, bz, receflag,
         sendbmbh, senddate, recebmbh, zk, djbh_sl)
        Select cgyj, ywbmbh, dh, kfbh, pfczybh, id, djsl, 0, Trim(qsclfs), P_lxbh,
               flowid_fhrw, '调度时库存不足', '0', cybh, Sysdate, ywbmbh, fhzk, ysdjh
          From t_pf_temp_QS_XTW
         Where PFCZYBH = P_CZYBH;
    v_bj := -17;
    Delete From t_pf_temp_qs_xtw Where pfczybh = p_czybh;
    -- 2010-06-25 add by yangyi:
    -- 当调度程序中间环节的第一个窗口T_PF_TEMP无数据,
    -- 第二个窗口t_pf_temp_QS_XTW中有数据时
    -- 可能造成t_fhrwb中出现重复, 故此在这里加删除语句
    If v_rows1 > 0 And v_rows2 = 0 Then
        Delete From t_fhrwb Where ddczybh = p_czybh;
    End If;
    -- end add
    ERRNO   := 0;
    ERRTEXT := 'OK';
    Return;
Exception
    When Others Then
        ERRNO   := Sqlcode;
        ERRTEXT := Sqlerrm || 'PROC_KFZYDD_CANCEL_XTW:' || v_bj;
        Rollback; -- 2010-06-30 new add by yangyi
        Return;
End PROC_KFZYDD_CANCEL_XTW;
create or replace procedure PROC_DYTT(p_bjlsh char, -----------$active$
                                            p_startXh    char, --用来传序号
                                            p_shdw   out varchar2,
                                            p_ghdw   out varchar2,
                                            p_station out varchar2,
                                            p_bjlshout    out varchar2,
                                            p_rqh    out varchar2,
                                            p_tietouAmount out varchar2,
                                            p_bzr out varchar2,
                                            p_zcs out varchar2,
                                            p_yxj out varchar2,
                                            p_jhrq out varchar2,
                                            p_sjlx out varchar2,
                                            errNo    out number,
                                            errText  out char) as
  v_rows   number;
  v_bz      varchar2(500); --备注
  v_jhtask t_jhtask%rowtype;
  v_jhbag t_jhbag%rowtype;

  v_dh char(6);
  v_id_jhtask number;
  v_bj number;
begin

  p_station:='';
  v_bz:='';

  select min(id_jhtask) into v_id_jhtask from t_jhbag where id = p_bjlsh;
  if v_id_jhtask is null then
    errNo   := -1;
    errText := '无此包件信息!';
  end if;
v_bj:=-1;
  select * into v_jhtask from t_jhtask where id = v_id_jhtask;
  v_bj:=-2;
  select * into v_jhbag from t_jhbag where id = p_bjlsh;
  v_bj:=-3;
  select sjlx into p_sjlx from t_jhbag where id = p_bjlsh;
  v_bj:=-4;
  p_rqh:=v_jhtask.rqh;
  p_zcs:=v_jhbag.zcs||'册';
  p_jhrq:=to_char(v_jhbag.jhdate,'yy/mm/dd hh24:mi');
  select  trim(dm) into p_ghdw from t_dm where dh=v_jhtask.ywbmbh;
  select trim(name) into p_bzr from t_user where usr_id=v_jhbag.bzr;
  
    --增加到站
  select count(*) into v_rows from t_dm where dh=v_jhtask.ywbmbh and t_dm.station is not null;
  if v_rows>0 then
      select  trim(mc) into p_station from t_dm,t_station where t_dm.station=t_station.bh and dh=v_jhtask.ywbmbh;
   end if;

/*  if v_jhtask.gkh = 'JT' then
      v_bz := '拒退包件';
  end if;*/

  if v_jhtask.yxj='A' then
    p_yxj:='加急';
  end if;

  p_tietouAmount:= v_jhbag.js;
   if p_startXh is not null and p_startXh>p_tietouAmount then
         errNo   := -2;
         errText := '本包件无此序号！';
          return;
   end if ;

   if  v_jhtask.ywlx = 'FH' then

    select trim(dm) into p_shdw from t_dm where dh=v_jhtask.dh;
   if v_jhtask.isgz='1' or  v_jhtask.isgp='1' then
     select trim(dm) into v_bz from  t_dm d where dh=v_jhtask.zddh;
   else
     if v_jhtask.ddcdbj='1' then
       v_bz:=v_bz||v_jhtask.zb;
     end if;

   end if;


   elsif v_jhtask.ywlx ='ST'  then
        select   trim(mc) into p_shdw from t_ghdw where bh=v_jhtask.dh;

   elsif v_jhtask.ywlx  = 'BF' then


         select   trim(dm) into p_shdw from t_dm where dh=v_jhtask.dh;

   end if ;

   if v_jhbag.sjlx='JT' then
     v_bz:=v_bz||'拒退';
   end if ;

   p_bjlshout:=p_bjlsh;
   if trim(v_bz) is   null then
      p_shdw:=p_shdw;
   else
      p_shdw:=p_shdw||'-'||v_bz;
   end if;



    errNo   := 0;
    errText := 'OK';



exception
  when others then
    ERRNO:=-1;
    ERRTEXT:='PROC_DYTT'||sqlerrm||v_bj;
    rollback;

end PROC_DYTT;
CREATE OR REPLACE Procedure RF_ZPOCCUPY2
(p_line Char,
 p_ysrqh Char,
 p_czybh Char,
 p_gp out varchar2,
 p_flowid out varchar2,
 errno   Out Number,
 errtext Out Varchar) As
    v_rows        Number;

    v_rqh char(10);
     v_id number;

     v_flowid number;
     v_zprwhz t_zprwhz%rowtype;
     v_dmlist varchar2(4000);
Begin



   select min(rqh) into v_rqh from t_zprwhz where ZPCZY=p_czybh and finished='0';
   if v_rqh is not null then
       errno   := -1;
       errtext := '还有箱号'||trim(v_rqh)||'的任务未完成';
      return;
   end if;

   select min(tableid) into v_flowid from t_rqzy where tbname='t_zprwhz' and bh=p_ysrqh;
   if v_flowid is null then
       errno   := -2;
       errtext := '箱子没有播撒任务！';
       Return;

   end if ;

   select * into v_zprwhz from t_zprwhz where flowid=v_flowid;

   if v_zprwhz.line<>p_line then
      errno:= -2;
      errtext := '该箱子是'||v_zprwhz.line||'播撒线的任务';
      return;
   end if;

   if v_zprwhz.finished='1' then

     errno   := -2;
     errtext := '该箱子的任务已经完成';
     Return;
   end if ;

   if v_zprwhz.zt='1' then

     errno   := -2;
     errtext := '该箱子已被'|| v_zprwhz.zpczyname||'占用';
     Return;
   end if ;


   select listagg(trim(dm), ',') within Group(Order By Null) into v_dmlist
   from  t_zprw t,t_dm d where id_zprwhz=v_flowid
   and not exists (select 1 from t_line_zp_hw2 where zpzxid=t.jhzxid and line=t.ln_zp_no)
   and t.zddh=d.dh ;
   if v_dmlist is not null then
     errno   := -1;
     errtext := v_dmlist||'没有在播撒线绑定货位!';
     Return;
   end if;

   Update t_zprw  t Set zpczybh = p_czybh,ln_zp_hw=(
   select  hw from t_line_zp_hw2 where zpzxid=t.jhzxid and line=t.ln_zp_no)

   Where  id_zprwhz=v_zprwhz.flowid;


   update t_zprwhz set zt='1' ,exedate=sysdate,zpczy= p_czybh ,
   zpczyname=(select trim(name) from t_user where usr_id=p_czybh)
    where flowid=v_flowid;
   if sql%notfound then
        errno   := -1;
        errtext := '占用任务失败';
        rollback;
        Return;
   end if;

  update t_flrqh set zt_qx='1' where flqx='ZP' and flowid_qx=v_flowid and zt_qx='0' ;
   p_gp:=v_zprwhz.isgp;
   p_flowid:=v_flowid;

    errno   := 0;
    errtext := 'OK';
Exception
    When Others Then
        errno   := Sqlcode;
        errtext := Sqlerrm;
        rollback;
End;
CREATE OR REPLACE Procedure PROC_GOO_DHLR_YX_DJTJ_LV(as_flowid_dj In Number,
                                                     as_errcode   Out Number,
                                                     as_errtext   Out Varchar2) Is
    tmpVar  Number;
    v_fjw   Char(3);
    v_id    Char(18);
    v_zjxs  Number;
    v_sys   Number;
    v_thzq  Number;
    v_dhpch Char(12);
    v_dhdj  tmp_dhdj%Rowtype;
    v_hqbh  Char(4);
    v_hw    Char(20);
    v_zpz   Number;
    v_zcs   Number;
    v_zmy   Number;
    v_zsy   Number;
    v_qssl  Number;
    v_qsmy  Number;
    v_qssy  Number;
    v_zl    Number;
    v_bj    Number;
    v_rows  Number;
    v_hqmc varchar2(100);
    v_idpmsjhz number;
    /******************************************************************************
    NAME:       PROC_GOO_DHLR_YX_DJTJ_LV
    PURPOSE:    音像到货单据形成并增加库存、传输给商流

    REVISIONS:
    Ver        Date        Author           Description
    ---------  ----------  ---------------  ------------------------------------
    1.0        2011/11/1          1. Created this procedure.

    NOTES:

    Automatically available Auto Replace Keywords:
    Object Name:     PROC_GOO_DHLR_YX_DJTJ_LV
    Sysdate:         2011/11/1
    Date and Time:   2011/11/1, 12:57:56, and 2011/11/1 12:57:56
    Username:         (set in TOAD Options, Procedure Editor)
    Table Name:       (set in the "New PL/SQL Object" dialog)

    ******************************************************************************/

    -- 2017-01-17 yangyi: 新增处理：下边两处：
    --
    -- 因为音像类部门的到货不参与到货分书，直接上架，
    -- 所以在循环tmp_dhmx中，将音像类部门的t_sl_yfsj(到货分书结果)转入物流的t_fhrwb
    -- 最后，将 t_sl_yfsj 备份到t_sl_yfsj_bak中了

Begin

    tmpVar := 0;
    v_bj   := 1;
    Select Count(*) Into tmpVar From tmp_dhmx Where flowid_dj = as_flowid_dj;
    If tmpVar > 0 Then

        Select * Into v_dhdj From tmp_dhdj Where flowid_dj = as_flowid_dj;

        -- 生成到货调拨批次号:
        dlgetlsh(v_dhdj.cybh, v_dhdj.kfbh, 'DH', v_dhpch);
        If v_dhpch Is Null Then
            as_errcode := -1;
            as_errtext := 'PROC_GOO_DHLR_YX_DJTJ_YY 生成到货批次号错误!';
            Rollback;
            Return;
        End If;

        -- 循环单据明细, 生成正式到货数据:
        For c1 In (Select * From tmp_dhmx Where flowid_dj = as_flowid_dj)
        Loop

-- 因为发现有些品种，不知何原因，在业务审批后，物流的书名又变了，
-- 改成为其它ID了，为避免此种情况，改为下述方式了：
-- 2016-04-18 yangyi: 屏蔽了下边的语句，
/*            -- 生成书目信息:
            proc_getid_yangyi(c1.isbn, c1.sm, c1.dj, c1.zt, c1.wz, '01', 9999,
                              v_dhdj.ywbmbh, c1.fl, c1.bc, v_id1, as_errcode, as_errtext);
            If as_errcode <> 0 Then
                Rollback;
                Return;
            End If;
            v_fjw := substr(v_id1, 1, 3);
            v_id  := substr(v_id1, 4);
*/
----------------------------------------------------------------------------
-- 2016-04-18 yangyi: 增加了下边的语句，
            Select id
              Into v_id
              From tmp_dhmx_kcsm@c_link_wl_sl
             Where flowid_dhmx = c1.flowid_dhmx;

            Select fjw Into v_fjw From t_kcsm@c_link_wl_ex Where id=v_id;
-----------------------------------------------------------------------------


---2017-01-17 add by yangyi:
-- 因为音像类部门的到货不参与到货分书，直接上架，
-- 所以需要将音像类部门的t_sl_yfsj(到货分书结果)转入物流的t_fhrwb
            Insert Into t_fhrwb
                (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl,
                 fhzk, sylx, zjxs, djly, qsts, QSCLFS, FYFSH, FHFS, DJ, KJXBJ, FHYXJ,
                 QSDS, RQ, sdhrq, yxrq, cgyj, cgyj_kh, thl, bdbj, phbz,zddh)
                Select all_flowid.Nextval /*flowid_yfsj*/,
                       (Select Min(tdpch)
                           From t_dpls
                          Where dbdh =
                                substrb(Trim(t_sl_yfsj.ysdjh) || '            ', 1, 12)),
                       dh, v_id, v_dhdj.kfbh, v_dhdj.ywbmbh, v_dhdj.cybh, c1.dbbz,
                       c1.xbbz, (nvl(yfsl, 0) - nvl(YQBZQCS, 0)), fhzk, sylx,
                       decode(sylx,'0',c1.dj,100), djly, 0, qsclfs, nvl(tihfs, '01'), nvl(tihfs, '01'),
                       c1.dj, '1', YXJ, 0, Sysdate, SDHRQ, (Sysdate + 30), ysdjh,
                       CGYJ_KH, THL,
                       (Select nvl(t_dpls.spbj, '0')
                           From t_dpls
                          Where dbdh =
                                substrb(Trim(t_sl_yfsj.ysdjh) || '            ', 1, 12)),
                       (Select t_dpls.note_gp
                           From t_dpls
                          Where dbdh =
                                substrb(Trim(t_sl_yfsj.ysdjh) || '            ', 1, 12)),nvl(zddh,dh)
                  From t_sl_yfsj
                 Where flowid = c1.flowid_dhmx And nvl(yfsl, 0) - nvl(YQBZQCS, 0) > 0;
---- end add

            --------------------------------------------------------------------
            -- 2013-05-09 add by yangyi:
            -- 先拦挡一下物流生成新ID的情况:

            -- 2015-08-26 yangyi: 改为所有部门的ID都从商流取得了!!!!
            --select count(*) into v_rows from t_dm
            --   where dh=trim(v_dhdj.ywbmbh) and lxbh='1' and kflx='TS';
            --If v_rows>0 Then
                Select Count(*) Into v_rows From t_kcsm@c_link_wl_ex Where id = v_id;
                If v_rows = 0 Then
                    as_errcode := -1;
                    as_errtext := '商流无此ID!--' || v_id;
                    Rollback;
                    Return;
                End If;
            --End If;
            --------------------------------------------------------------------

            Update tmp_dhmx Set id = v_id Where flowid_dhmx = c1.flowid_dhmx;
            proc_write_id_xtw(c1.flowid_dhmx, v_dhdj.ywbmbh, '', 120, v_fjw, v_id,
                              as_errcode, as_errtext);
            If as_errcode <> 0 Then
                Rollback;
                Return;
            End If;
            -- 2012-03-13 add by lvbin:
            -- 根据赵宣请示后的意思
            -- 根据海燕意思，图书取库存书目的重量，不再取到货录入的重量
            v_bj := 2;
            Select zl Into v_zl From t_kcsm Where id = v_id;
            v_bj := 3;
            Update tmp_dhmx Set zl = v_zl Where flowid_dhmx = c1.flowid_dhmx;
            --end add
            v_bj := 4;
            -- 写t_dhls_jx:
            If c1.sylx = '0' Then
                v_zjxs := c1.dj;
            Else
                v_zjxs := 100;
            End If;
            v_sys := round(c1.djshsl * v_zjxs * c1.jhzk / 100, 2);
            If c1.jzjtrq Is Null Then
                Select nvl(Min(sys_value), 180)
                  Into v_thzq
                  From t_sysset
                 Where sys_item = 'THZQ' And sys_ywbmbh = v_dhdj.ywbmbh;
                Select (Sysdate + v_thzq) Into c1.jzjtrq From dual;
            End If;
            -- 2011-11-21 yangyi:
            -- 改为将进项税率 v_dhdj.sl 写入t_dhls_jx
            Insert Into t_dhls_jx
                (flowid_dj, flowid_dhmx, id, cybh, ywbmbh, ghdwh, kfbh, ysdj, ysrq, chych,
                 flowid_tldjhz, thdh, yh, sl, jhfs, lsdzjhbj, lsddh, sylx, jhzk, fhzk,
                 dbbz, xbbz, mkzl, yssl, djshsl, pssl, yjrq, cqjtbl, xszq, remark, lrczybh,
                 oklrrq, shczybh, shqrrq, shrq, dhpch, zjxs, flowid, sys, jzjtrq)
            Values
                (c1.flowid_dj, c1.flowid_dhmx, v_id, v_dhdj.cybh, v_dhdj.ywbmbh,
                 v_dhdj.ghdwh, v_dhdj.kfbh, v_dhdj.ysdj, v_dhdj.ysrq, '', Null,
                 v_dhdj.thdh, v_dhdj.yh, v_dhdj.sl, nvl(c1.jhfs, '01'), v_dhdj.lsdzjhbj,
                 v_dhdj.lsddh, c1.sylx, c1.jhzk, c1.fhzk, c1.dbbz, c1.xbbz, c1.mkzl,
                 c1.yssl, c1.djshsl, c1.pssl, c1.yjrq, c1.cqjtbl, c1.xszq, c1.remark,
                 c1.lrczybh, Sysdate, v_dhdj.lrqrzyczybh, Sysdate, Sysdate, v_dhpch,
                 v_zjxs, c1.flowid_dhmx, v_sys, c1.jzjtrq);
            If c1.djshsl > 0 Then
                -- 写一笔t_crkls的到货入库记录:
                -- 2011-11-21 yangyi:
                -- 改为将进项税率 v_dhdj.sl 写入t_crkls
                Insert Into t_crkls
                    (FLOWID_CRKLS, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH,
                     ID, CRKCS, CRKSY, SYLX, ZK_JG, ZJXS, DBBZ, XBBZ, SN_CRKCS, SN_CRKSY,
                     FGBJ, SL, flowid_wl, pk)
                Values
                    (c1.flowid_dhmx, v_dhpch, v_dhpch, Sysdate, 'DH', v_dhdj.kfbh,
                     v_dhdj.ghdwh, v_dhdj.cybh, v_dhdj.ywbmbh, v_id, c1.djshsl, v_sys,
                     c1.sylx, c1.jhzk, v_zjxs, c1.dbbz, c1.xbbz, 0, 0, '0', v_dhdj.sl,
                     c1.flowid_dhmx, c1.flowid_dhmx);
                -- 写t_kcsl:
                Update t_kcsl
                   Set kccs = nvl(kccs, 0) + c1.djshsl
                 Where id = v_id And kfbh = v_dhdj.kfbh And ywbmbh = v_dhdj.ywbmbh;
                If Sql%Notfound Then
                    Insert Into t_kcsl
                        (id, kfbh, ywbmbh, kccs, cybh, dbbz, xbbz, zycs, change)
                    Values
                        (v_id, v_dhdj.kfbh, v_dhdj.ywbmbh, c1.djshsl, v_dhdj.cybh,
                         c1.dbbz, c1.xbbz, 0, '1');
                End If;
                -- 用tmp_dhmx.hw来保存上架货区编号:
                -- 在录入明细的过程中, 已经取得了相应的货区
                -- 并对容器的合法性已经进行了验证
          /*      v_hqbh := substr(c1.hw, 1, 4);
                -- 在相应的货区内找原货位:
                Select Min(t_ltkf.hw)
                  Into v_hw
                  From t_ltkf, t_hwdy
                 Where t_ltkf.hw = t_hwdy.hw And t_hwdy.hqbh = v_hqbh And
                       t_ltkf.id = v_id And t_ltkf.kfbh = v_dhdj.kfbh And
                       t_ltkf.dbbz = c1.dbbz And t_ltkf.xbbz = c1.xbbz And
                       t_ltkf.zl = c1.zl And t_ltkf.ywbmbh = v_dhdj.ywbmbh;*/
                -- 写t_pmsjrwb:
                PROC_GET_HQBH3(c1.djshsl  ,
                     'DH'    ,
                     v_id      ,
                     c1.dbbz    ,
                     c1.xbbz    ,

                     v_dhdj.ywbmbh  ,
                     v_dhdj.cybh    ,
                     v_hqbh      ,
                     v_hqmc      ,
                     v_hw        ,
                     as_errcode       ,
                     as_errtext     );
                       if as_errcode<>0 then
                          rollback;
                          return;
                       end if;
             select min(flowid) into v_idpmsjhz from t_pmsjhz  where rqh=c1.tph and finished='0';
               if v_idpmsjhz is null then
                select  all_flowid.Nextval into v_idpmsjhz from dual;

                insert into t_pmsjhz
                 (flowid, rqh, lxbh, kfbh, ywbmbh, yssl,  zpz, zmy, createczybh, createczyname,hqbh)
                 values
                 (v_idpmsjhz, trim(c1.tph) , 'DH', v_dhdj.kfbh, v_dhdj.ywbmbh, 0, 0, 0, c1.lrczybh,
                 (select trim(name) from t_user where usr_id=c1.lrczybh),
                v_hqbh) ;

                 insert into t_rqzy
                    (bh, zydate, czy, tbname, tableid, note,QX,zylx)
                    values(   trim(c1.tph), sysdate, null, 't_pmsjhz',
                      v_idpmsjhz, '货区'||trim(v_hqbh) ||'上架任务','KFSJ','s');
               end if ;

                Insert Into t_pmsjrwb
                    (flowid_sj, id, kfbh, cybh, ywbmbh, hqbh, tm, lxbh, sjfs, yssl,
                     dh, dbbz, xbbz, sjsl,  zckf,  ysczybh, zl,
                     hwh, pk,id_pmsjhz)
                Values
                    (c1.flowid_dhmx, v_id, v_dhdj.kfbh, v_dhdj.cybh, v_dhdj.ywbmbh,
                    v_hqbh, Trim(c1.tph), 'DH', 'ZD', c1.djshsl,  v_dhdj.kfbh,
                     c1.dbbz, c1.xbbz, 0,   v_dhdj.kfbh,
                      c1.lrczybh, v_zl, v_hw, c1.flowid_dhmx,v_idpmsjhz);

             update t_pmsjhz a set yssl=yssl+ c1.djshsl,zmy=zmy+  c1.djshsl * c1.dj,
             zpz=(select count(distinct id) from t_pmsjrwb where id_pmsjhz=a.flowid)
             where  flowid= v_idpmsjhz;
            End If;
        End Loop;
        -- 写t_dhdj表:
        Select Count(*), Sum(t_dhls_jx.djshsl), Sum(t_dhls_jx.djshsl * t_kcsm.dj),
               Sum(t_dhls_jx.sys), Sum(t_dhls_jx.yssl - t_dhls_jx.djshsl),
               Sum((t_dhls_jx.yssl - t_dhls_jx.djshsl) * t_kcsm.dj),
               Sum(round((t_dhls_jx.yssl - t_dhls_jx.djshsl) * t_dhls_jx.zjxs *
                          t_dhls_jx.jhzk / 100, 2))
          Into v_zpz, v_zcs, v_zmy, v_zsy, v_qssl, v_qsmy, v_qssy
          From t_dhls_jx, t_kcsm
         Where t_kcsm.id = t_dhls_jx.id And t_dhls_jx.flowid_dj = as_flowid_dj;
        -- 2011-11-21 yangyi:
        -- 单据头增加写税率(tmp_dhdj.sl)
        --2011-12-31 modify by lv 增加flowid_tldjhz 运号删除使用

        Insert Into t_dhdj
            (flowid_dj, dhpch, ghdwh, ysdj, ysrq, dbrq, zpz, zcs, zmy, zsy, qssl, qsmy,
             qssy, ywbmbh, kfbh, dhdjlsh, chk_czybh, yh, remark, flowid_dj_ys, cybh, ysbbj,
             js, sl)
        Values
            (as_flowid_dj, v_dhpch, v_dhdj.ghdwh, v_dhdj.ysdj, v_dhdj.ysrq, Sysdate,
             v_zpz, v_zcs, v_zmy, v_zsy, v_qssl, v_qsmy, v_qssy, v_dhdj.ywbmbh,
             v_dhdj.kfbh, v_dhdj.flowid_tldjhz, v_dhdj.lrqrzyczybh, v_dhdj.yh,
             v_dhdj.remark, as_flowid_dj, v_dhdj.cybh, '0', v_dhdj.zjs, v_dhdj.sl);
        -- 写t_wl_sjdhsj_hz上报商流:

        Insert Into t_wl_sjdhsj_hz
            (flowid_dj, jls, sendbmbh, recebmbh, receflag, senddate, djrq)
            Select flowid_dj, v_zpz, cybh, ywbmbh, '0', Sysdate, oklrrq
              From tmp_dhdj
             Where flowid_dj = as_flowid_dj;
        -- 2011-11-21 ADD BY YANGYI:
        -- 形成音像到货数据后，直接删除临时表数据
        Insert Into tmp_dhmx_xtw
            Select * From tmp_dhmx Where flowid_dj = as_flowid_dj;
        Insert Into tmp_dhdj_xtw
            Select * From tmp_dhdj Where flowid_dj = as_flowid_dj;
        Delete From tmp_dhmx Where flowid_dj = as_flowid_dj;
        Delete From tmp_dhdj Where flowid_dj = as_flowid_dj;

        -----------------------------------------------------------
        -- 2017-01-17 add by yangyi:
        Insert Into t_sl_yfsj_bak
            Select * From t_sl_yfsj Where flowid_dj = as_flowid_dj;
        Delete From t_sl_yfsj Where flowid_dj = as_flowid_dj;
        -----------------------------------------------------------
        delete t_rqzy where tbname='tmp_dhdj' and tableid=as_flowid_dj;
    Else
        Update tmp_dhdj
           Set note = 'PROC_GOO_DHLR_YX_DJTJ_LV过程没有发现数据'
         Where flowid_dj = as_flowid_dj;
    End If;
    as_errcode := 0;
    as_errtext := '';
Exception
    When Others Then
        as_errcode := Sqlcode;
        as_errtext := 'PROC_GOO_DHLR_YX_DJTJ_LV'||as_errtext|| Sqlerrm || ',' || as_flowid_dj || ',' || v_id || ',' || v_bj;
        -- 2014-04-18 add by yangyi:
        Rollback;
        -------------------------------
End PROC_GOO_DHLR_YX_DJTJ_LV;

CREATE OR REPLACE Procedure PROC_SX_FHXTST_GZ_YY

    -- 2015-08-05 yangyi:
    -- 本过程是从PROC_SX_FHXTST_GZ_XTW中复制过来的，专门为商流更正时调用的
    -- 原来商流发货发退进退更正处理调用的是PROC_SX_FHXTST_GZ_XTW过程
    -- 但由于商流是通过数据链方式调用的，所以，被调用的过程中不能出现rollback和commit语句
    -- 为此，特意编制了这个过程，将原过程中的rollback和commit语句全部屏蔽了
    --
    --这个过程是更正存储过程，作用于：销售发货更正、货源退货更正、客户退货更正
    -- 2011-11-18 升级
    -- 2010-09-23 YANGYI 最新修改
    -- 该过程处理原则如下:
    --
    -- 1. 入口的p_ywpch应该是要更正的单据号, 而不是包件号
    --
    -- 2. 对于出库类的更正, 如果 更正后>更正前数量
    --    对于入库类的更正, 如果 更正后<更正前数量
    --    都将自动生成正式的收益数据, 即正SY, 使得库存保持不变
    --    这部分差异数据将写入t_wl_bssj上报商流, 用于商流增加库存
    --    更正后的数据都是冲减出库的, 因此, 最终商流库存是不变的.
    --
    -- 3. 对于出库类的更正, 如果 更正后<更正前数量
    --    对于入库类的更正, 如果 更正后>更正前数量
    --    则将自动生成负的差异数据, 即负CY, 使得库存保持不变
    --
    --    此类差异数据, 将写入t_sy_jh表, 用于后期物流做差异匹配
    --    同时, 这部分差异数据将写入t_bsjh_lsb上报商流, 以作为商流的库存占用
    --
    -- 4. 更正的原则: 首先将原记录的更正标记置为1
    --                按原记录的负值写一笔负记录, 其更正标记=1
    --                按更正后的数据写一笔正记录, 其更正标记=0
    --
    --        不论是物流更正还是商流更正, 都先生成更正计划写入表中, 然后调物流
    --    的这个过程, 生成更正数据.
    --
    -- 5. 对于货源退货更正, 如果更正前后有差异, 需要做退货库的转出和备货库的转入
    --    然后根据差异数, 按储备库的差异/损益写入t_crkls
    --
    -- 6. 顺便说一下到货更正:
    --    如果到货往少了更, 则生成正差益(CY), 库存不变，
    --    如果到货往多了更, 则直接增加库存.
    --    到货更正生成的正差异不上报商流, 只有定期将其转换为损益后才上报商流.
    --
    -- 7. 物流做更正时, 将更正计划写到T_SL_GZJH_MX中后, 直接调本过程.
    --    商流做更正时, 也将更正计划写到T_SL_GZJH_MX中后, 通过链接方式调用本过程.
    --
    -- 8. t_sl_gzjh_hz增加店号字段, 主要为确保发货更正单据的唯一性
    --    T_SL_GZJH_MX增加店号字段
    --    相应地 t_sl_gzjh_hz_bak, t_sl_gzjh_mx_bak 也增加店号字段
    --           T_WL_GZJG_mx_TEMP, T_WL_GZJG_mx 也增加店号字段
    --           t_wl_gzjg_hz 也增加店号字段
    --
    --!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    -- 9. 2010-11-17 yangyi: 再次重申：
    --    t_bsjh_lsb 中存放的是物流要上报商流的差异数据，正数表示“损”，负数表示“益”
    --    与物流t_crkls中差异数的写法正好相反
    --    商流在接收差异计划时，正数(表示“损”)直接插入，负数用来冲抵商流已有的只是将上报的数据与已有的差异计划进行冲抵，只影响库存占用数
    --
    --    t_wl_bssj 中存放的是物流要上报商流的正式报损/报益数据，正数表示"益"。负数表示"损"
    --    与物流t_crkls中损益数的写法一致
    --!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    --
    --    商流更正时, 需要调此过程
    --    物流更正时, 需要调此过程
    --    销货店收货差异,自动更正程序需要调这个过程
    --
    -- 2012-10-06 yangyi:做了如下修改：
    -- 由于下边几个数据表，是在交换区存放的，
    -- 而物流与交换区不在同一个实例中，因此，统一改为通过链的方式来进行数据的读取和写入
    -- t_sl_gzjh_hz/t_sl_gzjh_mx/
    -- t_wl_gzjg_hz/t_wl_gzjg_mx/t_wl_gzjg_mx_temp/
    -- 发货更正时，在t_wl_gzjg_mx更正结果中标明了哪些是门店差异更正，哪些是总部主动更正的
    -- t_wl_gzjg_mx、t_wl_gzjg_mx_temp 中新增字段gzlx char(1)
    --
    -- 对于更正所产生的差异记录，在写t_crkls时，增加两个字段
    -- t_crkls中，新增字段cylx char(2), DH/FH/ST/FT/PK --- 更正类型，用于表示是哪类更正引起的差异
    -- t_crkls中，新增字段gzmxkey char(12), 用于记录被更正记录的主键，-- 用于记录被更正记录的主键
    --            到货更正时，gzmxkey=t_dhls_jx.flowid_dhmx
    --            退货更正时，gzmxkey=t_hythmx.flowid
    --            发货更正时，gzmxkey=t_fhmx.dbdh
    --            发退更正时，gzmxkey=t_khthmx.flowid
(p_ywpch  Char, -- 被更正单号
 p_cybh   Char, -- 单据所在储运
 p_ywbmbh Char, -- 业务部门编号
 p_gzlx   Char, -- 更正类型，FH=发货更正,ST=货源退货更正,XT=客户退货更正
 p_gzczy  Char, -- 2011-02-16 yangyi 更正操作员编号为‘sl’，表示是连锁店接到货差异更正
 -- 将这个值写入t_fhmx.cspc中了，用于区别是差异更正的
 p_dh    Char, -- 新增店号字段, 为确保发货单据的唯一性
 errno   Out Number,
 errtext Out Varchar) As
    v_kfbh Char(6);
    --    s_bjlsh        Char(12);
    --    s_bjlsh_hy     Char(12);
    --    s_ywpch        Char(12);
    --    s_ywpch_hy     Char(12);
    d_flowid       Number;
    s_id           Char(18);
    l_count        Number;
    S_dbdh         Char(12);
    l_yssl         Number;
    D_FHZK_YS      Number;
    S_DH_YS        Char(30);
    ls_dbdh_new    Char(12);
    d_cysy_old     Number;
    d_cysy_new     Number;
    ldc_new_flowid Number;
    --    s_ywpch_ghhy   Char(12);
    --    s_bjlsh_ghhy   Char(12);
    s_crkls_lx   Char(12);
    s_wl_jsdh    Char(6);
    l_cys        Number;
    --ls_zypch     Char(12);
    d_dbbz       Number;
    d_xbbz       Number;
    S_YWPCH_SY   Char(12);
    s_dh_1212    Char(6);
    d_crkls      Number;
    v_tsbj       Char(1);
  --  v_ysthrq     Date;
    v_lsdbj      Char(1);
    v_khlxbh     Char(2);
    v_dh         Char(6);
    v_jl         Number;
    s_zdbj       Char(1);
    l_count_sl   Number;
    d_bs_flowid  Number;
    v_djbh       Char(12);
    v_rows       Number;
    v_cys        Number;
    v_zpz        Number;
    v_zcs        Number;
    v_zmy        Number;
    v_zsy        Number;
    v_bj         Number;
    v_curr_bjlsh Char(12);
    v_curr_ywpch Char(12);
    v_currsl     Number;
    ld_zl        Number;
    ls_zfzd      Char(1);
    tmpVar       Number;
    ls_thkf      t_dm.dh%Type;
    tmp3f        Number;
    v_gzkf       t_dm.dh%Type;
    v_newdh1     Char(6);
    v_dh1        Char(6);
    v_bz         Char(30);
    -- 2013-08-10 yangyi: 为更正sylx
    v_id_new     Char(18);
    v_zjxs_new   Number;
    v_sylx_new   Char(1);
    v_flowid_djh number;

Begin

    ls_zfzd := '0';
    v_bj    := -1;
    Select Min(nvl(zdbj, '0'))
      Into s_zdbj
      From t_sl_gzjh_hz@C_LINK_WL_EX
     Where Trim(gzjhdh) = Trim(p_ywpch);
    Select Min(dh) Into v_kfbh From t_dm Where kflx = 'LK' And LXBH = '2';
    Select Count(*) Into tmp3f From t_dm Where dh = p_ywbmbh And KFLX='3F';
    If tmp3f > 0 Then
        --第三方标记
        tmp3f := 1;
    End If;
    -- 2011-04-11 yangyi:
    -- 在生成单据号之前先循环判断一下合法性，然后再执行更正处理
    -- 否则会浪费很多包件流水号：
    For c10 In (Select *
                  From T_SL_GZJH_MX@C_LINK_WL_EX
                 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
    Loop
        ---校验数据表里是否有该单据
        If p_gzlx = 'FH' Then
            s_dbdh := Trim(c10.dbdh);
            Select Count(*)
              Into l_count
              From t_fhmx
             Where DBDH = s_dbdh And NVL(GZBJ, '0') <> '1';
            If l_count < 1 Then
                ERRNO   := -13;
                ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
                           s_dbdh;
                --Rollback;
                Return;
            End If;
        End If;
        If p_GZLX = 'ST' Then
            Select to_number(c10.dbdh) Into d_flowid From dual;
            Select Count(*)
              Into l_count
              From t_hythmx
             Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
            If l_count < 1 Then
                ERRNO   := -131;
                ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
                           d_flowid;
                --Rollback;
                Return;
            End If;
        End If;
        If p_gzlx = 'XT' Then
            Select to_number(c10.dbdh) Into d_flowid From dual;
            Select Count(*)
              Into l_count
              From t_khthmx
             Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
            If l_count < 1 Then
                ERRNO   := -132;
                ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
                           d_flowid;
                --Rollback;
                Return;
            End If;
        End If;
    End Loop;

    ------------校验结束-------------------------------
    If p_gzlx = 'FH' Then

        -- 在连锁店接到货之前, 总部不允许对该发货单据做发货更正:
        v_djbh := Trim(p_ywpch);

        Select Count(*)
          Into v_rows
          From t_fhhz@c_link_wl_sl
         Where pfpch = v_djbh And dh = p_dh;
        If v_rows = 0 Then
            --Rollback;
            errno   := -1;
            errtext := '该单据还没有上报到商流,暂不能做更正!' || v_djbh;
            Return;
        End If;
        Select Count(*)
          Into v_rows
          From t_fhhz@c_link_wl_sl a
         Where pfpch = v_djbh And dh = p_dh And nvl(get_sjsh, '0') = '0' And Not Exists
         (Select 1 From t_fhmx Where pfpch = a.pfpch And nvl(gzbj, '0') = '1');
        If v_rows > 0 Then
            --Rollback;
            errno   := -1;
            errtext := '该单据连锁店还没有收到货,暂不能做更正!' || v_djbh;
            Return;
        End If;
        /*        -- 有可能出现换户更正, 所以生成了两套号码
        -- 如果不是换户更正, 则更正后单据只用一套单号;
        -- 如果是换户更正, 则更正后单据就要分成两张单了;
        -- 下边的退货更正/销退更正都是一样道理
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh From dual;
        dlgetlsh(p_ywbmbh, 'XS', 'XS', S_YWPCH);
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh_hy From dual;
        dlgetlsh(p_ywbmbh, 'XS', 'XS', s_ywpch_hy);
        */
        -- 对于newsl为空的记录，取得原记录的税率：
        For c_djh0 In (Select *
                         From T_SL_GZJH_MX@C_LINK_WL_EX
                        Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And newsl Is Null)
        Loop
            s_dbdh := c_djh0.dbdh;
            Select sl Into v_currsl From t_fhmx Where dbdh = s_dbdh;
            Update T_SL_GZJH_MX@C_LINK_WL_EX
               Set newsl = v_currsl
             Where dbdh = c_djh0.dbdh And Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
        End Loop;
        -- 2012-12-18 yangyi:
        -- 换户更正时，新店将按正常到货验货，而同帮系统不允许单号内有字母，
        -- 所以，新店的发货单号改为按正常规则生成：

        -- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
        select flowid_T_TMP_GZDJH.nextval into v_flowid_djh from dual;

        --Delete From tm_gzdjh;

        For c_djh1 In (Select Distinct newdh, newsl
                         From T_SL_GZJH_MX@C_LINK_WL_EX
                        Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
        Loop

-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select Count(*)
              Into v_rows
              From tm_gzdjh
             Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl;
*/
            Select Count(*)
              Into v_rows
              From t_tmp_gzdjh
             Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl and flowid=v_flowid_djh;

            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                --dlgetlsh(p_ywbmbh, 'XS', 'XS', v_curr_ywpch);
                v_curr_ywpch := Trim(to_char(c_djh1.newsl)) || Trim(v_curr_bjlsh);

/*                Insert Into tm_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj)
                Values
                    (c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh);
*/
                Insert Into t_tmp_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj, flowid)
                Values
                    (c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh, v_flowid_djh);

            End If;
        End Loop;
        For c_djh2 In (Select Distinct a.dh, a.sl
                         From t_fhmx a, T_SL_GZJH_MX@C_LINK_WL_EX b
                        Where a.dbdh = substrb(Trim(b.dbdh) || '           ', 1, 12) And
                              Not Exists
                        (Select 1 From t_tmp_gzdjh Where ghdwh = a.dh And
                              newsl = a.sl and flowid=v_flowid_djh) And
                              Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh)
        Loop

-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
        /*    Select Count(*)
              Into v_rows
              From tm_gzdjh
             Where ghdwh = c_djh2.dh And newsl = c_djh2.sl;
        */
            Select Count(*)
              Into v_rows
              From t_tmp_gzdjh
             Where ghdwh = c_djh2.dh And newsl = c_djh2.sl and flowid=v_flowid_djh;

            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'XS', 'XS', v_curr_ywpch);

-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*                Insert Into tm_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj)
                Values
                    (c_djh2.dh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh);
*/
                Insert Into t_tmp_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj, flowid)
                Values
                    (c_djh2.dh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh, v_flowid_djh);

            End If;
        End Loop;
    Elsif p_GZLX = 'ST' Then

        /*        dlgetlsh(p_ywbmbh, 'ST', 'ST', s_ywpch);
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh From dual;
        dlgetlsh(p_ywbmbh, 'ST', 'ST', S_YWPCH_HY);
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh_hy From dual;
        */
        -- 对于newsl为空的记录，取得原记录的税率：
        For c_djh0 In (Select *
                         From T_SL_GZJH_MX@C_LINK_WL_EX
                        Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And newsl Is Null)
        Loop
            d_flowid := to_number(c_djh0.dbdh);
            Select sl Into v_currsl From t_hythmx Where flowid = d_flowid;
            Update T_SL_GZJH_MX@C_LINK_WL_EX
               Set newsl = v_currsl
             Where dbdh = c_djh0.dbdh And Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
        End Loop;

        -- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
        select flowid_T_TMP_GZDJH.nextval into v_flowid_djh from dual;

        --Delete From tm_gzdjh;
        For c_djh1 In (Select Distinct newdh, newsl
                         From T_SL_GZJH_MX@C_LINK_WL_EX
                        Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
        Loop

-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select Count(*)
              Into v_rows
              From tm_gzdjh
             Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl;

            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'ST', 'ST', v_curr_ywpch);
                Insert Into tm_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj)
                Values
                    (c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh);
            End If;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select Count(*)
              Into v_rows
              From t_tmp_gzdjh
             Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl and flowid=v_flowid_djh;

            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'ST', 'ST', v_curr_ywpch);
                Insert Into t_tmp_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj, flowid)
                Values
                    (c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh, v_flowid_djh);
            End If;

        End Loop;
        For c_djh2 In (Select Distinct a.hybh, a.sl
                         From T_HYTHMX a, T_SL_GZJH_MX@C_LINK_WL_EX b
                        Where a.FLOWID = to_number(b.dbdh) And Not Exists
                        (Select 1 From t_tmp_gzdjh Where ghdwh = a.hybh And newsl = a.sl and flowid=v_flowid_djh) And
                              Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh)
        Loop

-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select Count(*)
              Into v_rows
              From tm_gzdjh
             Where ghdwh = c_djh2.hybh And newsl = c_djh2.sl;
            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'ST', 'ST', v_curr_ywpch);
                Insert Into tm_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj)
                Values
                    (c_djh2.hybh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh);
            End If;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select Count(*)
              Into v_rows
              From t_tmp_gzdjh
             Where ghdwh = c_djh2.hybh And newsl = c_djh2.sl and flowid=v_flowid_djh;
            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'ST', 'ST', v_curr_ywpch);
                Insert Into t_tmp_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj, flowid)
                Values
                    (c_djh2.hybh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh, v_flowid_djh);
            End If;

        End Loop;
    Else
        /*        dlgetlsh(p_ywbmbh, 'XT', 'XT', s_ywpch);
        dlgetlsh(p_ywbmbh, 'XT', 'XT', s_ywpch_hy);
        */
        -- 对于newsl为空的记录，取得原记录的税率：
        -- 2012-10-06 交换区与物流不在同一实例中，因此改用链接方式读取T_SL_GZJH_MX@C_LINK_WL_EX
        For c_djh0 In (Select *
                         From T_SL_GZJH_MX@C_LINK_WL_EX
                        Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And newsl Is Null)
        Loop
            d_flowid := to_number(c_djh0.dbdh);
            Select sl Into v_currsl From t_khthmx Where flowid = d_flowid;
            Update T_SL_GZJH_MX@C_LINK_WL_EX
               Set newsl = v_currsl
             Where dbdh = c_djh0.dbdh And Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
        End Loop;

        -- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
        select flowid_T_TMP_GZDJH.nextval into v_flowid_djh from dual;

        --Delete From tm_gzdjh;

        For c_djh1 In (Select Distinct newdh, newsl
                         From T_SL_GZJH_MX@C_LINK_WL_EX
                        Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
        Loop
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select Count(*)
              Into v_rows
              From tm_gzdjh
             Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl;
            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'XT', 'XT', v_curr_ywpch);
                Insert Into tm_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj)
                Values
                    (c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh);
            End If;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select Count(*)
              Into v_rows
              From t_tmp_gzdjh
             Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl and flowid=v_flowid_djh;
            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'XT', 'XT', v_curr_ywpch);
                Insert Into t_tmp_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj, flowid)
                Values
                    (c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh, v_flowid_djh);
            End If;

        End Loop;

        /*union
        Select Distinct a.dh,a.sl From t_KHTHMX a, T_SL_GZJH_MX b
        Where a.FLOWID=to_number(b.dbdh) and Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh
        */
        For c_djh2 In (Select Distinct a.dh, a.sl
                         From t_KHTHMX a, T_SL_GZJH_MX@C_LINK_WL_EX b
                        Where a.FLOWID = to_number(b.dbdh) And Not Exists
                        (Select 1 From t_tmp_gzdjh
                           Where ghdwh = a.dh And
                                 newsl = a.sl and flowid=v_flowid_djh) And
                              Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh)
        Loop
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select Count(*)
              Into v_rows
              From tm_gzdjh
             Where ghdwh = c_djh2.dh And newsl = c_djh2.sl;
*/
            Select Count(*)
              Into v_rows
              From t_tmp_gzdjh
             Where ghdwh = c_djh2.dh And newsl = c_djh2.sl and flowid=v_flowid_djh;

            If v_rows = 0 Then
                Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
                dlgetlsh(p_ywbmbh, 'XT', 'XT', v_curr_ywpch);

/*                Insert Into tm_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj)
                Values
                    (c_djh2.dh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh);
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
                Insert Into t_tmp_gzdjh
                    (ghdwh, newsl, ywpch, flowid_dj, flowid)
                Values
                    (c_djh2.dh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh, v_flowid_djh);

            End If;
        End Loop;
    End If;

    v_bj := -123;
    ---对明细进行更正
    For c1 In (Select *
                 From T_SL_GZJH_MX@C_LINK_WL_EX
                Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
    Loop
        s_id   := c1.newid;
        s_dbdh := Trim(c1.dbdh);
        Select dbbz, xbbz Into d_dbbz, d_xbbz From t_kcsm Where id = s_id;
        ---校验数据表里是否有该单据
        If p_gzlx = 'FH' Then
            Select Count(*)
              Into l_count
              From t_fhmx
             Where DBDH = s_dbdh And NVL(GZBJ, '0') <> '1';
            If l_count < 1 Then
                ERRNO   := -13;
                ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
                           s_dbdh;
                --Rollback;
                Return;
            End If;
        End If;
        If p_GZLX = 'ST' Then
            Select to_number(c1.dbdh) Into d_flowid From dual;
            Select Count(*)
              Into l_count
              From t_hythmx
             Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
            If l_count < 1 Then
                ERRNO   := -131;
                ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
                           d_flowid;
                --Rollback;
                Return;
            End If;
        End If;
        If p_gzlx = 'XT' Then
            Select to_number(c1.dbdh) Into d_flowid From dual;
            Select Count(*)
              Into l_count
              From t_khthmx
             Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
            If l_count < 1 Then
                ERRNO   := -132;
                ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch);
                --Rollback;
                Return;
            End If;
        End If;
        ------------校验结束-------------------------------
        --------不管何种更正，都要先插入一个原始记录的负数
        If p_gzlx = 'FH' Then
            errno := -14;
            v_bj := -1231;
            Select SFCS, FHZK, DH, sl
              Into l_yssl, D_FHZK_YS, s_dh_1212, v_currsl
              From t_fhmx
             Where dbdh = s_dbdh; --and nvl(gzbj,'0') <> '1';
            -- 取得托收标记,以便下边程序判断是否写t_fhmx1
            v_bj := -1232;
            Select nvl(tsbj, '0')
              Into v_tsbj
              From t_dm_ywbm
             Where dh = s_dh_1212 And ywbmbh = p_ywbmbh;
            v_bj := -1233;
            -- 原记录置更正标记
            s_dh_ys := s_dh_1212;
            errno   := -15;
            --插入负的发货记录
            Select to_char(all_flowid.Nextval) Into ls_dbdh_new From dual;
            --Select dh,sl Into v_currdh,v_currsl From t_fhmx Where dbdh=s_dbdh;
            v_bj := -1265;
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From tm_gzdjh
             Where ghdwh = s_dh_1212 And newsl = v_currsl;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From t_tmp_gzdjh
             Where ghdwh = s_dh_1212 And newsl = v_currsl and flowid=v_flowid_djh;

            v_bj  := -1266;
            errno := -16;
            -- 2009-12-07 yangyi: 增加 YSPFPCH, ysdbrq, GZDBDH
            -- 2011-02-16 yangyi: 如果是连锁店差异更正，则通过cspc='SL'来表示
            -- 2012-12-26 yangyi: 用zl字段携带直发转单标记
            -- zl: 0=正常、直发=1、补单=3  调剂发货=4，2012-12-27 yangyi
            -- 2013-05-15 yangyi:
            -- 将换户更正的单据备注上标明《换户更正》字样：
            -- 以便门店在接收此张更正单据时，顺便将原单也自动接收到系统当中。
            -- 这种情况的处理只涉及负单，与正单无关，所以只在这里做了处理
            Select newdh, dh
              Into v_newdh1, v_dh1
              From T_SL_GZJH_MX@C_LINK_WL_EX
             Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And rownum = 1;
            If Trim(v_newdh1) <> Trim(v_dh1) Then
                v_bz := '换户更正';
            Else
                v_bz := '';
            End If;
            -------------------------------------------------------------------------
            Insert Into t_fhmx
                (FHFS, BZ, SL, ZJXS, SYLX, SYS, TIHFS, PFPCH, ID, ZDH, DH, SFCS, FHZK,
                 BZJS, YWBMBH, KFBH, BJLSH, HW, DJLY, CBJ, PJZK, dbdh, PFRQ, DBRQ, pfbmbh,
                 fhbmbh, txy, gzbj, ysdbdh, ysbbj, yh, jzthrq, yscs, zzpc, cgyj, cgyj_kh,
                 thl, thcs, YSPFPCH, ysdbrq, gzdbdh, dbbz, xbbz, cspc, zl, pk)
                Select FHFS, nvl(Trim(v_bz), BZ), SL, ZJXS, SYLX, -sys, TIHFS,
                       v_curr_ywpch /*s_ywpch*/, ID, ZDH, DH, -sfcs, FHZK, BZJS, YWBMBH,
                       KFBH, v_curr_bjlsh /*s_bjlsh*/, HW, DJLY, CBJ, PJZK, ls_dbdh_new,
                       Sysdate, Sysdate, pfbmbh, fhbmbh, txy, '1', dbdh, '1', yh, jzthrq,
                       -yscs, zzpc, cgyj, cgyj_kh, thl, -thcs, pfpch, dbrq, dbdh, dbbz,
                       xbbz, upper(p_gzczy), zl, ls_dbdh_new
                  From t_fhmx
                 Where dbdh = s_dbdh;
            Select -sys Into d_cysy_old From t_fhmx Where dbdh = ls_dbdh_new;
            errno := -17;
            Select Max(kfbh) Into v_gzkf From t_fhmx Where dbdh = s_dbdh;
            --2012-12-27 modify by lv 增加直发转单的更正标记
            -- zl: 0=正常、直发=1、补单=3  调剂发货=4，2012-12-27 yangyi
            -- 这个重量标记是在写t_fhmx时置的，一共四个地方：
            -- DBWL.PROC_WRITE_FHMX_XTW(正常/绿通), DBWL.PROC_SX_JSDHSJ_ZFZDCL(直转)
            -- DBSL.PKG_MDTJ.PROC_MAIN(调剂),DBSL.PKG_BFDJ.PROC_OK_DJ(补单)

            Select zl Into ld_zl From t_fhmx Where dbdh = s_dbdh;
            If ld_zl = 1 Then
                ls_zfzd := '1';
            Elsif ld_zl = 2 Then
                ls_zfzd := '2';
            Elsif ld_zl = 3 Then
                ls_zfzd := '3';
            Elsif ld_zl = 4 Then
                ls_zfzd := '4';
            Else
                ls_zfzd := '0';
            End If;

            -- 原记录更正标记置为1
            Update t_fhmx Set gzbj = '1', cspc = 'SL' Where dbdh = s_dbdh;
            errno := -18;
            -- 先记一笔负发货: (t_fhmx_sl中ls_dbdh_new记录内本身就是负数)
            Insert Into t_crkls
                (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
                 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl
                 )
                Select all_flowid.Nextval, id, v_curr_ywpch /*s_ywpch*/, v_curr_ywpch
                       /*s_ywpch*/, Sysdate, 'FH', kfbh, dh, pfbmbh, ywbmbh, sfcs, 'FHGZ',
                       sys, sylx, fhzk, zjxs, 0, 0, 0, 0, sl
                  From t_fhmx
                 Where dbdh = ls_dbdh_new;
            errno := -19;
            ---商流判断时, 如果cs_new < 0 ，则商流在写t_fhmx时，将gzbj ='1'
            -- 2012-10-06 YANGYI: 改为用链的方式读取交换区的表，
            -- 因为交换区与物流可能不在同一个实例中了。
            -- T_WL_GZJG_MX_TEMP@C_LINK_WL_EX 新增了1个字段：gzlx char(1)
            -- 如果是总部发起的发货更正，则为0，如果是门店收货差异生成的更正，则置为1
            Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
                (ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
                 dh, SL_NEW, gzlx)
            Values
                (S_ID, p_ywpch, S_DBDH, LS_DBDH_NEW, v_curr_bjlsh /*S_BJLSH*/, S_DH_YS,
                 -L_YSSL, D_FHZK_YS, v_curr_ywpch /*S_YWPCH*/, p_dh, v_currsl,
                 decode(Trim(upper(p_gzczy)), 'SL', '1', '0'));
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = v_curr_bjlsh /*s_bjlsh*/
            ;
            If v_jl = 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (v_curr_bjlsh /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
        Elsif p_gzlx = 'XT' Then
            errno := -20;
            Select thcs, THZK, DH, sl
              Into l_yssl, D_FHZK_YS, S_DH_YS, v_currsl
              From t_khthmx
             Where flowid = d_flowid;

            Select all_flowid.Nextval Into ldc_new_flowid From dual;
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From tm_gzdjh
             Where ghdwh = S_DH_YS And newsl = v_currsl;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From t_tmp_gzdjh
             Where ghdwh = S_DH_YS And newsl = v_currsl and flowid=v_flowid_djh;

            errno := -21;
            -- 2009-12-07 add by yangyi: ysflowid,ysywpch,yslrrq,gzflowid
            --2013-01-17 modify by lv 山东的退货更正都算到退货库即2002 ，因此在此处写死、
            Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
            If tmpVar < 1 Then
                errno   := -1;
                errtext := '没有设置退货库房!';
                --Rollback;
                Return;
            Else
                Select dh
                  Into ls_thkf
                  From t_dm
                 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
            End If;
            --2013-07-03 modify by lv 为了查询程序日期，需要将lrrq1 用sysdate来填写
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_khthmx
                (fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, tslsh, jspch, clrq, lrrq1, thlx,
                 sylx, zjxs, sl, dh, id, kfbh, ywbmbh, yscs, hw, dfdh, ysdh, dbbz, xbbz,
                 baohao, ysbbj, sb_ftp_pch, sb_ftp_rq, dhpch, ysbbj_kf, pch, bz, flowid,
                 thcs, thzk, gzbj, usr_id, lrrq, sys, cybh, ywpch, ysflowid, ysywpch,
                 yslrrq, gzflowid)
                Select fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, Null, Null, Null, Sysdate,
                       thlx, sylx, zjxs, sl, dh, id, 
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf),
                       ywbmbh, yscs, hw, dfdh, ysdh, dbbz, xbbz, baohao, '1', sb_ftp_pch,
                       sb_ftp_rq, dhpch, ysbbj_kf, v_curr_ywpch /*s_ywpch*/, bz,
                       ldc_new_flowid, -thcs, thzk, '1', p_gzczy, Sysdate, -sys, p_cybh,
                       v_curr_ywpch /*s_ywpch*/, flowid, pch, lrrq, d_flowid
                  From t_khthmx
                 Where flowid = d_flowid;
            Select Max(kfbh) Into v_gzkf From t_khthmx Where flowid = d_flowid;
            errno := -22;
            -- 原记录置更正标记:
            Update t_khthmx Set gzbj = '1' Where flowid = d_flowid;
            -- 按冲账记录写t_crkls:
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_crkls
                (flowid_crkls, ywpch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh, id, crkcs,
                 crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, fgbj, yspch
                 )
                Select all_flowid.Nextval, v_curr_ywpch /*s_ywpch*/, Sysdate, 'XT',
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       dh, p_cybh, ywbmbh, id, thcs, sys,
                       sylx, thzk, zjxs, dbbz, xbbz, thcs, sys, '0', pch
                  From t_khthmx
                 Where flowid = ldc_new_flowid;
            errno := -23;
            Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
                (ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
                 dh, sl_new)
            Values
                (S_ID, p_ywpch, S_DBDH, TO_CHAR(ldc_new_flowid), v_curr_ywpch /*s_ywpch*/,
                 S_DH_YS, -L_YSSL, D_FHZK_YS, v_curr_ywpch /*s_ywpch*/, p_dh, v_currsl);
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = v_curr_ywpch /*s_ywpch*/
            ;
            If v_jl = 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (v_curr_ywpch /*s_ywpch*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
        Else
            --货源退货
            errno := -24;
            Select thcs, thzk, hybh, sl
              Into l_yssl, d_fhzk_ys, s_dh_ys, v_currsl
              From t_hythmx
             Where flowid = d_flowid;
            Select all_flowid.Nextval Into ldc_new_flowid From dual;
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From tm_gzdjh
             Where ghdwh = S_DH_YS And newsl = v_currsl;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From t_tmp_gzdjh
             Where ghdwh = S_DH_YS And newsl = v_currsl and flowid=v_flowid_djh;

            --2013-01-17 modify by lv 山东的退货更正都算到退货库即2002 ，因此在此处写死、
            Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
            If tmpVar < 1 Then
                errno   := -1;
                errtext := '没有设置退货库房!';
                --Rollback;
                Return;
            Else
                Select dh
                  Into ls_thkf
                  From t_dm
                 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
            End If;
            -- 2009-12-07 add by yangyi: 新增YSYWPCH,ysdbrq,ysflowid,gzflowid
            -- 记一笔负退货
            --2014-2-26 modify by 增加p_gzczy
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_hythmx
                (YWPCH, ID, THCS, THZK, DBRQ, SYS, SYLX, ZJXS, HYBH, YWBMBH, FLOWID, sl,
                 kfbh, cybh, gzbj, bjlsh, ysbbj, cgyj, ysywpch, ysdbrq, ysflowid, gzflowid,
                 chych, thlx)
                Select v_curr_ywpch /*s_ywpch*/, ID, -thcs, THZK, Sysdate, -sys, SYLX,
                       ZJXS, HYBH, YWBMBH, ldc_new_flowid, sl,
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       cybh, '1', v_curr_bjlsh /*s_bjlsh*/,
                       '1', cgyj, ywpch, dbrq, flowid, flowid, p_gzczy, thlx
                  From t_hythmx
                 Where flowid = d_flowid And nvl(gzbj, '0') <> '1';
            -- 原记录置更正标记
            Update t_hythmx Set gzbj = '1' Where flowid = d_flowid;
            errno := -25;
            Select Max(kfbh) Into v_gzkf From t_hythmx Where flowid = d_flowid;
            --负退货记录原样复制到t_crkls中:
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_crkls
                (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
                 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl)
                Select flowid, id, ywpch, ywpch, dbrq, 'ST',
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       hybh, cybh, ywbmbh, thcs, 'THGZ',
                       sys, sylx, thzk, zjxs, 0, 0, 0, 0, sl
                  From t_hythmx
                 Where flowid = ldc_new_flowid;
            errno := -26;
            Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
                (ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
                 dh, sl_new)
            Values
                (S_ID, p_ywpch, S_DBDH, TO_CHAR(ldc_new_flowid), v_curr_bjlsh /*s_bjlsh*/,
                 S_DH_YS, -L_YSSL, D_FHZK_YS, v_curr_ywpch /*s_ywpch*/, p_dh, v_currsl);
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = v_curr_bjlsh /*s_bjlsh*/
            ;
            If v_jl = 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (v_curr_bjlsh /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
        End If;
        ------------------插入负数结束------------------------------------------
        /*        errno := -27;
        If Trim(s_dh_ys) <> Trim(c1.newdh) Then
        --更换货源/客户时需要重新起单号
        s_ywpch_ghhy := s_ywpch_hy;
        s_bjlsh_ghhy := s_bjlsh_hy;
        Else
        s_ywpch_ghhy := s_ywpch;
        s_bjlsh_ghhy := s_bjlsh;
        End If;
        */
        errno := -28;
        v_bj  := -124;
        ----插入新记录
        -- 2011-11-14 yangyi: 为处理王文华错报的数据
        -- If c1.newcs >= 0 Then
        -- 2011-12-07 yangyi:  改为即使更正后数量=0 也要插入一条新纪录，否则，就无法再次做更正了
        --
        --If c1.newcs <> 0 Then
        --插入新记录
        If p_gzlx = 'FH' Then
            -- 按更正后数据增加正发货记录
            s_crkls_lx := 'FHGZ';
            errno      := -29;
            Select jsdh, tsbj
              Into s_wl_jsdh, v_tsbj
              From t_dm_ywbm
             Where dh = c1.newdh And ywbmbh = p_ywbmbh;

            Select to_char(all_flowid.Nextval) Into ls_dbdh_new From dual;
            errno := -30;
            -- 若更正后税率为空，表示与原税率一致：
            If c1.newsl Is Null Then
                Select sl Into c1.newsl From t_fhmx Where dbdh = s_dbdh;
            End If;
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From tm_gzdjh
             Where ghdwh = c1.newdh And newsl = c1.newsl;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From t_tmp_gzdjh
             Where ghdwh = c1.newdh And newsl = c1.newsl and flowid=v_flowid_djh;

            -- 2011-02-16 yangyi: 如果是连锁店差异更正，则通过cspc='SL'来表示
            -- 2012-12-26 yangyi: 用zl字段携带直发转单标记
            -- zl: 0=正常、直发=1、补单=3  调剂发货=4，2012-12-27 yangyi
            -- 2013-08-10 yangyi:
            -- 为处理对sylx的更正，若c1.newzk=0.1 且为AD类操作员，则表示更改sylx
            If c1.newzk = 0.1 And substrb(p_gzczy, 1, 2) = 'AD' Then
                -- 表示将sylx从1更为0
                Select decode(sylx, '0', '1', '0'), fhzk, id
                  Into v_sylx_new, c1.newzk, v_id_new
                  From t_fhmx
                 Where dbdh = s_dbdh;
                If v_sylx_new = '0' Then
                    Select dj Into v_zjxs_new From t_kcsm Where id = v_id_new;
                Else
                    v_zjxs_new := 100;
                End If;
            Else
                -- 正常更正处理
                Select zjxs, sylx
                  Into v_zjxs_new, v_sylx_new
                  From t_fhmx
                 Where dbdh = s_dbdh;

 /*                v_sylx_new := c1.newsylx;
                 v_id_new := C1.NEWID;
 								 If v_sylx_new = '0' Then
										Select dj Into v_zjxs_new From t_kcsm Where id = v_id_new;
								 Else
								   v_zjxs_new := 100;
                 end if;
*/

            End If;
            
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            select kfbh into v_gzkf from t_fhmx where dbdh = s_dbdh;
            
            Insert Into t_fhmx
                (FHFS, BZ, SL, ZJXS, SYLX, SYS, TIHFS, PFPCH, ID, ZDH, DH, SFCS, FHZK,
                 BZJS, YWBMBH, KFBH, BJLSH, HW, DJLY, CBJ, PJZK, dbdh, PFRQ, DBRQ, pfbmbh,
                 fhbmbh, txy, gzbj, ysdbdh, ysbbj, yh, jzthrq, yscs, zzpc, cgyj, cgyj_kh,
                 thl, thcs, YSPFPCH, YSDBRQ, dbbz, xbbz, cspc, zl, pk)
                Select FHFS, BZ, c1.newsl, v_zjxs_new /*zjxs*/, v_sylx_new /*sylx*/,
                       round(c1.newcs * v_zjxs_new /*zjxs*/
                              * c1.newzk / 100, 2), TIHFS, v_curr_ywpch, id, ls_dbdh_new,
                       c1.newdh, c1.newcs, c1.newzk, BZJS, YWBMBH, KFBH, v_curr_bjlsh, HW,
                       DJLY, CBJ, PJZK, ls_dbdh_new, Sysdate, Sysdate, pfbmbh, fhbmbh, txy,
                       '0', dbdh, '1', yh, jzthrq, sfcs, s_wl_jsdh, cgyj, cgyj_kh, thl,
                       thcs, PFPCH, DBRQ, dbbz, xbbz, upper(p_gzczy), zl, ls_dbdh_new
                  From t_fhmx
                 Where dbdh = s_dbdh;
            
            Select sys Into d_cysy_new From t_fhmx Where dbdh = ls_dbdh_new;
            
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_crkls
                (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
                 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl
                 )
                Select all_flowid.Nextval, id, pfpch, pfpch, Sysdate, 'FH', kfbh, dh,
                       pfbmbh, ywbmbh, sfcs, '发货更正', sys, sylx, fhzk, zjxs, 0, 0, 0, 0, sl
                  From t_fhmx
                 Where dbdh = ls_dbdh_new;
            -- 2012-10-06 YANGYI: 改为用链的方式读取交换区的表，
            -- 因为交换区与物流可能不在同一个实例中了。
            -- T_WL_GZJG_MX_TEMP@C_LINK_WL_EX 新增了1个字段：gzlx char(1)
            -- 如果是总部发起的发货更正，则为0，如果是门店收货差异生成的更正，则置为1
            Insert Into T_WL_GZJG_mx_TEMP@C_LINK_WL_EX
                (ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
                 dh, sl_New, gzlx)
            Values
                (S_ID, p_ywpch, S_DBDH, LS_DBDH_NEW, v_curr_bjlsh /*S_BJLSH_ghhy*/,
                 c1.newdh, c1.newcs, c1.newzk, v_curr_ywpch /*S_YWPCH_ghhy*/, p_dh,
                 c1.newsl, decode(Trim(upper(p_gzczy)), 'SL', '1', '0'));
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = v_curr_bjlsh /*s_bjlsh_ghhy*/
            ;
            If v_jl = 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (v_curr_bjlsh /*s_bjlsh_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
            ----------20130717------editby----zgm--------------
            proc_sd_fhxtst_gztj_xtw_crbz(S_dbdh, p_gzlx, p_ywpch, errno, errtext);
            --------------------------------------------------
        Elsif p_gzlx = 'XT' Then
            --销退更正 --插入新记录
            s_crkls_lx := '销退更正';
            errno      := -31;
            Select all_flowid.Nextval Into ldc_new_flowid From dual;
            -- 若更正后税率为空，表示与原税率一致：
            If c1.newsl Is Null Then
                Select sl Into c1.newsl From t_khthmx Where flowid = d_flowid;
            End If;
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From tm_gzdjh
             Where ghdwh = c1.newdh And newsl = c1.newsl;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From t_tmp_gzdjh
             Where ghdwh = c1.newdh And newsl = c1.newsl and flowid=v_flowid_djh;

            --2013-01-17 modify by lv 山东的退货更正都算到退货库即2002 ，因此在此处写死
            Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
            If tmpVar < 1 Then
                errno   := -1;
                errtext := '没有设置退货库房!';
                --Rollback;
                Return;
            Else
                Select dh
                  Into ls_thkf
                  From t_dm
                 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
            End If;
            --2013-07-03 modify by lv 为了查询程序日期，需要将lrrq1 用sysdate来填写
            -- 2013-08-10 yangyi:
            -- 为处理对sylx的更正，若c1.newzk=0.1 且为AD类操作员，则表示更改sylx
            If c1.newzk = 0.1 And substrb(p_gzczy, 1, 2) = 'AD' Then
                -- 表示将sylx从1更为0
                Select decode(sylx, '0', '1', '0'), thzk, id
                  Into v_sylx_new, c1.newzk, v_id_new
                  From t_khthmx
                 Where flowid = d_flowid;
                If v_sylx_new = '0' Then
                    Select dj Into v_zjxs_new From t_kcsm Where id = v_id_new;
                Else
                    v_zjxs_new := 100;
                End If;
            Else
                -- 正常更正处理
                Select zjxs, sylx
                  Into v_zjxs_new, v_sylx_new
                  From t_khthmx
                 Where flowid = d_flowid;
            End If;
            
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            select kfbh into v_gzkf from t_khthmx where flowid = d_flowid;
            
            Insert Into t_khthmx
                (fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, tslsh, jspch, clrq, lrrq1, thlx,
                 sylx, zjxs, sl, dh, id, kfbh, ywbmbh, yscs, hw, dfdh, ysdh, dbbz, xbbz,
                 baohao, ysbbj, sb_ftp_pch, sb_ftp_rq, dhpch, ysbbj_kf, pch, bz, flowid,
                 thcs, thzk, gzbj, usr_id, lrrq, sys, cybh, ywpch, ysflowid, YSYWPCH,
                 YSLRRQ, GZFLOWID)
                Select fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, Null, Null, Sysdate, Sysdate,
                       thlx, v_sylx_new, v_zjxs_new /*sylx, zjxs*/, c1.newsl, c1.newdh, id,
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       ywbmbh, c1.newcs, hw, dfdh, ysdh,
                       dbbz, xbbz, baohao, '1', sb_ftp_pch, sb_ftp_rq, dhpch, ysbbj_kf,
                       v_curr_ywpch, bz, ldc_new_flowid, c1.newcs, c1.newzk, '0', p_gzczy,
                       Sysdate,
                       round(c1.newcs * v_zjxs_new /*zjxs*/
                              * c1.newzk / 100, 2), cybh, v_curr_ywpch, d_flowid, PCH,
                       LRRQ, FLOWID
                  From t_khthmx
                 Where flowid = d_flowid;
                 
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致     
            Insert Into t_crkls
                (flowid_crkls, ywpch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh, id, crkcs,
                 crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, fgbj, yspch, bz)
                Select all_flowid.Nextval, v_curr_ywpch /*s_ywpch_ghhy*/, Sysdate, 'XT',
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       dh, '3001', ywbmbh, id, thcs, sys,
                       sylx, thzk, zjxs, dbbz, xbbz, thcs, sys, '0', pch, '销退更正'
                  From t_khthmx
                 Where flowid = ldc_new_flowid;
            Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
                (ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
                 dh, sl_new)
            Values
                (S_ID, p_ywpch, S_DBDH, to_char(LDC_NEW_flowid), v_curr_ywpch
                 /*s_ywpch_ghhy*/, c1.newdh, c1.newcs, c1.newzk, v_curr_ywpch
                 /*s_ywpch_ghhy*/, p_dh, c1.newsl);
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = v_curr_ywpch /*s_ywpch_ghhy*/
            ;
            If v_jl <= 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (v_curr_ywpch /*s_ywpch_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
            ----------20130717------editby----zgm--------------
            proc_sd_fhxtst_gztj_xtw_crbz(d_flowid, p_gzlx, p_ywpch, errno, errtext);
            --------------------------------------------------
        Else
            --社退更正--插入新记录
            errno      := -32;
            s_crkls_lx := 'THGZ';
            Select all_flowid.Nextval Into ldc_new_flowid From dual;
            -- 若更正后税率为空，表示与原税率一致：
            If c1.newsl Is Null Then
                Select sl Into c1.newsl From t_hythmx Where flowid = d_flowid;
            End If;
            Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
            If tmpVar < 1 Then
                errno   := -1;
                errtext := '没有设置退货库房!';
                --Rollback;
                Return;
            Else
                Select dh
                  Into ls_thkf
                  From t_dm
                 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
            End If;
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
/*            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From tm_gzdjh
             Where ghdwh = c1.newdh And newsl = c1.newsl;
*/
-- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
            Select ywpch, to_char(flowid_dj)
              Into v_curr_ywpch, v_curr_bjlsh
              From t_tmp_gzdjh
             Where ghdwh = c1.newdh And newsl = c1.newsl and flowid=v_flowid_djh;

            -- 2013-08-10 yangyi:
            -- 为处理对sylx的更正，若c1.newzk=0.1 且为AD类操作员，则表示更改sylx
            If c1.newzk = 0.1 And substrb(p_gzczy, 1, 2) = 'AD' Then
                -- 表示将sylx从1更为0
                Select decode(sylx, '0', '1', '0'), thzk, id
                  Into v_sylx_new, c1.newzk, v_id_new
                  From t_hythmx
                 Where flowid = d_flowid;
                If v_sylx_new = '0' Then
                    Select dj Into v_zjxs_new From t_kcsm Where id = v_id_new;
                Else
                    v_zjxs_new := 100;
                End If;
            Else
                -- 正常更正处理
                Select zjxs, sylx
                  Into v_zjxs_new, v_sylx_new
                  From t_hythmx
                 Where flowid = d_flowid;
            End If;
            
            select kfbh into v_gzkf from t_hythmx where flowid = d_flowid;
            
            --2014-2-26 modify by 增加p_gzczy
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_hythmx
                (YWPCH, ID, THCS, THZK, DBRQ, SYS, SYLX, ZJXS, HYBH, YWBMBH, FLOWID, sl,
                 kfbh, cybh, bjlsh, ysbbj, ysflowid, cgyj, YSYWPCH, YSDBRQ, chych, thlx)
                Select v_curr_ywpch, id, c1.newcs, c1.newzk, Sysdate,
                       round(c1.newcs * v_zjxs_new /*zjxs*/
                              * c1.newzk / 100, 2), v_sylx_new, v_zjxs_new, /*sylx, zjxs,*/
                       c1.newdh, YWBMBH, ldc_new_flowid, c1.Newsl,
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       cybh, v_curr_bjlsh, '1', d_flowid,
                       cgyj, YWPCH, DBRQ, p_gzczy, thlx
                  From t_hythmx
                 Where flowid = d_flowid;
            
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_crkls
                (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
                 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl)
                Select flowid, id, ywpch, ywpch, dbrq, 'ST',
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       hybh, cybh, ywbmbh, thcs, '进退更正',
                       sys, sylx, thzk, zjxs, 0, 0, 0, 0, sl
                  From t_hythmx
                 Where flowid = ldc_new_flowid;
            Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
                (ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
                 dh, sl_new)
            Values
                (S_ID, p_ywpch, S_DBDH, to_char(LDC_NEW_flowid), v_curr_bjlsh
                 /*s_bjlsh_ghhy*/, c1.newdh, c1.newcs, c1.newzk, v_curr_ywpch
                 /*s_ywpch_ghhy*/, p_dh, c1.newsl);
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = v_curr_ywpch /*s_bjlsh_ghhy*/
            ;
            If v_jl <= 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (v_curr_ywpch /*s_bjlsh_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
            ----------20130717------editby----zgm--------------
            proc_sd_fhxtst_gztj_xtw_crbz(d_flowid, p_gzlx, p_ywpch, errno, errtext);
            --------------------------------------------------
        End If;
        --End If;
        ------------------------------------插入新记录结束
        v_bj := -224;
        --如果册数发生改变，要进行差异处理
        If l_yssl <> c1.newcs Then

            --新册数 减 原始数量 如果是发货、退货更正，差异数大于0，表示需要补充发货，
            l_cys := c1.newcs - l_yssl;
            -- 如果更正后会引起库存减少, 则用正损益来平衡
            If (l_cys > 0 And p_gzlx <> 'XT') Or (l_cys < 0 And p_gzlx = 'XT') Then
                If p_gzlx = 'XT' Then
                    v_cys := -l_cys;
                Else
                    v_cys := l_cys;
                End If;
                -- 2010-11-17 yangyi modify:
                -- 为损益匹配时统一处理，改为全部写差异了，
                ---如果库存减少，为平抑库存，则记正差异，
                --dlgetlsh(p_ywbmbh, 'CY', 'CY', s_ywpch_sy);
                dlgetlsh_yy(p_cybh, 'CY', 'CY', s_ywpch_sy);
                Select all_flowid.Nextval Into d_crkls From dual;
                -- 2012-10-07 yangyi: 增加 cylx, gzmxkey
                If p_gzlx = 'XT' Or p_gzlx = 'ST' Then
                    --2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
                    Select Count(*)
                      Into tmpVar
                      From t_dm
                     Where lxbh = '2' And kflx = 'TH';
                    If tmpVar < 1 Then
                        errno   := -1;
                        errtext := '没有设置退货库房!';
                        --Rollback;
                        Return;
                    Else
                        Select dh
                          Into ls_thkf
                          From t_dm
                         Where lxbh = '2' And kflx = 'TH' And rownum = 1;
                    End If;
                    -- 2018-05-13 yangyi: 修改税率的写法:
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_crkls
                        (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                         ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                         sn_crksy, sl, cylx, gzmxkey)
                    Values
                        (d_crkls, S_Id, s_ywpch_sy, s_ywpch_sy, Sysdate, 'CY',
                         v_gzkf, v_gzkf,
                         --decode(tmp3f, 1, v_gzkf, ls_thkf),
                         --decode(tmp3f, 1, v_kfbh, ls_thkf), 
                         p_cybh, p_ywbmbh, v_cys,
                         decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', 0, '0', 0,
                         0, 0, 0, 0, 0, c1.newsl/*13*/, p_gzlx, s_dbdh);
                    -- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
                    -- 山东正差异也报商流：
                    -- t_bsjh_lsb 是为上报商流用的
                    -- 由于上报的负差异在t_bsjh_lsb表中, 是以正值来表示的（即：报损=正，报益=负）
                    -- 以便统一写下边的插入语句
                    -- 2013-11-08 YANGYI: 写cs时，改用 - v_cys
                    --
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_bsjh_lsb
                        (flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
                         gzmxkey, zfzdbj)
                    Values
                        (all_flowid.Nextval, s_id, p_ywbmbh,
                         v_gzkf, --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, -v_cys /*-l_cys*/,
                         s_ywpch_sy, d_crkls, p_gzlx, s_dbdh, ls_zfzd);
                    -- t_sy_jh 是为物流用于后期匹配的
                    --2011-07-12 by lv
                    --2012-12-27 增加直发转单更正标记
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_sy_jh
                        (flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj, czybh)
                    Values
                        ( /*all_flowid.nextval*/ d_crkls, s_id, p_ywbmbh,
                         v_gzkf, --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, v_cys, Sysdate, 'SY',
                         decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd,
                         p_gzczy);
                Else
                    --2105-0-13 yangyi: 修改税率的写法
                    
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_crkls
                        (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                         ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                         sn_crksy, sl, cylx, gzmxkey)
                    Values
                        (d_crkls, S_Id, s_ywpch_sy, s_ywpch_sy, Sysdate, 'CY', v_gzkf/*v_kfbh*/,
                         v_gzkf/*v_kfbh*/, p_CYBH, p_ywbmbh, v_cys,
                         decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', 0, '0', 0,
                         0, 0, 0, 0, 0,  c1.newsl/*13*/, p_gzlx, s_dbdh);
                    -- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
                    -- 山东正差异也报商流：
                    -- t_bsjh_lsb 是为上报商流用的
                    -- 由于上报的负差异在t_bsjh_lsb表中, 是以正值来表示的（即：报损=正，报益=负）
                    -- 以便统一写下边的插入语句
                    
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_bsjh_lsb
                        (flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
                         gzmxkey, zfzdbj)
                    Values
                        (all_flowid.Nextval, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/, p_cybh, -l_cys,
                         s_ywpch_sy, d_crkls, p_gzlx, s_dbdh, ls_zfzd);
                    -- t_sy_jh 是为物流用于后期匹配的
                    --2011-07-12 by lv
                    --2012-12-27 增加直发转单更正标记
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_sy_jh
                        (flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj, czybh)
                    Values
                        ( /*all_flowid.nextval*/ d_crkls, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/, p_cybh,
                         v_cys, Sysdate, 'SY',
                         decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd,
                         p_gzczy);
                End If;
            End If;

            Select all_flowid.Nextval Into d_bs_flowid From dual;
            -- 如果更正后会引起库存增加, 则用 负差异 来平衡, 注意: 是CY
            If (l_cys < 0 And p_gzlx <> 'XT') Or (l_cys > 0 And p_gzlx = 'XT') Then
                If p_gzlx = 'XT' Or p_gzlx = 'ST' Then
                    --2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
                    Select Count(*)
                      Into tmpVar
                      From t_dm
                     Where lxbh = '2' And kflx = 'TH';
                    If tmpVar < 1 Then
                        errno   := -1;
                        errtext := '没有设置退货库房!';
                        --Rollback;
                        Return;
                    Else
                        Select dh
                          Into ls_thkf
                          From t_dm
                         Where lxbh = '2' And kflx = 'TH' And rownum = 1;
                    End If;
                End If;
                If p_GZLX = 'ST' Then
                    /*
                    --2012-12-27 modify by lv 因为差异算到退货上，因此不需要进行转移操作了
                    --如果是货源退货更正，要首先写一个转移数据，从退货库转移到立库
                    dlgetlsh(p_cybh, 'ZC', 'ZC', ls_zypch);
                    Insert Into t_wl_zyls
                    (flowid, id, ckkf, rkkf, cybh, ywbmbh, yssl, sjsl, cgyj, lx,
                    ghdwh, zypch, Zjxs, ZK, SYLX, rq)
                    Select all_flowid.Nextval, id, kfbh, v_kfbh, cybh, ywbmbh, -l_cys,
                    -l_cys, cgyj, 'SZ', hybh, ls_zypch, zjxs, thzk, sylx,
                    Sysdate
                    From t_hythmx
                    Where flowid = d_flowid;

                    Insert Into t_crkls
                    (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                    ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                    sn_crksy, sl)
                    Select all_flowid.Nextval, id, ls_zypch, bjlsh, Sysdate, 'ZC',
                    KFBH, v_kfbh, CYBH, YWBMBH, -L_CYS, '进退更正', 0, SYLX, THZK,
                    ZJXS, D_DBBZ, D_XBBZ, -L_CYS, 0, SL
                    From t_hythmx
                    Where flowid = d_flowid;

                    dlgetlsh(p_cybh, 'ZR', 'ZR', ls_zypch);
                    Insert Into t_crkls
                    (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                    ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                    sn_crksy, sl)
                    Select all_flowid.Nextval, id, ls_zypch, bjlsh, Sysdate, 'ZR',
                    v_kfbh, KFBH, CYBH, YWBMBH, -L_CYS, '进退更正', 0, SYLX, THZK,
                    ZJXS, D_DBBZ, D_XBBZ, -L_CYS, 0, SL
                    From t_hythmx
                    Where flowid = d_flowid;

                    */
                    dlgetlsh_yy(p_cybh, 'CY', 'CY', s_ywpch_sy);
                    -- l_cys本身是负值, 所以, 这里应该是 负差异
                    -- 2012-10-07 yangyi: 增加 cylx, gzmxkey
                    --2012-12-27  差异算到退货库上
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_crkls
                        (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                         ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                         sn_crksy, sl, cylx, gzmxkey)
                        Select d_bs_flowid, id, s_ywpch_sy, bjlsh, Sysdate, 'CY',
                               kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                               KFBH, CYBH, YWBMBH, L_CYS,
                               '进退更正', 0, SYLX, THZK, ZJXS, D_DBBZ, D_XBBZ, L_CYS, 0, SL,
                               p_gzlx, s_dbdh
                          From t_hythmx
                         Where flowid = d_flowid;
                Elsif P_GZLX = 'FH' Then
                    dlgetlsh_yy(p_cybh, 'CY', 'CY', s_ywpch_sy);
                    -- 2012-10-07 yangyi: 增加 cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_crkls
                        (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                         ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                         sn_crksy, sl, cylx, gzmxkey)
                        Select d_bs_flowid, id, s_ywpch_sy, s_dbdh, Sysdate, 'CY', kfbh,
                               dh, pfbmbh, ywbmbh, l_cys, '发货更正',
                               round(l_cys * zjxs * FHZK / 100, 2), sylx, fhzk, zjxs, 0, 0,
                               0, 0, sl, p_gzlx, s_dbdh
                          From t_fhmx
                         Where dbdh = ls_dbdh_new;
                Else
                    ---如果是客户退货更正，往大了更，则物流要增加库存
                    -- 为避免库存增加, 用负差异来平衡一下, 使库存保持不变
                    -- 注意, 对销退来说, L_CYS是个>0的数, 所以这里要取负值
                    --
                    v_bj := -234;
                    dlgetlsh_yy(p_cybh, 'CY', 'CY', s_ywpch_sy);
                    -- 2012-10-07 yangyi: 增加 cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_crkls
                        (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                         ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                         sn_crksy, sl, cylx, gzmxkey)
                        Select d_bs_flowid, id, s_ywpch_sy, s_dbdh, Sysdate, 'CY',
                               kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                               kfbh, cybh, ywbmbh, -l_cys,
                               '销退更正', round(-l_cys * zjxs * thZK / 100, 2), sylx, thzk,
                               zjxs, 0, 0, 0, 0, sl, p_gzlx, s_dbdh
                          From t_khthmx
                         Where flowid = ldc_new_flowid;
                End If;
                -- 负差异需要上报商流
                -- t_bsjh_lsb 是为上报商流用的
                -- 由于上报的负差异在t_bsjh_lsb表中, 是以正值来表示的（即：报损=正，报益=负）
                -- 而由于销退是正值才走这里, 所以对销退的差异数要先求一次反
                -- 以便统一写下边的插入语句
                v_bj := -244;
                If p_gzlx = 'XT' Then
                    l_cys := -l_cys;
                End If;
                If p_gzlx = 'XT' Or p_gzlx = 'ST' Then
                    -- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_bsjh_lsb
                        (flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
                         gzmxkey, zfzdbj)
                    Values
                        (all_flowid.Nextval, s_id, p_ywbmbh,
                         v_gzkf, --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, -l_cys, s_ywpch_sy,
                         d_bs_flowid, p_gzlx, s_dbdh, ls_zfzd);
                    -- t_sy_jh 是为物流用于后期匹配的
                    --2011-07-12
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_sy_jh
                        (flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj)
                    Values
                        ( /*all_flowid.nextval*/ d_bs_flowid, s_id, p_ywbmbh,
                         v_gzkf, --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, -l_cys, Sysdate, 'BS',
                         decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd);
                Else
                    -- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_bsjh_lsb
                        (flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
                         gzmxkey, zfzdbj)
                    Values
                        (all_flowid.Nextval, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/, p_cybh, -l_cys,
                         s_ywpch_sy, d_bs_flowid, p_gzlx, s_dbdh, ls_zfzd);
                    -- t_sy_jh 是为物流用于后期匹配的
                    --2011-07-12
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_sy_jh
                        (flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj)
                    Values
                        ( /*all_flowid.nextval*/ d_bs_flowid, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/,
                         p_cybh, -l_cys, Sysdate, 'BS',
                         decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd);
                End If;
            End If;
        End If;
        -----------------------------------结束更正
        errno := 0;
    End Loop;
    v_bj := -264;
    Update t_sl_gzjh_hz@C_LINK_WL_EX
       Set receflag = '1'
     Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;

    -- 2011-01-07 add by yangyi:
    -- 如果是发货更正需要写t_wcbj, t_wl_dfbj
    -- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
    If p_gzlx = 'FH' Then
        For c_bj In (Select * From t_tmp_gzdjh where flowid=v_flowid_djh)
        Loop
            v_curr_bjlsh := to_char(c_bj.flowid_dj);
            Select Count(*), Sum(t_fhmx.sfcs), Sum(t_fhmx.sfcs * t_kcsm.dj),
                   Sum(t_fhmx.sys), Min(dh)
              Into v_zpz, v_zcs, v_zmy, v_zsy, v_dh
              From t_fhmx, t_kcsm
             Where t_kcsm.id = t_fhmx.id And t_fhmx.pfpch = c_bj.Ywpch; /*s_ywpch;*/
            v_bj := -998;
            Insert Into t_wcbj
                (BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
                 FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
                 YWLX, FYRQ, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
                 CYR, CYDW, ssjs, psjs, shrq, hw, zb, js, jxfs)
            Values
                (to_char(c_bj.flowid_dj) /*s_bjlsh*/, '', Sysdate, p_ywbmbh, c_bj.Ywpch
                 /*s_ywpch*/, v_dh, v_zpz, v_zcs, v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate,
                 '', '16', '', '', '', v_dh, '', '16', 'FH', Sysdate, '', Sysdate, '',
                 Null, '', '', '', Sysdate, '', '', '', 1, 0, Sysdate, '', '', 1,
                 decode(ls_zfzd, '1', 'ZF', ''));
            -- 为回告商流:
            Insert Into t_wl_dfbj@C_LINK_WL_EX
                (BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
                 FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
                 YWLX, FYrq, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
                 CYR, CYDW, ssjs, psjs, shrq, hw, zb, JS, RECEBMBH, SENDBMBH, RECEFLAG,
                 SENDDATE)
            Values
                (to_char(c_bj.flowid_dj) /*s_bjlsh*/, '', Sysdate, p_ywbmbh, c_bj.Ywpch
                 /*s_ywpch*/, v_dh, v_zpz, v_zcs, v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate,
                 '', '16', '', '', '', v_dh, '', '16', 'FH', Sysdate, '', Sysdate, '',
                 Null, '', '', '', Sysdate, '', '', '', 1, 0, Sysdate, '', '', 1, p_ywbmbh,
                 p_cybh, '0', Sysdate);
            /*        If Trim(s_ywpch_ghhy) <> Trim(s_ywpch) Then

            Select Count(*), Sum(t_fhmx.sfcs), Sum(t_fhmx.sfcs * t_kcsm.dj),
            Sum(t_fhmx.sys), Min(dh)
            Into v_zpz, v_zcs, v_zmy, v_zsy, v_dh
            From t_fhmx, t_kcsm
            Where t_kcsm.id = t_fhmx.id And t_fhmx.pfpch = s_ywpch_ghhy;

            v_bj := -999;
            Insert Into t_wcbj
            (BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
            FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
            YWLX, FYRQ, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
            CYR, CYDW, ssjs, psjs, shrq, hw, zb, js)
            Values
            (s_bjlsh_ghhy, '', Sysdate, p_ywbmbh, s_ywpch_ghhy, v_dh, v_zpz, v_zcs,
            v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate, '', '16', '', '', '', v_dh, '',
            '16', 'FH', Sysdate, '', Sysdate, '', Null, '', '', '', Sysdate, '', '',
            '', 1, 0, Sysdate, '', '', 1);

            -- 为回告商流:
            Insert Into t_wl_dfbj
            (BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
            FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
            YWLX, FYrq, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
            CYR, CYDW, ssjs, psjs, shrq, hw, zb, JS, RECEBMBH, SENDBMBH, RECEFLAG,
            SENDDATE)
            Values
            (s_bjlsh_ghhy, '', Sysdate, p_ywbmbh, s_ywpch_ghhy, v_dh, v_zpz, v_zcs,
            v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate, '', '16', '', '', '', v_dh, '',
            '16', 'FH', Sysdate, '', Sysdate, '', Null, '', '', '', Sysdate, '', '',
            '', 1, 0, Sysdate, '', '', 1, p_ywbmbh, p_cybh, '0', Sysdate);

            End If;
            */
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = v_curr_bjlsh /*s_bjlsh*/
            ;
            If v_jl <= 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (v_curr_bjlsh /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
        End Loop;
    End If;
    -- 2009-12-07 add by yangyi:
    -- 如果是销退更正需要写t_khthhz, t_khthhz_sl
    If p_gzlx = 'XT' Then
        v_bj := -274;
        --2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
        Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
        If tmpVar < 1 Then
            errno   := -1;
            errtext := '没有设置退货库房!';
            --Rollback;
            Return;
        Else
            Select dh
              Into ls_thkf
              From t_dm
             Where lxbh = '2' And kflx = 'TH' And rownum = 1;
        End If;

        -- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
        For c_hz In (Select * From t_tmp_gzdjh where flowid=v_flowid_djh)
        Loop
            --v_bj := -375;
            --Select thrq Into v_ysthrq From t_khthhz Where thpch = c_hz.Ywpch/*p_ywpch*/;
            Select Min(dh)
              Into v_dh
              From t_khthmx
             Where ywpch = c_hz.Ywpch /*s_ywpch*/
            ;
            -- 取得托收标记
            Select nvl(tsbj, '0'), nvl(lsdbj, '0'), khlxbh
              Into v_tsbj, v_lsdbj, v_khlxbh
              From t_dm_ywbm
             Where dh = v_dh And ywbmbh = p_ywbmbh;
            v_bj := -374;
            -- 写物流t_khthhz表:
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_khthhz
                (THRQ, YDKJE, YJSBJ, TXY, THPCH, DH, ZPZ, ZCS, ZMY, ZSY, SL, YWPC, KFBH,
                 FGBJ, KCFGBJ, THXCBJ, YSBBJ, WZSCBJ, WZSCRQ, YSBBJ_KF, CYBH, YWBMBH,thlx)
                Select Min(t_khthmx.lrrq), 0, '0', Min(t_khthmx.txy), t_khthmx.pch,
                       t_khthmx.dh, Count(*), Sum(t_khthmx.thcs),
                       Sum(t_khthmx.thcs * t_kcsm.dj), Sum(t_khthmx.sys), Min(t_khthmx.sl),
                       t_khthmx.pch, min(t_khthmx.kfbh),
                       --Max(decode(tmp3f, 1, kfbh, ls_thkf)),
                        '0', '0', '0',
                       '1', '0', Null, '0', Min(cybh), Min(ywbmbh),min(t_khthmx.thlx)
                  From t_khthmx, t_kcsm
                 Where t_kcsm.id = t_khthmx.id And t_khthmx.ywpch = c_hz.Ywpch /*s_ywpch*/
                       And t_khthmx.dh = v_dh
                 Group By t_khthmx.pch, t_khthmx.dh;
            /*        If Trim(s_ywpch_ghhy) <> Trim(s_ywpch) Then

            Select Min(dh) Into v_dh From t_khthmx Where ywpch = s_ywpch_ghhy;
            -- 取得托收标记
            Select nvl(tsbj, '0'), nvl(lsdbj, '0'), khlxbh
            Into v_tsbj, v_lsdbj, v_khlxbh
            From t_dm_ywbm
            Where dh = v_dh And ywbmbh = p_ywbmbh;
            Insert Into t_khthhz
            (THRQ, YDKJE, YJSBJ, TXY, THPCH, DH, ZPZ, ZCS, ZMY, ZSY, SL, YWPC, KFBH,
            FGBJ, KCFGBJ, THXCBJ, YSBBJ, WZSCBJ, WZSCRQ, YSBBJ_KF, CYBH, YWBMBH)
            Select Min(t_khthmx.lrrq), 0, '0', Min(t_khthmx.txy), t_khthmx.pch,
            t_khthmx.dh, Count(*), Sum(t_khthmx.thcs),
            Sum(t_khthmx.thcs * t_kcsm.dj), Sum(t_khthmx.sys), Min(t_khthmx.sl),
            t_khthmx.pch, Min(t_khthmx.kfbh), '0', '0', '0', '1', '0', Null,
            '0', Min(cybh), Min(ywbmbh)
            From t_khthmx, t_kcsm
            Where t_kcsm.id = t_khthmx.id And t_khthmx.ywpch = s_ywpch_ghhy And
            t_khthmx.dh = v_dh
            Group By t_khthmx.pch, t_khthmx.dh;
            End If;

            */
            v_bj := -474;
            Select Count(*)
              Into v_jl
              From t_gzdj_print
             Where ywpch = c_hz.ywpch /*s_bjlsh*/
            ;
            If v_jl <= 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (c_hz.ywpch /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
        End Loop;
    End If;
    -- 写物流t_hythhz表:
    If p_gzlx = 'ST' Then
        --2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
        Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
        If tmpVar < 1 Then
            errno   := -1;
            errtext := '没有设置退货库房!';
            --Rollback;
            Return;
        Else
            Select dh
              Into ls_thkf
              From t_dm
             Where lxbh = '2' And kflx = 'TH' And rownum = 1;
        End If;
        -- 2019-04-23 yangyi: 将tm_gzdjh改为正式表 t_tmp_gzjhdh
        For c_hz In (Select * From t_tmp_gzdjh where flowid=v_flowid_djh)
        Loop
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
            Insert Into t_hythhz
                (THRQ, YWPCH, HYBH, CYBH, YWBMBH, KFBH, ZPZ, ZCS, ZMY, ZSY, BJS, USR_ID,
                 JHR, FYPC, FYRQ, FYFS, YH, CH, FYR, Bz, thlx)
                Select Min(dbrq), ywpch, hybh, cybh, ywbmbh,
                       kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                       Count(id), Sum(thcs),
                       Sum(thcs * zjxs), Sum(sys), 1, 'auto', '', '', Min(dbrq), '', '',
                       '', '', '更正',min(thlx)
                  From t_hythmx
                 Where ywpch = c_hz.Ywpch /*s_ywpch*/
                 Group By ywpch, hybh, cybh, ywbmbh, kfbh;
            Select Count(*) Into v_jl From t_gzdj_print Where ywpch = c_hz.ywpch;
            If v_jl <= 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (c_hz.ywpch, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
            If v_jl = 0 Then
                Insert Into t_gzdj_print
                    (ywpch, gzrq, djlx, cs, gzczy)
                Values
                    (c_hz.Ywpch /*s_bjlsh_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
            End If;
        End Loop;
    End If;
    /*    If Trim(s_ywpch_ghhy) <> Trim(s_ywpch) Then
    Insert Into t_gzdj_print
    (ywpch, gzrq, djlx, cs, gzczy)
    Values
    (s_bjlsh_ghhy, Sysdate, p_gzlx, 0, p_gzczy);
    If p_gzlx = 'ST' Then
    Insert Into t_hythhz
    (THRQ, YWPCH, HYBH, CYBH, YWBMBH, KFBH, ZPZ, ZCS, ZMY, ZSY, BJS, USR_ID,
    JHR, FYPC, FYRQ, FYFS, YH, CH, FYR, Bz)
    Select Min(dbrq), ywpch, hybh, cybh, ywbmbh, kfbh, Count(id), Sum(thcs),
    Sum(thcs * zjxs), Sum(sys), 1, 'auto', '', '', Min(dbrq), '', '',
    '', '', '更正'
    From t_hythmx
    Where ywpch = s_ywpch_ghhy
    Group By ywpch, hybh, cybh, ywbmbh, kfbh;
    End If;
    End If;
    */

    v_bj := -284;
    Insert Into t_wl_gzjg_mx@c_link_wl_ex
        Select *
          From T_WL_GZJG_MX_TEMP@c_link_wl_ex
         Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;

    v_bj := -285;
    Update t_wl_gzjg_mx@c_link_wl_ex
       Set gzjhdh = Trim(gzjhdh), dbdh_old = Trim(dbdh_old), dbdh_new = Trim(dbdh_new),
           bjlsh_new = Trim(bjlsh_new), dh_new = Trim(dh_new), ywpch = Trim(ywpch)
     Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;

    v_bj := -286;
    Select Count(*)
      Into l_count_sl
      From t_wl_gzjg_mx@c_link_wl_ex
     Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;

    v_bj := -287;
    Delete t_wl_gzjg_hz@c_link_wl_ex Where gzjhdh = Trim(p_ywpch);

    v_bj := -288;
    Insert Into t_wl_gzjg_hz@c_link_wl_ex
        (GZJHDH, SENDBMBH, GZLX, RECEBMBH, RECEFLAG, SENDDATE, JLS, zdbj, gzczy, dh)
    Values
        (Trim(p_ywpch), Trim(p_cybh), Trim(p_gzlx), Trim(p_ywbmbh), '0', Sysdate,
         l_count_sl, s_zdbj, Trim(p_gzczy), p_dh);
    v_bj := -289;
    Delete From t_wl_gzjg_mx_temp@c_link_wl_ex
     Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;

    v_bj := -290;
    Insert Into t_sl_gzjh_hz_bak
        Select *
          From t_sl_gzjh_hz@c_link_wl_ex
         Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;

    v_bj := -291;
    Insert Into t_sl_gzjh_mx_bak
        Select *
          From t_sl_gzjh_mx@c_link_wl_ex
         Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;

    -- 2019-04-23 add yangyi: 将tm_gzdjh改为正式表了
    delete from t_tmp_gzdjh where flowid=v_flowid_djh;

/*    v_bj := -292;
    Delete From t_sl_gzjh_hz@c_link_wl_ex
     Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
    v_bj := -293;
    Delete From t_sl_gzjh_mx@c_link_wl_ex
     Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
*/

    errno   := 0;
    errtext := 'OK';
Exception
    When Others Then
        errno   := v_bj;
        errtext := Sqlerrm || p_ywpch || '-PROC_SX_FHXTST_GZ_YY' || v_bj || ',' ||
                   to_char(d_flowid)||','||s_dh_1212||','||p_ywbmbh;--||','||v_currsl||','||v_rows;
        --Rollback;
        Return;
End PROC_SX_FHXTST_GZ_YY;
/
CREATE OR REPLACE Procedure "RF_XJHG_HX" -- RF下架换箱:
		--
		-- 2008-07-29 yangyi 对此过程进行了大规模的修缮工作，主要包括一下几点：
		-- 1. 对容器合法性校验，改为调用proc_chkrqh()
		-- 2. 换箱号时取bjlsh函数改为调用proc_get_bjlsh()
(v_xsdh    In Char, --销售单号
 v_cybh    In Char, --储运编号
 v_xhao    In Char, --新箱号
 v_cwh     In Char, --车位号
 v_xjczybh In Char, --下架操作员编号
  p_writetrace out Varchar,
 errno     Out Number,
 errtext   Out Varchar) As

		v_bj       Number;
		v_phdh_old Char(12);
		v_phdh_new Char(12);
		v_jxfs     Char(2);
		v_lxbh     Char(2);
		v_kfbh     Char(6);
		v_kflx     Char(2);
		d_pch      Number(10);
		v_rows     Number(10);
		ls_xjczybh Char(4);
		LDC_JLS    Number(10);
		V_ZCS      Number(10);
		LDC_SJJS   Number(10, 2);
		v_ywbmbh   Char(6);

		s_xsdh     Char(12);
		v_xhao_old Char(10);
		p_flowid   Number;
		v_bzjmy    Number;
    v_ywlx   t_dfbj.ywlx%type;
Begin

	      errno   := -10;
				errtext := '停用';
				Return;

		/*    errno   := -10;
    errtext := '非按单方式拣选的任务，不能进行换箱操作!'||v_xsdh||v_xhao||v_cybh||v_xjczybh;
    return;
    */
		s_xsdh := v_xsdh;
		Select Max(jxfs) Into v_jxfs From t_agv_rw_xt Where xsdh = s_xsdh;
		If v_jxfs <> 'AD' Then
				errno   := -10;
				errtext := '非按单方式拣选的任务，不能进行换箱操作!';
				Return;
		End If;
		-- 2008-07-28 modify by yangyi:
		-- 对新箱号的检测改为调用统一函数:
		proc_chkrqh(v_xhao, '', errno, errtext);
		If errno <> 0 Then
				Return;
		End If;
		-- 将原包件置wcbj=1
		v_bj := 4;
		Select Min(phdh),min(lxbh)
			Into v_phdh_old,v_lxbh
			From t_agv_rw_xt
		 Where xsdh = s_xsdh And xjczybh = v_xjczybh And cybh = v_cybh And jxfs = 'AD';
		Select Count(*)
			Into v_rows
			From t_agv_rw_xt
		 Where xjczybh = v_xjczybh And phdh <> v_phdh_old And cwh = v_cwh;
		If v_rows > 0 Then
				errno   := -10;
				errtext := '该车位号已被其它容器占用了!';
				Rollback;
				Return;
		End If;
		Update t_dfbj Set wcbj = '1' Where bjlsh = v_phdh_old;
    if v_lxbh='ST' then
      update t_hykcsl set jhcs=kccs where bjlsh=v_phdh_old;
    end if;

		-- 取得新的包件号:
		Select Max(lxbh), Max(ywbmbh)
			Into v_lxbh, v_ywbmbh
			From t_agv_rw_xt
		 Where xsdh = s_xsdh;

     if v_ywbmbh='000002' then
        update t_pxmx set jhcs=pxcs where bjlsh=v_phdh_old;
     end if ;
		proc_get_bjlsh(v_lxbh, v_ywbmbh, v_phdh_new, errno, errtext);
		If errno <> 0 Then
				Rollback;
				Return;
		End If;

		-- 取得标准件的码洋, 为推算异型品的实际件数
		Select nvl(Min(sys_value), 900)
			Into v_bzjmy
			From t_sysset
		 Where sys_item = 'GPBJBZ' And sys_ywbmbh = v_ywbmbh;
		-- 2010-09-11 add by yangyi:
		-- 在换箱时需要对接力提示信息表进行维护
		-- 取得原箱号
		Select Min(xhao)
			Into v_xhao_old
			From t_agv_rw_xt
		 Where xsdh = s_xsdh And xjczybh = v_xjczybh And cybh = v_cybh And jxfs = 'AD';

		----------------------------------------------------------------------------------


		Update t_agv_rw_xt
			 Set xhao = v_xhao, cwh = v_cwh, phdh = v_phdh_new, XSDH = V_PHDH_NEW
		 Where /*xjczybh=v_xjczybh and*/
		 xsdh = s_xsdh And cybh = v_cybh And jxfs = 'AD';
		Update t_agv_rw_xt_bak
			 Set xhao = v_xhao, phdh = v_phdh_new, XSDH = V_PHDH_NEW
		 Where xsdh = s_xsdh And cybh = v_cybh And jxfs = 'AD' And xjrq Is Null;
		s_xsdh := v_phdh_new;
		-- ELSE
		--       update t_agv_rw_xt set xhao=v_xhao,cwh=v_cwh,phdh=v_phdh_new
		--     where /*xjczybh=v_xjczybh and*/ xsdh=s_xsdh and cybh=v_cybh and jxfs='AD';
		--  END IF;
		-----------------------------------------------------------------------------------
		If Sql%Notfound Then
				errno   := 3;
				errtext := '当前下架任务不存在或已经被删除' || ',' || s_xsdh || ',' || v_cybh || ',' ||
									 v_xjczybh;
				Rollback;
				Return;
		End If;

		Select Count(Distinct xjczybh)
			Into v_rows
			From t_agv_rw_xt_bak
		 Where phdh = v_phdh_old;
		--如果是单操作员，直接从t-dfbj里记工作量，
		--如果是多操作员则从agv_bak表里计算
		If v_rows = 1 Then
				Select Count(*) Into v_rows From t_dfbj Where bjlsh = v_phdh_old;
				If v_rows > 0 Then
						Select Min(xjczybh)
							Into ls_xjczybh
							From t_agv_rw_xt_bak
						 Where phdh = v_phdh_old;
						-- 2011-07-02 yangyi: 这句话太害人了，不是一般的害人呀！！！
						-- if not (ls_xjczybh='' or ls_xjczybh is null ) then
						--2012-02-07 modify by lv 用t_dfbj 计算的工作量是不准的因为
						--zpz 没有更新
						--改为t_agv_rw_xt_bak计算得出
						If nvl(Trim(ls_xjczybh), 'wwwww') <> 'wwwww' Then
								Select ZPZ, ZCS, SJJS
									Into LDC_JLS, V_ZCS, LDC_SJJS
									From T_DFBJ
								 Where BJLSH = v_phdh_old;
								Select all_flowid.Nextval Into p_flowid From dual;
								Insert Into t_gzl
										(CZYBH, CZLX, CZRQ, JLS, CS, JS, FLOWID, my,TABLE_NAME,FLOWID_TABLE,YWBMBH,PROC_NAME)
										Select ls_xjczybh, (V_Lxbh || 'XJ'), Sysdate, Count(*), Sum(SJSL),
													 ROUND(Sum(decode(sign(a.dbbz * a.xbbz - 1), 1,
																						 SJSL / a.DBBZ / a.XBBZ, sjsl * dj / v_bzjmy)),
																	2), p_flowid, Sum(sjsl * dj)
                               ,'T_AGV_RW_XT_BAK',min(flowid_xj),min(YWBMBH),'RF_XJHG_HX'
											From T_AGV_RW_XT_BAK a, t_kcsm
										 Where PHDH = v_phdh_old And xjczybh = ls_xjczybh And
													 a.id = t_kcsm.id;
								--                 insert into t_ gzl(CZYBH,CZLX,CZRQ,JLS,CS,JS,FLOWID)
								--                     values (ls_xjczybh,(V_Lxbh||'XJ'),sysdate,ldc_jls,V_ZCS,ldc_sjjs,all_flowid.nextval);
						End If;
				End If;
		Else
				For c1 In (Select Distinct xjczybh
										 From t_agv_rw_xt_bak
										Where phdh = v_phdh_old And xjczybh Is Not Null)
				Loop
						Select ALL_FLOWID.Nextval Into D_PCH From DUAL;
						Insert Into t_gzl
								(CZYBH, CZLX, CZRQ, JLS, CS, JS, FLOWID)
								Select c1.xjczybh, (V_Lxbh || 'XJ'), Sysdate, Count(*), Sum(SJSL),
											 ROUND(Sum(SJSL / DBBZ / XBBZ), 2), d_pch
									From T_AGV_RW_XT_BAK
								 Where PHDH = v_phdh_old And dbbz * xbbz >= 1 And xjczybh = c1.xjczybh;
						--异型的工作量：暂时屏蔽，因为异型的都是手工的，在人工下架程序里记录了工作量
						Insert Into t_gzl
								(CZYBH, CZLX, CZRQ, JLS, CS, JS, FLOWID)
								Select c1.XJCZYBH, (V_Lxbh || 'XJ'), Sysdate, Count(*), Sum(SJSL), 0,
											 D_PCH
									From T_AGV_RW_XT_BAK
								 Where PHDH = v_phdh_old And dbbz * xbbz < 1 And xjczybh = c1.xjczybh
								 Group By XJCZYBH;
						--         values (ls_xjczybh,(V_XJ.Lxbh||'XJ'),sysdate,ldc_jls,V_ZCS,ldc_sjjs,all_flowid.nextval);
				End Loop;
		End If;
		-- end if;
		-- 2007-08-28 yangyi add
		-- 由于样本转移下架是按单进行的，因此，在样本转移下架换箱时，应及时删除t_dfbj
		Select Min(lxbh), Min(kfbh) Into v_lxbh, v_kfbh From t_agv_rw_xt Where xsdh = s_xsdh;
		Select kflx Into v_kflx From t_dm Where dh = v_kfbh;
		If v_lxbh = 'ZY' And v_kflx = 'YB' Then
				errno := -105;
				Insert Into t_dfbj_bak1
						Select * From t_dfbj Where bjlsh = v_phdh_old;
				Delete From t_dfbj Where bjlsh = v_phdh_old;
		End If;

     select count(*) into v_rows from t_sysset where sys_item='TRANSON' and sys_value='1' ;

      ----------判断流水线写传送任务用 重庆
   if  /*V_XJ.XJCZYBH='0002'  and */v_rows >0 then

      select min(ywlx) into v_ywlx from  t_dfbj where bjlsh =v_phdh_old;
      if v_ywlx is not null   then
        select node into p_writetrace from  t_location2node where location=v_ywlx and tablename='t_dfbj';
      end if;


    end if;
      ----------判断流水线写传送任务用 重庆
		errno   := 0;
		errtext := 'OK';

Exception
		When Others Then
				ERRNO   := V_BJ;
				ERRTEXT := Sqlerrm;
				Rollback;
End;

CREATE OR REPLACE Procedure PROC_OccupyPmsjrwb_QD(p_rqh    Char,
                                             p_czybh    Char,
                                             p_hqbh char,
                                             p_sjmode       varchar,
                                             p_cwh      Char,
                                             p_flowid Out Number,
                                             errno   Out Number,
                                             errtext Out Varchar) Is
  v_sjname varchar2(20);
  v_ysname varchar2(20);
  v_rows number;
  v_id number;
  v_sjmode varchar2(10);
  v_hqmc varchar2(30);
  v_ywbmbh char(6);
  v_cwywbmbh char(6);
  v_hqbh char(6);
  v_cwflowid number;
  v_cwcreate char(1);
  v_hw  char(20);
Begin

   /*select count(*) into v_rows from t_pmsjrwb where tm=p_rqh;
  if v_rows =0 then
    errno   := -1;
    errtext := '无该箱号的上架记录';
    Return;
  end if;*/
   proc_chkrqh2(p_rqh,'t_pmsjhz',errno,errtext);
   if errno <>0 then

    Return;
   end if;

   select count(*) into v_rows from t_cw where cw=p_cwh;
   if  v_rows =0 then
      errno   := -1;
      errtext := '找不到此车位'||v_sjname;
      Return;
   end if ;

   select count(*) into v_rows from t_pmsjhz where rqh=p_rqh and ( zt='0' or zt='2') ;
   if v_rows =0 then
       select count(*) into v_rows from t_pmsjhz where rqh=p_rqh and  zt='1' ;
       if v_rows >0 then
         select trim(sjczyname) into v_sjname from t_pmsjhz where rqh=p_rqh and  zt='1';
        errno   := -1;
        errtext := '箱子已被占用'||v_sjname;
        Return;
       end if;

       select count(*) into v_rows from t_pmsjhz where rqh=p_rqh and  zt='3' and SJDATE>sysdate-1;
       if v_rows >0 then
         select min(trim(sjczyname)) into v_sjname from t_pmsjhz where
          rqh=p_rqh and  zt='3' and SJDATE>sysdate-1;
        errno   := -1;
        errtext := '箱子已被合并,'||v_sjname;
        Return;
       end if;

       errno   := -1;
       errtext := '箱子里没有上架任务';
       return;
   end if;



 -- if p_sjmode='Common' then
   select min(flowid),min(ywbmbh),min(cwcreate) into p_flowid,v_ywbmbh ,v_cwcreate
   from t_pmsjhz where
   rqh=p_rqh and hqbh=p_hqbh and ( zt='0' or zt='2');
    if p_flowid  is null  then
      select  trim(mc) into v_hqmc from t_hqdy q,t_pmsjhz z where z.hqbh=q.bh  and rqh=p_rqh and ( zt='0' or zt='2');
      errno   := -1;
      errtext := '上架任务属于'||v_hqmc;
      Return;
    end if;
    if v_cwcreate ='1'then
        errno   := -1;
        errtext := '车上的任务不能合并';
        Return;
    end if;
   /* select min(sjmode) into v_sjmode from t_pmsjhz where rqh=p_rqh and zt='2' ;
    if v_sjmode='Bulk' then
       errno   := -1;
       errtext := '不允许更改上架方式';
      Return;
    end if ;*/
  -- end if;

   select min(hqbh),min(flowid),min(ywbmbh) into v_hqbh,v_cwflowid ,v_cwywbmbh from t_pmsjhz where  rqh=p_cwh  and  finished='0';
   if v_hqbh <> p_hqbh  then
      errno   := -1;
      errtext := '车位上任务的货区和箱子任务的货区不一致'||v_hqbh||','||p_hqbh;
      Return;
   end if;

   update t_flrqh set zt_qx='1' where flqx='CC' and flowid_qx=p_flowid and zt_qx='0' ;
  /* if v_ywbmbh <> v_cwywbmbh  then
      errno   := -1;
      errtext := '车位上任务的货主和箱子任务的货主不一致'||v_hqbh||','||p_hqbh;
      Return;
   end if;*/

   if v_cwflowid is null then

     select sq_pmsjhz.nextval into v_cwflowid  from dual;

     insert into t_pmsjhz
       (flowid, rqh, lxbh, kfbh, ywbmbh, yssl, sjsl, zpz,
        zmy, createdate, createczybh, createczyname, sjdate,
        sjczybh, sjczyname, finishdate, finished, bz, zt,
        sjmode, canceldate, cancelczybh, cancelczyname, hqbh, cwh, cwflowid, cwcreate)
     select
        v_cwflowid, p_cwh, lxbh, kfbh, ywbmbh, yssl, sjsl, zpz,
        zmy, createdate, createczybh, createczyname, sjdate,
        p_czybh, (select trim(name)   from  t_user u where u.usr_id=p_czybh  ), finishdate, finished, bz, '1',
        p_sjmode, canceldate, cancelczybh, cancelczyname, hqbh, p_cwh, null, '1'
        from t_pmsjhz where  rqh=p_rqh and hqbh=p_hqbh and ( zt='0' or zt='2');

        insert into t_rqzy
        (bh, zydate, czy, tbname, tableid, note,qx,zylx)
       select    p_cwh, sysdate, null, 't_pmsjhz',
       v_cwflowid, '货区'||trim(mc) ||'小车上架任务','KFSJ','s'
       from t_hqdy where bh=p_hqbh;
   end if ;

   update t_pmsjrwb  set
    sjczybh=p_czybh,id_pmsjhz =v_cwflowid ,id_pmsjhz_old=p_flowid where  id_pmsjhz=p_flowid;

   update t_pmsjhz set  zt='3' , finished='1', cwflowid=v_cwflowid ,sjdate=nvl(sjdate,sysdate)
   ,cwh=p_cwh,sjczybh=p_czybh,sjmode=p_sjmode,sjczyname=
   (select trim(name)   from  t_user u where u.usr_id=p_czybh  )
   where flowid=p_flowid;

   delete t_rqzy where tbname='t_pmsjhz' and tableid=p_flowid;
   
   for cur in (select id from  t_pmsjrwb where id_pmsjhz_old=p_flowid and hwh is null) loop
     
      select min(hw)  into v_hw from  t_sjrecord where id=cur.id and ywbmbh = v_ywbmbh 
       and hqbh=p_hqbh ;
      if v_hw is null then
        select min(hw)  into v_hw from  t_sjrecord where id=cur.id  and ywbmbh = v_ywbmbh;
      end if;

      if v_hw is null then
        select min(l.hw) into v_hw from t_ltkf l where    id = cur.id and
        ywbmbh = v_ywbmbh  and hqbh=p_hqbh
         and  kccs > 0   And rownum = 1;
      end if;
      
      if v_hw is null then
         continue;
      end if ;
      
      update t_pmsjrwb set hwh=v_hw where id_pmsjhz =v_cwflowid and id=cur.id;
   end loop;
  
   
   
    
/*  update t_pmsjhz
  set zt='3' , finished='1' sjdate=nvl(sjdate,sysdate) ,cwh=p_cwh,sjczybh=p_czybh,sjmode=p_sjmode,sjczyname=
   (select trim(name)   from  t_user u where u.usr_id=p_czybh  )
   where rqh=p_rqh and ( zt='0' or zt='2');

 select flowid into p_flowid from t_pmsjhz where   rqh=p_rqh and   zt='1'  ;*/



  errno   := 0;
  errtext := 'ok';

  Return;

Exception
    When Others Then
        errno   := -1;
        errtext := Sqlerrm || 'PROC_OccupyPmsjrwb_QD';
        Rollback;

End PROC_OccupyPmsjrwb_QD;
CREATE OR REPLACE Procedure PROC_KFZYDD_DSFP_XTW_TS

    -- 2010-05-17 yangyi:
    -- 处理特殊订单的订数分配数据, 与普通订单订数分配的区别是
    -- 只涉及普通货区的库存, 不涉及高架库的库存
    -- 在下边的筛选库存的语句中,
    -- 都增加了限制条件: hw<>'GMSAREA'
    -- 一张订单到特殊都特殊, 不存在一部分特殊的情况

    --本过程是订数分配，取立体库房或者t_kcsl取货位，
    --将货位、货区、包装标准、重量等数据写到t_pf_temp，
    --并对t_ltkf或t_kcsl加占用，并对不满足的品种插入到
    --不满足单据表中以返回给商流。在调度时，首先调用本过程，
    --当返回值大于0时，要根据提示是否提交或者继续下一步操作，
    --返回值大于0的，都是因为有的品种不能满足，所以要给出提示
    --是否继续进行调度。执行完本过程后，调用PROC_KFZYDD_XTW进行实际的调度
    --首先读取立库数据，然后再读取存储库
    --对于需要手工拣选的，不能读取立库库存

(v_czybh Char,
 -- V_KFBH char,
 --V_KFLX char,
 V_YWBMBH1 Char,
 V_lxbh    Char,
 v_flag    Char, --0 = 对于不满足的要给出提示，在errtext，1 = 对于不满足的不给提示了
 v_ddfs    Char, --  AP = 按店调度   AD =  按单调度
 errno     Out Number,
 errtext   Out Char)
--订数分配
 As
    errno1             Number;
    v_pf_temp          t_pf_temp%Rowtype;
    v_ltkf             Number(10);
    v_pmsjrwb          Number(10);
    s_error_id         Char(1000); --对于不满足库存的记录下id
    p_djsl             Number(10);
    p_cfbj             Char(1); --拆分标记
    p_hqbh             Char(4);
    p_bccs             Number(10);
    p_flowid_fhrwb_new Number(10);
    d_zl               Number(10, 2);
    p_hw               Char(20);
    p_kcsl             t_kcsl%Rowtype;
    v_bj               Number(4);
    p_jllx             Number(2);
    p_flowid_ys        Number(10);
    V_DHFL             Number(10);
    p_hqlx             Char(2);
    p_hqnm             Char(20);
    v_kfbh             Char(6);
    v_kflx             Char(2);
    V_YWBMBH           Char(6);
    vv_rows            Number(10);
    v_gjkc             Number;
    v_pmkc             Number;
    v_dbbz             Number(9, 2);
    v_xbbz             Number(9, 2);
    v_errtext          Varchar2(4000);
    v_zddhbf char(6);
    v_zddh  char(6);
    v_rows  Number;
Begin

    s_error_id := '下列品种库存不能满足需求，是否继续下达?';
    errno1     := 0;
    If Trim(v_lxbh) = 'FH' Then
        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, FHFS, PFCZYBH, FYFSH, DJ, cgyj, sdhrq, xszq, QSCLFS, fhyxj,
             cgyj_kh, thl, PHBZ, Xz, yx, rq, pk,BDBJ,zddh,ysdjh1)
            Select a.FLOWID_FHRW, a.YSDJH, a.DH, a.ID, a.KFBH, a.YWBMBH, a.CYBH, a.DBBZ,
                   a.XBBZ, a.DJSL, a.FHZK, a.SYLX, a.ZJXS, a.DJLY, a.QSTS, a.FHFS, V_czybh,
                   a.FYFSH, a.DJ, a.cgyj, a.sdhrq, a.xszq, a.qsclfs, a.fhyxj, a.cgyj_kh,
                   a.thl, a.PHBZ, 0,
                   Case
                       When a.dbbz * a.xbbz >= 1 Then
                        '0'
                       Else
                        '1'
                   End, rq, FLOWID_FHRW,nvl(BDBJ,'0'),zddh,ysdjh1
              From T_FHRWB a, t_kcsm b
             Where a.id = b.id And Trim(a.ddczybh) = Trim(v_czybh);
    Elsif Trim(v_lxbh) = 'ST' Then
        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, PHBZ, FHFS, PFCZYBH, FYFSH, DJ, SDHRQ, cgyj, xz, yx, rq, pk,zddh,bdbj)

            Select all_flowid.Nextval, ywpch, HYBH, T_THJH.ID, KFBH, YWBMBH, CYBH, DBBZ,
                   XBBZ, THCS, THZK, T_THJH.SYLX, T_THJH.ZJXS, '2', 0, T_THJH.BZ, ' ',
                   v_czybh, ' ', T_KCSM.DJ, jhrq, cgyj, 0,
                   Case
                       When dbbz * xbbz >= 1 Then
                        '0'
                       Else
                        '1'
                   End, jhrq, all_flowid.Nextval,HYBH,'1'
              From T_THJH, T_KCSM
             Where T_THJH.ID = T_KCSM.ID And Trim(ddczybh) = Trim(v_czybh) And
                   T_THJH.THCS > 0; --and t_thjh.ywbmbh =  v_ywbmbh;

    Elsif Trim(v_lxbh) = 'ZY' Then
        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, PHBZ, FHFS, PFCZYBH, FYFSH, DJ, ZRCYBH, cgyj, xz, rq,pk,BDBJ,zddh)
            Select all_flowid.Nextval, a.jhpch, a.drkfbh, a.ID, a.dcKFBH, a.YWBMBH, a.zcCY,
                   4, 10, a.zycs, b.pjzk, a.sylx, a.zjxs, '1', 0, '', '01', ddczybh, '01',
                   0, a.ZRCY, a.cgyj, 0, jhrq, all_flowid.Nextval,'1',drkfbh
              From T_zyjh a, t_kcsm_ywbm b
             Where a.id = b.id And Trim(a.ddczybh) = Trim(v_czybh) And a.zycs > 0;
    Else
        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, PHBZ, FHFS, PFCZYBH, FYFSH, DJ, ZRCYBH, cgyj, xz, rq, pk,BDBJ,zddh)
            Select all_flowid.Nextval, A.ywpch, A.kfbh, A.ID, A.KFBH, A.YWBMBH, A.cybh,
                   B.DBBZ, B.XBBZ, A.bfcs, A.bfzk, B.sylx, DECODE(B.SYLX, '1', 100, B.DJ),
                   '1', 0, '', '01', A.ddczybh, '1', B.DJ, A.cybh, A.cgyj, 0, bfrq,
                   all_flowid.Nextval,'1', A.kfbh
              From T_BFJHMX A, T_KCSM B
             Where Trim(ddczybh) = Trim(v_czybh) And A.ID = B.ID And BFCS > 0;
    End If;
--return;
    For c1 In (Select * From t_pf_temp Where pfczybh = v_czybh Order By ywbmbh, id)
    Loop

        Select *
          Into v_pf_temp
          From t_pf_temp
         Where t_pf_temp.flowid_fhrw = c1.flowid_fhrw;

        v_ywbmbh := c1.ywbmbh;
        v_kfbh   := c1.kfbh;

        Select kflx Into v_kflx From t_dm Where dh = v_kfbh;
        p_flowid_ys := c1.flowid_fhrw;
        Select nvl(Sum(yssl), 0)
          Into v_pmsjrwb
          From t_pmsjrwb
         Where id = c1.id And ywbmbh = v_ywbmbh And kfbh = v_kfbh;

        Select NVL(Sum(JHFLCS), 0)
          Into V_DHFL
          From T_DHFL1
         Where id = c1.id And ywbmbh = v_ywbmbh And kfbh = v_kfbh;

        If v_kflx = 'LK' Then

            --如果是立库
          /*  Select NVL(Sum(kccs - nvl(zycs, 0)), 0)
              Into v_ltkf
              From t_ltkf
             Where id = c1.id And kfbh = v_kfbh And ywbmbh = v_ywbmbh And hw <> 'GMSAREA';*/
  Select nvl(Sum(kccs - nvl(zycs, 0)), 0) Into v_ltkf
              From t_ltkf l,   t_hqdy q
             Where l.hqbh = q.bh and id = c1.id And l.kfbh = v_kfbh And l.ywbmbh = v_ywbmbh And l.cybh = c1.cybh
          and hqlx not in (decode(Trim(v_lxbh), 'FH', 'DT', 'x') );

            p_djsl := c1.djsl;

            If p_djsl > 0 And V_LTKF > 0 Then
               /*Select *  From t_ltkf
                            Where id = c1.id And kfbh = v_kfbh And ywbmbh = v_ywbmbh And
                                  hw <> 'GMSAREA' And (kccs - nvl(zycs, 0)) > 0
                                  and exists( select 1 from t_hwdy a where not exists(select 1 from t_hqdy b where hqlx in ('DT') and bh=a.hqbh) and hw=t_ltkf.hw)
                            Order By (kccs - nvl(zycs, 0)) Desc*/
                For c2 In (
                  select id, l.hw, l.kfbh, l.dbbz, l.xbbz, l.ywbmbh, l.cybh, kccs, zycs, zl
                      from t_ltkf l,   t_hqdy q
                     where  l.hqbh = q.bh
                       and l.id = c1.id
                       And l.kfbh = v_kfbh
                       And l.cybh = c1.cybh
                       And l.ywbmbh = v_ywbmbh
                       And (kccs - nvl(zycs, 0)) > 0
                       and hqlx not in (decode(Trim(v_lxbh), 'FH', 'DT','x')  ,'LK' )

                     order by hqyxj desc, (kccs - nvl(zycs, 0)) Desc
                  )
                Loop

                    If c2.zycs Is Null Then
                        c2.zycs := 0;
                    End If;

                    -- 取得相应的货区
                    Select hqbh
                      Into p_hqbh
                      From t_hwdy
                     Where hw = c2.hw And kfbh = c2.kfbh;

                    -- 取得相应货区的接力类型及货区类型
                    Select nvl(jllx, 0), hqlx
                      Into p_jllx, p_hqlx
                      From t_hqdy
                     Where bh = p_hqbh;

                    p_hqnm := '散货区';
                    If p_djsl <= (c2.kccs - c2.zycs) Then
                        p_bccs := p_djsl;
                        p_djsl := 0;
                        p_cfbj := '0';
                    Else
                        p_bccs := (c2.kccs - c2.zycs);
                        p_djsl := p_djsl - p_bccs;
                        p_cfbj := '1';
                    End If;

                    Update t_pf_temp
                       Set hw = c2.hw, dbbz = c2.dbbz, xbbz = c2.xbbz, hqbh = p_hqbh,
                           djsl = p_bccs, zl = c2.zl, jllx = p_jllx, xz = 1, hqlx = p_hqnm
                     Where flowid_fhrw = c1.flowid_fhrw;

                    Update t_ltkf
                       Set zycs = nvl(zycs, 0) + p_bccs
                     Where id = c1.id And hw = c2.hw And kfbh = c2.kfbh And
                           dbbz = c2.dbbz And xbbz = c2.xbbz And ywbmbh = c2.ywbmbh And
                           zl = c2.zl;

                    Update t_kcsl
                       Set zycs = nvl(zycs, 0) + p_bccs
                     Where id = c1.id And kfbh = C2.kfbh And ywbmbh = C2.ywbmbh And
                           cybh = C2.cybh;

                    If p_cfbj = '1' Then
                        Select all_flowid.Nextval Into p_flowid_fhrwb_new From dual;
                        Insert Into t_pf_temp
                            (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz,
                             djsl, fhzk, sylx, zjxs, djly, qsts, phbz, fyfsh, fhfs,
                             pfczybh, dj, zrcybh, cgyj, sdhrq, zl, FHYXJ, XSZQ, cgyj_kh,
                             thl, jllx, QSCLFS, xz, yx, pk,BDBJ,zddh,ysdjh1)
                            Select p_flowid_fhrwb_new, ysdjh, dh, id, kfbh, ywbmbh, cybh,
                                   dbbz, xbbz, p_djsl, fhzk, sylx, zjxs, djly, qsts, phbz,
                                   fyfsh, fhfs, v_czybh, dj, zrcybh, cgyj, sdhrq, zl,
                                   FHYXJ, XSZQ, cgyj_kh, thl, jllx, QSCLFS, 0, yx,
                                   p_flowid_fhrwb_new,BDBJ,zddh,ysdjh1
                              From t_pf_temp
                             Where flowid_fhrw = c1.flowid_fhrw;
                        c1.flowid_fhrw := p_flowid_fhrwb_new;
                    End If;
                    If p_djsl = 0 Then
                        Exit;
                    End If;
                End Loop;
            End If;

            If P_DJSL > 0 Then

                If v_ddfs = 'AD' Then

                    Select nvl(Sum(yssl), 0)
                      Into v_pmkc
                      From t_pmsjrwb
                     Where id = v_pf_temp.id And kfbh = v_pf_temp.kfbh And
                           ywbmbh = v_pf_temp.ywbmbh And cybh = v_pf_temp.cybh;
                    Select nvl(Sum(kccs - zycs), 0), Min(dbbz), Min(xbbz), Min(zl)
                      Into v_gjkc, v_dbbz, v_xbbz, d_zl
                      From t_ltkf
                     Where id = v_pf_temp.id And kfbh = v_pf_temp.kfbh And
                           ywbmbh = v_pf_temp.ywbmbh And cybh = v_pf_temp.cybh And
                           hw = 'GMSAREA';

                    --平面上架没有待上架的册数的非不齐不要的订单
                    If v_pmkc <= 0 And
                       (Trim(C1.QSCLFS) <> '2' And Trim(C1.QSCLFS) <> '3') Then

                        If v_gjkc > 0 Then

                            Select least(p_djsl, v_gjkc) Into p_bccs From dual;
                            Select greatest(0, p_djsl - v_gjkc) Into p_djsl From dual;

                            Select Min(bh) Into p_hqbh From t_hqdy Where hqlx = 'GJ';

                            Update t_pf_temp
                               Set hw = 'GMSAREA', dbbz = v_dbbz, xbbz = v_xbbz,
                                   hqbh = p_hqbh, djsl = p_bccs, zl = d_zl, jllx = '0',
                                   xz = 1, hqlx = '高架区'
                             Where flowid_fhrw = c1.flowid_fhrw;
                            -- 2010-07-15 yangyi:
                            -- 因为在wms系统中对于高架库来说一书只有一位
                            -- 而且每次入库都更新dbbz,xbbz,zl
                            -- 所以, 这里在占用库存时, 不应加dbbz,xbbz,zl的条件,
                            -- 否则, 有可能就会占用不上了(刚读出来高架库就更新了).
                            -- 同样, 在高架库下架时, 也不按dbbz,xbbz,zl三个条件
                            -- 来冲减库存
                            Update t_ltkf
                               Set zycs = nvl(zycs, 0) + p_bccs
                             Where id = v_pf_temp.id And hw = 'GMSAREA' And
                                   kfbh = v_pf_temp.kfbh And
                                  --dbbz = v_dbbz and xbbz = v_xbbz and
                                   ywbmbh = v_pf_temp.ywbmbh And
                                  --zl = d_zl and
                                   cybh = v_pf_temp.cybh;

                            Update t_kcsl
                               Set zycs = nvl(zycs, 0) + p_bccs
                             Where id = v_pf_temp.id And kfbh = v_pf_temp.kfbh And
                                   ywbmbh = v_pf_temp.ywbmbh And cybh = v_pf_temp.cybh;

                        End If;

                        --高架库能够全部满足的非不齐不要订单（(TRIM(C1.QSCLFS) <>'2' and TRIM(C1.QSCLFS) <> '3')）
                    Elsif p_djsl <= v_gjkc And
                          (Trim(C1.QSCLFS) <> '2' And Trim(C1.QSCLFS) <> '3') Then

                        p_bccs := p_djsl;
                        p_djsl := 0;

                        Select Min(bh) Into p_hqbh From t_hqdy Where hqlx = 'GJ';

                        Update t_pf_temp
                           Set hw = 'GMSAREA', dbbz = v_dbbz, xbbz = v_xbbz, hqbh = p_hqbh,
                               djsl = p_bccs, zl = d_zl, jllx = '0', xz = 1, hqlx = '高架区'
                         Where flowid_fhrw = c1.flowid_fhrw;

                        Update t_ltkf
                           Set zycs = nvl(zycs, 0) + p_bccs
                         Where id = v_pf_temp.id And hw = 'GMSAREA' And
                               kfbh = v_pf_temp.kfbh And cybh = v_pf_temp.cybh And
                               ywbmbh = v_pf_temp.ywbmbh;

                        Update t_kcsl
                           Set zycs = nvl(zycs, 0) + p_bccs
                         Where id = v_pf_temp.id And kfbh = v_pf_temp.kfbh And
                               ywbmbh = v_pf_temp.ywbmbh And cybh = v_pf_temp.cybh;

                    Elsif v_pmkc + v_gjkc > 0 Then

                        errno   := -1444;
                        errtext := '该单据中有的品种还没有上架(' || Trim(to_char(v_pmkc)) || ')或在高架区(' ||
                                   Trim(to_char(v_gjkc)) || ')上，暂不能进行调度!' ||
                                   Trim(v_pf_temp.id) || '-' || to_char(p_djsl);
                        Rollback;
                        Return;

                    End If;

                    --按单调度,退货等都是按单调度
                 /*   If Trim(C1.QSCLFS) = '2' Or Trim(C1.QSCLFS) = '3' Then
                        errtext := '此为特殊订单，库存不足不能下达';
                        ERRNO   := -1333;
                        Rollback;
                        Return;*/
                    if p_djsl > 0 Then

                        --2011-11-07 modify by lv 将pfczybh插入到rkbh中
                        --2012-04-14 modify by lv 为第三方物流修改
                        Insert Into t_wl_bmzdj
                            (ysdjh, ywbmbh, dh, ckbh, rkbh, id, cs, sjkcs, qsclfs, lx,
                             FLOWID, bz, receflag, sendbmbh, senddate, recebmbh, zk,
                             djbh_sl)
                            Select cgyj, ywbmbh, dh, v_kfbh, pfczybh, id, p_djsl, 0,
                                   Trim(qsclfs), v_lxbh, flowid_fhrw, '调度时库存不足', '0', cybh,
                                   Sysdate, v_ywbmbh, fhzk, ysdjh
                              From t_pf_temp
                             Where flowid_fhrw = c1.flowid_fhrw;

                        --                      insert into t_wl_bmzdj
                        --                          (ysdjh, ywbmbh, dh, ckbh, rkbh, id, cs, sjkcs, qsclfs, lx, FLOWID, bz, receflag, sendbmbh, senddate, recebmbh, zk)
                        --                          select cgyj, ywbmbh, dh, v_kfbh, '', id, p_djsl, 0, trim(qsclfs), v_lxbh, flowid_fhrw, '库存不足', '0', cybh, sysdate, v_ywbmbh, fhzk
                        --                            from t_pf_temp
                        --                           where flowid_fhrw = c1.flowid_fhrw;
                    End If;
                Else
                    --按店调度
                    /*    INSERT INTO T_RWDD_QSMX_XTW(ysdjh,ywbmbh,dh,ckbh,rkbh,id,cs,sjkcs,qsclfs,lx,FLOWID,bz,
                    receflag,sendbmbh,senddate,recebmbh,zk,DDCZYBH,cgyj,cgyj_kh,SYLX)
                    select ysdjh,ywbmbh,dh,v_kfbh,'',id,P_DJSL,(C1.djsl - P_DJSL),trim(QSCLFS),v_lxbh,p_flowid_ys,'库存不足',
                    '0',cybh,sysdate,v_ywbmbh,fhzk,V_CZYBH,cgyj,cgyj_kh,SYLX*/
                    Insert Into t_pf_temp_QS_XTW
                        (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl,
                         fhzk, sylx, zjxs, djly, qsts, phbz, fyfsh, fhfs, pfczybh, dj,
                         zrcybh, cgyj, sdhrq, zl, FHYXJ, XSZQ, cgyj_kh, thl, jllx, QSCLFS,
                         xz, PMSJRWB, DHFL, LTKF, pk)
                        Select --p_flowid_fhrwb_new
                         all_flowid.Nextval, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz,
                         p_djsl, fhzk, sylx, zjxs, djly, qsts, phbz, fyfsh, fhfs, v_czybh,
                         dj, zrcybh, cgyj, sdhrq, zl, FHYXJ, XSZQ, cgyj_kh, thl, jllx,
                         QSCLFS, 0, v_pmsjrwb, V_DHFL, v_ltkf, all_flowid.Nextval
                          From t_pf_temp
                         Where flowid_fhrw = c1.flowid_fhrw;
                End If;
            End If;

        Else
            --如果出库是样本室
            Select zl Into d_zl From t_kcsm Where id = c1.id;
            Select *
              Into p_kcsl
              From t_kcsl
             Where id = c1.id And kfbh = v_kfbh And ywbmbh = v_ywbmbh;
            If p_kcsl.zycs Is Null Then
                p_kcsl.zycs := 0;
            End If;
            If P_djsl > (p_kcsl.kccs - p_kcsl.zycs) Then
                p_bccs := p_kcsl.kccs - p_kcsl.zycs;
                P_djsl := P_djsl - p_bccs;

            Else
                p_bccs := P_djsl;
                P_djsl := 0;

            End If;
            If P_djsl > 0 Then
                /*         INSERT INTO T_RWDD_QSMX_XTW(ysdjh,ywbmbh,dh,ckbh,rkbh,id,cs,sjkcs,qsclfs,lx,FLOWID,bz,
                receflag,sendbmbh,senddate,recebmbh,zk,DDCZYBH)
                select cgyj,ywbmbh,dh,v_kfbh,'',id,P_DJSL,(C1.djsl - P_DJSL),trim(QSCLFS),v_lxbh,flowid_fhrw,'库存不足',
                '0',cybh,sysdate,v_ywbmbh,fhzk,V_CZYBH
                from t_pf_temp
                where flowid_fhrw = c1.flowid_fhrw;  */

                --2011-11-07 modify by lv 将pfczybh插入到rkbh中
                --2012-04-14 modify by lv 为第三方物流修改
                Insert Into t_wl_bmzdj
                    (ysdjh, ywbmbh, dh, ckbh, rkbh, id, cs, sjkcs, qsclfs, lx, FLOWID, bz,
                     receflag, sendbmbh, senddate, recebmbh, zk, djbh_sl)
                    Select cgyj, ywbmbh, dh, v_kfbh, pfczybh, id, p_djsl, 0, Trim(qsclfs),
                           v_lxbh, flowid_fhrw, '调度时库存不足', '0', cybh, Sysdate, v_ywbmbh,
                           fhzk, ysdjh
                      From t_pf_temp
                     Where flowid_fhrw = c1.flowid_fhrw;

                --                insert into t_wl_bmzdj
                --                    (ysdjh, ywbmbh, dh, ckbh, rkbh, id, cs, sjkcs, qsclfs, lx, FLOWID, bz, receflag, sendbmbh, senddate, recebmbh, zk)
                --                    select cgyj, ywbmbh, dh, v_kfbh, '', id, p_djsl, 0, trim(qsclfs), v_lxbh, flowid_fhrw, '库存不足', '0', cybh, sysdate, v_ywbmbh, fhzk
                --                      from t_pf_temp
                --                     where flowid_fhrw = c1.flowid_fhrw;
            End If;
            Update t_pf_temp
               Set hw = p_kcsl.hw, zl = d_zl, djsl = p_bccs, xz = 1
             Where flowid_fhrw = c1.flowid_fhrw;
            If p_bccs = 0 Then
                Delete From t_pf_temp Where flowid_fhrw = c1.flowid_fhrw;

            End If;
            Update t_kcsl
               Set zycs = nvl(zycs, 0) + p_bccs
             Where id = p_kcsl.id And kfbh = p_kcsl.kfbh And ywbmbh = p_kcsl.ywbmbh And
                   cybh = p_kcsl.cybh;

        End If;

    End Loop;

    if V_lxbh ='FH' then
        for cur in (Select dh From t_pf_temp Where pfczybh = v_czybh and YWBMBH='000001' group by dh) loop
           Select Count(*)   Into v_rows  From  t_guizu_fl
            Where dh =cur.dh And  enable = '1';
            if v_rows =0 then
             continue;
            end if;
           select min(gzbh) into v_zddhbf  from t_guizu_fl  where  dh=cur.dh;
           for cur2 in (select flowid_fhrw,s.fl from  t_pf_temp p,t_kcsm  s Where pfczybh = v_czybh and YWBMBH='000001'
               and dh=cur.dh and p.id=s.id) loop


                Select min(gzbh) into v_zddh
                 From  t_guizu_fl c
                Where flbh=cur2.fl And dh = cur.dh;
                if v_zddh is null then
                   update t_pf_temp set zddh=v_zddhbf where flowid_fhrw=cur2.flowid_fhrw;
                else
                  update t_pf_temp set zddh=v_zddh where flowid_fhrw=cur2.flowid_fhrw;
                end if ;


           end loop;
       end loop;
    end if;
    --  if v_kflx ='LK' then
    Delete From t_pf_temp
       Where pfczybh = v_czybh And hqbh Is Null And Exists
            (Select * From t_dm Where dh = t_pf_temp.kfbh And kflx = 'LK');

    --end if;
    Delete From t_pf_temp_back Where pfczybh = v_czybh;
    Insert Into t_pf_temp_back
        (pfczybh, id, cs)
        Select v_czybh, id, Sum(djsl) From t_pf_temp Where pfczybh = v_czybh Group By id;

    Insert Into t_pf_temp_xtw
        Select * From t_pf_temp;
    If errno1 = 0 Then
        errno   := 0;
        errtext := 'OK';
    Else
        errno   := errno1;
        errtext := s_error_id;
    End If;

Exception
    When Others Then
        ERRNO   := v_bj;
        v_ERRTEXT := Sqlerrm;
        ERRTEXT := Sqlerrm;
        Rollback;
End PROC_KFZYDD_DSFP_XTW_TS;
CREATE OR REPLACE Procedure "PROC_CANEL_FLRW"
(p_mac            CHAR, --拆包台编号
 p_czy            Char,--登录人
 p_flowid            CHAR,--任务号
 errno           Out Number,
 errtext         Out Varchar2) As
    v_cbt  Char(4);
    v_name Char(10);
    v_rows Number;
    v_zybj number;
Begin
  -- 先判断登录人是否为管理员
  v_zybj:=0;

  -- 判断分流人员当天取消的任务数量，大于4条 进行提示限制

  select count(*) into v_rows from t_group_user  where groupbh =1
  and user_id=p_czy;
  if  v_rows=0  then
    select count(*) into v_rows  from t_flrw_canel WHERE  flczy = p_czy and  trunc(flqxrq) = trunc(SYSDATE);
   If v_rows >= 20 Then
        errno   := -1;
        errtext := '当天取消任务数已经超过限制！';
        Rollback;
        Return;
    End If;
  end if;
  -- 更新相关任务表
    Update t_cbt Set djbh = null, zt = '0', CZY = null  Where  djbh = p_flowid;

   -- UPDATE t_tldjhz SET fl_czy =null WHERE flowid_tldjhz = p_flowid;

    UPDATE t_dhfltask SET  flczybh=null ,flczyname=null,zt='3',mac =null
    ,canceldate=sysdate,cancelczybh=p_czy,
    cancelczyname=( select trim(name) from t_user where usr_id=p_czy )
      WHERE flowid_tldjhz = p_flowid and  zt='2';
    if sql%notfound then
       errno   := -1;
        errtext := '未更新，请刷新重试！';
        Rollback;
        Return;
    end if;
    --插入取消任务备份表 t_flrw_canel
    INSERT INTO t_flrw_canel(flowid,FLCZY,mac,flqxrq)
    VALUES
    (p_flowid,p_czy,p_mac,SYSDATE);


    ERRNO   := 0;
    ERRTEXT := 'ok';
    Return;
Exception
    When Others Then
        ERRNO   := -1;
        ERRTEXT := 'PROC_CANEL_FLRW' || Sqlerrm;
        Rollback;
        Return;
End PROC_CANEL_FLRW;
CREATE OR REPLACE Procedure RF_DHFL_TJ
--------------$active$---------------------
    -- 此过程为山西翻理台分流整运号提交处理
    -- 思路: 循环tmp_dhmx 这个运号的
    --
    --       从t_dhfl1中取得所有实际分流数, 记入tmp_dhmx.djshsl,
    --       从t_dhfl1中取得FLQX='ST'所有实际分流数, 记入tmp_dhmx.pssl
    --       将t_sj_yfsj中的所有yqbzqcs=0的且分过流的记录,全部写入t_fhrwb
    --       形成t_dhls_jx(对未分过流的要生成书目信息)
    --       循环结束
    --       2011-11-18 升级
    --       根据t_dhls_jx形成t_dhdj及上报商流的到货表数据
    --       删除t_dhfl1中的数据及t_sl_yfsj中的数据
(p_flowid_tldjhz Number,
p_czy Char,
 errno           Out Number,
 errtext         Out Varchar2) As
    v_rows   Number;
    v_zjxs   Number;
    v_zcs number;

    v_gzlmy number;
    v_gzlcs number;
    v_ysjs  number;
    v_yssl number;
    v_zddh char(6);
    v_wlsh t_wlsh%rowtype;
    v_gzjls   Number;
    v_djsl    Number;
    v_Addflag Char(1);
    v_flcs    Number;
Begin
  v_gzlmy:=0;
  v_gzlcs:=0;


    select Count(*) Into v_rows from t_dhfltask where flowid_tldjhz = p_flowid_tldjhz
    and  finished='0' ;
    If v_rows = 0 Then
        errno   := -12;
        errtext := '运号内部码不存在或已分流确认!' || to_char(p_flowid_tldjhz);
        Rollback;
        Return;
    End If;

    select * into v_wlsh from t_wlsh where id=p_flowid_tldjhz;

    select count(*) into v_rows from
    (  select flowid_dhmx ,bdcs from tmp_dhmx x,tmp_dhdj j where flowid_tldjhz=p_flowid_tldjhz
       and x.flowid_dj=j.flowid_dj) t1,

    ( select flowid_dhmx, sum(sjsl) yfsj from t_dh_yfsj y ,tmp_dhdj j where
        y.flowid_tldjhz=p_flowid_tldjhz and y.flowid_dj=j.flowid_dj  group by flowid_dhmx) t2
   where t1.flowid_dhmx=t2.flowid_dhmx and bdcs >yfsj;
   if v_rows> 0 then
      errno   := -1;
        errtext := p_flowid_tldjhz||'存在册数不符情况';
        Return;
   end if ;

 -- t_dhfltask  0:未领取   1:已领取  2:正在分流   3:开始分流,已取消   4:完成,,9:分流任务异常
    update t_dhfltask set zt='4',finishdate=sysdate,finished='1' where  flowid_tldjhz = p_flowid_tldjhz and zt='2';
    if sql%notfound then
        errno   := -1;
        errtext := p_flowid_tldjhz||'任务已提交或不存在';
        Return;
    end if ;

    for curDj in( select flowid_dj ,cybh,kfbh,ywbmbh ,ysdj,sl,ghdwh from tmp_dhdj where flowid_tldjhz=p_flowid_tldjhz and  nvl(zfzd,'0')<>'1')

    loop
       v_gzjls := 0;
       v_djsl  := 0;
       For c1 In (Select  flowid_dhmx,   id,yssl,bdcs,pssl, dbbz,xbbz, tm,xszq,fhzk, x.zz,x.kb,x.tm_flag
               ,x.fl, x.isbn, x.sm, x.dj, x.sylx, x.jhzk, x.bc, x.yc, x.cbny, x.bz, x.yz, x.bb, x.sl
                 From tmp_dhmx x
                Where  flowid_dj =  curDj.flowid_dj )
        Loop


    ---------------



       Select Count(*) Into v_rows From t_dhls_jx Where flowid_dhmx=c1.flowid_dhmx;
        If v_rows>0 Then

            Select djshsl Into v_yssl From t_dhls_jx Where flowid_dhmx=c1.flowid_dhmx;

            -- 对已有记录，将破损数或拒收数写入t_dhls_jx.pscs中，以便后期备查
            -- 对新增记录，在分流差异处理时，再将pscs写到正式到货的记录中。
            Update t_dhls_jx Set pssl=c1.pssl Where flowid_dhmx=c1.flowid_dhmx;
            Update t_dhls_jx@c_link_wl_sl Set pssl=c1.pssl Where flowid_dhmx=c1.flowid_dhmx;

           v_Addflag := '0';
        Else
           v_yssl := 0;
           v_Addflag := '1';
        End If;

        -- 如果到货分流结果与原单有差异，则生成到货更正计划数据：
        -- 到货分流后出现差异，只能改变原记录的实际数量，不能修改其它项目
        If c1.bdcs<>v_yssl Then

            -- gzlx=0, 表示更正折扣, gzlx=1表示更正货源或者税率更正
            -- addflag=1, 表示为到货分流中新增的到货记录
            -- dhflflag=1，表示为到货分流生成的更正计划，正常的更正处理将不涉及此类更正计划
            Insert Into t_sl_dhgzjh@c_link_wl_ex
              (flowid_dj, flowid_dhmx, ysdj, shrq, ghdwh,
               isbn, sm, dj, sylx, jhzk, bc, yc, cbny, bz, yz, bb, fl,
               tm_flag, kb, zz, sl, ghdw, receflag, sendbmbh, senddate, recedate,
               flowid_dhmx_old, yssl, xsl, jtjzrq, fhzk, xszq, tm, id, gzlx, remark, newsl, addflag, dhflflag)
            Values
              (curDj.flowid_dj, c1.flowid_dhmx, curDj.ysdj, Null, curDj.ghdwh,
               c1.isbn, c1.sm, c1.dj, c1.sylx, c1.jhzk, c1.bc, c1.yc, c1.cbny, c1.bz, c1.yz, c1.bb, c1.fl,
               c1.tm_flag, c1.kb, c1.zz, curDj.sl, curDj.ghdwh, '0',  curDj.cybh, Sysdate, Null,
               c1.flowid_dhmx, v_yssl, c1.bdcs, Null, c1.fhzk, c1.xszq, c1.tm, c1.id, '0', '到货分流差异',
               curDj.sl, v_addflag, '1');

            v_gzjls := v_gzjls + 1;
            v_djsl  := v_djsl + c1.yssl;

            -- 原记录置更正占用标记：
            If v_Addflag = '0' Then
               Update t_dhls_jx Set gzbj='8' Where flowid_dhmx=c1.flowid_dhmx;
            End If;

         End If;

    -- 如果该品种除破损以外分流过,
            -- 将除已经去往包装区的分配数外的其它任务,
            -- 全部转入t_fhrwb, 为调度做准备
            -- 注意: 即使本次到货数不能满足所有待分配数,
            --       也转入t_fhrwb,因为库存有可能能够满足
            -- 如果该品种除破损以外分流过, 将t_sl_yfsj中YQBZQCS=0的记录全部写入t_fhrwb:

         if c1.bdcs-c1.pssl>0 then
            -- 因为t_sl_yfsj.ysdjh是个varchar型的,
                -- 所以在下边的语句中要用substrb(trim(t_sl_yfsj.ysdjh)||'            ',1,12)
                -- t_sl_yfsj.ysdjh保存的是t_dpls.dbdh, 根据这个值从t_dpls中取得tdpch
                -- 写入t_fhrwb中.
                --
                -- 需要特别注意的是调度程序, 必须按ysdjh+dh来判断是否为同一张单据
                -- 2011-03-04 yangyi: 新增【单独成单标记】bdbj,【配货备注】phbz
                --2011-06-27 修改 lb 将条件nvl(YQBZQCS,0) = 0 改为 nvl(yfsl,0) - nvl(YQBZQCS,0) >0
                --插入册数改为nvl(yfsl,0) - nvl(YQBZQCS,0),因为存在部分不去包装区的情况
                select count(*) into v_rows from t_dh_yfsj where flowid_dhmx =c1.flowid_dhmx ;
                if v_rows = 0 then
                     insert into t_dh_yfsj
                      (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx,ywbmbh,
                      flqxmc, detailqx,  cgyj, cgyj_kh,djly,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch)
                        select   flowid_yfsj,  flowid, flowid_dj, dh, c1.id, yfsl, 0, null,v_wlsh.ywbmbh, null, null,
                          ysdjh, trim(cgyj_kh) ,DJLY,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch
                       from t_sl_yfsj  Where flowid = c1.flowid_dhmx ;

                     if v_wlsh.fllx='PT' then
                        for cur in (select flowid,dh from t_dh_yfsj where  flowid_dhmx = c1.flowid_dhmx  ) loop
                             Select min(gzbh) into v_zddh
                             From  t_guizu_fl c
                            Where flbh=c1.fl And dh = cur.dh;
                            if v_zddh is null then
                              select min(gzbh) into v_zddh  from t_guizu_fl  where  dh=cur.dh;
                            end if ;
                            update t_dh_yfsj set zddh=v_zddh  where flowid =cur.flowid;
                        end loop;
                     end if ;

                end if;

                Insert Into t_fhrwb
                    (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl,
                     fhzk, sylx, zjxs, djly, qsts, QSCLFS, FYFSH, FHFS, DJ, KJXBJ, FHYXJ,
                     QSDS, RQ, sdhrq, yxrq, cgyj, cgyj_kh,  bdbj, phbz,sl,zddh)
                    Select all_flowid.Nextval /*flowid_yfsj*/,
                           (Select Min(tdpch)
                               From t_dpls
                              Where trim(dbdh) = t.cgyj ),
                           dh, id, curDj.kfbh, curDj.ywbmbh, curDj.cybh, c1.dbbz,
                           c1.xbbz,  yfsl - sjsl , fhzk, c1.sylx,
                           v_zjxs, djly, 0, qsclfs, '01' ,   '01' ,
                           c1.dj, '1', YXJ, 0, Sysdate, SDHRQ, (Sysdate + 30), cgyj,
                           cgyj_kh,
                           (Select nvl(t_dpls.spbj, '0')   From t_dpls   Where  trim(dbdh) =  t.cgyj),
                           (Select t_dpls.note_gp  From t_dpls  Where trim(dbdh) =  t.cgyj),
                           c1.sl,zddh
                      From t_dh_yfsj t
                     Where flowid_dhmx = c1.flowid_dhmx And  yfsl-sjsl > 0 and (flqx='FH' or flqx='ZP');
         else
             -- 如果该品种没分流过, 将t_sl_yfsj中的记录全部写入t_wl_bmzdj:
                -- 并将类型(LX)置为'XX', 商流将据此将t_dpls相应记录的状态恢复
                -- 为未分书状态(参见商流proc_get_bmzdj)
                Insert Into t_wl_bmzdj
                    (YSDJH, YWBMBH, DH, CKBH, RKBH, ID, CS, SJKCS, QSCLFS, RQ, LX, FLOWID,
                     BZ, SENDBMBH, SENDDATE, RECEBMBH, RECEFLAG, ZK)
                    Select ysdjh, curDj.ywbmbh, dh, curDj.kfbh, '', id, yfsl, 0, qsclfs,
                           Sysdate, 'XX', flowid_yfsj, '到货分流时未发现该品种', cybh, Sysdate,
                           curDj.ywbmbh, '0', fhzk
                      From t_sl_yfsj
                     Where flowid = c1.flowid_dhmx;
         end if;



    End Loop;

          -- 更正计划来源：1/物流，2/B2B，3/直发单收货差异
      If v_gzjls>0 Then
          Insert Into t_sl_dhgzjh_hz@c_link_wl_ex
            (flowid_dj, djsl, jls, zjs, sendbmbh, senddate, recebmbh, recedate, reason, receflag, gzczy, djly, dhflflag)
          Values
            (curDj.flowid_dj, v_djsl, v_gzjls, 1, curDj.cybh, Sysdate, curDj.ywbmbh, Null, '到货分流差异', '0', p_czy, '1', '1');
      Else
          -- 若无差异，则将gzbj置为0，解除对正常更正的限制。
          Update t_dhdj Set gzbj='0' Where flowid_dj=curDj.flowid_dj;
          Update t_dhdj@c_link_wl_sl Set gzbj='0' Where flowid_dj=curDj.flowid_dj;
          Update t_dhdj_cf@c_link_wl_sl Set gzbj='0' Where flowid_dj=curDj.flowid_dj;
      End If;

      -- 2017-08-03 add by yangyi:
      -- 商流的tmp_dhmx/tmp_dhdj由 物流分流结束后删除，商流不再进行删除处理
      -- 商流接物流到货时，物流还未做分流，如果此时删除，将无法进行补样处理
      insert into tmp_dhdj_bak@c_link_wl_sl select * from tmp_dhdj@c_link_wl_sl where flowid_dj=curDj.flowid_dj;
      insert into tmp_dhmx_bak@c_link_wl_sl select * from tmp_dhmx@c_link_wl_sl where flowid_dj=curDj.flowid_dj;
      delete from tmp_dhdj@c_link_wl_sl where flowid_dj=curDj.flowid_dj;
      delete from tmp_dhmx@c_link_wl_sl where flowid_dj=curDj.flowid_dj;

    end loop;

    -- 循环tmp_dhmx当前运号的到货明细:



   -- Update t_tldjhz Set flbj = '1', flrq = Sysdate Where flowid_tldjhz = p_flowid_tldjhz;
    -- 临时表数据备份及删除:
    For c3 In (Select flowid_dj From tmp_dhdj Where flowid_tldjhz = p_flowid_tldjhz and  nvl(zfzd,'0')<>'1')
    Loop

        Insert Into tmp_dhmx_xtw
            Select * From tmp_dhmx Where flowid_dj = c3.flowid_dj;
        Delete From tmp_dhmx Where flowid_dj = c3.flowid_dj;

        insert into t_dh_yfsj_bak
        (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx, flqxmc, detailqx, active,
        cgyj, cgyj_kh, finished, djly, fhzk, sdhrq, yxj, hw, xh, qsclfs, flowid_tldjhz, zddh, hqbh,
        ddcdbj, tdpch, ttbz, dhzxid, isgz, isgp, nxtzxid, line, ywbmbh)

       select flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx, flqxmc, detailqx, active,
        cgyj, cgyj_kh, finished, djly, fhzk, sdhrq, yxj, hw, xh, qsclfs, flowid_tldjhz, zddh, hqbh,
        ddcdbj, tdpch, ttbz, dhzxid, isgz, isgp, nxtzxid, line, ywbmbh
         from t_dh_yfsj Where flowid_dj = c3.flowid_dj;

        Delete From T_DH_YFSJ Where flowid_dj = c3.flowid_dj;

       Insert Into t_sl_yfsj_bak
            Select * From t_sl_yfsj Where flowid_dj = c3.flowid_dj;
        Delete From t_sl_yfsj Where flowid_dj = c3.flowid_dj;



        Insert Into t_flrqh_bak
            Select * From t_flrqh Where flowid_dj = c3.flowid_dj;
        Delete From t_flrqh Where flowid_dj = c3.flowid_dj;

        --delete t_linehw_dhmx where flowid_dj = c3.flowid_dj;
    End Loop;

    Insert Into tmp_dhdj_xtw
        Select * From tmp_dhdj Where flowid_tldjhz = p_flowid_tldjhz and  nvl(zfzd,'0')<>'1';
    Delete From tmp_dhdj Where flowid_tldjhz = p_flowid_tldjhz and  nvl(zfzd,'0')<>'1';


    select ssjs into v_ysjs from t_wlsh where id=p_flowid_tldjhz;
      Insert Into t_gzl
        (czybh, czlx, czrq, jls, cs, my, js, flowid,TABLE_NAME,FLOWID_TABLE,YWBMBH,PROC_NAME)
    Values
        (p_czy, 'DHFL', Sysdate, 1, v_gzlcs, v_gzlmy, v_ysjs,
         all_flowid.Nextval,'t_wlsh',p_flowid_tldjhz,'000001','proc_goo_dhlr_tj_zjs');


    select sum(cs) into v_flcs from T_FLRecord where   flowid_tldjhz=p_flowid_tldjhz;
    if v_flcs >0 then
      select  zcs into v_zcs from t_dhfltask where    flowid_tldjhz=p_flowid_tldjhz;
       insert into t_gzl2
       (czybh,    pz, js, id_job, proc, tablename, tablepk)
     select
        czybh ,   count(distinct id),
        round (v_ysjs*sum(cs)/v_zcs,2),
        'DHFL', 'proc_goo_dhlr_tj_zjs2', 'T_FLRecord' ,p_flowid_tldjhz from T_FLRecord where flowid_tldjhz=p_flowid_tldjhz
        group by czybh ;
    end if;

    errno   := 0;
    errtext := 'ok';
    Return;
Exception
    When Others Then
        errno   := Sqlcode;
        errtext := 'proc_goo_dhlr_tj_zjs' || Sqlerrm;
        Rollback;
        Return;
End RF_DHFL_TJ;
CREATE OR REPLACE Procedure PROC_SX_QRFYJH_YY2
-----------------------------------------------------------------
    -- 此过程是根据 PROC_SX_QRFYJH_XTW 修改后的过程
    -- 前台将改为调用此过程, PROC_SX_QRFYJH_XTW作为备份了
    -- 主要变化在于, 在发运计划确认时, 按业务部门重新生成了发运计划号
    ------------------------------------------------------------------
    /*在制定运输计划时,
    T_dfbj:
    t_dfbj.fyjhpc=新生成的批次
    t_dfbj.jhpch=新生成的批次，
    t_dfbj.fyjhrq=sysdate
    t_dfbj_fylh:
    t_dfbj_fylh.fypch=新生成的批次

    当发运计划确认时，
    T_dfbj
    t_dfbj.jhpch=null
    t_dfbj.fyjhrq=sysdate
    t_dfbj_fylh:
    t_dfbj_fylh.fyrq=sysdate
    */
    --确认运输计划
    -- 山西由于有发运理货过程，所以在制定发运计划后，不使用RF进行发运，直接采用打印
    --单据的方式进行发运
(p_fyjhpc Char, --运号
 p_driver   Char, --类型
 p_czybh Char, --发运操作员,就是v_worker全局变量
 p_cydw char,
 p_carnum char,
 errno    Out Number,
 errtext  Out Varchar2) As
    l_count     Number;
    l_sjjs      Number;
    l_jhjs      Number;
    v_cybh      Char(6);
    v_ywlx      Char(2);
    l_rs        Number;
    v_rows      Number;
    v_ztbj      Char(1);
    v_bj        Number;
    ls_lsh      Number;
    tmpVar      Number;
    l_bjlsh     t_dfbj.bjlsh%type;
    l_ywbmbh    char(6);
    v_xh        number;
    v_current  number;
    v_sql      varchar2(2000);
Begin

    v_bj := 11;

    select count(distinct ywlx) into v_rows from t_fybj where fyjhpc=p_fyjhpc;
    if v_rows>1 then
      errno   := -1;
      errtext := '计划存在多个发货类型';
      return;
    end if ;

    select ywlx into v_ywlx from  t_fybj where fyjhpc=p_fyjhpc and rownum=1;

/*  update t_dfbj set fyjhpc=p_fyjhpc,fyrh = p_czybh,
   CH = p_carnum,cyrq = Sysdate,cydw = p_cydw,yh=p_driver
  where bjlsh in (select bjlsh from t_fybj where fyjhpc=p_fyjhpc);*/

   Insert Into T_DFBJ
              (BJLSH, RQH, tph,WCBJ, PFRQ, YWBMBH, YWPC, DH, YBZBJ, ZPZ, ZCS, ZMY, ZSY,
                     BZJS, FHBMBH, SJJS, TIHFS, KFBH, ywlx, jxfs, fyfsh, ZZL, Sdhrq, js,
                     Fhyxj, ttxh, Djbj,zddh,zb ,ddcdbj,tdpch,JHCZYBH,fyjhpc,fyrh,CH,cyrq,cydw,cyr)
   select
     BJLSH, null, tph,'1', sysdate, j.YWBMBH, BJLSH, j.DH, '1', ZPZ, ZCS, ZMY, ZSY,
     js, '3001', js, '01', KFBH, j.ywlx, jxfs, '01', ZZL, null, js,
      yxj, 1, '1',zddh,zb ,ddcdbj,tdpch,JHCZY,p_fyjhpc,p_czybh,p_carnum,Sysdate,p_cydw,p_driver
      from t_jhbag j,t_fybj f where j.id=f.bjlsh
     and f.fyjhpc= p_fyjhpc;


     update  t_jhbag j set zt='2',wcdate=sysdate where exists (select 1 from  t_fybj   where j.id= bjlsh
     and  fyjhpc= p_fyjhpc);

    ---  写装车工作量
 /*   Select Sum(bzjs) Into l_sjjs From t_dfbj Where fyjhpc = p_fyjhpc;
    Select Sum(zcs), Sum(zmy),min(bjlsh),min(ywbmbh) Into l_count, l_jhjs,l_bjlsh,l_ywbmbh From t_dfbj Where fyjhpc = p_fyjhpc;
    Select Count(*) Into l_rs From t_dfbj_zcr Where fypch = p_fyjhpc;
    If l_rs > 0 Then
        For c_zc In (Select * From t_dfbj_zcr Where t_dfbj_zcr.fypch = p_fyjhpc)
        Loop
            Insert Into t_gzl
                (CZYBH, CZLX, CZRQ, JLS, CS, JS, FLOWID, MY,TABLE_NAME,FLOWID_TABLE,YWBMBH,PROC_NAME)
            Values
                (c_zc.czybh, 'FYZC', Sysdate, 1, round(l_count / l_rs, 2),
                 round(l_sjjs / l_rs, 2), all_flowid.Nextval, round(l_jhjs / l_rs, 2)
                 ,'t_dfbj',l_bjlsh,l_ywbmbh,'PROC_SX_QRFYJH_YY'
                 );
        End Loop;
    End If;*/



        -- 如果是第三方物流发运的话发货回告不及时，所以应该先写完发货数据
        If v_ywlx = 'FH' Then

          PROC_WRITE_FHMX_XTW(p_fyjhpc, v_ywlx, '3001', errno, errtext);
          If errno <> 0 Then
              Rollback;
              Return;
          End If;
        End If;

        If v_ywlx = 'ST' Or v_ywlx = 'SF' Then
            PROC_WRITE_HYTHMX_XTW2(p_fyjhpc, p_czybh, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;
        End If;
     /* Update t_dfbj
           Set jhpch = ''
         Where jhpch = v_fypch_new ;*/
        v_bj := 14;
        -- 写发货理货工作量表：
      /*  Insert Into t_gzl
            (CZYBH, CZLX, CZRQ, JLS, CS, JS, FLOWID, MY,TABLE_NAME,FLOWID_TABLE,YWBMBH,PROC_NAME)
            Select p_czybh, 'FHLH', Sysdate, jls, cs, js, all_flowid.Nextval, MY
            ,'t_dfbj',l_bjlsh,l_ywbmbh,'PROC_SX_QRFYJH_YY'
              From (Select fyth_czybh As fyrh, Sum(zcs) As cs, Sum(bzjs) As js,
                            Sum(ZMY) As MY,count(*) jls
                       From t_dfbj
                      Where fyjhpc = p_fyjhpc
                      Group By fyth_czybh);*/

     update t_ywpc set qrrq=sysdate where ywpch=p_fyjhpc;
  /*
     v_xh:=1;


     for cur in (select distinct dh from t_fybj where fyjhpc=p_fyjhpc) loop

     insert into  t_fyxh (fyjhpc  ,dh  ,xh  )
       values ( p_fyjhpc,cur.dh,v_xh);
       v_xh:=v_xh+1;
     end loop;
    */
/*   select fyxh.nextval into v_current from dual;
v_sql:='alter sequence fyxh increment by '||-v_current||' nocache';
        Execute Immediate v_sql;
select fyxh.nextval into v_current from dual;
v_sql:='alter sequence fyxh increment by 1 cache 20';
        Execute Immediate v_sql;*/

     insert into  t_fypcdh
       ( fyjhpc, dh,xh, bzjs, zzl, zmy, zcs)
      select p_fyjhpc ,dh ,rownum,bzjs,zzl,zmy,zcs from (
         select  dh,sum(bzjs) bzjs ,sum(zzl) zzl ,sum(zmy) zmy ,sum(zcs) zcs
      from t_dfbj where fyjhpc=p_fyjhpc group by dh);


     insert into t_fybj_bak
     select * from t_fybj where fyjhpc=p_fyjhpc;
     delete t_fybj where fyjhpc=p_fyjhpc;
     update t_fyjhpc set qrrq=sysdate,finish='1' where fyjhpc=p_fyjhpc;

    errno   := 0;
    errtext := 'ok';
 Return;
Exception
    When Others Then
        errno   := Sqlcode;
        errtext := 'PROC_SX_QRFYJH_YY2'||Sqlerrm || to_char(v_bj);
        Rollback;
        Return;
End PROC_SX_QRFYJH_YY2;
CREATE OR REPLACE Procedure PROC_CREATE_WLFL_XTW5
-- 当到货拆包台选中一条到货记录后,
    -- 调此过程生成ID, 同时生成物流分流数据
(p_flowid_dhmx In Number,
 p_flowid_dj in Number,
 p_flowid_tldjhz number,
 p_line in char,
 errno         Out Number,
 errtext       Out Varchar2) As

v_cbname varchar2(10);
v_id char(19);
v_rows number;
v_pass char(1);
v_sjcs number;

    v_dhmx tmp_dhmx%Rowtype;
    v_ywbmbh char(6);
    v_fllx  char(2);
    l_fltbzxs_sx Number;
    l_fltbzxs_xx Number;

    l_fltbzcs_xx Number;

    v_bj   Number;

    v_hqbh      Char(4);
    v_flqxmc    varChar2(60);
     v_hw       Char(20);

    v_dhzxid varchar2(30);
    v_nxtzxid varchar2(30);
    v_isgz char(1);
    v_isgp char(1);
    v_zddh char(6);
    v_counter number;
    v_line char(2);
Begin

    errno   := 0;
    errtext := 'ok';

    select id, pass into v_id,v_pass  from    tmp_dhmx
    where flowid_dhmx = p_flowid_dhmx;
    if v_pass='3' then
       return;
    end if ;

    if v_pass ='0' then

      If v_id Is Null Then
        errno   := 0;
        errtext := 'id为空';
        Return;
      End If;

      update tmp_dhmx a set(dbbz,xbbz,zl)=(select dbbz,xbbz,zl from t_kcsm where id=a.id)
       where flowid_dhmx=p_flowid_dhmx;

      update  tmp_dhmx set pass='1'   where flowid_dhmx = p_flowid_dhmx and pass='0';

      v_pass:='1';


    end if ;

    select * into v_dhmx from tmp_dhmx where flowid_dhmx = p_flowid_dhmx;
    select ywbmbh,fllx into v_ywbmbh,v_fllx from t_wlsh where id =p_flowid_tldjhz;
    select splitczyname into v_cbname from t_splitbagtask where flowid_tldjhz=p_flowid_tldjhz;

    if v_pass ='1' then

       insert into t_dh_yfsj
      (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx,ywbmbh,
      flqxmc, detailqx,  cgyj, cgyj_kh,djly,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch)
        select   flowid_yfsj,  flowid, flowid_dj, dh, v_dhmx.id, yfsl, 0, null,v_ywbmbh, null, null,
          ysdjh, trim(cgyj_kh) ,DJLY,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch
       from t_sl_yfsj  Where flowid = p_flowid_dhmx;


      if v_fllx= 'PT' then --馆配全播撒
        Select nvl(min(sys_value),0)
          Into l_fltbzxs_xx
          From t_sysset
         Where upper(sys_item) = 'L_FLTBZ_XX' And SYS_YWBMBH = v_ywbmbh;

         l_fltbzcs_xx := ROUND(v_dhmx.dbbz * v_dhmx.xbbz * l_fltbzxs_xx, 0);

          update t_dh_yfsj t set flqx='FH',flqxmc='发货包装区', xh=0
          where  flowid_dhmx = p_flowid_dhmx
          and ( yfsl >= l_fltbzcs_xx or v_dhmx.xbbz = 1
          or exists (select 1 from t_fhdh where dh=t.dh and v_fllx='PT')
          );
       end if ;

        update t_dh_yfsj t set flqx='ZP',xh=1
        where flowid_dhmx = p_flowid_dhmx and flqx is null;
        -- yfsl < l_fltbzcs_xx  And  v_dhmx.xbbz <> 1
        --and not  exists (select 1 from t_fhdh where dh=t.dh);

        select v_dhmx.yssl- nvl(sum(yfsl),0) into v_sjcs from t_dh_yfsj
        where  flowid_dhmx = p_flowid_dhmx ;


     insert into t_dh_yfsj
      (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx, ywbmbh,
        flqxmc, detailqx, hw,  xh)
      values
      (all_flowid.Nextval,p_flowid_dhmx,v_dhmx.flowid_dj,null,v_dhmx.id,
      v_sjcs,0,'CC',v_ywbmbh,null,null,null ,2);

       update t_dh_yfsj set zddh=dh where flowid_dhmx = p_flowid_dhmx and zddh is null ;

       update  tmp_dhmx set pass='2'   where flowid_dhmx = p_flowid_dhmx and pass='1';

       v_pass:='2';

       commit;
    end if ;


    if v_fllx ='GP' then
      v_isgp:='1';
    elsif  v_fllx='PT' then
      v_isgp:='0';
    end if;

/*发货去向：ywbmbh（货主），flqx（FH），成包类型（G柜组 || 馆配P || 门店D），
成包编号6位（柜组号 || 图书馆号 || 店号），是否单独成单（Y|| N）,单号||空

播撒去向：ywbmbh（货主），flqx（ZP），播撒线号2位。
计算去向线号时，要根据规则，查询下一个环节（RF播撒）使用的去向在播撒线上存不存在货位。
下一环节去向计算方法，ywbmbh（货主），成包类型（G柜组 || 馆配P || 门店D），
成包编号6位（柜组号 || 图书馆号 || 店号），是否单独成单（N）

上架去向：ywbmbh（货主），flqx（CC），货区编号*/

    for cur in (select dh,flqx,zddh,tdpch,ddcdbj ,flowid,yfsl from t_dh_yfsj
       where flowid_dhmx=p_flowid_dhmx and dhzxid is null ) loop

      v_dhzxid:=v_ywbmbh||cur.flqx;

      if cur.flqx='FH' then

        if v_fllx='GP' then
           v_isgz:='0';
           v_dhzxid:=v_dhzxid||'P';
           v_zddh:=cur.zddh;


        elsif v_fllx='PT' then

            Select Count(*)   Into v_rows  From  t_guizu_fl
              Where dh =cur.dh And  enable = '1';
             if v_rows >0 and v_ywbmbh='000001' then

                v_isgz:='1';
                v_dhzxid:=v_dhzxid||'G';

                Select min(gzbh) into v_zddh
                 From  t_guizu_fl c
                Where flbh=v_dhmx.fl And dh = cur.dh;
                if v_zddh is null then
                  select min(gzbh) into v_zddh  from t_guizu_fl  where  dh=cur.dh;
                end if ;

             else

                v_isgz:='0';
                v_dhzxid:=v_dhzxid||'D';
                v_zddh:=cur.dh;

             end if;
        end if;
        v_dhzxid:=v_dhzxid||v_zddh;
        if cur.ddcdbj ='1' then

          v_dhzxid:=v_dhzxid||'Y'||trim(cur.tdpch);

        else

          v_dhzxid:=v_dhzxid||'N';

        end if ;
        select trim(dm) into v_flqxmc from t_dm where dh=v_zddh;
        update  t_dh_yfsj set isgp=v_isgp ,isgz=v_isgz, dhzxid=v_dhzxid,zddh=v_zddh ,
        flqxmc= v_flqxmc
        where flowid =cur.flowid;
      end if;

      if cur.flqx='ZP' then

        v_nxtzxid:=v_ywbmbh||'FH';

        if v_fllx='GP' then
           v_isgz:='0';
           v_nxtzxid:=v_nxtzxid||'P';
           v_zddh:=cur.zddh;

        elsif v_fllx='PT' then

            Select Count(*)   Into v_rows  From  t_guizu_fl
              Where dh =cur.dh And  enable = '1';
             if  v_rows >0 and v_ywbmbh='000001' then

                v_isgz:='1';
                v_nxtzxid:=v_nxtzxid||'G';

                Select min(gzbh) into v_zddh
                 From  t_guizu_fl c
                Where flbh=v_dhmx.fl And dh = dh;
                if v_zddh is null then
                  select min(gzbh) into v_zddh  from t_guizu_fl  where  dh=cur.dh;
                end if ;
             else

                v_isgz:='0';
                v_nxtzxid:=v_nxtzxid||'D';
                v_zddh:=cur.dh;

             end if;
        end if;
        v_nxtzxid:=v_nxtzxid||v_zddh||'N';
        if p_line is null then

           select min(counter) into v_counter from t_line_zp_hw2 where waitdisable='0' and zpzxid=v_nxtzxid;
           if v_counter is not null then
             select min(ywbmbh||'ZP'||line),min(line) into  v_dhzxid,v_line from t_line_zp_hw2
             where waitdisable='0' and ZPZXID=v_nxtzxid and counter=v_counter;
           else
             v_dhzxid:=null;
             v_line:=null;
           end if;

        else
           select min(ywbmbh||'ZP'||line) into  v_dhzxid from t_line_zp_hw2 where waitdisable='0' and  ZPZXID=v_nxtzxid
           and line=p_line;
           v_line:=p_line;

        end if ;
        select min(trim(mc)) into v_flqxmc from t_line_zp where bh=v_line;

        update  t_dh_yfsj set isgp=v_isgp ,isgz=v_isgz, dhzxid=v_dhzxid,zddh=v_zddh ,
          nxtzxid=v_nxtzxid,line=v_line,flqxmc=v_flqxmc where flowid=cur.flowid;
      end if ;

      if cur.flqx='CC' then

          proc_get_hqbh3(cur.yfsl, 'DH', v_dhmx.id, v_dhmx.dbbz, v_dhmx.xbbz,
                      v_ywbmbh, '3001', v_hqbh, v_flqxmc, v_hw, errno,
                      errtext);
          if v_hqbh is null then
            v_dhzxid:='';
          else
            v_dhzxid:=v_ywbmbh||'CC'||trim(v_hqbh);
          end if ;
          
          update  t_dh_yfsj set isgp='0' ,isgz='0', dhzxid=v_dhzxid,zddh=cur.dh ,
          nxtzxid=null,hqbh=trim(v_hqbh),flqxmc=trim(v_flqxmc) where flowid=cur.flowid;

      end if ;

    end loop;


    select   listagg( trim(dm), ',') within Group(Order By Null)
    into errtext
    from    t_dh_yfsj t ,t_dm d where  FLOWID_DHMX = p_flowid_dhmx
    and flqx='ZP' and dhzxid is null and t.zddh=d.dh;
    if errtext is not null then
      errno:=-1;
      errtext:=errtext||'在播撒线上没有绑定货位！';
      return;
    end if;
    errtext:='ok';

    select count(*) into v_rows  from t_dh_yfsj t where  FLOWID_DHMX = p_flowid_dhmx
    and flqx='CC' and dhzxid is null;
    if v_rows >0 then
      errno:=-1;
      errtext:='没有找到储备库上架货区';
      return;
    end if;

   update  tmp_dhmx set pass='3'  where FLOWID_DHMX = p_flowid_dhmx ;
   
   insert into t_tree
     (tbid, tbname, pid, pname, note, id, cs,  orderno, lf,rt,rid,dm)
   select
    t.flowid, 't_dh_yfsj', flowid_yfsj, 't_sl_yfsj',
     '到货分流指令,'||t.flqxmc||',任务号'||p_flowid_tldjhz||',拆包人'||v_cbname, t.id,
     t.yfsl,  trim(s.ysdjh),1,2,t.flowid,
     (select trim(dm) from t_dm where dh=t.zddh)
   from t_dh_yfsj t left join t_sl_yfsj s
   on t.flowid=s.flowid_yfsj  where  FLOWID_DHMX = p_flowid_dhmx;




Exception
    When Others Then
        errno   := -1; --执行失败
        errtext := 'PROC_CREATE_WLFL_XTW5' || Sqlerrm ;
        Rollback;
End;
CREATE OR REPLACE Procedure PROC_SX_FHXTST_GZ_XTW
--这个过程是更正存储过程，作用于：销售发货更正、货源退货更正、客户退货更正
		-- 2011-11-18 升级
		-- 2010-09-23 YANGYI 最新修改
		-- 该过程处理原则如下:
		--
		-- 1. 入口的p_ywpch应该是要更正的单据号, 而不是包件号
		--
		-- 2. 对于出库类的更正, 如果 更正后>更正前数量
		--    对于入库类的更正, 如果 更正后<更正前数量
		--    都将自动生成正式的收益数据, 即正SY, 使得库存保持不变
		--    这部分差异数据将写入t_wl_bssj上报商流, 用于商流增加库存
		--    更正后的数据都是冲减出库的, 因此, 最终商流库存是不变的.
		--
		-- 3. 对于出库类的更正, 如果 更正后<更正前数量
		--    对于入库类的更正, 如果 更正后>更正前数量
		--    则将自动生成负的差异数据, 即负CY, 使得库存保持不变
		--
		--    此类差异数据, 将写入t_sy_jh表, 用于后期物流做差异匹配
		--    同时, 这部分差异数据将写入t_bsjh_lsb上报商流, 以作为商流的库存占用
		--
		-- 4. 更正的原则: 首先将原记录的更正标记置为1
		--                按原记录的负值写一笔负记录, 其更正标记=1
		--                按更正后的数据写一笔正记录, 其更正标记=0
		--
		--        不论是物流更正还是商流更正, 都先生成更正计划写入表中, 然后调物流
		--    的这个过程, 生成更正数据.
		--
		-- 5. 对于货源退货更正, 如果更正前后有差异, 需要做退货库的转出和备货库的转入
		--    然后根据差异数, 按储备库的差异/损益写入t_crkls
		--
		-- 6. 顺便说一下到货更正:
		--    如果到货往少了更, 则生成正差益(CY), 库存不变，
		--    如果到货往多了更, 则直接增加库存.
		--    到货更正生成的正差异不上报商流, 只有定期将其转换为损益后才上报商流.
		--
		-- 7. 物流做更正时, 将更正计划写到T_SL_GZJH_MX中后, 直接调本过程.
		--    商流做更正时, 也将更正计划写到T_SL_GZJH_MX中后, 通过链接方式调用本过程.
		--
		-- 8. t_sl_gzjh_hz增加店号字段, 主要为确保发货更正单据的唯一性
		--    T_SL_GZJH_MX增加店号字段
		--    相应地 t_sl_gzjh_hz_bak, t_sl_gzjh_mx_bak 也增加店号字段
		--           T_WL_GZJG_mx_TEMP, T_WL_GZJG_mx 也增加店号字段
		--           t_wl_gzjg_hz 也增加店号字段
		--
		--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		-- 9. 2010-11-17 yangyi: 再次重申：
		--    t_bsjh_lsb 中存放的是物流要上报商流的差异数据，正数表示“损”，负数表示“益”
		--    与物流t_crkls中差异数的写法正好相反
		--    商流在接收差异计划时，正数(表示“损”)直接插入，负数用来冲抵商流已有的只是将上报的数据与已有的差异计划进行冲抵，只影响库存占用数
		--
		--    t_wl_bssj 中存放的是物流要上报商流的正式报损/报益数据，正数表示"益"。负数表示"损"
		--    与物流t_crkls中损益数的写法一致
		--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		--
		--    商流更正时, 需要调此过程
		--    物流更正时, 需要调此过程
		--    销货店收货差异,自动更正程序需要调这个过程
		--
		-- 2012-10-06 yangyi:做了如下修改：
		-- 由于下边几个数据表，是在交换区存放的，
		-- 而物流与交换区不在同一个实例中，因此，统一改为通过链的方式来进行数据的读取和写入
		-- t_sl_gzjh_hz/t_sl_gzjh_mx/
		-- t_wl_gzjg_hz/t_wl_gzjg_mx/t_wl_gzjg_mx_temp/
		-- 发货更正时，在t_wl_gzjg_mx更正结果中标明了哪些是门店差异更正，哪些是总部主动更正的
		-- t_wl_gzjg_mx、t_wl_gzjg_mx_temp 中新增字段gzlx char(1)
		--
		-- 对于更正所产生的差异记录，在写t_crkls时，增加两个字段
		-- t_crkls中，新增字段cylx char(2), DH/FH/ST/FT/PK --- 更正类型，用于表示是哪类更正引起的差异
		-- t_crkls中，新增字段gzmxkey char(12), 用于记录被更正记录的主键，-- 用于记录被更正记录的主键
		--            到货更正时，gzmxkey=t_dhls_jx.flowid_dhmx
		--            退货更正时，gzmxkey=t_hythmx.flowid
		--            发货更正时，gzmxkey=t_fhmx.dbdh
		--            发退更正时，gzmxkey=t_khthmx.flowid
(p_ywpch  Char, -- 被更正单号
 p_cybh   Char, -- 单据所在储运
 p_ywbmbh Char, -- 业务部门编号
 p_gzlx   Char, -- 更正类型，FH=发货更正,ST=货源退货更正,XT=客户退货更正
 p_gzczy  Char, -- 2011-02-16 yangyi 更正操作员编号为‘sl’，表示是连锁店接到货差异更正
 -- 将这个值写入t_fhmx.cspc中了，用于区别是差异更正的
 p_dh    Char, -- 新增店号字段, 为确保发货单据的唯一性
 errno   Out Number,
 errtext Out Varchar) As
		v_kfbh Char(6);
		--    s_bjlsh        Char(12);
		--    s_bjlsh_hy     Char(12);
		--    s_ywpch        Char(12);
		--    s_ywpch_hy     Char(12);
		d_flowid       Number;
		s_id           Char(18);
		l_count        Number;
		S_dbdh         Char(12);
		l_yssl         Number;
		D_FHZK_YS      Number;
		S_DH_YS        Char(30);
		ls_dbdh_new    Char(12);
		d_cysy_old     Number;
		d_cysy_new     Number;
		ldc_new_flowid Number;
		--    s_ywpch_ghhy   Char(12);
		--    s_bjlsh_ghhy   Char(12);
		s_crkls_lx   Char(12);
		s_wl_jsdh    Char(6);
		l_cys        Number;
		ls_zypch     Char(12);
		d_dbbz       Number;
		d_xbbz       Number;
		S_YWPCH_SY   Char(12);
		s_dh_1212    Char(6);
		d_crkls      Number;
		v_tsbj       Char(1);
		v_ysthrq     Date;
		v_lsdbj      Char(1);
		v_khlxbh     Char(2);
		v_dh         Char(6);
		v_jl         Number;
		s_zdbj       Char(1);
		l_count_sl   Number;
		d_bs_flowid  Number;
		v_djbh       Char(12);
		v_rows       Number;
		v_cys        Number;
		v_zpz        Number;
		v_zcs        Number;
		v_zmy        Number;
		v_zsy        Number;
		v_bj         Number;
		v_curr_bjlsh Char(12);
		v_curr_ywpch Char(12);
		v_currsl     Number;
		ld_zl        Number;
		ls_zfzd      Char(1);
		tmpVar       Number;
		ls_thkf      t_dm.dh%Type;
		tmp3f        Number;
		v_gzkf       t_dm.dh%Type;
		v_newdh1     Char(6);
		v_dh1        Char(6);
		v_bz         Char(30);
		-- 2013-08-10 yangyi: 为更正sylx
		v_id_new   Char(18);
		v_zjxs_new Number;
		v_sylx_new Char(1);
		v_nofhbj   Char(1);
		v_ywshbj   Char(1);
		v_nothbj   Char(1);
		v_gzkey    Number;
		v_yjfbj    Char(1);
    v_zk       number;
Begin
		-- 2017-03-06 yangyi: 为写dbwl.t_fhmx 做准备：
		Select nvl(zdbj,'0') Into v_yjfbj From t_sl_gzjh_hz Where trim(gzjhdh)=trim(p_ywpch);

		Select all_flowid.nextval Into v_gzkey From dual;
		ls_zfzd := '0';
		v_bj    := -1;
		Select Min(nvl(zdbj, '0'))
			Into s_zdbj
			From t_sl_gzjh_hz@C_LINK_WL_EX
		 Where Trim(gzjhdh) = Trim(p_ywpch);
		Select Min(dh) Into v_kfbh From t_dm Where kflx = 'LK' And LXBH = '2';
		Select Count(*) Into tmp3f From t_dm Where dh = p_ywbmbh And KHLXBH = '1 ';
		If tmp3f > 0 Then
				--第三方标记
				tmp3f := 1;
		End If;
		-- 2015-08-12 add by yangyi:
		If p_gzlx = 'FH' Or p_gzlx = 'XT' Then
				Select nvl(nofhbj, '0'), nvl(nothbj, '0'), nvl(ywshbj, '0')
					Into v_nofhbj, v_nothbj, v_ywshbj
					From t_dm_ywbm@c_link_wl_sl
				 Where dh = p_dh And ywbmbh = p_ywbmbh;
				If v_ywshbj = '0' Then
						ERRNO   := -13;
						ERRTEXT := '该客户已被设置为冻结客户，不能再做单据更正了!' || p_dh;
						Rollback;
						Return;
				End If;
				If v_nofhbj = '1' And p_gzlx = 'FH' Then
						ERRNO   := -13;
						ERRTEXT := '该客户已被设置为禁止发货，不能再做发货更正了!' || p_dh;
						Rollback;
						Return;
				End If;
				If v_nofhbj = '1' And p_gzlx = 'XT' Then
						ERRNO   := -13;
						ERRTEXT := '该客户已被设置为禁止退货，不能再做发退更正了!' || p_dh;
						Rollback;
						Return;
				End If;
		End If;
		----------------------------------------
		-- 2011-04-11 yangyi:
		-- 在生成单据号之前先循环判断一下合法性，然后再执行更正处理
		-- 否则会浪费很多包件流水号：
		For c10 In (Select *
									From T_SL_GZJH_MX@C_LINK_WL_EX
								 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
		Loop


				---校验数据表里是否有该单据
				If p_gzlx = 'FH' Then
				 		s_dbdh := Trim(c10.dbdh);

						Select Count(*)
							Into l_count
							From t_fhmx
						 Where   DBDH   =  s_dbdh  And NVL(GZBJ, '0') <> '1';
						If l_count < 1 Then
								ERRNO   := -13;
								ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
													 s_dbdh;
								Rollback;
								Return;
						End If;
				End If;
				If p_GZLX = 'ST' Then
						Select to_number(c10.dbdh) Into d_flowid From dual;
						Select Count(*)
							Into l_count
							From t_hythmx
						 Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
						If l_count < 1 Then
								ERRNO   := -131;
								ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
													 d_flowid;
								Rollback;
								Return;
						End If;
				End If;
				If p_gzlx = 'XT' Then
						Select to_number(c10.dbdh) Into d_flowid From dual;
						Select Count(*)
							Into l_count
							From t_khthmx
						 Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
						If l_count < 1 Then
								ERRNO   := -132;
								ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
													 d_flowid;
								Rollback;
								Return;
						End If;
				End If;
		End Loop;
		------------校验结束-------------------------------
		If p_gzlx = 'FH' Then
				-- 在连锁店接到货之前, 总部不允许对该发货单据做发货更正:
				v_djbh := Trim(p_ywpch);
				Select Count(*)
					Into v_rows
					From t_fhhz@c_link_wl_sl
				 Where pfpch = v_djbh And dh = p_dh;
				If v_rows = 0 Then
						Rollback;
						errno   := -1;
						errtext := '该单据还没有上报到商流,暂不能做更正!' || v_djbh;
						Return;
				End If;
				Select Count(*)
					Into v_rows
					From t_fhhz@c_link_wl_sl a
				 Where pfpch = v_djbh And dh = p_dh And nvl(get_sjsh, '0') = '0' And Not Exists
				 (Select 1 From t_fhmx Where pfpch = a.pfpch And nvl(gzbj, '0') = '1');
				If v_rows > 0 Then
						Rollback;
						errno   := -1;
						errtext := '该单据连锁店还没有收到货,暂不能做更正!' || v_djbh;
						Return;
				End If;
				/*        -- 有可能出现换户更正, 所以生成了两套号码
        -- 如果不是换户更正, 则更正后单据只用一套单号;
        -- 如果是换户更正, 则更正后单据就要分成两张单了;
        -- 下边的退货更正/销退更正都是一样道理
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh From dual;
        dlgetlsh(p_ywbmbh, 'XS', 'XS', S_YWPCH);
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh_hy From dual;
        dlgetlsh(p_ywbmbh, 'XS', 'XS', s_ywpch_hy);
        */
				-- 对于newsl为空的记录，取得原记录的税率：
				For c_djh0 In (Select *
												 From T_SL_GZJH_MX@C_LINK_WL_EX
												Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And newsl Is Null)
				Loop
						s_dbdh := c_djh0.dbdh;
						Select sl Into v_currsl From t_fhmx Where dbdh = s_dbdh;
						Update T_SL_GZJH_MX@C_LINK_WL_EX
							 Set newsl = v_currsl
						 Where dbdh = c_djh0.dbdh And Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
				End Loop;
				-- 2012-12-18 yangyi:
				-- 换户更正时，新店将按正常到货验货，而同帮系统不允许单号内有字母，
				-- 所以，新店的发货单号改为按正常规则生成：
				--
				-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
				Delete From tm_gzdjh_new Where gzkey = v_gzkey;
				For c_djh1 In (Select Distinct newdh, newsl
												 From T_SL_GZJH_MX@C_LINK_WL_EX
												Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
				Loop

            -- 2018-06-07 add yangyi: 由于财务凭证中，传媒部门按税率区分不同科目，故增加限制:
            proc_chk_sl(p_ywbmbh, c_djh1.newsl, errno, errtext);
            If errno<>0  Then
                Rollback;
                Return;
            End If;

						Select Count(*)
							Into v_rows
							From tm_gzdjh_new
						 Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl And gzkey = v_gzkey;
						If v_rows = 0 Then
								Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
								--dlgetlsh(p_ywbmbh, 'XS', 'XS', v_curr_ywpch);
								v_curr_ywpch := Trim(to_char(c_djh1.newsl)) || Trim(v_curr_bjlsh);
								Insert Into tm_gzdjh_new
										(ghdwh, newsl, ywpch, flowid_dj, gzkey)
								Values
										(c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh, v_gzkey);
						End If;
				End Loop;
				-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
				For c_djh2 In (Select Distinct a.dh, a.sl
												 From t_fhmx a, T_SL_GZJH_MX@C_LINK_WL_EX b
												Where a.dbdh = substrb(Trim(b.dbdh) || '           ', 1, 12) And
															Not Exists
												(Select 1
																 From tm_gzdjh_new
																Where ghdwh = a.dh And newsl = a.sl And gzkey = v_gzkey) And
															Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh)
				Loop

            -- 2018-06-07 add yangyi: 由于财务凭证中，传媒部门按税率区分不同科目，故增加限制:
            proc_chk_sl(p_ywbmbh, c_djh2.sl, errno, errtext);
            If errno<>0  Then
                Rollback;
                Return;
            End If;

						Select Count(*)
							Into v_rows
							From tm_gzdjh_new
						 Where ghdwh = c_djh2.dh And newsl = c_djh2.sl And gzkey = v_gzkey;
						If v_rows = 0 Then
								Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
								dlgetlsh(p_ywbmbh, 'XS', 'XS', v_curr_ywpch);
								Insert Into tm_gzdjh_new
										(ghdwh, newsl, ywpch, flowid_dj, gzkey)
								Values
										(c_djh2.dh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh, v_gzkey);
						End If;
				End Loop;
		Elsif p_GZLX = 'ST' Then
				/*        dlgetlsh(p_ywbmbh, 'ST', 'ST', s_ywpch);
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh From dual;
        dlgetlsh(p_ywbmbh, 'ST', 'ST', S_YWPCH_HY);
        Select to_char(bjlsh_flowid.Nextval) Into s_bjlsh_hy From dual;
        */
				-- 对于newsl为空的记录，取得原记录的税率：
				For c_djh0 In (Select *
												 From T_SL_GZJH_MX@C_LINK_WL_EX
												Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And newsl Is Null)
				Loop
						d_flowid := to_number(c_djh0.dbdh);
						Select sl Into v_currsl From t_hythmx Where flowid = d_flowid;
						Update T_SL_GZJH_MX@C_LINK_WL_EX
							 Set newsl = v_currsl
						 Where dbdh = c_djh0.dbdh And Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
				End Loop;
				-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
				Delete From tm_gzdjh_new Where gzkey = v_gzkey;
				For c_djh1 In (Select Distinct newdh, newsl
												 From T_SL_GZJH_MX@C_LINK_WL_EX
												Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
				Loop

            -- 2018-06-07 add yangyi: 由于财务凭证中，传媒部门按税率区分不同科目，故增加限制:
            proc_chk_sl(p_ywbmbh, c_djh1.newsl, errno, errtext);
            If errno<>0  Then
                Rollback;
                Return;
            End If;

						Select Count(*)
							Into v_rows
							From tm_gzdjh_new
						 Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl And gzkey = v_gzkey;
						If v_rows = 0 Then
								Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
								dlgetlsh(p_ywbmbh, 'ST', 'ST', v_curr_ywpch);
								Insert Into tm_gzdjh_new
										(ghdwh, newsl, ywpch, flowid_dj, gzkey)
								Values
										(c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh, v_gzkey);
						End If;
				End Loop;
				-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
				For c_djh2 In (Select Distinct a.hybh, a.sl
												 From T_HYTHMX a, T_SL_GZJH_MX@C_LINK_WL_EX b
												Where a.FLOWID = to_number(b.dbdh) And Not Exists
												(Select 1
																 From tm_gzdjh_new
																Where ghdwh = a.hybh And newsl = a.sl And gzkey = v_gzkey) And
															Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh)
				Loop
            -- 2018-06-07 add yangyi: 由于财务凭证中，传媒部门按税率区分不同科目，故增加限制:
            proc_chk_sl(p_ywbmbh, c_djh2.sl, errno, errtext);
            If errno<>0  Then
                Rollback;
                Return;
            End If;

						Select Count(*)
							Into v_rows
							From tm_gzdjh_new
						 Where ghdwh = c_djh2.hybh And newsl = c_djh2.sl And gzkey = v_gzkey;
						If v_rows = 0 Then
								Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
								dlgetlsh(p_ywbmbh, 'ST', 'ST', v_curr_ywpch);
								Insert Into tm_gzdjh_new
										(ghdwh, newsl, ywpch, flowid_dj, gzkey)
								Values
										(c_djh2.hybh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh, v_gzkey);
						End If;
				End Loop;
		Else
				/*        dlgetlsh(p_ywbmbh, 'XT', 'XT', s_ywpch);
        dlgetlsh(p_ywbmbh, 'XT', 'XT', s_ywpch_hy);
        */
				-- 对于newsl为空的记录，取得原记录的税率：
				-- 2012-10-06 交换区与物流不在同一实例中，因此改用链接方式读取T_SL_GZJH_MX@C_LINK_WL_EX
				For c_djh0 In (Select *
												 From T_SL_GZJH_MX@C_LINK_WL_EX
												Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And newsl Is Null)
				Loop
						d_flowid := to_number(c_djh0.dbdh);
						Select sl Into v_currsl From t_khthmx Where flowid = d_flowid;
						Update T_SL_GZJH_MX@C_LINK_WL_EX
							 Set newsl = v_currsl
						 Where dbdh = c_djh0.dbdh And Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
				End Loop;
				-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
				Delete From tm_gzdjh_new Where gzkey = v_gzkey;
				For c_djh1 In (Select Distinct newdh, newsl
												 From T_SL_GZJH_MX@C_LINK_WL_EX
												Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
				Loop

            -- 2018-06-07 add yangyi: 由于财务凭证中，传媒部门按税率区分不同科目，故增加限制:
            proc_chk_sl(p_ywbmbh, c_djh1.newsl, errno, errtext);
            If errno<>0  Then
                Rollback;
                Return;
            End If;

						Select Count(*)
							Into v_rows
							From tm_gzdjh_new
						 Where ghdwh = c_djh1.newdh And newsl = c_djh1.newsl And gzkey = v_gzkey;
						If v_rows = 0 Then
								Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
								dlgetlsh(p_ywbmbh, 'XT', 'XT', v_curr_ywpch);
								Insert Into tm_gzdjh_new
										(ghdwh, newsl, ywpch, flowid_dj, gzkey)
								Values
										(c_djh1.newdh, c_djh1.newsl, v_curr_ywpch, v_curr_bjlsh, v_gzkey);
						End If;
				End Loop;
				/*union
        Select Distinct a.dh,a.sl From t_KHTHMX a, T_SL_GZJH_MX b
        Where a.FLOWID=to_number(b.dbdh) and Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh
        */
				-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
				For c_djh2 In (Select Distinct a.dh, a.sl
												 From t_KHTHMX a, T_SL_GZJH_MX@C_LINK_WL_EX b
												Where a.FLOWID = to_number(b.dbdh) And Not Exists
												(Select 1
																 From tm_gzdjh_new
																Where ghdwh = a.dh And newsl = a.sl And gzkey = v_gzkey) And
															Trim(b.gzjhdh) = Trim(p_ywpch) And b.dh = p_dh)
				Loop
            -- 2018-06-07 add yangyi: 由于财务凭证中，传媒部门按税率区分不同科目，故增加限制:
            proc_chk_sl(p_ywbmbh, c_djh2.sl, errno, errtext);
            If errno<>0  Then
                Rollback;
                Return;
            End If;

						Select Count(*)
							Into v_rows
							From tm_gzdjh_new
						 Where ghdwh = c_djh2.dh And newsl = c_djh2.sl And gzkey = v_gzkey;
						If v_rows = 0 Then
								Select to_char(bjlsh_flowid.Nextval) Into v_curr_bjlsh From dual;
								dlgetlsh(p_ywbmbh, 'XT', 'XT', v_curr_ywpch);
								Insert Into tm_gzdjh_new
										(ghdwh, newsl, ywpch, flowid_dj, gzkey)
								Values
										(c_djh2.dh, c_djh2.sl, v_curr_ywpch, v_curr_bjlsh, v_gzkey);
						End If;
				End Loop;
		End If;
		v_bj := -123;
		---对明细进行更正
		For c1 In (Select *
								 From T_SL_GZJH_MX@C_LINK_WL_EX
								Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh)
		Loop
				s_id   := c1.newid;
				s_dbdh := Trim(c1.dbdh);
				Select dbbz, xbbz Into d_dbbz, d_xbbz From t_kcsm Where id = s_id;
				---校验数据表里是否有该单据
				If p_gzlx = 'FH' Then
						Select Count(*)
							Into l_count
							From t_fhmx
						 Where DBDH = s_dbdh And NVL(GZBJ, '0') <> '1';
						If l_count < 1 Then
								ERRNO   := -13;
								ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
													 s_dbdh;
								Rollback;
								Return;
						End If;
				End If;
				If p_GZLX = 'ST' Then
						Select to_number(c1.dbdh) Into d_flowid From dual;
						Select Count(*)
							Into l_count
							From t_hythmx
						 Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
						If l_count < 1 Then
								ERRNO   := -131;
								ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch) || ',' ||
													 d_flowid;
								Rollback;
								Return;
						End If;
				End If;
				If p_gzlx = 'XT' Then
						Select to_number(c1.dbdh) Into d_flowid From dual;
						Select Count(*)
							Into l_count
							From t_khthmx
						 Where flowid = d_flowid And NVL(GZBJ, '0') <> '1';
						If l_count < 1 Then
								ERRNO   := -132;
								ERRTEXT := '没有对应的调拨单号或者该单号正在进行其他更正，请稍后再做! 单据号' || Trim(p_ywpch);
								Rollback;
								Return;
						End If;
				End If;
				------------校验结束-------------------------------
				--------不管何种更正，都要先插入一个原始记录的负数
				If p_gzlx = 'FH' Then
						errno := -14;
						Select SFCS, FHZK, DH, sl
							Into l_yssl, D_FHZK_YS, s_dh_1212, v_currsl
							From t_fhmx
						 Where dbdh = s_dbdh; --and nvl(gzbj,'0') <> '1';
						-- 取得托收标记,以便下边程序判断是否写t_fhmx1
						Select nvl(tsbj, '0')
							Into v_tsbj
							From t_dm_ywbm
						 Where dh = s_dh_1212 And ywbmbh = p_ywbmbh;
						-- 原记录置更正标记
						s_dh_ys := s_dh_1212;
						errno   := -15;
						--插入负的发货记录
						Select to_char(all_flowid.Nextval) Into ls_dbdh_new From dual;
						--Select dh,sl Into v_currdh,v_currsl From t_fhmx Where dbdh=s_dbdh;
						v_bj := -1265;
						-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
						Select ywpch, to_char(flowid_dj)
							Into v_curr_ywpch, v_curr_bjlsh
							From tm_gzdjh_new
						 Where ghdwh = s_dh_1212 And newsl = v_currsl And gzkey = v_gzkey;
						v_bj  := -1266;
						errno := -16;
						-- 2009-12-07 yangyi: 增加 YSPFPCH, ysdbrq, GZDBDH
						-- 2011-02-16 yangyi: 如果是连锁店差异更正，则通过cspc='SL'来表示
						-- 2012-12-26 yangyi: 用zl字段携带直发转单标记
						-- zl: 0=正常、直发=1、补单=3  调剂发货=4，2012-12-27 yangyi
						-- 2013-05-15 yangyi:
						-- 将换户更正的单据备注上标明《换户更正》字样：
						-- 以便门店在接收此张更正单据时，顺便将原单也自动接收到系统当中。
						-- 这种情况的处理只涉及负单，与正单无关，所以只在这里做了处理
						Select newdh, dh
							Into v_newdh1, v_dh1
							From T_SL_GZJH_MX@C_LINK_WL_EX
						 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh And rownum = 1;
						If Trim(v_newdh1) <> Trim(v_dh1) Then
								v_bz := '换户更正';
						Else
								v_bz := '';
						End If;
						-------------------------------------------------------------------------
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_fhmx
								(FHFS, BZ, SL, ZJXS, SYLX, SYS, TIHFS, PFPCH, ID, ZDH, DH, SFCS, FHZK,
								 BZJS, YWBMBH, KFBH, BJLSH, HW, DJLY, CBJ, PJZK, dbdh, PFRQ, DBRQ, pfbmbh,
								 fhbmbh, txy, gzbj, ysdbdh, ysbbj, yh, jzthrq, yscs, zzpc, cgyj, cgyj_kh,
								 thl, thcs, YSPFPCH, ysdbrq, gzdbdh, dbbz, xbbz, cspc, zl, pk, yjfbj)
								Select FHFS, nvl(Trim(v_bz), BZ), SL, ZJXS, SYLX, -sys, TIHFS,
											 v_curr_ywpch /*s_ywpch*/, ID, ZDH, DH, -sfcs, FHZK, BZJS, YWBMBH,
											 KFBH, v_curr_bjlsh /*s_bjlsh*/, HW, DJLY, CBJ, PJZK, ls_dbdh_new,
											 Sysdate, Sysdate, pfbmbh, fhbmbh, txy, '1', dbdh, '1', yh, jzthrq,
											 -yscs, zzpc, cgyj, cgyj_kh, thl, -thcs, pfpch, dbrq, dbdh, dbbz,
											 xbbz, upper(p_gzczy), zl, pk, v_yjfbj
									From t_fhmx
								 Where dbdh = s_dbdh;
						Select -sys Into d_cysy_old From t_fhmx Where dbdh = ls_dbdh_new;
						errno := -17;
						
            Select Max(kfbh) Into v_gzkf From t_fhmx Where dbdh = s_dbdh;
						
            --2012-12-27 modify by lv 增加直发转单的更正标记
						-- zl: 0=正常、直发=1、补单=3  调剂发货=4，2012-12-27 yangyi
						Select zl Into ld_zl From t_fhmx Where dbdh = s_dbdh;
						If ld_zl = 1 Then
								ls_zfzd := '1';
						Elsif ld_zl = 3 Then
								ls_zfzd := '3';
						Elsif ld_zl = 4 Then
								ls_zfzd := '4';
						Else
								ls_zfzd := '0';
						End If;
						-- 原记录更正标记置为1
						Update t_fhmx Set gzbj = '1', cspc = 'SL' Where dbdh = s_dbdh;
						errno := -18;
						-- 先记一笔负发货: (t_fhmx_sl中ls_dbdh_new记录内本身就是负数)
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_crkls
								(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
								 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl,
								 flowid_wl, pk)
								Select all_flowid.Nextval, id, v_curr_ywpch /*s_ywpch*/, v_curr_ywpch
											 /*s_ywpch*/, Sysdate, 'FH', kfbh, dh, pfbmbh, ywbmbh, sfcs, 'FHGZ',
											 sys, sylx, fhzk, zjxs, 0, 0, 0, 0, sl, dbdh, pk
									From t_fhmx
								 Where dbdh = ls_dbdh_new;
						errno := -19;
						---商流判断时, 如果cs_new < 0 ，则商流在写t_fhmx时，将gzbj ='1'
						-- 2012-10-06 YANGYI: 改为用链的方式读取交换区的表，
						-- 因为交换区与物流可能不在同一个实例中了。
						-- T_WL_GZJG_MX_TEMP@C_LINK_WL_EX 新增了1个字段：gzlx char(1)
						-- 如果是总部发起的发货更正，则为0，如果是门店收货差异生成的更正，则置为1
						Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
								(ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
								 dh, SL_NEW, gzlx)
						Values
								(S_ID, p_ywpch, S_DBDH, LS_DBDH_NEW, v_curr_bjlsh /*S_BJLSH*/, S_DH_YS,
								 -L_YSSL, D_FHZK_YS, v_curr_ywpch /*S_YWPCH*/, p_dh, v_currsl,
								 decode(Trim(upper(p_gzczy)), 'SL', '1', '0'));
						Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = v_curr_bjlsh /*s_bjlsh*/
						;
						If v_jl = 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(v_curr_bjlsh /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;

				Elsif p_gzlx = 'XT' Then
						errno := -20;
						Select thcs, THZK, DH, sl
							Into l_yssl, D_FHZK_YS, S_DH_YS, v_currsl
							From t_khthmx
						 Where flowid = d_flowid;
						Select all_flowid.Nextval Into ldc_new_flowid From dual;
						-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
						Select ywpch, to_char(flowid_dj)
							Into v_curr_ywpch, v_curr_bjlsh
							From tm_gzdjh_new
						 Where ghdwh = S_DH_YS And newsl = v_currsl And gzkey = v_gzkey;
						errno := -21;
						-- 2009-12-07 add by yangyi: ysflowid,ysywpch,yslrrq,gzflowid
						--2013-01-17 modify by lv 山东的退货更正都算到退货库即2002 ，因此在此处写死、
						Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
						If tmpVar < 1 Then
								errno   := -1;
								errtext := '没有设置退货库房!';
								Rollback;
								Return;
						Else
								Select dh
									Into ls_thkf
									From t_dm
								 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
						End If;
						
            Select Max(kfbh) Into v_gzkf From t_khthmx Where flowid = d_flowid;
            
            --2013-07-03 modify by lv 为了查询程序日期，需要将lrrq1 用sysdate来填写
						-- 2016-12-29 yangyi: 增加写PK字段
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_khthmx
								(fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, tslsh, jspch, clrq, lrrq1, thlx,
								 sylx, zjxs, sl, dh, id, kfbh, ywbmbh, yscs, hw, dfdh, ysdh, dbbz, xbbz,
								 baohao, ysbbj, sb_ftp_pch, sb_ftp_rq, dhpch, ysbbj_kf, pch, bz, flowid,
								 thcs, thzk, gzbj, usr_id, lrrq, sys, cybh, ywpch, ysflowid, ysywpch,
								 yslrrq, gzflowid, pk)
								Select fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, Null, Null, Null, Sysdate,
											 thlx, sylx, zjxs, sl, dh, id, kfbh/*decode(tmp3f, 1, kfbh, ls_thkf)*/,
											 ywbmbh, yscs, hw, dfdh, ysdh, dbbz, xbbz, baohao, '1', sb_ftp_pch,
											 sb_ftp_rq, dhpch, ysbbj_kf, v_curr_ywpch /*s_ywpch*/, bz,
											 ldc_new_flowid, -thcs, thzk, '1', p_gzczy, Sysdate, -sys, p_cybh,
											 v_curr_ywpch /*s_ywpch*/, flowid, pch, lrrq, d_flowid,
											 ldc_new_flowid
									From t_khthmx
								 Where flowid = d_flowid;
						
						errno := -22;
						-- 原记录置更正标记:
						Update t_khthmx Set gzbj = '1' Where flowid = d_flowid;
						-- 按冲账记录写t_crkls:
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_crkls
								(flowid_crkls, ywpch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh, id, crkcs,
								 crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, fgbj, yspch,
								 flowid_wl, pk)
								Select all_flowid.Nextval, v_curr_ywpch /*s_ywpch*/, Sysdate, 'XT',
											 --decode(tmp3f, 1, kfbh, ls_thkf), 
                       kfbh, dh, p_cybh, ywbmbh, id, thcs, sys,
											 sylx, thzk, zjxs, dbbz, xbbz, thcs, sys, '0', pch, flowid, pk
									From t_khthmx
								 Where flowid = ldc_new_flowid;
						errno := -23;
						Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
								(ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
								 dh, sl_new)
						Values
								(S_ID, p_ywpch, S_DBDH, TO_CHAR(ldc_new_flowid), v_curr_ywpch /*s_ywpch*/,
								 S_DH_YS, -L_YSSL, D_FHZK_YS, v_curr_ywpch /*s_ywpch*/, p_dh, v_currsl);
						Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = v_curr_ywpch /*s_ywpch*/
						;
						If v_jl = 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(v_curr_ywpch /*s_ywpch*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
				Else
						--货源退货
						errno := -24;
						Select thcs, thzk, hybh, sl
							Into l_yssl, d_fhzk_ys, s_dh_ys, v_currsl
							From t_hythmx
						 Where flowid = d_flowid;
						Select all_flowid.Nextval Into ldc_new_flowid From dual;
						-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
						Select ywpch, to_char(flowid_dj)
							Into v_curr_ywpch, v_curr_bjlsh
							From tm_gzdjh_new
						 Where ghdwh = S_DH_YS And newsl = v_currsl And gzkey = v_gzkey;
						--2013-01-17 modify by lv 山东的退货更正都算到退货库即2002 ，因此在此处写死、
						Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
						If tmpVar < 1 Then
								errno   := -1;
								errtext := '没有设置退货库房!';
								Rollback;
								Return;
						Else
								Select dh
									Into ls_thkf
									From t_dm
								 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
						End If;
						-- 2009-12-07 add by yangyi: 新增YSYWPCH,ysdbrq,ysflowid,gzflowid
						-- 记一笔负退货
						--2014-2-26 modify by 增加p_gzczy
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_hythmx
								(YWPCH, ID, THCS, THZK, DBRQ, SYS, SYLX, ZJXS, HYBH, YWBMBH, FLOWID, sl,
								 kfbh, cybh, gzbj, bjlsh, ysbbj, cgyj, ysywpch, ysdbrq, ysflowid, gzflowid,
								 chych, pk, thlx)
								Select v_curr_ywpch /*s_ywpch*/, ID, -thcs, THZK, Sysdate, -sys, SYLX,
											 ZJXS, HYBH, YWBMBH, ldc_new_flowid, sl,
											 --decode(tmp3f, 1, kfbh, ls_thkf), 
                       kfbh, cybh, '1', v_curr_bjlsh /*s_bjlsh*/,
											 '1', cgyj, ywpch, dbrq, flowid, flowid, p_gzczy, pk, thlx
									From t_hythmx
								 Where flowid = d_flowid And nvl(gzbj, '0') <> '1';
                 
						-- 原记录置更正标记
						Update t_hythmx Set gzbj = '1' Where flowid = d_flowid;
						
            errno := -25;
						Select Max(kfbh) Into v_gzkf From t_hythmx Where flowid = d_flowid;
						
            --负退货记录原样复制到t_crkls中:
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_crkls
								(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
								 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl,
								 flowid_wl, pk)
								Select flowid, id, ywpch, ywpch, dbrq, 'ST',
											 --decode(tmp3f, 1, kfbh, ls_thkf), 
                       kfbh, hybh, cybh, ywbmbh, thcs, 'THGZ',
											 sys, sylx, thzk, zjxs, 0, 0, 0, 0, sl, flowid, pk
									From t_hythmx
								 Where flowid = ldc_new_flowid;
						
            errno := -26;
						Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
								(ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
								 dh, sl_new)
						Values
								(S_ID, p_ywpch, S_DBDH, TO_CHAR(ldc_new_flowid), v_curr_bjlsh /*s_bjlsh*/,
								 S_DH_YS, -L_YSSL, D_FHZK_YS, v_curr_ywpch /*s_ywpch*/, p_dh, v_currsl);
						Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = v_curr_bjlsh /*s_bjlsh*/
						;
						If v_jl = 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(v_curr_bjlsh /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
				End If;
				------------------插入负数结束------------------------------------------
				/*        errno := -27;
        If Trim(s_dh_ys) <> Trim(c1.newdh) Then
        --更换货源/客户时需要重新起单号
        s_ywpch_ghhy := s_ywpch_hy;
        s_bjlsh_ghhy := s_bjlsh_hy;
        Else
        s_ywpch_ghhy := s_ywpch;
        s_bjlsh_ghhy := s_bjlsh;
        End If;
        */
				errno := -28;
				v_bj  := -124;
				----插入新记录
				-- 2011-11-14 yangyi: 为处理王文华错报的数据
				-- If c1.newcs >= 0 Then
				-- 2011-12-07 yangyi:  改为即使更正后数量=0 也要插入一条新纪录，否则，就无法再次做更正了
				--
				--If c1.newcs <> 0 Then
				--插入新记录
				If p_gzlx = 'FH' Then
						-- 按更正后数据增加正发货记录
						s_crkls_lx := 'FHGZ';
						errno      := -29;
						Select jsdh, tsbj
							Into s_wl_jsdh, v_tsbj
							From t_dm_ywbm
						 Where dh = SUBSTRB(c1.newdh || '      ', 1, 6) And ywbmbh = p_ywbmbh;
						Select to_char(all_flowid.Nextval) Into ls_dbdh_new From dual;
						v_bj := -1241;
						errno := -30;
						-- 若更正后税率为空，表示与原税率一致：
						If c1.newsl Is Null Then
								Select sl Into c1.newsl From t_fhmx Where dbdh = s_dbdh;
						End If;
						-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
						Select ywpch, to_char(flowid_dj)
							Into v_curr_ywpch, v_curr_bjlsh
							From tm_gzdjh_new
						 Where ghdwh = SUBSTRB(c1.newdh || '      ', 1, 6) And newsl = c1.newsl And
									 gzkey = v_gzkey;
						v_bj := -1242;
						-- 2011-02-16 yangyi: 如果是连锁店差异更正，则通过cspc='SL'来表示
						-- 2012-12-26 yangyi: 用zl字段携带直发转单标记
						-- zl: 0=正常、直发=1、补单=3  调剂发货=4，2012-12-27 yangyi
						-- 2013-08-10 yangyi:
						-- 为处理对sylx的更正，若c1.newzk=0.1 且为AD类操作员，则表示更改sylx
						If c1.newzk = 0.1 And substrb(p_gzczy, 1, 2) = 'AD' Then
								-- 表示将sylx从1更为0
								Select decode(sylx, '0', '1', '0'), fhzk, id
									Into v_sylx_new, c1.newzk, v_id_new
									From t_fhmx
								 Where dbdh = s_dbdh;
								v_bj := -1243;
								If v_sylx_new = '0' Then
										Select dj Into v_zjxs_new From t_kcsm Where id = v_id_new;
										v_bj := -1244;
								Else
										v_zjxs_new := 100;
								End If;
						Else
								-- 正常更正处理
								Select zjxs, sylx
									Into v_zjxs_new, v_sylx_new
									From t_fhmx
								 Where dbdh = s_dbdh;
								v_bj := -125;
						End If;
            
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_fhmx
								(FHFS, BZ, SL, ZJXS, SYLX, SYS, TIHFS, PFPCH, ID, ZDH, DH, SFCS, FHZK,
								 BZJS, YWBMBH, KFBH, BJLSH, HW, DJLY, CBJ, PJZK, dbdh, PFRQ, DBRQ, pfbmbh,
								 fhbmbh, txy, gzbj, ysdbdh, ysbbj, yh, jzthrq, yscs, zzpc, cgyj, cgyj_kh,
								 thl, thcs, YSPFPCH, YSDBRQ, dbbz, xbbz, cspc, zl, pk, yjfbj)
								Select FHFS, BZ, c1.newsl, v_zjxs_new /*zjxs*/, v_sylx_new /*sylx*/,
											 round(c1.newcs * v_zjxs_new /*zjxs*/
															* c1.newzk / 100, 2), TIHFS, v_curr_ywpch, id, ls_dbdh_new,
											 c1.newdh, c1.newcs, c1.newzk, BZJS, YWBMBH, KFBH, v_curr_bjlsh, HW,
											 DJLY, CBJ, PJZK, ls_dbdh_new, Sysdate, Sysdate, pfbmbh, fhbmbh, txy,
											 '0', dbdh, '1', yh, jzthrq, sfcs, s_wl_jsdh, cgyj, cgyj_kh, thl,
											 thcs, PFPCH, DBRQ, dbbz, xbbz, upper(p_gzczy), zl, pk, v_yjfbj
									From t_fhmx
								 Where dbdh = s_dbdh;
						
            Select sys Into d_cysy_new From t_fhmx Where dbdh = ls_dbdh_new;
						
            Insert Into t_crkls
								(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
								 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl,
								 flowid_wl, pk)
								Select all_flowid.Nextval, id, pfpch, pfpch, Sysdate, 'FH', kfbh, dh,
											 pfbmbh, ywbmbh, sfcs, '发货更正', sys, sylx, fhzk, zjxs, 0, 0, 0, 0, sl,
											 dbdh, pk
									From t_fhmx
								 Where dbdh = ls_dbdh_new;
						
            -- 2012-10-06 YANGYI: 改为用链的方式读取交换区的表，
						-- 因为交换区与物流可能不在同一个实例中了。
						-- T_WL_GZJG_MX_TEMP@C_LINK_WL_EX 新增了1个字段：gzlx char(1)
						-- 如果是总部发起的发货更正，则为0，如果是门店收货差异生成的更正，则置为1
						Insert Into T_WL_GZJG_mx_TEMP@C_LINK_WL_EX
								(ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
								 dh, sl_New, gzlx)
						Values
								(S_ID, p_ywpch, S_DBDH, LS_DBDH_NEW, v_curr_bjlsh /*S_BJLSH_ghhy*/,
								 c1.newdh, c1.newcs, c1.newzk, v_curr_ywpch /*S_YWPCH_ghhy*/, p_dh,
								 c1.newsl, decode(Trim(upper(p_gzczy)), 'SL', '1', '0'));
						
            Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = v_curr_bjlsh /*s_bjlsh_ghhy*/
						;
						If v_jl = 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(v_curr_bjlsh /*s_bjlsh_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
						----------20130717------editby----zgm--------------
						proc_sd_fhxtst_gztj_xtw_crbz(S_dbdh, p_gzlx, p_ywpch, errno, errtext);
						If ERRNO <> 0 Then
								Rollback;
								Return;
						End If;
						--------------------------------------------------

            -- 2020-07-07 add yangyi: 取得发货折扣，为写t_bsjh_lsb.zk做准备
            select fhzk into v_zk from t_fhmx where dbdh=ls_dbdh_new;

				Elsif p_gzlx = 'XT' Then
						--销退更正 --插入新记录
						s_crkls_lx := '销退更正';
						errno      := -31;
						Select all_flowid.Nextval Into ldc_new_flowid From dual;
						-- 若更正后税率为空，表示与原税率一致：
						If c1.newsl Is Null Then
								Select sl Into c1.newsl From t_khthmx Where flowid = d_flowid;
						End If;
						-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
						Select ywpch, to_char(flowid_dj)
							Into v_curr_ywpch, v_curr_bjlsh
							From tm_gzdjh_new
						 Where ghdwh = SUBSTRB(c1.newdh || '      ', 1, 6) And newsl = c1.newsl And
									 gzkey = v_gzkey;
						
            --2013-01-17 modify by lv 山东的退货更正都算到退货库即2002 ，因此在此处写死
						Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
						If tmpVar < 1 Then
								errno   := -1;
								errtext := '没有设置退货库房!';
								Rollback;
								Return;
						Else
								Select dh
									Into ls_thkf
									From t_dm
								 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
						End If;
						
            --2013-07-03 modify by lv 为了查询程序日期，需要将lrrq1 用sysdate来填写
						-- 2013-08-10 yangyi:
						-- 为处理对sylx的更正，若c1.newzk=0.1 且为AD类操作员，则表示更改sylx
						If c1.newzk = 0.1 And substrb(p_gzczy, 1, 2) = 'AD' Then
								-- 表示将sylx从1更为0
								Select decode(sylx, '0', '1', '0'), thzk, id
									Into v_sylx_new, c1.newzk, v_id_new
									From t_khthmx
								 Where flowid = d_flowid;
								If v_sylx_new = '0' Then
										Select dj Into v_zjxs_new From t_kcsm Where id = v_id_new;
								Else
										v_zjxs_new := 100;
								End If;
						Else
								-- 正常更正处理
								Select zjxs, sylx
									Into v_zjxs_new, v_sylx_new
									From t_khthmx
								 Where flowid = d_flowid;
						End If;
						
            -- 2016-12-29 yangyi: 增加写PK字段
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_khthmx
								(fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, tslsh, jspch, clrq, lrrq1, thlx,
								 sylx, zjxs, sl, dh, id, kfbh, ywbmbh, yscs, hw, dfdh, ysdh, dbbz, xbbz,
								 baohao, ysbbj, sb_ftp_pch, sb_ftp_rq, dhpch, ysbbj_kf, pch, bz, flowid,
								 thcs, thzk, gzbj, usr_id, lrrq, sys, cybh, ywpch, ysflowid, YSYWPCH,
								 YSLRRQ, GZFLOWID, pk)
								Select fhdh, txy, khlb, tsh, zzpc, zzcy, sxh, Null, Null, Sysdate, Sysdate,
											 thlx, v_sylx_new, v_zjxs_new /*sylx, zjxs*/, c1.newsl, c1.newdh, id,
											 kfbh,--decode(tmp3f, 1, kfbh, ls_thkf), 
                       ywbmbh, c1.newcs, hw, dfdh, ysdh,
											 dbbz, xbbz, baohao, '1', sb_ftp_pch, sb_ftp_rq, dhpch, ysbbj_kf,
											 v_curr_ywpch, bz, ldc_new_flowid, c1.newcs, c1.newzk, '0', p_gzczy,
											 Sysdate,
											 round(c1.newcs * v_zjxs_new /*zjxs*/
															* c1.newzk / 100, 2), cybh, v_curr_ywpch, d_flowid, PCH,
											 LRRQ, FLOWID, ldc_new_flowid
									From t_khthmx
								 Where flowid = d_flowid;
                 
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致     
						Insert Into t_crkls
								(flowid_crkls, ywpch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh, id, crkcs,
								 crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, fgbj, yspch, bz,
								 flowid_wl, pk)
								Select all_flowid.Nextval, v_curr_ywpch /*s_ywpch_ghhy*/, Sysdate, 'XT',
											 kfbh,--decode(tmp3f, 1, kfbh, ls_thkf), 
                       dh, '3001', ywbmbh, id, thcs, sys,
											 sylx, thzk, zjxs, dbbz, xbbz, thcs, sys, '0', pch, '销退更正', flowid,
											 pk
									From t_khthmx
								 Where flowid = ldc_new_flowid;

						Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
								(ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
								 dh, sl_new)
						Values
								(S_ID, p_ywpch, S_DBDH, to_char(LDC_NEW_flowid), v_curr_ywpch
								 /*s_ywpch_ghhy*/, c1.newdh, c1.newcs, c1.newzk, v_curr_ywpch
								 /*s_ywpch_ghhy*/, p_dh, c1.newsl);
						Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = v_curr_ywpch /*s_ywpch_ghhy*/
						;
						If v_jl <= 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(v_curr_ywpch /*s_ywpch_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
						----------20130717------editby----zgm--------------
						proc_sd_fhxtst_gztj_xtw_crbz(d_flowid, p_gzlx, p_ywpch, errno, errtext);
						--------------------------------------------------

           -- 2020-07-07 add yangyi: 取得退货折扣，为写t_bsjh_lsb.zk做准备
            select thzk into v_zk from t_khthmx where flowid = ldc_new_flowid;

				Else
						--社退更正--插入新记录
						errno      := -32;
						s_crkls_lx := 'THGZ';
						Select all_flowid.Nextval Into ldc_new_flowid From dual;
						-- 若更正后税率为空，表示与原税率一致：
						If c1.newsl Is Null Then
								Select sl Into c1.newsl From t_hythmx Where flowid = d_flowid;
						End If;
						Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
						If tmpVar < 1 Then
								errno   := -1;
								errtext := '没有设置退货库房!';
								Rollback;
								Return;
						Else
								Select dh
									Into ls_thkf
									From t_dm
								 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
						End If;
						-- 2017-01-04 yangyi: 将临时表tm_gzdjh，改为正式表tm_gzdjh_new了，并增加了字段gzkey
						Select ywpch, to_char(flowid_dj)
							Into v_curr_ywpch, v_curr_bjlsh
							From tm_gzdjh_new
						 Where ghdwh = SUBSTRB(c1.newdh || '      ', 1, 6) And newsl = c1.newsl And
									 gzkey = v_gzkey;
						-- 2013-08-10 yangyi:
						-- 为处理对sylx的更正，若c1.newzk=0.1 且为AD类操作员，则表示更改sylx
						If c1.newzk = 0.1 And substrb(p_gzczy, 1, 2) = 'AD' Then
								-- 表示将sylx从1更为0
								Select decode(sylx, '0', '1', '0'), thzk, id
									Into v_sylx_new, c1.newzk, v_id_new
									From t_hythmx
								 Where flowid = d_flowid;
								If v_sylx_new = '0' Then
										Select dj Into v_zjxs_new From t_kcsm Where id = v_id_new;
								Else
										v_zjxs_new := 100;
								End If;
						Else
								-- 正常更正处理
								Select zjxs, sylx
									Into v_zjxs_new, v_sylx_new
									From t_hythmx
								 Where flowid = d_flowid;
						End If;
						--2014-2-26 modify by 增加p_gzczy
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_hythmx
								(YWPCH, ID, THCS, THZK, DBRQ, SYS, SYLX, ZJXS, HYBH, YWBMBH, FLOWID, sl,
								 kfbh, cybh, bjlsh, ysbbj, ysflowid, cgyj, YSYWPCH, YSDBRQ, chych, pk, thlx)
								Select v_curr_ywpch, id, c1.newcs, c1.newzk, Sysdate,
											 round(c1.newcs * v_zjxs_new /*zjxs*/
															* c1.newzk / 100, 2), v_sylx_new, v_zjxs_new, /*sylx, zjxs,*/
											 c1.newdh, YWBMBH, ldc_new_flowid, c1.Newsl,
											 kfbh,--decode(tmp3f, 1, kfbh, ls_thkf), 
                       cybh, v_curr_bjlsh, '1', d_flowid,
											 cgyj, YWPCH, DBRQ, p_gzczy, pk, thlx
									From t_hythmx
								 Where flowid = d_flowid;
                 
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致    
						Insert Into t_crkls
								(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
								 crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs, sn_crksy, sl,
								 flowid_wl, pk)
								Select flowid, id, ywpch, ywpch, dbrq, 'ST',
											 kfbh,--decode(tmp3f, 1, kfbh, ls_thkf), 
                       hybh, cybh, ywbmbh, thcs, '进退更正',
											 sys, sylx, thzk, zjxs, 0, 0, 0, 0, sl, flowid, pk
									From t_hythmx
								 Where flowid = ldc_new_flowid;
						Insert Into T_WL_GZJG_MX_TEMP@C_LINK_WL_EX
								(ID, GZJHDH, DBDH_OLD, DBDH_NEW, BJLSH_NEW, DH_NEW, CS_NEW, ZK_NEW, YWPCH,
								 dh, sl_new)
						Values
								(S_ID, p_ywpch, S_DBDH, to_char(LDC_NEW_flowid), v_curr_bjlsh
								 /*s_bjlsh_ghhy*/, c1.newdh, c1.newcs, c1.newzk, v_curr_ywpch
								 /*s_ywpch_ghhy*/, p_dh, c1.newsl);
						Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = v_curr_ywpch /*s_bjlsh_ghhy*/
						;
						If v_jl <= 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(v_curr_ywpch /*s_bjlsh_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
						----------20130717------editby----zgm--------------
						proc_sd_fhxtst_gztj_xtw_crbz(d_flowid, p_gzlx, p_ywpch, errno, errtext);
						--------------------------------------------------

            -- 2020-07-07 add yangyi: 取得退货折扣，为写t_bsjh_lsb.zk做准备
            select thzk into v_zk from t_hythmx where flowid = ldc_new_flowid;

				End If;
				--End If;
				------------------------------------插入新记录结束
				v_bj := -224;
				--如果册数发生改变，要进行差异处理
				If l_yssl <> c1.newcs Then
						--新册数 减 原始数量 如果是发货、退货更正，差异数大于0，表示需要补充发货，
						l_cys := c1.newcs - l_yssl;
						-- 如果更正后会引起库存减少, 则用正损益来平衡
						If (l_cys > 0 And p_gzlx <> 'XT') Or (l_cys < 0 And p_gzlx = 'XT') Then
								If p_gzlx = 'XT' Then
										v_cys := -l_cys;
								Else
										v_cys := l_cys;
								End If;
								-- 2010-11-17 yangyi modify:
								-- 为损益匹配时统一处理，改为全部写差异了，
								---如果库存减少，为平抑库存，则记正差异，
								--dlgetlsh(p_ywbmbh, 'CY', 'CY', s_ywpch_sy);
								dlgetlsh(p_cybh, 'CY', 'CY', s_ywpch_sy);
								Select all_flowid.Nextval Into d_crkls From dual;
								-- 2012-10-07 yangyi: 增加 cylx, gzmxkey
								If p_gzlx = 'XT' Or p_gzlx = 'ST' Then
										--2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
										Select Count(*)
											Into tmpVar
											From t_dm
										 Where lxbh = '2' And kflx = 'TH';
										If tmpVar < 1 Then
												errno   := -1;
												errtext := '没有设置退货库房!';
												Rollback;
												Return;
										Else
												Select dh
													Into ls_thkf
													From t_dm
												 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
										End If;
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_crkls
												(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
												 ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
												 sn_crksy, sl, cylx, gzmxkey)
										Values
												(d_crkls, S_Id, s_ywpch_sy, s_ywpch_sy, Sysdate, 'CY',
												 --decode(tmp3f, 1, v_gzkf, ls_thkf),
												 --decode(tmp3f, 1, v_kfbh, ls_thkf), 
                         v_gzkf, v_gzkf,
                         p_CYBH, p_ywbmbh, v_cys,
												 decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', 0, '0', 0,
												 0, 0, 0, 0, 0, 10, p_gzlx, s_dbdh);
										-- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
										-- 山东正差异也报商流：
										-- t_bsjh_lsb 是为上报商流用的
										-- 由于上报的负差异在t_bsjh_lsb表中, 是以正值来表示的（即：报损=正，报益=负）
										-- 以便统一写下边的插入语句
										-- 2013-11-08 YANGYI: 写cs时，改用 - v_cys

                    -- 2020-07-07 yangyi: 增加写zk字段, 最主要目的是商流写t_hykcsl时，需要 thzk
                    --                    物流通过过程 proc_sx_cksjfs_xtw 写入 t_wl_bsjh，商流再接收
										-- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_bsjh_lsb
												(flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
												 gzmxkey, zfzdbj, zk)
										Values
												(all_flowid.Nextval, s_id, p_ywbmbh,
												 v_gzkf, --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, -v_cys /*-l_cys*/,
												 s_ywpch_sy, d_crkls, p_gzlx, s_dbdh, ls_zfzd, v_zk);

										-- t_sy_jh 是为物流用于后期匹配的
										--2011-07-12 by lv
										--2012-12-27 增加直发转单更正标记
										-- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_sy_jh
												(flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj, czybh)
										Values
												( /*all_flowid.nextval*/ d_crkls, s_id, p_ywbmbh,
												 v_gzkf, --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, v_cys, Sysdate, 'SY',
												 decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd,
												 p_gzczy);
								Else
										-- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_crkls
												(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
												 ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
												 sn_crksy, sl, cylx, gzmxkey)
										Values
												(d_crkls, S_Id, s_ywpch_sy, s_ywpch_sy, Sysdate, 'CY', v_gzkf/*v_kfbh*/,
												 v_gzkf/*v_kfbh*/, p_CYBH, p_ywbmbh, v_cys,
												 decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', 0, '0', 0,
												 0, 0, 0, 0, 0, 10, p_gzlx, s_dbdh);
										-- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
										-- 山东正差异也报商流：
										-- t_bsjh_lsb 是为上报商流用的
										-- 由于上报的负差异在t_bsjh_lsb表中, 是以正值来表示的（即：报损=正，报益=负）
										-- 以便统一写下边的插入语句

                    -- 2020-07-07 yangyi: 增加写zk字段, 最主要目的是商流写t_hykcsl时，需要 thzk
                    --                    物流通过过程 proc_sx_cksjfs_xtw 写入 t_wl_bsjh，商流再接收
										-- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_bsjh_lsb
												(flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
												 gzmxkey, zfzdbj, zk)
										Values
												(all_flowid.Nextval, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/, p_cybh, -l_cys,
												 s_ywpch_sy, d_crkls, p_gzlx, s_dbdh, ls_zfzd, v_zk);
										
                    -- t_sy_jh 是为物流用于后期匹配的
										-- 2011-07-12 by lv
										-- 2012-12-27 增加直发转单更正标记
										-- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
                    Insert Into t_sy_jh
												(flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj, czybh)
										Values
												( /*all_flowid.nextval*/ d_crkls, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/, p_cybh,
												 v_cys, Sysdate, 'SY',
												 decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd,
												 p_gzczy);
								End If;
						End If;
						
            Select all_flowid.Nextval Into d_bs_flowid From dual;
						-- 如果更正后会引起库存增加, 则用 负差异 来平衡, 注意: 是CY
						If (l_cys < 0 And p_gzlx <> 'XT') Or (l_cys > 0 And p_gzlx = 'XT') Then
								If p_gzlx = 'XT' Or p_gzlx = 'ST' Then
										--2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
										Select Count(*)
											Into tmpVar
											From t_dm
										 Where lxbh = '2' And kflx = 'TH';
										If tmpVar < 1 Then
												errno   := -1;
												errtext := '没有设置退货库房!';
												Rollback;
												Return;
										Else
												Select dh
													Into ls_thkf
													From t_dm
												 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
										End If;
								End If;
								If p_GZLX = 'ST' Then
										/*
                    --2012-12-27 modify by lv 因为差异算到退货上，因此不需要进行转移操作了
                    --如果是货源退货更正，要首先写一个转移数据，从退货库转移到立库
                    dlgetlsh(p_cybh, 'ZC', 'ZC', ls_zypch);
                    Insert Into t_wl_zyls
                    (flowid, id, ckkf, rkkf, cybh, ywbmbh, yssl, sjsl, cgyj, lx,
                    ghdwh, zypch, Zjxs, ZK, SYLX, rq)
                    Select all_flowid.Nextval, id, kfbh, v_kfbh, cybh, ywbmbh, -l_cys,
                    -l_cys, cgyj, 'SZ', hybh, ls_zypch, zjxs, thzk, sylx,
                    Sysdate
                    From t_hythmx
                    Where flowid = d_flowid;

                    Insert Into t_crkls
                    (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                    ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                    sn_crksy, sl)
                    Select all_flowid.Nextval, id, ls_zypch, bjlsh, Sysdate, 'ZC',
                    KFBH, v_kfbh, CYBH, YWBMBH, -L_CYS, '进退更正', 0, SYLX, THZK,
                    ZJXS, D_DBBZ, D_XBBZ, -L_CYS, 0, SL
                    From t_hythmx
                    Where flowid = d_flowid;

                    dlgetlsh(p_cybh, 'ZR', 'ZR', ls_zypch);
                    Insert Into t_crkls
                    (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
                    ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
                    sn_crksy, sl)
                    Select all_flowid.Nextval, id, ls_zypch, bjlsh, Sysdate, 'ZR',
                    v_kfbh, KFBH, CYBH, YWBMBH, -L_CYS, '进退更正', 0, SYLX, THZK,
                    ZJXS, D_DBBZ, D_XBBZ, -L_CYS, 0, SL
                    From t_hythmx
                    Where flowid = d_flowid;

                    */
										dlgetlsh(p_cybh, 'CY', 'CY', s_ywpch_sy);
										-- l_cys本身是负值, 所以, 这里应该是 负差异
										-- 2012-10-07 yangyi: 增加 cylx, gzmxkey
										--2012-12-27  差异算到退货库上
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_crkls
												(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
												 ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
												 sn_crksy, sl, cylx, gzmxkey, flowid_wl, pk)
												Select d_bs_flowid, id, s_ywpch_sy, bjlsh, Sysdate, 'CY',
															 kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                               KFBH, CYBH, YWBMBH, L_CYS,
															 '进退更正', 0, SYLX, THZK, ZJXS, D_DBBZ, D_XBBZ, L_CYS, 0, SL,
															 p_gzlx, s_dbdh, flowid, pk
													From t_hythmx
												 Where flowid = d_flowid;
								Elsif P_GZLX = 'FH' Then
										dlgetlsh(p_cybh, 'CY', 'CY', s_ywpch_sy);
										-- 2012-10-07 yangyi: 增加 cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_crkls
												(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
												 ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
												 sn_crksy, sl, cylx, gzmxkey, flowid_wl, pk)
												Select d_bs_flowid, id, s_ywpch_sy, s_dbdh, Sysdate, 'CY', kfbh,
															 dh, pfbmbh, ywbmbh, l_cys, '发货更正',
															 round(l_cys * zjxs * FHZK / 100, 2), sylx, fhzk, zjxs, 0, 0,
															 0, 0, sl, p_gzlx, s_dbdh, dbdh, pk
													From t_fhmx
												 Where dbdh = ls_dbdh_new;
								Else
										---如果是客户退货更正，往大了更，则物流要增加库存
										-- 为避免库存增加, 用负差异来平衡一下, 使库存保持不变
										-- 注意, 对销退来说, L_CYS是个>0的数, 所以这里要取负值
										--
										v_bj := -234;
										dlgetlsh(p_cybh, 'CY', 'CY', s_ywpch_sy);
										-- 2012-10-07 yangyi: 增加 cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_crkls
												(flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh,
												 ywbmbh, crkcs, bz, crksy, sylx, zk_jg, zjxs, dbbz, xbbz, sn_crkcs,
												 sn_crksy, sl, cylx, gzmxkey, flowid_wl, pk)
												Select d_bs_flowid, id, s_ywpch_sy, s_dbdh, Sysdate, 'CY',
															 kfbh, --decode(tmp3f, 1, kfbh, ls_thkf), 
                               dh, cybh, ywbmbh, -l_cys,
															 '销退更正', round(-l_cys * zjxs * thZK / 100, 2), sylx, thzk,
															 zjxs, 0, 0, 0, 0, sl, p_gzlx, s_dbdh, flowid, pk
													From t_khthmx
												 Where flowid = ldc_new_flowid;
								End If;
								-- 负差异需要上报商流
								-- t_bsjh_lsb 是为上报商流用的
								-- 由于上报的负差异在t_bsjh_lsb表中, 是以正值来表示的（即：报损=正，报益=负）
								-- 而由于销退是正值才走这里, 所以对销退的差异数要先求一次反
								-- 以便统一写下边的插入语句
								v_bj := -244;
								If p_gzlx = 'XT' Then
										l_cys := -l_cys;
								End If;
								If p_gzlx = 'XT' Or p_gzlx = 'ST' Then
										-- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_bsjh_lsb
												(flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
												 gzmxkey, zfzdbj)
										Values
												(all_flowid.Nextval, s_id, p_ywbmbh,
												 v_gzkf, --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, -l_cys, s_ywpch_sy,
												 d_bs_flowid, p_gzlx, s_dbdh, ls_zfzd);
										-- t_sy_jh 是为物流用于后期匹配的
										--2011-07-12
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_sy_jh
												(flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj)
										Values
												( /*all_flowid.nextval*/ d_bs_flowid, s_id, p_ywbmbh,
												 v_gzkf,
                         --decode(tmp3f, 1, v_gzkf, ls_thkf), 
                         p_cybh, -l_cys, Sysdate, 'BS',
												 decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd);
								Else
										-- 2012-10-07 yangyi: 新增字段：flowid_crkls_wl, cylx, gzmxkey
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_bsjh_lsb
												(flowid, id, ywbmbh, kfbh, cybh, cs, ysdjh, flowid_crkls_wl, cylx,
												 gzmxkey, zfzdbj)
										Values
												(all_flowid.Nextval, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/, p_cybh, -l_cys,
												 s_ywpch_sy, d_bs_flowid, p_gzlx, s_dbdh, ls_zfzd);
										-- t_sy_jh 是为物流用于后期匹配的
										--2011-07-12
                    -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
										Insert Into t_sy_jh
												(flowid, id, ywbmbh, kfbh, cybh, cs, rq, lx, reason, zybj)
										Values
												( /*all_flowid.nextval*/ d_bs_flowid, s_id, p_ywbmbh, v_gzkf/*v_kfbh*/,
												 p_cybh, -l_cys, Sysdate, 'BS',
												 decode(p_gzlx, 'ST', '进退', 'FH', '发货', '销退') || '更正', ls_zfzd);
								End If;
						End If;
				End If;
				-----------------------------------结束更正
				errno := 0;
		End Loop;
		v_bj := -264;
		Update t_sl_gzjh_hz@C_LINK_WL_EX
			 Set receflag = '1'
		 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		-- 2011-01-07 add by yangyi:
		-- 如果是发货更正需要写t_wcbj, t_wl_dfbj
		If p_gzlx = 'FH' Then
				For c_bj In (Select * From tm_gzdjh_new Where gzkey = v_gzkey)
				Loop
						v_curr_bjlsh := to_char(c_bj.flowid_dj);
						Select Count(*), Sum(t_fhmx.sfcs), Sum(t_fhmx.sfcs * t_kcsm.dj),
									 Sum(t_fhmx.sys), Min(dh)
							Into v_zpz, v_zcs, v_zmy, v_zsy, v_dh
							From t_fhmx, t_kcsm
						 Where t_kcsm.id = t_fhmx.id And t_fhmx.pfpch = c_bj.Ywpch; /*s_ywpch;*/
						v_bj := -998;
						Insert Into t_wcbj
								(BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
								 FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
								 YWLX, FYRQ, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
								 CYR, CYDW, ssjs, psjs, shrq, hw, zb, js, jxfs)
						Values
								(to_char(c_bj.flowid_dj) /*s_bjlsh*/, '', Sysdate, p_ywbmbh, c_bj.Ywpch
								 /*s_ywpch*/, v_dh, v_zpz, v_zcs, v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate,
								 '', '16', '', '', '', v_dh, '', '16', 'FH', Sysdate, '', Sysdate, '',
								 Null, '', '', '', Sysdate, '', '', '', 1, 0, Sysdate, '', '', 1,
								 decode(ls_zfzd, '1', 'ZF', ''));
						-- 为回告商流:
						Insert Into t_wl_dfbj@C_LINK_WL_EX
								(BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
								 FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
								 YWLX, FYrq, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
								 CYR, CYDW, ssjs, psjs, shrq, hw, zb, JS, RECEBMBH, SENDBMBH, RECEFLAG,
								 SENDDATE)
						Values
								(to_char(c_bj.flowid_dj) /*s_bjlsh*/, '', Sysdate, p_ywbmbh, c_bj.Ywpch
								 /*s_ywpch*/, v_dh, v_zpz, v_zcs, v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate,
								 '', '16', '', '', '', v_dh, '', '16', 'FH', Sysdate, '', Sysdate, '',
								 Null, '', '', '', Sysdate, '', '', '', 1, 0, Sysdate, '', '', 1, p_ywbmbh,
								 p_cybh, '0', Sysdate);
						/*        If Trim(s_ywpch_ghhy) <> Trim(s_ywpch) Then

            Select Count(*), Sum(t_fhmx.sfcs), Sum(t_fhmx.sfcs * t_kcsm.dj),
            Sum(t_fhmx.sys), Min(dh)
            Into v_zpz, v_zcs, v_zmy, v_zsy, v_dh
            From t_fhmx, t_kcsm
            Where t_kcsm.id = t_fhmx.id And t_fhmx.pfpch = s_ywpch_ghhy;

            v_bj := -999;
            Insert Into t_wcbj
            (BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
            FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
            YWLX, FYRQ, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
            CYR, CYDW, ssjs, psjs, shrq, hw, zb, js)
            Values
            (s_bjlsh_ghhy, '', Sysdate, p_ywbmbh, s_ywpch_ghhy, v_dh, v_zpz, v_zcs,
            v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate, '', '16', '', '', '', v_dh, '',
            '16', 'FH', Sysdate, '', Sysdate, '', Null, '', '', '', Sysdate, '', '',
            '', 1, 0, Sysdate, '', '', 1);

            -- 为回告商流:
            Insert Into t_wl_dfbj
            (BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS,
            FHBMBH, FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS,
            YWLX, FYrq, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE,
            CYR, CYDW, ssjs, psjs, shrq, hw, zb, JS, RECEBMBH, SENDBMBH, RECEFLAG,
            SENDDATE)
            Values
            (s_bjlsh_ghhy, '', Sysdate, p_ywbmbh, s_ywpch_ghhy, v_dh, v_zpz, v_zcs,
            v_zmy, v_zsy, 0, 1, p_cybh, '', Sysdate, '', '16', '', '', '', v_dh, '',
            '16', 'FH', Sysdate, '', Sysdate, '', Null, '', '', '', Sysdate, '', '',
            '', 1, 0, Sysdate, '', '', 1, p_ywbmbh, p_cybh, '0', Sysdate);

            End If;
            */
						Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = v_curr_bjlsh /*s_bjlsh*/
						;
						If v_jl <= 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(v_curr_bjlsh /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
				End Loop;
		End If;
		-- 2009-12-07 add by yangyi:
		-- 如果是销退更正需要写t_khthhz, t_khthhz_sl
		If p_gzlx = 'XT' Then
				v_bj := -274;
				--2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
				Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
				If tmpVar < 1 Then
						errno   := -1;
						errtext := '没有设置退货库房!';
						Rollback;
						Return;
				Else
						Select dh
							Into ls_thkf
							From t_dm
						 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
				End If;
				For c_hz In (Select * From tm_gzdjh_new Where gzkey = v_gzkey)
				Loop
						--v_bj := -375;
						--Select thrq Into v_ysthrq From t_khthhz Where thpch = c_hz.Ywpch/*p_ywpch*/;
						Select Min(dh)
							Into v_dh
							From t_khthmx
						 Where ywpch = c_hz.Ywpch /*s_ywpch*/
						;
						-- 取得托收标记
						Select nvl(tsbj, '0'), nvl(lsdbj, '0'), khlxbh
							Into v_tsbj, v_lsdbj, v_khlxbh
							From t_dm_ywbm
						 Where dh = v_dh And ywbmbh = p_ywbmbh;
						v_bj := -374;
						-- 写物流t_khthhz表:
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_khthhz
								(THRQ, YDKJE, YJSBJ, TXY, THPCH, DH, ZPZ, ZCS, ZMY, ZSY, SL, YWPC, KFBH,
								 FGBJ, KCFGBJ, THXCBJ, YSBBJ, WZSCBJ, WZSCRQ, YSBBJ_KF, CYBH, YWBMBH, thlx)
								Select Min(t_khthmx.lrrq), 0, '0', Min(t_khthmx.txy), t_khthmx.pch,
											 t_khthmx.dh, Count(*), Sum(t_khthmx.thcs),
											 Sum(t_khthmx.thcs * t_kcsm.dj), Sum(t_khthmx.sys), Min(t_khthmx.sl),
											 t_khthmx.pch, min(t_khthmx.kfbh),
                       --Max(decode(tmp3f, 1, kfbh, ls_thkf)),
                        '0', '0', '0',
											 '1', '0', Null, '0', Min(cybh), Min(ywbmbh),min(t_khthmx.thlx)
									From t_khthmx, t_kcsm
								 Where t_kcsm.id = t_khthmx.id And t_khthmx.ywpch = c_hz.Ywpch /*s_ywpch*/
											 And t_khthmx.dh = v_dh
								 Group By t_khthmx.pch, t_khthmx.dh;
						/*        If Trim(s_ywpch_ghhy) <> Trim(s_ywpch) Then

            Select Min(dh) Into v_dh From t_khthmx Where ywpch = s_ywpch_ghhy;
            -- 取得托收标记
            Select nvl(tsbj, '0'), nvl(lsdbj, '0'), khlxbh
            Into v_tsbj, v_lsdbj, v_khlxbh
            From t_dm_ywbm
            Where dh = v_dh And ywbmbh = p_ywbmbh;
            Insert Into t_khthhz
            (THRQ, YDKJE, YJSBJ, TXY, THPCH, DH, ZPZ, ZCS, ZMY, ZSY, SL, YWPC, KFBH,
            FGBJ, KCFGBJ, THXCBJ, YSBBJ, WZSCBJ, WZSCRQ, YSBBJ_KF, CYBH, YWBMBH)
            Select Min(t_khthmx.lrrq), 0, '0', Min(t_khthmx.txy), t_khthmx.pch,
            t_khthmx.dh, Count(*), Sum(t_khthmx.thcs),
            Sum(t_khthmx.thcs * t_kcsm.dj), Sum(t_khthmx.sys), Min(t_khthmx.sl),
            t_khthmx.pch, Min(t_khthmx.kfbh), '0', '0', '0', '1', '0', Null,
            '0', Min(cybh), Min(ywbmbh)
            From t_khthmx, t_kcsm
            Where t_kcsm.id = t_khthmx.id And t_khthmx.ywpch = s_ywpch_ghhy And
            t_khthmx.dh = v_dh
            Group By t_khthmx.pch, t_khthmx.dh;
            End If;

            */
						v_bj := -474;
						Select Count(*)
							Into v_jl
							From t_gzdj_print
						 Where ywpch = c_hz.ywpch /*s_bjlsh*/
						;
						If v_jl <= 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(c_hz.ywpch /*s_bjlsh*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
				End Loop;
		End If;
		-- 写物流t_hythhz表:
		If p_gzlx = 'ST' Then
				--2013-01-17 modify by lv 山东的退货更正、社退更正都算到退货库即2002 ，因此在此处写死、
				Select Count(*) Into tmpVar From t_dm Where lxbh = '2' And kflx = 'TH';
				If tmpVar < 1 Then
						errno   := -1;
						errtext := '没有设置退货库房!';
						Rollback;
						Return;
				Else
						Select dh
							Into ls_thkf
							From t_dm
						 Where lxbh = '2' And kflx = 'TH' And rownum = 1;
				End If;
				For c_hz In (Select * From tm_gzdjh_new Where gzkey = v_gzkey)
				Loop
            --2020-10-31 yangyi: 增加写thlx
            -- 2020-11-19 yangyi: 库房编号保持与原记录的库房一致
						Insert Into t_hythhz
								(THRQ, YWPCH, HYBH, CYBH, YWBMBH, KFBH, ZPZ, ZCS, ZMY, ZSY, BJS, USR_ID,
								 JHR, FYPC, FYRQ, FYFS, YH, CH, FYR, Bz, thlx)
								Select Min(dbrq), ywpch, hybh, cybh, ywbmbh,
											 min(t_hythmx.kfbh),
                       --decode(tmp3f, 1, kfbh, ls_thkf), 
                       Count(id), Sum(thcs),
											 Sum(thcs * zjxs), Sum(sys), 1, 'auto', '', '', Min(dbrq), '', '',
											 '', '', '更正',min(thlx)
									From t_hythmx
								 Where ywpch = c_hz.Ywpch /*s_ywpch*/
								 Group By ywpch, hybh, cybh, ywbmbh, kfbh;
						Select Count(*) Into v_jl From t_gzdj_print Where ywpch = c_hz.ywpch;
						If v_jl <= 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(c_hz.ywpch, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
						If v_jl = 0 Then
								Insert Into t_gzdj_print
										(ywpch, gzrq, djlx, cs, gzczy)
								Values
										(c_hz.Ywpch /*s_bjlsh_ghhy*/, Sysdate, p_gzlx, 0, p_gzczy);
						End If;
				End Loop;
		End If;
		/*    If Trim(s_ywpch_ghhy) <> Trim(s_ywpch) Then
    Insert Into t_gzdj_print
    (ywpch, gzrq, djlx, cs, gzczy)
    Values
    (s_bjlsh_ghhy, Sysdate, p_gzlx, 0, p_gzczy);
    If p_gzlx = 'ST' Then
    Insert Into t_hythhz
    (THRQ, YWPCH, HYBH, CYBH, YWBMBH, KFBH, ZPZ, ZCS, ZMY, ZSY, BJS, USR_ID,
    JHR, FYPC, FYRQ, FYFS, YH, CH, FYR, Bz)
    Select Min(dbrq), ywpch, hybh, cybh, ywbmbh, kfbh, Count(id), Sum(thcs),
    Sum(thcs * zjxs), Sum(sys), 1, 'auto', '', '', Min(dbrq), '', '',
    '', '', '更正'
    From t_hythmx
    Where ywpch = s_ywpch_ghhy
    Group By ywpch, hybh, cybh, ywbmbh, kfbh;
    End If;
    End If;
    */
		v_bj := -284;
		Insert Into t_wl_gzjg_mx@c_link_wl_ex
				Select *
					From T_WL_GZJG_MX_TEMP@c_link_wl_ex
				 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		Update t_wl_gzjg_mx@c_link_wl_ex
			 Set gzjhdh = Trim(gzjhdh), dbdh_old = Trim(dbdh_old), dbdh_new = Trim(dbdh_new),
					 bjlsh_new = Trim(bjlsh_new), dh_new = Trim(dh_new), ywpch = Trim(ywpch)
		 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		Select Count(*)
			Into l_count_sl
			From t_wl_gzjg_mx@c_link_wl_ex
		 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		Delete t_wl_gzjg_hz@c_link_wl_ex Where gzjhdh = Trim(p_ywpch);

    Insert Into t_wl_gzjg_hz@c_link_wl_ex
				(GZJHDH, SENDBMBH, GZLX, RECEBMBH, RECEFLAG, SENDDATE, JLS, zdbj, gzczy, dh)
		Values
				(Trim(p_ywpch), Trim(p_cybh), Trim(p_gzlx), Trim(p_ywbmbh), '0', Sysdate,
				 l_count_sl, s_zdbj, Trim(p_gzczy), p_dh);
		Delete From t_wl_gzjg_mx_temp@c_link_wl_ex
		 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		Insert Into t_sl_gzjh_hz_bak
				Select *
					From t_sl_gzjh_hz@c_link_wl_ex
				 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		Insert Into t_sl_gzjh_mx_bak
				Select *
					From t_sl_gzjh_mx@c_link_wl_ex
				 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		Delete From t_sl_gzjh_hz@c_link_wl_ex
		 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		Delete From t_sl_gzjh_mx@c_link_wl_ex
		 Where Trim(gzjhdh) = Trim(p_ywpch) And dh = p_dh;
		-- 2017-01-04 add by yangyi:
		Delete From Tm_Gzdjh_new Where gzkey = v_gzkey;
		errno   := 0;
		errtext := 'OK';
Exception
		When Others Then
				errno   := v_bj;
				errtext := Sqlerrm || p_ywpch || '-PROC_SX_FHXTST_GZ_XTW' || v_bj || ',' ||
									 p_cybh || ',' || p_ywbmbh || ',' || p_gzlx || ',' || p_gzczy || ',' || p_dh;
				--                   to_char(d_flowid); --||','||s_dh_1212||','||v_currsl||','||v_rows;
				Rollback;
				Return;
End PROC_SX_FHXTST_GZ_XTW;
/
create or replace procedure RF_UPDATETLDJHZ(
p_djr char,
p_ghdw char,
p_ssjs number,
p_djlx char,
p_ywbmbh char,
p_djsl number,
p_id_wlfh char,
p_hw      char,
p_wlgs char,
p_wldh char,
p_flowid number,
p_stop  char,
ERRNO   Out Number,
ERRTEXT Out Char
)
as

  v_rows number;
  v_wlsh t_wlsh%rowtype;
begin


     select * into v_wlsh from t_wlsh where id=p_flowid;
      if v_wlsh.ywbmbh<>p_ywbmbh then

        select count(*) into v_rows from tmp_dhdj@c_link_wl_sl where
         flowid_tldjhz=p_flowid or flowid_tldjhz_tmp=p_flowid ;
        if v_rows >0 then

            ERRNO:=-2;
            ERRTEXT:='投单下已录入单据，不能修改业务部门';
          return;

        end if ;
        select count(*) into v_rows from tmp_dhdj  where flowid_tldjhz=p_flowid ;
        if v_rows >0 then

            ERRNO:=-3;
            ERRTEXT:='投单下已录入单据，不能修改业务部门';
          return;


        end if ;

       select count(*) into v_rows from tmp_dhdj_xtw where flowid_tldjhz=p_flowid;
        if v_rows >0 then
            ERRNO:=-4;
            ERRTEXT:='已经确认收货，不能修改业务部门';
          return;

        end if ;

      end if;

      if v_wlsh.djsl<>p_djsl then
         select count(*) into v_rows from tmp_dhdj@c_link_wl_sl where
          flowid_tldjhz=p_flowid or flowid_tldjhz_tmp=p_flowid ;
          if v_rows >0 then
             select count(*) into v_rows from tmp_dhdj@c_link_wl_sl where
              sbbj='0' and ( flowid_tldjhz=p_flowid or flowid_tldjhz_tmp=p_flowid );
             if v_rows =0 then
                ERRNO:=-2;
                ERRTEXT:='电子单已提交业务审核，不能修改单据张数';
                return;

             end if;

          end if ;
      end if;

      if v_wlsh.dh<>p_ghdw then
          select count(*) into v_rows from tmp_dhdj@c_link_wl_sl
          where  flowid_tldjhz=p_flowid or flowid_tldjhz_tmp=p_flowid ;
          if v_rows >0 then
             select count(*) into v_rows from tmp_dhdj@c_link_wl_sl where sbbj='0' and ( flowid_tldjhz=p_flowid or flowid_tldjhz_tmp=p_flowid );
             if v_rows =0 then
                ERRNO:=-2;
                ERRTEXT:='电子单已提交业务审核，不能修改供货单位';
                return;
             else
             update  tmp_dhdj@c_link_wl_sl set ghdwh=p_ghdw  where  flowid_tldjhz=p_flowid or flowid_tldjhz_tmp=p_flowid ;
             end if;

          end if ;
      end if;

      if v_wlsh.ssjs<>p_ssjs then
        update t_tldjhz_state set js=p_ssjs where flowid_tldjhz=p_flowid;
      end if;


       update  t_wlsh set shczy=p_djr, id_wlgs=p_wlgs,dh=p_ghdw ,
          ssjs=p_ssjs ,wldh=p_wldh,id_wlfh=p_id_wlfh,
            shhw=p_hw,ywbmbh=p_ywbmbh,
         djlx=p_djlx,djsl=p_djsl
         where id=p_flowid;

   --已提交的登记需要再更新tldjhz
    update  t_tldjhz set  ysjs=p_ssjs,ssjs=p_ssjs,dh =p_ghdw,
     djlx=p_djlx,ywbmbh=p_ywbmbh,TLLRYBH =p_djr ,djsl =p_djsl,  xchw=p_hw
     where flowid_tldjhz=p_flowid;

     if p_stop ='1' then
       update t_wlfh set zt='4' where id=p_id_wlfh;
     else
       update t_wlfh set zt='3' where id=p_id_wlfh;
     end if;

ERRNO:=0;
ERRTEXT:='ok';
exception
  when others then
    ERRNO:=-1;
    ERRTEXT:='RF_UPDATETLDJHZ'||sqlerrm;
    rollback;
end RF_UPDATETLDJHZ;
CREATE OR REPLACE Procedure RF_RFBZ4 -- 说明：
    -- 为便于电子标签系统的判断及提示，所有容器的异常判断返回值都是 -1
(p_id_zprwhz   In Char, --
 p_mdrqh    In Char, --目的箱号
 p_hw   In Char, --主配线号
 p_jhzxid    In Char,
 p_id    In Char, --品种号
 p_cfbj  In Char, --拆分标记，1=拆分，默认是0
 p_sjsl    In Number,
 p_signtrace out Varchar,
 p_writetrace out Varchar,
 p_outnode out varchar,
 errno   Out Number,
 errtext Out Varchar) As
    v_zp t_zprw%Rowtype;
    v_allflowid number;
    v_one_sys  t_dfbj.zsy%Type;
    v_dj       t_kcsm.dj%Type;
    v_one_mys  t_dfbj.zmy%Type;
    v_bjlsh    number;
    v_bj       Number;
    v_js     Number(6, 2);
    v_cys    Number(9); --差异数
    d_jzthrq Date;
    flowid  Number(10);
    v_count Number(5);
    v_bccs   Number(10); -- 本次册数
    v_sjsl   Number(10);
    v_mdrqh  char(6);
    v_rows     Number;

    v_flowid number;
    v_zy varchar2(60);
    v_line_zp_hw2 t_line_zp_hw2%rowtype;
    v_dh char(6);
    v_rqh char(10);
    v_bz   varchar2(30);
    v_dm varchar2(60);
Begin
    -- 2015-08-18 yangyi:
    If p_sjsl < 0 Then
        ERRNO   := 1;
        ERRTEXT := '播种数量必须大于等于0!';
        Return;
    End If;

   select sum(yssl-sjsl) -p_sjsl into v_rows   From t_zprw
     Where id_zprwhz=p_id_zprwhz And id = p_id and jhzxid=p_jhzxid ;
    If v_rows < 0 Then
        ERRNO   := -1;
        ERRTEXT := '您输入的数量不能大于原始数量';
      Return;
    End If;

    if v_rows=0 and p_cfbj ='1' then
        ERRNO   := -1;
        ERRTEXT := '拆分数量和原数量相同';
        Return;
    end if ;

    v_one_mys := 0;
    proc_chkrqh2(p_mdrqh, 't_jhtask,t_line_zp_hw2', errno, errtext);
    If errno <> 0 Then
        errno := -1;
        Return;
    End If;

    select count(*) into v_rows from   t_line_zp_hw2 where hw=p_hw ;
    if v_rows =0  then
      errno := -1;
      errtext:='播撒线上没有这个货位';
      Return;
    end if;

    select * into v_line_zp_hw2 from   t_line_zp_hw2 where hw=p_hw ;

    if p_jhzxid<>v_line_zp_hw2.zpzxid then
       errno := -1;
       errtext:='任务的去向和货位的去向不一致';
       Return;
    end if;

    select min(hw) into v_zy   from t_line_zp_hw2
    where rqh=p_mdrqh and hw<> p_hw;
    if v_zy is not null then
       errno := -1;
       errtext:='箱号被用于货位'||v_zy;
       Return;
    end if ;

    select count(*) into v_rows from  t_jhtask where rqh=p_mdrqh and zt='1' ;
    if v_rows > 0 then
       errno := -1;
       errtext:='箱号有待校核任务';
       Return;
    end if ;


    if   p_sjsl>0 then
      If v_line_zp_hw2.rqh is null  Then
          -- 如果主配货位上没有绑定容器，则用当前容器自动做绑定：

          Update t_line_zp_hw2
             Set rqh = p_mdrqh
           Where  hw= p_hw and rqh is null;
           if sql%notfound then
             select rqh into v_mdrqh from  t_line_zp_hw2 where  hw= p_hw  ;
              errno   := -1;
              errtext := '货位上已经有容器' || v_mdrqh  ;

              Return;
           end if;

         insert into t_rqzy
          (bh, zydate, czy, tbname, tableid, note,qx,zylx)
         values(   p_mdrqh, sysdate, null, 't_line_zp_hw2',
         trim(p_hw), v_line_zp_hw2.line||'播撒线'||p_hw||'绑定','BSBD','q'  );

        -- select dh into v_dh from t_zprwhz where flowid=p_id_zprwhz;
         Select   dh into v_dh  From t_zprw
         Where id_zprwhz=p_id_zprwhz And id = p_id and jhzxid=p_jhzxid and rownum=1;

         select sq_jhtask.nextval into v_flowid from  dual;
         insert into t_jhtask
         (id, rqh, zt, createdate, ywbmbh, dh, zpz,
          zcs, zmy, zsy, ywlx,sjlx, jxfs, zzl, js, zddh, isgp,isgz,jhzxid)
         values
         (v_flowid, p_mdrqh, '0', sysdate, v_line_zp_hw2.ywbmbh, v_dh,
          0, 0, 0, 0, 'FH','FH', 'ZP', 0, 1, v_line_zp_hw2.dh,
          v_line_zp_hw2.isgp,v_line_zp_hw2.isgz,p_jhzxid);

          insert into t_rqzy
         (bh, zydate, czy, tbname, tableid, note,qx,zylx)
         select   p_mdrqh, sysdate, null, 't_jhtask',
         v_flowid,  trim(dm)||'的校核任务' ,'FHJH','s'  from
         t_dm where dh=v_line_zp_hw2.dh;

      Else
          If v_line_zp_hw2.rqh  <>  p_mdrqh  Then
              errno   := -1;
              errtext := '应放入' || v_line_zp_hw2.rqh || '容器中' ;

              Return;
          End If;
      End If;
      select bz into v_bz from t_zprwhz where flowid=p_id_zprwhz;
   end if ;



    Select dj Into v_dj From t_kcsm Where id = p_id;

    Select id   Into v_bjlsh   From t_jhtask
    Where rqh = p_mdrqh  and jhzxid=p_jhzxid and zt='0';

    v_sjsl := p_sjsl;

    For c1 In (Select  flowid_zp, yssl-sjsl rwsl
                 From t_zprw
                Where id_zprwhz=p_id_zprwhz And id = p_id and jhzxid=p_jhzxid )
    Loop
        v_bj := 4;
        Select * Into v_zp From t_zprw Where flowid_zp = c1.flowid_zp;

        v_bj := 5;
        If v_sjsl > c1.rwsl Then
            v_bccs := c1.rwsl;
            v_cys  := 0;
           -- v_sjsl := v_sjsl - v_bccs; -- 累减本次回告总数
        Else
            v_bccs := v_sjsl;
            v_cys  := c1.rwsl - v_bccs;
           -- v_sjsl := 0;
        End If;
        V_SJSL := V_SJSL -v_bccs;
        select ALL_FLOWID.Nextval into  v_allflowid from dual;

        If v_bccs > 0 Then
            --v_bj      := 4;
            v_one_sys := round(v_zp.zjxs * v_zp.zk * v_bccs / 100, 2);
            v_one_mys := v_dj * v_bccs;



            Update t_jhtask
               Set zpz = zpz + 1, zcs = zcs + v_bccs, zmy = zmy + v_one_mys,
                   zsy = zsy + v_one_sys,   rqh = p_mdrqh,
                   zzl = nvl(zzl, 0) + (v_zp.zl * v_bccs),
                   zb=nvl(zb,v_bz)
             Where id=v_bjlsh;
            If Sql%Notfound Then
                 errno   := -1;
                errtext := '更新出错！';
                 rollback;
                return;
            End If;


            v_bj := 11;
            Insert Into t_crkls
                (flowid_crkls, id, ywpch, yspch, crkrq, ywlx, kfbh, lybh, cybh, ywbmbh,
                 crkcs, crksy, sylx, zk_jg, zjxs, bz, dbbz, xbbz, sl,
                 flowid_wl, pk)
            Values
                (v_allflowid, v_zp.id, v_bjlsh, v_bjlsh, Sysdate, 'FH', v_zp.kfbh,
                 v_zp.dh, v_zp.cybh, v_zp.ywbmbh, v_bccs, v_one_sys, v_zp.sylx, v_zp.zk,
                 v_zp.zjxs, 'RFBZ', v_zp.dbbz, v_zp.xbbz, v_zp.sl,
                 v_zp.flowid_zp, v_zp.pk);


           insert into t_tree
              (tbid, tbname, pid, pname, note, id, cs,czy )
              values
              (v_allflowid, 't_fhjh', c1.flowid_zp, 't_zprw',
              '播撒到货位'||trim(p_hw)||'校核任务号'||v_bjlsh||'箱号'||trim(p_mdrqh), v_zp.id,
               v_bccs ,v_zp.zpczybh);

         Insert Into t_fhjh
                (flowid, pxdh, bjlsh,  id, ywbmbh, kfbh, cybh, dh, pxcs, sylx, zjxs,
                 pxzk, sl, fhfs, thfs, djly, ZDH, DBBZ, XBBZ, sys, txy, cgyj, jzthrq, zl,
                 sdhrq, yscs, cgyj_kh,   pfrq, pk,ysczy,zddh,sourceid,sourcetable)
            Values
                (v_allflowid, v_bjlsh, v_bjlsh,   v_zp.id, v_zp.ywbmbh,
                 v_zp.kfbh, v_zp.cybh, v_zp.dh, v_bccs, v_zp.sylx, v_zp.zjxs, v_zp.zk,
                 v_zp.sl, '01', v_zp.tihfs, 'ZP', V_BJLSH, V_ZP.DBBZ, V_ZP.XBBZ, V_ONE_SYS,
                 null, v_zp.cgyj, d_jzthrq, v_zp.zl, v_zp.sdhrq, v_zp.yssl, v_zp.cgyj_kh,
                    sysdate, v_zp.pk,v_zp.zpczybh,v_zp.zddh,v_zp.flowid_zp,'t_zprw');

                 --冲减库存
            Update t_kcsl
               Set KCCS = KCCS -decode(p_cfbj, '1', v_bccs, c1.rwsl),
                   ZYCS = ZYCS - decode(p_cfbj, '1', v_bccs, c1.rwsl)

             Where id = v_zp.id And ywbmbh = v_zp.ywbmbh And kfbh = v_zp.kfbh And
                   cybh = v_zp.cybh;


          Update t_zprw  Set   SJSL = SJSL+v_bccs
           Where flowid_zp = v_zp.flowid_zp;

        End If;
        --转播撒的数据重复写t_agv_rw_xt_bak 会导致TG_T_FHRWB 报错
      if v_zp.LXBH <>'XJ' then
         Insert Into t_agv_rw_xt_bak
              (flowid_xj, ph, id, lxbh, ln_zp, kfbh, ywbmbh, cybh, dh, phdh, xsdh,
               tihfs, xhao, qshqbh, hqbh, hwh, pxhw, zrhq, zrhw, yssl, sl, zk, sylx,
               zjxs, cltz, xjrq, xjczybh, wcbj, ysczybh, dbbz, xbbz, cwh, jxfs, djly,
               dbdh, zrcybh, sjsl, lhqhw, xdrq, zl, sdhrq, cgyj, xszq, qsclfs,
               cgyj_kh,  pk)
          Values
              (v_allflowid, Trim(v_bjlsh), v_zp.id, 'ZP', '', Trim(v_zp.kfbh),
               Trim(v_zp.ywbmbh), Trim(v_zp.cybh), Trim(v_zp.dh), Trim(v_bjlsh),
              Trim(v_bjlsh), '01', p_mdrqh, '901',
              '901', Trim(v_zp.ln_zp_hw), '', '', '', v_bccs
               /*v_zp.yssl*/, v_zp.sl, v_zp.zk, v_zp.sylx, v_zp.zjxs, 1, Sysdate,
               v_zp.zpczybh, '0', v_zp.zpczybh, v_zp.dbbz, v_zp.xbbz, '', 'AJ',
               v_zp.djly, Null, '', v_bccs, '', Sysdate, v_zp.zl, V_ZP.SDHRQ,
               V_ZP.CGYJ, V_ZP.XSZQ, '0', v_zp.cgyj_kh,   v_zp.pk);
      end if;
       If v_cys > 0 and p_cfbj ='0' Then
           select ALL_FLOWID.Nextval into  v_allflowid from dual;
           select trim(dm) into v_dm from t_dm where dh=v_zp.zddh;
           insert into t_tree
              (tbid, tbname, pid, pname, note, id, cs,czy )
              values
              (v_allflowid, 't_wlccb', c1.flowid_zp, 't_zprw',
              '播撒差异,'||v_dm, v_zp.id,
               v_cys ,v_zp.zpczybh);

                 -- 2007-08-08 yangyi add: 写差错表
                Insert Into t_wlccb
                    (rq, lx, czybh_err, czybh_chk, id, flowid, ywbmbh)
                Values
                    (Sysdate, 'ZPBZ', v_zp.ysczybh, v_zp.zpczybh, v_zp.id,
                     v_allflowid, v_zp.ywbmbh);
                Insert Into T_WLCCB_MX_XTW
                    (flowid, lx, id, yssl, sjsl, dqczy, sjczy, rq, flag, ywbmbh)
                Values
                    (v_zp.flowid_zp, 'ZPBZ', v_zp.id, v_zp.yssl, v_bccs, v_zp.ysczybh,
                     v_zp.zpczybh, Sysdate, '0', v_zp.ywbmbh);

                -- end add
                -- 写报损：
                proc_cycl(v_zp.ywbmbh, v_zp.kfbh, v_zp.id, -v_cys, v_bjlsh,
                          'RFBZ', v_zp.zpczybh, v_zp.cgyj, v_zp.cybh, v_zp.dh, 'ZP',
                          v_zp.zk, errno, errtext);
                If errno <> 0 Then
                    Rollback;
                    Return;
                End If;
       end if ;



       if v_bccs=0 and p_cfbj='1' then
          exit;
       end if ;

    End Loop;

    if p_cfbj='1' then

      insert into t_zprw_bak
        (flowid_zp, lxbh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, tihfs, dh, zpxyrqh, yssl, zk,
        sylx, zjxs, ysczybh, ln_zp_no, ln_zp_hw, zpczybh, sourceid, ddbj, djly, bz, sl, yspch,
         zl, cgyj, xszq, sdhrq, mdrqh, bzrq, cgyj_kh, fhyxj, pk, xrrq, sourcetable,
         id_zprwhz, sjsl, zddh,jhzxid)
       select   flowid_zp, lxbh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, tihfs, dh, zpxyrqh, yssl, zk,
        sylx, zjxs, ysczybh, ln_zp_no, ln_zp_hw, zpczybh, sourceid, ddbj, djly, bz, sl, yspch,
         zl, cgyj, xszq, sdhrq, p_mdrqh, sysdate, cgyj_kh, fhyxj, pk, xrrq, sourcetable,
         id_zprwhz, sjsl, zddh,jhzxid from
       t_zprw where id_zprwhz=p_id_zprwhz And id = p_id and jhzxid=p_jhzxid and  yssl=sjsl;

       delete t_zprw where id_zprwhz=p_id_zprwhz And id = p_id and jhzxid=p_jhzxid and  yssl=sjsl;
    else
      insert into t_zprw_bak
        (flowid_zp, lxbh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, tihfs, dh, zpxyrqh, yssl, zk,
        sylx, zjxs, ysczybh, ln_zp_no, ln_zp_hw, zpczybh, sourceid, ddbj, djly, bz, sl, yspch,
         zl, cgyj, xszq, sdhrq, mdrqh, bzrq, cgyj_kh, fhyxj, pk, xrrq, sourcetable,
         id_zprwhz, sjsl, zddh,jhzxid)
       select   flowid_zp, lxbh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, tihfs, dh, zpxyrqh, yssl, zk,
        sylx, zjxs, ysczybh, ln_zp_no, ln_zp_hw, zpczybh, sourceid, ddbj, djly, bz, sl, yspch,
         zl, cgyj, xszq, sdhrq, p_mdrqh, sysdate, cgyj_kh, fhyxj, pk, xrrq, sourcetable,
         id_zprwhz, sjsl, zddh,jhzxid from
       t_zprw where id_zprwhz=p_id_zprwhz And id = p_id and jhzxid=p_jhzxid ;

      delete t_zprw where  id_zprwhz=p_id_zprwhz And id = p_id and jhzxid=p_jhzxid ;
    end if ;

    if p_sjsl >0 then
     insert into t_gzltimes
             (czybh,   cs, my, id_job, proc, tablename, tablepk,YWBM)
             values
             (v_zp.zpczybh, p_sjsl, p_sjsl*v_dj, 'ZPBZ', 'RF_RFBZ2', 't_zprw', v_zp.flowid_zp,v_zp.ywbmbh);

        update t_zprwhz set sjsl=sjsl+p_sjsl
        where flowid=v_zp.Id_zprwhz;
    end if ;

    -- 2006-12-02 add by yangyi:
    -- 记工作量
    If v_zp.dbbz * v_zp.xbbz >= 1 Then
        v_js := round(p_sjsl / v_zp.dbbz / v_zp.xbbz, 2);
    Else
        v_js := 0;
    End If;
    proc_write_gzl('ZPBZ', v_zp.zpczybh, 1, p_sjsl, v_js, v_one_mys, 't_zprw', '',
                  v_line_zp_hw2.ywbmbh, 'rf_rfbz', errno, errtext);
    If errno <> 0 Then
        Rollback;
        Return;
    End If;
    -- end add
  /*  Select Count(*)
      Into v_count
      From t_dfbj
     Where rqh = p_mdrqh And wcbj = '0' And
           bjlsh <> v_bjlsh;
    If v_count > 0 Then
        errno   := -119;
        errtext := '该容器存在另外一个单号,可能有其他人在该容器中进行播种，请您稍后再进行播种';
        Rollback;
        Return;
    End If;*/
    v_bj := 15;

    select count(*) into v_rows from T_ZPRW where  id_zprwhz = p_id_zprwhz;
    if v_rows=0 then
        update t_zprwhz set finishdate=sysdate,finished=1,zt='2'
        where flowid=v_zp.Id_zprwhz;

        select rqh into v_rqh from t_zprwhz where flowid=p_id_zprwhz;
        delete t_rqzy where tbname='t_zprwhz' and bh=v_rqh;

        insert into t_gzl2
       (czybh,    pz, js, id_job, proc, tablename, tablepk,YWBM)
       select zpczy,zpz,0,'ZPBZ','RF_RFBZ2','t_zprwhz',v_zp.Id_zprwhz,ywbmbh from
        t_zprwhz where flowid=v_zp.Id_zprwhz;

    end if;



    errno := 0;
    errtext :='ok';
Exception
    When Others Then
        errno   := v_bj;
        errtext := Sqlerrm ||v_bj;
        Rollback;
End;
CREATE OR REPLACE Procedure PROC_JT_NOFY(p_ywpc  Char,
																				 p_bjlsh Char,
																				 p_user  Char, --作计划的人
																				 p_ywbh  Char, --储运编号
																				 errcode Out Number,
																				 errtext Out Varchar) Is
		tmpVar Number;
		v_kfbh t_dm.dh%Type;
		/******************************************************************************
    NAME:       PROC_JT_NOFY
    PURPOSE:    拒退自提带走(非发运)

    REVISIONS:
    Ver        Date        Author           Description
    ---------  ----------  ---------------  ------------------------------------
    1.0        2010-12-11   Lv.       1. Created this procedure.

    NOTES:

    Automatically available Auto Replace Keywords:
    Object Name:     PROC_JT_NOFY
    Sysdate:         2010-12-11
    Date and Time:   2010-12-11, 下午 10:25:37, and 2010-12-11 下午 10:25:37
    Username:        Lv. (set in TOAD Options, Procedure Editor)
    Table Name:       (set in the "New PL/SQL Object" dialog)

    ******************************************************************************/
Begin
		tmpVar := 0;
		Select Count(*)
			Into tmpVar
			From t_dm
		 Where lxbh = '2' And kflx = 'LK' And cybh = p_ywbh;
		If (tmpVar < 1) Then
				errcode := -1;
				errtext := '没有查询到立库编号';
				Rollback;
				Return;
		End If;
		Select Min(dh)
			Into v_kfbh
			From t_dm
		 Where lxbh = '2' And kflx = 'LK' And cybh = p_ywbh;
		Select Count(*) Into tmpVar From t_ywpc Where ywpch = p_ywpc;
		If (tmpVar = 0) Then
				Insert Into T_YWPC
						(YWPCH, YWLX, YSPCH, KFBH, USR_ID, CYBH, PCRQ)
				Values
						(p_ywpc, 'FH', p_ywpc, v_kfbh, p_user, p_ywbh, Sysdate);
		End If;
		--lhbj 为了打印提货单（托运单）准备
		--2011-12-01 modify by lv 增加jjbj='1''
		Update t_dfbj
			 Set jhpch = '', fyjhpc = p_ywpc, fyjhrq = Sysdate, fyrh = p_user, lhbj = '1',
					 jjbj = '1'
		 Where bjlsh = P_bjlsh;
		-------20150327 将数据插入t_wcbj后，删除t_dfbj 内数据-----by ygd---------
		Insert Into t_wcbj
				(BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS, FHBMBH,
				 FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS, YWLX, FYRQ, FYRH,
				 KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE, CYR, CYDW, ssjs, psjs,
				 shrq, hw, zb, GKH, jxfs)
				Select BJLSH, RQH, PFRQ, YWBMBH, YWPC, DH, ZPZ, ZCS, ZMY, ZSY, ZZL, BZJS, FHBMBH,
							 FYJHPC, FYJHRQ, JHRH, FYFSH, CH, YH, YWQRPC, ZZBH, ZZBH1, TIHFS, YWLX,
							 Sysdate, FYRH, KTRQ, TYLX, TYRQ, TYR, TYR_TELE, TYNR, CYRQ, CYR_TELE, CYR,
							 CYDW, ssjs, psjs, shrq, hw, zb, GKH, jxfs
					From t_DFBJ a
				 Where a.bjlsh = P_bjlsh;
		Delete t_dfbj Where bjlsh = P_bjlsh;
		---------add over------------
		errcode := 0;
		errtext := '';
Exception
		When Others Then
				errcode := -1;
				errtext := Sqlerrm;
				Rollback;
End PROC_JT_NOFY;
CREATE OR REPLACE Procedure PROC_JH
(p_id  In Char,
 p_bjlsh    In Char,
 p_ywlx   In Char,
 p_jhcs    In Number,
 p_czy  IN CHAR,
 ERRNO   Out Number,
 ERRTEXT Out Varchar) As

  V_BJ   char(1);
  v_rows number;
  v_ywlx char(2);
  v_bccs number;
  v_sycs number;
  v_nothbj char(1);
  v_dh char(6);
  v_mc varchar2(60);
  v_ywbmbh char(6);
Begin



   select sjlx into v_ywlx from t_jhtask where id=p_bjlsh ;
   if p_ywlx<>v_ywlx then
      ERRNO   := -1;
      ERRTEXT := '和包件的类型不一致';
      return;
   end if ;

   v_sycs:=p_jhcs;
   --每次校核都重新置jhcs字段
   if p_ywlx='FH' then


      for cur in (select flowid,pxcs-fbcs kycs from t_fhjh where bjlsh=p_bjlsh
        and id=p_id and fbbj='0' order by flowid) loop
         if v_sycs>cur.kycs then
           v_bccs:=cur.kycs;
         else
           v_bccs:=v_sycs;
         end if;
         update  t_fhjh  set jhcs=v_bccs+fbcs,JHCZYBH=p_czy,jhrq=sysdate where flowid=cur.flowid;
         v_sycs:=v_sycs-v_bccs;
      end loop;
      if v_sycs>0 then
        ERRNO   := -1;
        ERRTEXT := '输入册数超量';
        rollback;
        return;
      end if ;
    
     update t_flrqh set zt_qx='1' where flqx='FH' and flowid_qx=p_bjlsh and zt_qx='0' ;

   end if;

  if p_ywlx='ST' then

     select dh,ywbmbh into v_dh,v_ywbmbh  from t_jhtask where id=p_bjlsh; 
     select  nothbj into v_nothbj from t_ghdw_ywbm@c_link_wl_sl 
      where ghdwh=v_dh and ywbmbh=v_ywbmbh;
      
     if v_nothbj ='1' and p_jhcs>0 then
        select trim(mc) into v_mc from t_ghdw where bh=v_dh;
        ERRNO   := -1;
        ERRTEXT := v_mc||'禁止退货，只能校核0本'; 
        return;
     end if;
     for cur in (select flowid,kccs-fbcs kycs from t_stjh where bjlsh=p_bjlsh
        and id=p_id and fbbj='0' order by flowid) loop
         if v_sycs>cur.kycs then
           v_bccs:=cur.kycs;
         else
           v_bccs:=v_sycs;
         end if;
         update  t_stjh  set jhcs=v_bccs+fbcs,jhczy=p_czy ,jhrq=sysdate where flowid=cur.flowid;
         v_sycs:=v_sycs-v_bccs;
      end loop;
      if v_sycs>0 then
        ERRNO   := -1;
        ERRTEXT := '输入册数超量';
        rollback;
        return;
      end if ;
   end if;

   if p_ywlx='JT' then


     for cur in (select flowid,sdsl-fbcs kycs from t_jtjh where bjlsh=p_bjlsh
        and id=p_id and fbbj='0' order by flowid) loop
         if v_sycs>cur.kycs then
           v_bccs:=cur.kycs;
         else
           v_bccs:=v_sycs;
         end if;
         update  t_jtjh  set jhcs=v_bccs+fbcs,jhczy=p_czy ,jhrq=sysdate where flowid=cur.flowid;
         v_sycs:=v_sycs-v_bccs;
      end loop;
      if v_sycs>0 then
        ERRNO   := -1;
        ERRTEXT := '输入册数超量';
        rollback;
        return;
      end if ;
   end if;

    ERRNO   := 0;
    ERRTEXT := 'OK';
Exception
    When Others Then
        ERRNO   := V_BJ;
        ERRTEXT :=V_BJ|| Sqlerrm|| '--PROC_JH';
        Rollback;
End;
CREATE OR REPLACE Procedure proc_goo_dhlr_tj_zjs2
(p_flowid_tldjhz Number,
 p_cft           Char, --拆分台号
 p_czy           Char, --拆分操作员
 errno           Out Number,
 errtext         Out Char) As
    v_rows   Number;
    v_zjxs   Number;
    v_zcs number;

    v_gzlmy number;
    v_gzlcs number;
    v_ysjs  number;
    v_yssl number;
    v_zddh char(6);
    v_wlsh t_wlsh%rowtype;
    v_gzjls   Number;
    v_djsl    Number;
    v_Addflag Char(1);
    v_flcs    Number;
Begin
  v_gzlmy:=0;
  v_gzlcs:=0;

   select Count(*)  Into v_rows  from t_dhfltask where flowid_tldjhz = p_flowid_tldjhz
    and  finished='0' ;
    If v_rows = 0 Then
        errno   := -12;
        errtext := '运号内部码不存在或已分流确认!' || to_char(p_flowid_tldjhz);
        Rollback;
        Return;
    End If;

    select * into v_wlsh from t_wlsh where id=p_flowid_tldjhz;
    -- 如果还有其它拆包台正在对该运号做分流, 则直接返回:
 /*   Select Count(*)
      Into v_rows
      From t_cbt
     Where djbh = p_flowid_tldjhz And t_cbt.bh <> p_cft;
    If v_rows > 0 Then
        Update t_cbt Set djbh = Null Where bh = p_cft;
        errno   := 0;
        errtext := 'ok';
        Return;
    End If;*/

    select count(*) into v_rows from
    (  select flowid_dhmx ,bdcs from tmp_dhmx x,tmp_dhdj j where flowid_tldjhz=p_flowid_tldjhz
       and x.flowid_dj=j.flowid_dj) t1,

    ( select flowid_dhmx, sum(sjsl) yfsj from t_dh_yfsj y ,tmp_dhdj j where
        j.flowid_tldjhz=p_flowid_tldjhz and y.flowid_dj=j.flowid_dj  group by flowid_dhmx) t2
   where t1.flowid_dhmx=t2.flowid_dhmx and bdcs >yfsj;
   if v_rows> 0 then
      errno   := -1;
        errtext := p_flowid_tldjhz||'存在册数不符情况';
        Return;
   end if ;

    for curDj in( select flowid_dj ,cybh,kfbh,ywbmbh ,ysdj,sl,ghdwh from tmp_dhdj where flowid_tldjhz=p_flowid_tldjhz and  zfzd='0')

    loop
       v_gzjls := 0;
       v_djsl  := 0;
       For c1 In (Select  flowid_dhmx,   id,yssl,bdcs,pssl, dbbz,xbbz, tm,xszq,fhzk, x.zz,x.kb,x.tm_flag
               ,x.fl, x.isbn, x.sm, x.dj, x.sylx, x.jhzk, x.bc, x.yc, x.cbny, x.bz, x.yz, x.bb
                 From tmp_dhmx x
                Where  flowid_dj =  curDj.flowid_dj )
        Loop


    ---------------



       Select Count(*) Into v_rows From t_dhls_jx Where flowid_dhmx=c1.flowid_dhmx;
        If v_rows>0 Then

            Select djshsl Into v_yssl From t_dhls_jx Where flowid_dhmx=c1.flowid_dhmx;

            -- 对已有记录，将破损数或拒收数写入t_dhls_jx.pscs中，以便后期备查
            -- 对新增记录，在分流差异处理时，再将pscs写到正式到货的记录中。
            Update t_dhls_jx Set pssl=c1.pssl Where flowid_dhmx=c1.flowid_dhmx;
            Update t_dhls_jx@c_link_wl_sl Set pssl=c1.pssl Where flowid_dhmx=c1.flowid_dhmx;

           v_Addflag := '0';
        Else
           v_yssl := 0;
           v_Addflag := '1';
        End If;

        -- 如果到货分流结果与原单有差异，则生成到货更正计划数据：
        -- 到货分流后出现差异，只能改变原记录的实际数量，不能修改其它项目
        If c1.bdcs<>v_yssl Then

            -- gzlx=0, 表示更正折扣, gzlx=1表示更正货源或者税率更正
            -- addflag=1, 表示为到货分流中新增的到货记录
            -- dhflflag=1，表示为到货分流生成的更正计划，正常的更正处理将不涉及此类更正计划
            Insert Into t_sl_dhgzjh@c_link_wl_ex
              (flowid_dj, flowid_dhmx, ysdj, shrq, ghdwh,
               isbn, sm, dj, sylx, jhzk, bc, yc, cbny, bz, yz, bb, fl,
               tm_flag, kb, zz, sl, ghdw, receflag, sendbmbh, senddate, recedate,
               flowid_dhmx_old, yssl, xsl, jtjzrq, fhzk, xszq, tm, id, gzlx, remark, newsl, addflag, dhflflag)
            Values
              (curDj.flowid_dj, c1.flowid_dhmx, curDj.ysdj, Null, curDj.ghdwh,
               c1.isbn, c1.sm, c1.dj, c1.sylx, c1.jhzk, c1.bc, c1.yc, c1.cbny, c1.bz, c1.yz, c1.bb, c1.fl,
               c1.tm_flag, c1.kb, c1.zz, curDj.sl, curDj.ghdwh, '0',  curDj.cybh, Sysdate, Null,
               c1.flowid_dhmx, v_yssl, c1.bdcs, Null, c1.fhzk, c1.xszq, c1.tm, c1.id, '0', '到货分流差异',
               curDj.sl, v_addflag, '1');

            v_gzjls := v_gzjls + 1;
            v_djsl  := v_djsl + c1.yssl;

            -- 原记录置更正占用标记：
            If v_Addflag = '0' Then
               Update t_dhls_jx Set gzbj='8' Where flowid_dhmx=c1.flowid_dhmx;
            End If;

         End If;

    -- 如果该品种除破损以外分流过,
            -- 将除已经去往包装区的分配数外的其它任务,
            -- 全部转入t_fhrwb, 为调度做准备
            -- 注意: 即使本次到货数不能满足所有待分配数,
            --       也转入t_fhrwb,因为库存有可能能够满足
            -- 如果该品种除破损以外分流过, 将t_sl_yfsj中YQBZQCS=0的记录全部写入t_fhrwb:

         if c1.bdcs-c1.pssl>0 then
            -- 因为t_sl_yfsj.ysdjh是个varchar型的,
                -- 所以在下边的语句中要用substrb(trim(t_sl_yfsj.ysdjh)||'            ',1,12)
                -- t_sl_yfsj.ysdjh保存的是t_dpls.dbdh, 根据这个值从t_dpls中取得tdpch
                -- 写入t_fhrwb中.
                --
                -- 需要特别注意的是调度程序, 必须按ysdjh+dh来判断是否为同一张单据
                -- 2011-03-04 yangyi: 新增【单独成单标记】bdbj,【配货备注】phbz
                --2011-06-27 修改 lb 将条件nvl(YQBZQCS,0) = 0 改为 nvl(yfsl,0) - nvl(YQBZQCS,0) >0
                --插入册数改为nvl(yfsl,0) - nvl(YQBZQCS,0),因为存在部分不去包装区的情况
               select count(*) into v_rows from t_dh_yfsj where flowid_dhmx =c1.flowid_dhmx ;
                if v_rows = 0 then
                     insert into t_dh_yfsj
                      (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx,ywbmbh,
                      flqxmc, detailqx,  cgyj, cgyj_kh,djly,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch)
                        select   flowid_yfsj,  flowid, flowid_dj, dh, c1.id, yfsl, 0, null,v_wlsh.ywbmbh, null, null,
                          ysdjh, trim(cgyj_kh) ,DJLY,fhzk,SDHRQ,yxj,qsclfs,zddh,ddcdbj,tdpch
                       from t_sl_yfsj  Where flowid = c1.flowid_dhmx ;

                     if v_wlsh.fllx='PT' then
                        for cur in (select flowid,dh from t_dh_yfsj where  flowid_dhmx = c1.flowid_dhmx  ) loop
                             Select min(gzbh) into v_zddh
                             From  t_guizu_fl c
                            Where flbh=c1.fl And dh = cur.dh;
                            if v_zddh is null then
                              select min(gzbh) into v_zddh  from t_guizu_fl  where  dh=cur.dh;
                            end if ;
                            update t_dh_yfsj set zddh=v_zddh  where flowid =cur.flowid;
                        end loop;
                     end if ;

                end if;

                Insert Into t_fhrwb
                    (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, djsl,
                     fhzk, sylx, zjxs, djly, qsts, QSCLFS, FYFSH, FHFS, DJ, KJXBJ, FHYXJ,
                     QSDS, RQ, sdhrq, yxrq, cgyj, cgyj_kh,  bdbj, phbz,zddh)
                    Select all_flowid.Nextval /*flowid_yfsj*/,
                           (Select Min(tdpch)
                               From t_dpls
                              Where trim(dbdh) = t.cgyj ),
                           dh, id, curDj.kfbh, curDj.ywbmbh, curDj.cybh, c1.dbbz,
                           c1.xbbz,  yfsl - sjsl , fhzk, c1.sylx,
                           v_zjxs, djly, 0, qsclfs, '01' ,   '01' ,
                           c1.dj, '1', YXJ, 0, Sysdate, SDHRQ, (Sysdate + 30), cgyj,
                           cgyj_kh,
                           (Select nvl(t_dpls.spbj, '0')   From t_dpls   Where  trim(dbdh) =  t.cgyj),
                           (Select t_dpls.note_gp  From t_dpls  Where trim(dbdh) =  t.cgyj),nvl(zddh,dh)
                      From t_dh_yfsj t
                     Where flowid_dhmx = c1.flowid_dhmx And  yfsl-sjsl > 0 and (flqx='FH' or flqx='ZP');
         else
             -- 如果该品种没分流过, 将t_sl_yfsj中的记录全部写入t_wl_bmzdj:
                -- 并将类型(LX)置为'XX', 商流将据此将t_dpls相应记录的状态恢复
                -- 为未分书状态(参见商流proc_get_bmzdj)
                Insert Into t_wl_bmzdj
                    (YSDJH, YWBMBH, DH, CKBH, RKBH, ID, CS, SJKCS, QSCLFS, RQ, LX, FLOWID,
                     BZ, SENDBMBH, SENDDATE, RECEBMBH, RECEFLAG, ZK)
                    Select ysdjh, curDj.ywbmbh, dh, curDj.kfbh, '', id, yfsl, 0, qsclfs,
                           Sysdate, 'XX', flowid_yfsj, '到货分流时未发现该品种', cybh, Sysdate,
                           curDj.ywbmbh, '0', fhzk
                      From t_sl_yfsj
                     Where flowid = c1.flowid_dhmx;
         end if;



    End Loop;

          -- 更正计划来源：1/物流，2/B2B，3/直发单收货差异
      If v_gzjls>0 Then
          Insert Into t_sl_dhgzjh_hz@c_link_wl_ex
            (flowid_dj, djsl, jls, zjs, sendbmbh, senddate, recebmbh, recedate, reason, receflag, gzczy, djly, dhflflag)
          Values
            (curDj.flowid_dj, v_djsl, v_gzjls, 1, curDj.cybh, Sysdate, curDj.ywbmbh, Null, '到货分流差异', '0', p_czy, '1', '1');
      Else
          -- 若无差异，则将gzbj置为0，解除对正常更正的限制。
          Update t_dhdj Set gzbj='0' Where flowid_dj=curDj.flowid_dj;
          Update t_dhdj@c_link_wl_sl Set gzbj='0' Where flowid_dj=curDj.flowid_dj;
          Update t_dhdj_cf@c_link_wl_sl Set gzbj='0' Where flowid_dj=curDj.flowid_dj;
      End If;

      -- 2017-08-03 add by yangyi:
      -- 商流的tmp_dhmx/tmp_dhdj由 物流分流结束后删除，商流不再进行删除处理
      -- 商流接物流到货时，物流还未做分流，如果此时删除，将无法进行补样处理
      insert into tmp_dhdj_bak@c_link_wl_sl select * from tmp_dhdj@c_link_wl_sl where flowid_dj=curDj.flowid_dj;
      insert into tmp_dhmx_bak@c_link_wl_sl select * from tmp_dhmx@c_link_wl_sl where flowid_dj=curDj.flowid_dj;
      delete from tmp_dhdj@c_link_wl_sl where flowid_dj=curDj.flowid_dj;
      delete from tmp_dhmx@c_link_wl_sl where flowid_dj=curDj.flowid_dj;

    end loop;

    -- 循环tmp_dhmx当前运号的到货明细:
    -- t_dhfltask  0:未领取   1:已领取  2:正在分流   3:开始分流,已取消   4:完成,,9:分流任务异常
    update t_dhfltask set zt='4',finishdate=sysdate,finished='1' where  flowid_tldjhz = p_flowid_tldjhz;


    --Update t_tldjhz Set flbj = '1', flrq = Sysdate Where flowid_tldjhz = p_flowid_tldjhz;
    -- 临时表数据备份及删除:
    For c3 In (Select flowid_dj From tmp_dhdj Where flowid_tldjhz = p_flowid_tldjhz and  zfzd='0')
    Loop
      /*  Insert Into tmp_dhmx_ss_bak
            Select * From tmp_dhmx_ss Where flowid_dj = c3.flowid_dj;
        Delete From tmp_dhmx_ss Where flowid_dj = c3.flowid_dj;*/
        Insert Into tmp_dhmx_xtw
            Select * From tmp_dhmx Where flowid_dj = c3.flowid_dj;
        Delete From tmp_dhmx Where flowid_dj = c3.flowid_dj;

       Insert Into t_sl_yfsj_bak
            Select * From t_sl_yfsj Where flowid_dj = c3.flowid_dj;
        Delete From t_sl_yfsj Where flowid_dj = c3.flowid_dj;

        insert into t_dh_yfsj_bak
        (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx, flqxmc, detailqx, active,
        cgyj, cgyj_kh, finished, djly, fhzk, sdhrq, yxj, hw, xh, qsclfs, flowid_tldjhz, zddh, hqbh,
        ddcdbj, tdpch, ttbz, dhzxid, isgz, isgp, nxtzxid, line, ywbmbh)

       select flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx, flqxmc, detailqx, active,
        cgyj, cgyj_kh, finished, djly, fhzk, sdhrq, yxj, hw, xh, qsclfs, flowid_tldjhz, zddh, hqbh,
        ddcdbj, tdpch, ttbz, dhzxid, isgz, isgp, nxtzxid, line, ywbmbh
         from t_dh_yfsj
           Where flowid_dj = c3.flowid_dj;
          Delete From T_DH_YFSJ Where flowid_dj = c3.flowid_dj;

        Insert Into t_flrqh_bak
            Select * From t_flrqh Where flowid_dj = c3.flowid_dj;
        Delete From t_flrqh Where flowid_dj = c3.flowid_dj;


    End Loop;

    Insert Into tmp_dhdj_xtw
        Select * From tmp_dhdj Where flowid_tldjhz = p_flowid_tldjhz and  zfzd='0';
    Delete From tmp_dhdj Where flowid_tldjhz = p_flowid_tldjhz and  zfzd='0';


    --select * from t_tldjmx where flowid_tldjhz = p_flowid_tldjhz;
    select ssjs into v_ysjs from t_wlsh where id=p_flowid_tldjhz;
      Insert Into t_gzl
        (czybh, czlx, czrq, jls, cs, my, js, flowid,TABLE_NAME,FLOWID_TABLE,YWBMBH,PROC_NAME)
    Values
        (p_czy, 'DHFL', Sysdate, 1, v_gzlcs, v_gzlmy, v_ysjs,
         all_flowid.Nextval,'t_wlsh',p_flowid_tldjhz,'000001','proc_goo_dhlr_tj_zjs');

    Delete From t_tldjmx Where flowid_tldjhz = p_flowid_tldjhz;
    Update t_cbt Set zt = '0', djbh = Null   Where bh = p_cft;
    -- update t_cfhw set empty='1' ,flowid_tldjhz=null,zyrq=null where flowid_tldjhz=p_flowid_tldjhz;

    select sum(cs) into v_flcs from T_FLRecord where   flowid_tldjhz=p_flowid_tldjhz;
    if v_flcs >0 then
      select  zcs into v_zcs from t_dhfltask where    flowid_tldjhz=p_flowid_tldjhz;
       insert into t_gzl2
       (czybh,    pz, js, id_job, proc, tablename, tablepk,YWBM)
     select
        czybh ,   count(distinct id),
        round (v_ysjs*sum(cs)/v_zcs,2),
        'DHFL', 'proc_goo_dhlr_tj_zjs2', 'T_FLRecord' ,p_flowid_tldjhz,v_wlsh.ywbmbh from T_FLRecord where flowid_tldjhz=p_flowid_tldjhz
        group by czybh ;
    end if;

    errno   := 0;
    errtext := 'ok';
    Return;
Exception
    When Others Then
        errno   := Sqlcode;
        errtext := 'proc_goo_dhlr_tj_zjs2' || Sqlerrm;
        Rollback;
        Return;
End proc_goo_dhlr_tj_zjs2;
CREATE OR REPLACE Procedure RF_XJHG3
(p_flowid  In Char,
 p_sjsl    In Number,
 p_cfbj    In Char,
 p_hw   In Char,
 p_id    In Char,
 p_xjzxid in char,
 p_rqh   in char ,
 p_finish out varchar,
 ERRNO   Out Number,
 ERRTEXT Out Varchar) As
    V_XJ      T_AGV_RW_XT%Rowtype;
    V_CYSL    Number;
    V_bj      Number;
    V_DJ      T_KCSM.DJ%Type;
    V_ONE_SYS Number(10, 2);
    V_ONE_MYS Number(10, 2);
    v_ddcdbj char(1);
    V_CS      Number;
    V_SY      Number(10, 2);
    V_MY      Number(10, 2);
    V_SJSL    Number(6);
    V_KFBH1   Char(6);
    a_ywpch   Char(12);
    v_zzl     Number;
    ls_xjdbj Char(1);
    v_rows        Number;
    d_jzthrq      Date;
    V_BFKF        Char(6); --报废库房编号
    v_hqbh char(6);
    v_bzjmy       Number;
     v_bccs number;
     v_ywlx   t_dfbj.ywlx%type;
     v_agvhz t_agvhz%Rowtype;
     v_jllx number;
     v_allflowid number;
     v_job varchar2(10);
     v_sumsjsl number;
     v_js  number;
     v_flowid number;
     v_zprwhz t_zprwhz%rowtype;
     v_jhtask t_jhtask%rowtype;
     v_line char(2);
     v_jhzxid varchar2(30);
     v_mxid number;
     v_dm varchar2(60);
Begin


   select sum(yssl-sjsl) -p_sjsl into v_rows   From t_agv_rw_xt
   Where zrhq = p_flowid And hwh = p_hw And id = p_id and xjzxid=p_xjzxid;
    If v_rows < 0 Then
        ERRNO   := -1;
        ERRTEXT := '您输入的数量不能大于原始数量';
      Return;
    End If;

    if v_rows=0 and p_cfbj ='1' then
        ERRNO   := -1;
        ERRTEXT := '拆分数量和原数量相同';
      Return;
    end if ;



   select  * into v_agvhz from t_agvhz where flowid=p_flowid;
   if p_sjsl>0 then
      if v_agvhz.xjqx='ZP' then
        proc_chkrqh2(p_rqh, 't_zprwhz', errno, errtext);
        If errno <> 0 Then
          errno := -1;
          Return;
        End If;
        select min(tableid) into v_flowid from t_rqzy where tbname='t_zprwhz' and bh=p_rqh;
        if v_flowid is not null then
          select * into v_zprwhz from t_zprwhz where flowid=v_flowid;
          if v_zprwhz.dhzxid<> p_xjzxid then
            errno := -1;
            ERRTEXT := '任务和箱子里的书不是同一去向';
            Return;
          end if ;
          if v_jhtask.zt='1' then
            errno := -1;
            ERRTEXT := '箱子已经装箱完成';
            Return;
          end if ;
        end if ;
     else
         proc_chkrqh2(p_rqh, 't_jhtask', errno, errtext);
         If errno <> 0 Then
            errno := -1;
            Return;
         End If;
        select min(tableid) into v_flowid from t_rqzy where tbname='t_jhtask' and bh=p_rqh;
        if v_flowid is not null then
          select * into v_jhtask from t_jhtask where id=v_flowid;
          if v_jhtask.jhzxid<> p_xjzxid then
            errno := -1;
            ERRTEXT := '任务和箱子里的书不是同一去向';
            Return;
          end if ;
          if v_jhtask.zt='1' then
            errno := -1;
            ERRTEXT := '箱子已经装箱完成';
            Return;
          end if ;
        end if ;

     end if ;

   end if ;


  -- bdbj,  1:特殊需求下架。2：馆配下架
   if v_agvhz.bdbj='1' then
      v_ddcdbj:='1';
   else
      v_ddcdbj:='0';
   end if;

   V_SJSL:=p_sjsl;
    For xj In (Select FLOWID_XJ, yssl-sjsl rwsl
                 From t_agv_rw_xt
                Where zrhq = p_flowid And hwh = p_hw And id = p_id and xjzxid=p_xjzxid and yssl-sjsl>0
                Order By yssl-sjsl)
    Loop


        If xj.rwsl <= V_SJSL Then
            v_bccs:=xj.rwsl;
            V_CYSL:=0;
        Else
            v_bccs:=V_SJSL;
            V_CYSL:=xj.rwsl-V_SJSL;
        end if;
        V_SJSL := V_SJSL -v_bccs;

        Select * Into V_XJ From T_AGV_RW_XT Where FLOWID_XJ = xj.flowid_xj;

          -- 取得标准件的码洋, 为推算异型品的实际件数
    Select nvl(Min(sys_value), 900)
      Into v_bzjmy
      From t_sysset
     Where sys_item = 'GPBJBZ' And sys_ywbmbh = v_xj.ywbmbh;



    If v_agvhz.xjqx = 'ST'   Then

        Select dh Into v_kfbh1 From t_dm Where kflx = 'TH' And cybh = v_xj.cybh;
    Else
        V_KFBH1 := V_XJ.KFBH;
    End If;


    If v_agvhz.xjqx = 'BF' Then
      Select Min(DH) Into V_BFKF From T_DM Where KFLX = 'BF' And CYBH = V_XJ.CYBH;
        If V_BFKF Is Null Then
            ERRNO   := -154;
            ERRTEXT := '请先设置报废库房，然后再进行下架操作';
            Rollback;
            Return;
        End If;
        V_KFBH1 := V_BFKF;
    End If;

    Select DJ
      Into V_DJ
      From T_KCSM
     Where ID = V_XJ.ID;
    V_ONE_SYS := V_XJ.ZJXS * V_XJ.ZK * v_bccs / 100;
    V_ONE_MYS := V_DJ * v_bccs;




    Update T_LTKF
       Set KCCS = KCCS - decode(p_cfbj, '1', v_bccs, xj.rwsl),
           ZYCS = ZYCS - decode(p_cfbj, '1', v_bccs, xj.rwsl)
     Where ID = V_XJ.ID And HW = V_XJ.HWH And KFBH = V_XJ.KFBH And
           YWBMBH = V_XJ.YWBMBH and kccs>0;
    If Sql%Notfound Then
        Rollback;
        Insert Into T_WJKC
            (FLOWID, RQ, LX)
        Values
            (V_XJ.FLOWID_XJ, Sysdate, 'L');
        ERRNO   := -1012;
        ERRTEXT := v_xj.id || v_xj.hwh || v_xj.kfbh || v_xj.ywbmbh ||
                   to_char(v_xj.zl);

        Return;
    End If;

     Update T_KCSL
      Set KCCS = KCCS - decode(p_cfbj, '1', v_bccs, xj.rwsl),
     ZYCS = ZYCS - decode(p_cfbj, '1', v_bccs, xj.rwsl)
     Where ID = V_XJ.ID And KFBH = V_XJ.KFBH And YWBMBH = V_XJ.YWBMBH;
    If Sql%Notfound Then
        Rollback;
        Insert Into T_WJKC (FLOWID, RQ, LX) Values (V_XJ.FLOWID_XJ, Sysdate, 'P');
         ERRNO   := -1012;
         ERRTEXT := 't_kcsl' ;
        Return;
    End If;


    ----如果有差异，写报损计划表
    If v_cysl > 0 and p_cfbj ='0' Then

       If  v_agvhz.xjqx = 'FH'  Then
         select trim(dm) into v_dm from t_dm where dh= V_XJ.zddh;
       end if ;
       If  v_agvhz.xjqx = 'ST'  Then
          select trim(mc) into v_dm from t_ghdw where bh= V_XJ.zddh;
       end if ;
       If  v_agvhz.xjqx = 'ZP'  Then
         select trim(dm) into v_dm from t_dm where dh= V_XJ.zddh;
       end if ;
       If  v_agvhz.xjqx = 'BF'  Then
         v_dm:='';
       end if ;

       select ALL_FLOWID.Nextval into  v_mxid from dual;

       insert into t_tree
          (tbid, tbname, pid, pname, note, id, cs,czy )
        values
        (v_mxid, 't_wlccb', V_XJ.flowid_xj, 't_agv_rw_xt',
        '下架差异,'||v_dm, v_xj.id,
         v_cysl ,v_agvhz.xjczybh);

        ---------收益表
        Insert Into t_wlccb
            (rq, lx, czybh_err, czybh_chk, id, flowid, flowid_wl, pk,ywbmbh )
        Values
            (Sysdate, 'XJHG', v_agvhz.xjczybh, v_agvhz.xjczybh, v_xj.id, v_mxid,
             v_xj.flowid_xj, v_xj.pk,v_xj.ywbmbh);
        Insert Into T_WLCCB_MX_XTW
            (flowid, lx, id, yssl, sjsl, dqczy, sjczy, rq, flag,ywbmbh)
        Values
            (v_xj.flowid_xj, 'KFXJ', V_XJ.ID, xj.rwsl, v_bccs, v_agvhz.xjczybh, v_agvhz.xjczybh,
             Sysdate, '0',v_xj.ywbmbh);

        If errno <> 0 Then
            Rollback;
            Return;
        End If;
        proc_cycl(v_xj.ywbmbh, v_xj.kfbh, v_xj.id, -v_cysl, v_xj.phdh, '下架回告',
                  v_agvhz.xjczybh, v_xj.cgyj, v_xj.cybh, v_xj.dh, v_xj.lxbh, v_xj.zk, errno,
                  errtext);
        If errno <> 0 Then
            Rollback;
            Return;
        End If;

          ----- --2018-1-4 新增
           insert into t_tasklack
           (taskflowid, tablename,   czybh, czyname, area, yssl, sjsl, lx, areanote, id,ywbmbh,dh,kfbh,dm)
               values
           (xj.FLOWID_XJ,'T_AGV_RW_XT',v_agvhz.xjczybh ,v_agvhz.xjczyname
           , p_hw,v_xj.yssl,v_xj.sjsl+ v_bccs ,  decode(v_xj.lxbh,'FH','发货下架','ST','退货下架','下架'),'库房货位', v_xj.id,
           v_xj.ywbmbh,v_xj.dh,v_xj.kfbh,
           decode(v_xj.lxbh,'ST',(select trim(mc) from t_ghdw where bh=v_xj.dh),(select trim(dm) from t_dm where dh=v_xj.dh) )
           );

            insert into t_lkchecktask
           (flowid, tablename,  createczybh, createczyname, hw, yssl, sjsl, lx,  rqh, taskflowid, id ,hqbh ,ywbmbh,dh,kfbh,dm)
         values
           (xj.FLOWID_XJ, 'T_AGV_RW_XT',  v_agvhz.xjczybh,v_agvhz.xjczyname ,
            p_hw, v_xj.yssl, v_xj.sjsl+ v_bccs,
            decode(v_xj.lxbh,'FH','发货下架','ST','退货下架','下架'),  v_agvhz.rqh, v_agvhz.flowid, v_xj.id , trim(v_xj.hqbh),
             v_xj.ywbmbh,v_xj.dh,v_xj.kfbh,
             decode(v_xj.lxbh,'ST',(select trim(mc) from t_ghdw where bh=v_xj.dh),(select trim(dm) from t_dm where dh=v_xj.dh) ));

             select count(*) into v_rows from t_lkchecktask where zt='1' and hw=p_hw   and id=v_xj.id ;
             if v_rows >0 then
              update  t_lkchecktask t  set
              (zt,handleczy,handledate,handleczyname)=
              (select   '1',handleczy,handledate,handleczyname from t_lkchecktask where zt='1' and id=t.id and hw=t.hw and rownum=1)
               where flowid=xj.FLOWID_XJ;
             end if;
          -----  --2018-1-4 新增
    End If;

    select ALL_FLOWID.Nextval into  v_allflowid from dual;
    if v_bccs>0  then

    update t_agvhz  set sjsl=sjsl+v_bccs where flowid=p_flowid;

     Update T_AGV_RW_XT   Set   SJSL = SJSL+v_bccs
     Where FLOWID_XJ = xj.flowid_xj;

        -- 按单是将本次实际下架数累加到t_dfbj的相应记录中
        V_SY := V_XJ.ZJXS * V_XJ.ZK * v_bccs / 100;
        V_MY := V_DJ * v_bccs;
        V_CS := v_bccs;

        v_zzl := v_bccs * v_xj.zl;



        if v_flowid is null then

          if v_agvhz.xjqx = 'ZP' then
            select sq_zprwhz.nextval into v_flowid from dual;
            select   substr(p_xjzxid,9,2) into v_line from  dual;


             insert into T_ZPRWHZ
            (flowid,zt, rqh, lxbh, kfbh, ywbmbh, yssl,sjsl  , zpz,
               createdate,   ysczybh, ysname,line,isgp,isgz,BZ,dhzxid  )
            values
             (v_flowid,'0', p_rqh, 'XJ', '2001', v_agvhz.ywbmbh,v_bccs,0,1,
                sysdate,  v_agvhz.xjczybh,
                (select trim(name) from t_user where usr_id = v_agvhz.xjczybh),
                v_line ,'1','0',v_agvhz.bz,p_xjzxid);

                insert into t_rqzy
                (bh, zydate, czy, tbname, tableid, note,qx,zylx)
               values( p_rqh, sysdate, null, 't_zprwhz',
               v_flowid, '播撒线'||trim(v_line)||'播撒任务','BSRW','s' );
          else

            select sq_jhtask.nextval into v_flowid from dual;
            Insert Into t_jhtask
                (id, RQH, zt, createdate, YWBMBH, DH,   ZPZ, ZCS, ZMY, ZSY,
                  JXFS, YWLX,  sjlx, zzl, js,
                  yxj, zddh,ddcdbj,isgp,isgz,zb,jhzxid)
            Values
                (v_flowid, p_rqh, '0', Sysdate, V_XJ.YWBMBH,   V_XJ.DH,
                    1, v_bccs, V_ONE_MYS, V_ONE_SYS, 'AD', V_XJ.LXBH,V_XJ.LXBH, v_zzl, 1,
                   v_agvhz.yxj,  V_XJ.zddh,v_ddcdbj,'0',v_agvhz.isgz,v_agvhz.bz,p_xjzxid);

              if v_agvhz.xjqx = 'FH' then

               insert into t_rqzy
                  (bh, zydate, czy, tbname, tableid, note,qx,zylx)
                select    p_rqh, sysdate, null, 't_jhtask',
                 v_flowid, trim(dm)||'的校核任务','FHJH','s'
                 from t_dm where dh=V_XJ.zddh;

              elsif v_agvhz.xjqx = 'ST' then

               insert into t_rqzy
                  (bh, zydate, czy, tbname, tableid, note,qx,zylx)
                select    p_rqh, sysdate, null, 't_jhtask',
                 v_flowid, trim(mc)||'的校核任务','THJH','s'
                 from t_ghdw where bh=V_XJ.zddh;
              else

               insert into t_rqzy
                  (bh, zydate, czy, tbname, tableid, note,qx,zylx)
                values(    p_rqh, sysdate, null, 't_jhtask',
                 v_flowid,  V_XJ.zddh||'的校核任务' ,'q','s');

              end if ;

          end if ;
        else

          if v_agvhz.xjqx = 'ZP' then
            update t_zprwhz
              Set  yssl = yssl + V_CS, ZMY = ZMY + V_MY
               Where flowid=v_flowid;
          else
             Update t_jhtask
             Set   ZCS = ZCS + V_CS, ZMY = ZMY + V_MY, ZSY = ZSY + V_SY
               ,zzl = nvl(zzl, 0) + v_zzl
               Where id=v_flowid;

          end if ;
          if sql%notfound then
               ERRNO   := V_BJ;
               ERRTEXT :='未更新到数据rqh'||p_rqh||'xjzxid'||p_xjzxid;
          end if;
        end if;


     If  v_agvhz.xjqx = 'FH'     Then

        Insert Into T_CRKLS
                (FLOWID_CRKLS, ID, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH,
                 CRKCS, CRKSY, SYLX, ZK_JG, ZJXS, BZ, flowid_wl, pk)
            Values
                (ALL_FLOWID.Nextval, V_XJ.ID, V_XJ.ph, V_XJ.ph, Sysdate, V_XJ.LXBH, V_KFBH1,
                 V_XJ.DH, V_XJ.CYBH, V_XJ.YWBMBH, v_bccs, V_ONE_SYS, V_XJ.SYLX, V_XJ.ZK,
                 V_XJ.ZJXS, 'XJHG', v_xj.flowid_xj, v_xj.pk);

        Select Sysdate + v_xj.xszq Into d_jzthrq From dual;

         Insert Into t_fhjh
            (flowid, pxdh, bjlsh,   id, ywbmbh, kfbh, cybh, dh, pxcs, sylx, zjxs,
             pxzk, sl, fhfs, thfs, djly, zdh,   SYS, DBBZ, XBBZ, TXY, zl, Cgyj, yscs,
             jzthrq, Sdhrq, cgyj_kh,  zdqh, pk,sourceid,sourcetable,pfrq)
        Values
            (v_allflowid, v_flowid,  v_flowid,  v_xj.id, v_xj.ywbmbh,
             v_xj.kfbh, v_xj.cybh, v_xj.dh, v_bccs, v_xj.sylx, v_xj.zjxs, v_xj.zk, v_xj.sl,
             '01', v_xj.tihfs, v_xj.djly, v_xj.phdh,
             round(v_xj.zjxs * v_bccs * v_xj.zk / 100, 2), V_XJ.DBBZ, V_XJ.XBBZ, '1',
             v_xj.zl, v_xj.cgyj, /*v_xj.yssl*/v_bccs, d_jzthrq, V_XJ.SDHRQ, v_xj.cgyj_kh,
             v_xj.hqbh, v_xj.pk,v_xj.FLOWID_XJ,'t_agv_rw_xt',sysdate);

         insert into t_tree
          (tbid, tbname, pid, pname, note, id, cs,czy )
          values
          (v_allflowid, 't_fhjh', V_XJ.flowid_xj, 't_agv_rw_xt',
          '发货下架到发货包装,校核任务号'||v_flowid||'箱号'||trim(p_rqh), v_xj.id,
           v_bccs ,v_agvhz.xjczybh);

        update t_jhtask set zpz =(select count(distinct id) from t_fhjh where bjlsh=v_flowid)
        where id=v_flowid;

    End If;
        --徐同文新增：对于报废类型的，则转出到报废库 2010.3.1
     If v_agvhz.xjqx = 'BF' Then

            proc_makedjh(V_XJ.KFBH, 'ZC', a_ywpch, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;
            Insert Into T_CRKLS
                (FLOWID_CRKLS, ID, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH,
                 CRKCS, CRKSY, SYLX, ZK_JG, ZJXS, BZ, flowid_wl, pk)
            Values
                (ALL_FLOWID.Nextval, V_XJ.ID, a_ywpch, a_ywpch, Sysdate, 'ZC', V_XJ.KFBH,
                 V_BFKF, V_XJ.CYBH, V_XJ.YWBMBH, v_bccs, V_ONE_SYS, V_XJ.SYLX, V_XJ.ZK,
                 V_XJ.ZJXS, 'XJBF', v_xj.flowid_xj, v_xj.pk);

            Insert Into t_wl_zyls
                (flowid, id, ckkf, rkkf, cybh, ywbmbh, yssl, sjsl, cgyj, lx, ghdwh, zypch,
                 ZK, Zjxs, Sylx, rq, BJLSH)
            Values
                (ALL_FLOWID.Nextval, v_xj.id, v_xj.kfbh, V_BFKF, v_xj.cybh, v_xj.ywbmbh,
                 /*v_xj.yssl*/v_bccs, v_bccs, v_xj.cgyj, 'ZY', v_xj.dh, a_ywpch, V_XJ.ZK, V_XJ.ZJXS,
                 V_XJ.SYLX, Sysdate, V_XJ.PHDH);

            proc_makedjh(V_XJ.KFBH, 'ZR', a_ywpch, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;
            Insert Into T_CRKLS
                (FLOWID_CRKLS, ID, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH,
                 CRKCS, CRKSY, SYLX, ZK_JG, ZJXS, BZ, flowid_wl, pk)
            Values
                (ALL_FLOWID.Nextval, V_XJ.ID, a_ywpch, a_ywpch, Sysdate, 'ZR', V_BFKF,
                 V_XJ.KFBH, V_XJ.CYBH, V_XJ.YWBMBH, v_bccs, V_ONE_SYS, V_XJ.SYLX, V_XJ.ZK,
                 V_XJ.ZJXS, 'XJBF', v_xj.flowid_xj, v_xj.pk);

            ---将出库数据插入到T_BFKCSL表中
            Insert Into T_BFKCSL
                (ID, YWBMBH, KFBH, KCCS, BJLSH, CYBH, Flowid)
            Values
                (V_XJ.ID, V_XJ.YWBMBH, V_BFKF, v_bccs, V_XJ.PHDH, V_XJ.CYBH, v_allflowid);

               insert into t_tree
              (tbid, tbname, pid, pname, note, id, cs,czy )
              values
              (v_allflowid, 't_bfkcsl', V_XJ.flowid_xj, 't_agv_rw_xt',
              '报废下架,箱号'||trim(p_rqh), v_xj.id,
               v_bccs ,v_agvhz.xjczybh);
     End If;

     If v_agvhz.xjqx = 'ST' Then

            -- 2008-07-09 yangyi:
            -- 主要为暂存区出现上架差异写损益时，按哪来哪去的原则记录损益。所以不再做下边的转移了
            -- 将来万一需要做暂存区向立库转移的处理，要注意了：
            -- t_hykcsl中的kfbh有可能不是立库的，可能有样本室的，
            -- 对于kfbh不是立库的，需要先按样本室库房做负退货，再写一笔样本转出和立库转入
            -- 对于kfbh为立库的，则只需要按立库写一笔负退货

            proc_makedjh(V_XJ.KFBH, 'ZC', a_ywpch, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;
            Insert Into T_CRKLS
                (FLOWID_CRKLS, ID, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH,
                 YWBMBH, CRKCS, CRKSY, SYLX, ZK_JG, ZJXS, BZ, flowid_wl, pk)
            Values
                (ALL_FLOWID.Nextval, V_XJ.ID, a_ywpch, a_ywpch, Sysdate, 'ZC',
                 V_XJ.KFBH, V_KFBH1, V_XJ.CYBH, V_XJ.YWBMBH, v_bccs, V_ONE_SYS,
                 V_XJ.SYLX, V_XJ.ZK, V_XJ.ZJXS, '退货下架转移', v_xj.flowid_xj, v_xj.pk);

            ---新增给商流传输表
            --徐同文：样本室退货首先转入到立库，然后由立库进行退货
            --所以样本下架后，将下架的数据以转移数据传输给商流
            Insert Into t_wl_zyls
                (flowid, id, ckkf, rkkf, cybh, ywbmbh, yssl, sjsl, cgyj, lx, ghdwh, zypch,
                 ZK, Zjxs, Sylx, rq)
            Values
                (ALL_FLOWID.Nextval, v_xj.id, v_xj.kfbh, V_KFBH1, v_xj.cybh, v_xj.ywbmbh,
                 /*v_xj.yssl*/v_bccs, v_bccs, v_xj.cgyj, 'TZ', v_xj.dh, a_ywpch, V_XJ.ZK, V_XJ.ZJXS,
                 V_XJ.SYLX, Sysdate);

                    ---徐同文于2008年11月25日修改，对于退货直接进行退货的由于没有上架过程，所以这里直接写流水的转入
            ---而有上架过程的在上架的时候写转入流水（proc_th_sj）
            proc_makedjh(V_KFBH1, 'ZR', a_ywpch, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;
            Insert Into T_CRKLS
                (FLOWID_CRKLS, ID, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH,
                 CRKCS, CRKSY, SYLX, ZK_JG, ZJXS, BZ, flowid_wl, pk)
            Values
                (ALL_FLOWID.Nextval, V_XJ.ID, a_ywpch, a_ywpch, Sysdate, 'ZR', V_KFBH1,
                 V_XJ.KFBH, V_XJ.CYBH, V_XJ.YWBMBH, v_bccs, V_ONE_SYS, V_XJ.SYLX, V_XJ.ZK,
                 V_XJ.ZJXS, 'YBXJHG', v_xj.flowid_xj, v_xj.pk);




                Insert Into t_stjh
                    (ID, YWBMBH, CYBH, KFBH, DBBZ, XBBZ, KCCS, HW, GHDWH, XM, SYLX, ZJXS,
                     SJLY, THZK, YWPC, FLOWID, BJLSH, zycs, sl, zl, cgyj, yscs, pk,sourceid,sourcetable)
                Values
                    (V_XJ.ID, V_XJ.YWBMBH, V_XJ.CYBH, V_KFBH1, V_XJ.DBBZ, V_XJ.XBBZ, v_bccs,
                     V_XJ.HWH, V_XJ.DH, v_agvhz.rqh, V_XJ.SYLX, V_XJ.ZJXS, 'HQ', V_XJ.ZK,
                     V_XJ.XSDH, v_allflowid, v_flowid, 0, v_xj.sl, v_xj.zl, v_xj.cgyj,
                    /* v_xj.yssl*/v_bccs, v_xj.pk,v_xj.FLOWID_XJ,'t_agv_rw_xt');

            insert into t_tree
              (tbid, tbname, pid, pname, note, id, cs,czy )
              values
              (v_allflowid, 't_stjh', V_XJ.flowid_xj, 't_agv_rw_xt',
              '退货下架到退货包装,校核任务号'||v_flowid||'箱号'||trim(p_rqh), v_xj.id,
               v_bccs ,v_agvhz.xjczybh);

        update t_jhtask set zpz =(select count(distinct id) from t_stjh where bjlsh=v_flowid)
        where id=v_flowid;

      End If;

     if v_agvhz.xjqx='ZP' then

        v_jhzxid :=v_xj.ywbmbh||'FHP';


        v_jhzxid :=v_jhzxid||v_xj.zddh||'N';
       -- select all_flowid.Nextval into v_mxid from  dual;

         Insert Into T_ZPRW
              (FLOWID_ZP, LXBH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ,   DH, ZPXYRQH,
               YSSL, ZK, SYLX, ZJXS, YSCZYBH, LN_ZP_NO,   LN_ZP_HW,
               sourceid, DJLY,   BZ, SL, YSPCH,
                zl, cgyj, xszq, sdhrq, cgyj_kh,  fhyxj, pk, ddbj,ID_ZPRWHZ,zddh,jhzxid,sourcetable)
          Values
              (v_allflowid, 'XJ', V_XJ.id, V_XJ.kfbh, V_XJ.ywbmbh,
               V_XJ.cybh, V_XJ.dbbz, V_XJ.xbbz,  V_XJ.dh, p_rqh,
               v_bccs, V_XJ.zk, V_XJ.Sylx,v_xj.Zjxs, v_agvhz.xjczybh, v_line,
                       null,
               V_XJ.flowid_xj, V_XJ.Djly,   Null, V_XJ.sl,
              V_XJ.cgyj, V_XJ.Zl,
               V_XJ.cgyj,  120, V_XJ.Sdhrq, V_XJ.cgyj_kh,   v_agvhz.Yxj,
               V_XJ.phdh, '0',v_flowid,V_XJ.zddh,v_jhzxid,'t_agv_rw_xt');

            insert into t_tree
              (tbid, tbname, pid, pname, note, id, cs,czy )
              values
              (v_allflowid, 't_zprw', V_XJ.flowid_xj, 't_agv_rw_xt',
              '下架到播撒线,'||v_line||'任务号'||v_flowid||'箱号'||trim(p_rqh), v_xj.id,
               v_bccs ,v_agvhz.xjczybh);

            update t_zprwhz set zpz =(select count(distinct id) from t_zprw where ID_ZPRWHZ=v_flowid)
            where flowid=v_flowid;
     end if ;
    end if;

      Insert Into T_AGV_RW_XT_BAK
      (FLOWID_XJ, PH, ID, LXBH,   KFBH, YWBMBH, CYBH, DH, PHDH, XSDH,  XHAO,
       QSHQBH, HQBH, HWH, PXHW, ZRHQ, ZRHW, YSSL, SL, ZK, SYLX, ZJXS,   XJRQ,
       XJCZYBH,   YSCZYBH,   JXFS, DJLY, DBDH, ZRCYBH, SJSL, LHQHW,
         cgyj, sdhrq,   qsclfs, xszq, tihfs, pk,dbbz,xbbz,xdrq,zddh,xjzxid)
       select
       v_allflowid, PH, ID, LXBH,   KFBH, YWBMBH, CYBH, DH, v_flowid, v_flowid,  trim(p_rqh),
       QSHQBH, HQBH, HWH, PXHW, ZRHQ, ZRHW, decode(p_cfbj, '1', v_bccs, xj.rwsl), SL, ZK, SYLX, ZJXS,   sysdate,
       v_agvhz.xjczybh,   YSCZYBH,   JXFS, DJLY, DBDH, ZRCYBH, v_bccs, LHQHW,
         cgyj, sdhrq,   qsclfs, xszq, tihfs, pk,dbbz,xbbz,to_date(zrhw,'yyyy/mm/dd hh24:mi:ss'),zddh,xjzxid
       from T_AGV_RW_XT where FLOWID_XJ=xj.FLOWID_XJ;

       if v_bccs=0 and p_cfbj='1' then
          exit;
       end if ;


     end loop;

        v_js:=1;
     if  v_xj.ywbmbh ='000001' then
        if v_agvhz.lxbh= 'FH' then
          if v_agvhz.currenthq= '18' then
               v_job:='TSFHDZXJ';
               v_js:=4;
           else

            v_job:='TSFHXJ';
          end if ;

        elsif v_agvhz.lxbh= 'ST'  then
          if v_agvhz.currenthq= '18' then
             v_job:='TSTHDZXJ';
             v_js:=3;
          ELSE
             v_job:='TSTHXJ';
          END IF;

        else
           v_job:=v_agvhz.lxbh;
        end if;
     else
       if v_agvhz.lxbh= 'FH' then
           v_job:='YXFHXJ';
           v_js:=2;
        elsif v_agvhz.lxbh= 'ST'  then
           v_job:='YXTHXJ';
        else
           v_job:='YX'||v_agvhz.lxbh;
        end if;

     end if ;

    if p_sjsl>0 then
      insert into t_gzltimes
             (czybh,   cs, my, id_job, proc, tablename, tablepk,ywbm)
             values
             (v_agvhz.xjczybh, p_sjsl, p_sjsl*v_dj,  v_job,
             'RF_XJHG2', 'T_AGV_RW_XT_BAK',  v_allflowid ,V_xJ.ywbmbh);
     end if;
     if p_cfbj='1' then
        insert into t_agv_rw_xt_bak2
        (flowid_xj, ph, id, lxbh, ln_zp, kfbh, ywbmbh, cybh, dh, phdh, xsdh, tihfs, xhao, qshqbh, hqbh, hwh, pxhw, zrhq, zrhw,
          yssl, sl, zk, sylx, zjxs, cltz, xjrq, xjczybh, wcbj, ysczybh, dbbz, xbbz, cwh, jxfs, djly, dbdh, zrcybh, sjsl, lhqhw,
          dybj, dyczybh, jhcs, jhrq, jhczybh, cgyj, sdhrq, zl, qsclfs, xszq, cgyj_kh, thl, bzr, bch, pk,zddh,xjzxid)
         select flowid_xj, ph, id, lxbh, ln_zp, kfbh, ywbmbh, cybh, dh, v_flowid, v_flowid, tihfs, xhao, qshqbh, hqbh, hwh, pxhw, zrhq, zrhw,
        yssl, sl, zk, sylx, zjxs, cltz, sysdate, v_agvhz.xjczybh, wcbj, ysczybh, dbbz, xbbz, cwh, jxfs, djly, dbdh, zrcybh, sjsl, lhqhw,
        dybj, dyczybh, jhcs, jhrq, jhczybh, cgyj, sdhrq, zl, qsclfs, xszq, cgyj_kh, thl, bzr, bch, pk,zddh,xjzxid
         from T_AGV_RW_XT where yssl=sjsl  and id=p_id and hwh=p_hw and zrhq=p_flowid;

        delete T_AGV_RW_XT where yssl=sjsl  and id=p_id and hwh=p_hw and zrhq=p_flowid;
     else
        insert into t_agv_rw_xt_bak2
        (flowid_xj, ph, id, lxbh, ln_zp, kfbh, ywbmbh, cybh, dh, phdh, xsdh, tihfs, xhao, qshqbh, hqbh, hwh, pxhw, zrhq, zrhw,
          yssl, sl, zk, sylx, zjxs, cltz, xjrq, xjczybh, wcbj, ysczybh, dbbz, xbbz, cwh, jxfs, djly, dbdh, zrcybh, sjsl, lhqhw,
          dybj, dyczybh, jhcs, jhrq, jhczybh, cgyj, sdhrq, zl, qsclfs, xszq, cgyj_kh, thl, bzr, bch, pk,zddh,xjzxid)
         select flowid_xj, ph, id, lxbh, ln_zp, kfbh, ywbmbh, cybh, dh, v_flowid, v_flowid, tihfs, xhao, qshqbh, hqbh, hwh, pxhw, zrhq, zrhw,
        yssl, sl, zk, sylx, zjxs, cltz, sysdate, v_agvhz.xjczybh, wcbj, ysczybh, dbbz, xbbz, cwh, jxfs, djly, dbdh, zrcybh, sjsl, lhqhw,
        dybj, dyczybh, jhcs, jhrq, jhczybh, cgyj, sdhrq, zl, qsclfs, xszq, cgyj_kh, thl, bzr, bch, pk,zddh,xjzxid
         from T_AGV_RW_XT
         where  id=p_id and hwh=p_hw and zrhq=p_flowid;

        delete T_AGV_RW_XT where  id=p_id and hwh=p_hw and zrhq=p_flowid;

     end if;
      v_rows:=sql%rowcount;
      update t_agvhz  set resttimes=resttimes-v_rows where flowid=p_flowid;

      if  p_cfbj='0' then

       select count(*) into v_rows from  t_agv_rw_xt  where zrhq= v_xj.zrhq;
        if v_rows =0  then
          p_finish:='1';

         --0:未领取     1:正在下架   2:开始下架,已取消  , 3:部分完成未领取, 4:完成

       update t_agvhz set   zt='4',finished='1',finishdate=sysdate where flowid= v_xj.zrhq    ;

   /*    Insert Into t_gzl
          (CZYBH, CZLX, CZRQ, JLS, CS,    my, table_name,  YWBMBH,PROC_NAME )
       Select xjczybh, Trim(min(a.LXBH)) || 'XJ', Sysdate,1, sum(SJSL),
               sum(sjsl * dj) , 'T_AGV_RW_XT_BAK',   min(ywbmbh),'rf_xjhg'
                      From T_AGV_RW_XT_BAK a, t_kcsm
                     Where phdh =V_XJ.phdh And a.id = t_kcsm.id
                     group by a.id,hwh,xjczybh,xhao;

             Insert Into t_gzl
          (CZYBH, CZLX, CZRQ,  table_name,  YWBMBH,PROC_NAME,js)
       Select v_agvhz.xjczybh, Trim(min(V_XJ.LXBH)) || 'XJ', Sysdate,   'T_AGV_RW_XT_BAK',V_XJ.Ywbmbh ,'rf_xjhg',1
              From  dual;*/


        for cur in ( select sum(sjsl) phdhsjsl, phdh  from t_agv_rw_xt_bak2
         where    zrhq =v_agvhz.flowid  and sjsl>0   group by phdh ) loop

             insert into t_gzl2
             (czybh,    pz, js, id_job, proc, tablename, tablepk,ywbm)
           select
              xjczybh  ,   count(distinct id),
              round ( v_js*sum(sjsl)/ cur.phdhsjsl,2),   v_job,
               'RF_XJHG2', 't_agv_rw_xt_bak2' ,cur.phdh,v_xj.ywbmbh from T_AGV_RW_XT_BAK2  where phdh =cur.phdh and sjsl>0
              group by   xjczybh ;
         end loop;

          select count(*) into v_rows from  t_jhtask where id = v_flowid;
          if v_rows>0  then
            Update t_jhtask Set zt = '1',wcdate=sysdate Where id = v_flowid;

          end if;

        else
          p_finish:='0';

        end if;

    end if ;

     insert into t_xjrecord
     (flowid, czy, sjsl, hw, id, xjzxid, rqh)
   values
     (p_flowid, v_agvhz.xjczybh, p_sjsl, trim(p_hw), p_id, p_xjzxid, p_rqh);



    ERRNO   := 0;
    ERRTEXT := 'OK';
Exception
    When Others Then
        ERRNO   := V_BJ;
        ERRTEXT :=V_BJ|| Sqlerrm|| '--RF_XJHG3';
        Rollback;
End;
CREATE OR REPLACE PROCEDURE "PROC_HX_BZ" --电脑上的换箱程序用

 (
 p_hw char,   -- 主配货位
 p_newrqh char, -- 新箱号
 p_oldrqh char,   -- 原箱号
 p_czybh char,
 p_writetrace out varchar,
 errno out number,
 errtext out  char
 )
 as
v_line char(2);
 v_count number;
 v_bj    number;

 begin


if trim( p_newrqh) is null  then
  errno   := -1;
 errtext :='新容器号为空!';
 return;
end if;

if trim(p_oldrqh) is null then
  errno   := -1;
 errtext :='原容器号为空!';
 return;
end if;

 if p_newrqh = p_oldrqh then
 errno   := -1;
 errtext :='新旧容器必须是不同的容器!';
 return;
 end if;

 select count(*) into v_count from t_line_zp_hw2
  where   hw=p_hw and container = p_oldrqh;
  if v_count<1 then
   errno   := -2;
   errtext :='货位和原箱号不匹配!';
   return;
  end if;

-- 判断新容器的合法性:
   proc_chkrqh(p_newrqh,'',errno,errtext);
   if errno<>0 then

   errno := -1;
   return;
   end if;
   select line into v_line from T_LINE_ZP_HW2 where hw=p_hw;
 RF_HX_BZ2(v_line,p_oldrqh,p_czybh,p_writetrace  ,errno ,errtext);
 if errno<>0 then
   return;
 end if;


 PROC_BINDRQH(p_newrqh,p_hw,errno ,errtext);
  if errno<>0 then
   rollback;
   return;
 end if;


 errno:=0;
 errtext:='ok';

 exception
 when others then
 errno   := -1;
 errtext := SQLERRM ;
 rollback;
 END ;
CREATE OR REPLACE Procedure PROC_JT_BZ
----------$active$-------拒退包装发运
(p_rqh   Char,
 p_bzrbh Char,
 p_czybh Char,
 p_bzjs  Number,
  p_tph   In Char, ---20170322 add by ygd--增加包件绑定的托盘，用于交接
 bjlsh   Out Varchar,
 errno   Out Number,
 errtext Out Varchar

 ) Is
		tmpVar   Number;
		v_cybh   t_user.bmbh%Type;
		v_kfbh   t_dm.dh%Type;
		v_bzjmy  Number;
		v_bzjzl  Number;
		v_js     Number;
		v_bj     Number;
		p_bjlsh  Number;
		v_ywbmbh t_khthmx_jt.YWBMBH%Type;
		v_bjlsh  t_khthmx_jt.BJLSH%Type;
		/******************************************************************************
    NAME:       PROC_JT_BZ
    PURPOSE:    拒退包装（完成拒退上架+拒退下架的功能 ）

    REVISIONS:
    Ver        Date        Author           Description
    ---------  ----------  ---------------  ------------------------------------
    1.0        2010-12-11   Lv.       1. Created this procedure.

    NOTES:

    Automatically available Auto Replace Keywords:
    Object Name:     PROC_JT_BZ
    Sysdate:         2010-12-11
    Date and Time:   2010-12-11, 下午 08:30:07, and 2010-12-11 下午 08:30:07
    Username:        Lv. (set in TOAD Options, Procedure Editor)
    Table Name:       (set in the "New PL/SQL Object" dialog)

    ******************************************************************************/
Begin
		tmpVar := 0;
		bjlsh  := '0';
		v_bj   := -1;
		Select bmbh Into v_cybh From t_user Where usr_id = p_czybh;
		Select Min(dh)
			Into v_kfbh
			From t_dm
		 Where lxbh = '2' And kflx = 'LK' And cybh = v_cybh;
		-- 2010-10-26 add by yangyi:
		-- 取得标准件码洋, 为按码洋推算退货上架的工作量件数:
		Select nvl(Min(sys_value), 900) Into v_bzjmy From t_sysset Where sys_item = 'GPBJBZ';
		-- 取得标准件重量, 为按码洋推算拒退包件的重量:
		Select nvl(Min(sys_value), 25) Into v_bzjzl From t_sysset Where sys_item = 'BZJZL';
		--    v_js := round(p_sjsl * v_thmx.dj/v_bzjmy,2);
		--    v_zl := round(p_sjsl * v_thmx.dj/v_bzjmy*v_bzjzl*1000,2);
		v_bj := -2;
		Select Count(*), Min(ywbmbh) ywbmbh
			Into tmpVar, v_ywbmbh
			From t_khthmx_jt
		 Where rqh = p_rqh;
		If (tmpVar > 0) Then
				v_bj := -44;
				-- 2010-04-10 yangyi:
				-- 因为最终t_dfbj_jt要插入t_dfbj中, 所以bjlsh要通过统一方法取得,
				/*        select to_char(all_flowid.nextval) into v_bjlsh from dual;*/
				proc_get_bjlsh('JT', v_ywbmbh, p_bjlsh, errno, errtext);
				If (errno <> 0) Then
						Rollback;
						Return;
				End If;
				-- end add
				v_bj    := -55;
				v_bjlsh := to_char(p_bjlsh);
				bjlsh   := v_bjlsh;
				--20111114 modify by lv 为了去除数量都为了0的单据
				Select Count(*) Into tmpVar From t_khthmx_jt Where rqh = p_rqh And sdsl > 0;
				If tmpVar = 0 Then
						Update t_khthmx_jt
							 Set bjlsh = v_bjlsh, /*rqh= '',*/ jhczy = p_czybh
						 Where rqh = p_rqh;
						p_bjlsh := '-100';
						errno   := 0;
						errtext := '';
						Return;
				End If;
				v_bj := -3;
				--为了后面发运、理货、回告都走发货的流程，因此将业务类型改成‘FH‘ 杨工同意了
				Insert Into tm_dfbj_jt
						(bjlsh, rqh, wcbj, pfrq, ywbmbh, ywpc, dh, hw, agvbj, ybzbj, bjfjbj, tph,
						 czybh, zpz, zcs, zmy, zsy, zzl, bzjs, sjjs, fhbmbh, fyfsh, ywlx, tihfs, kfbh)
						Select v_bjlsh, p_rqh, '1', Sysdate, Min(ywbmbh) ywbmbh, v_bjlsh, Min(dh) dh,
									 '', '0', '1', '0', '', p_czybh, Count(*) zpz, Sum(nvl(sdsl, 0)) zcs,
									 Sum(dj * nvl(sdsl, 0)) zmy, 0,
									 Sum(round(nvl(sdsl, 0) * dj / v_bzjmy * v_bzjzl * 1000, 2)) zzl, p_bzjs,
									 Sum(round(nvl(sdsl, 0) * dj / v_bzjmy, 2)) zjs, v_cybh, '01', 'FH',
									 '01', V_KFBH
							From t_khthmx_jt
						 Where rqh = p_rqh And sdsl > 0;
				--插入t_dfbj, 为交接, 理货, 发运做准备
				--用GKH = 'JT' 来区分拒退
				--2014-01-07 modify by lv 据退增加zpdh字段
				v_bj := -4;
				Insert Into t_dfbj
						(bjlsh, rqh, wcbj, pfrq, ywbmbh, ywpc, dh, gkh, hw, agvbj, ybzbj, bjfjbj, tph,
						 lhrq, czybh, zpz, zcs, zmy, zsy, zzl, bzjs, fhbmbh, fyjhpc, fyjhrq, fyjhpc1,
						 jhrh, fyfsh, ch, yh, ywqrpc, yqrjs, yjsje, zzbh, zzbh1, ktbj, ktjkfs, ktpch,
						 ktrq, kt_czybh, zb, tihfs, xgbj, fxjb, fyjb, ln_zp_no, sjjs, sum_xhao, kfbh,
						 jxfs, ywlx, frrq, ttxh, djbj, xjdbj, fyrh, jhczybh, jhrq, jhrqh, cydw, cyr,
						 cyr_tele, cyrq, jkpzrq, psjs, shrq, ssjs, tylx, tynr, tyr, tyr_tele, tyrq,
						 sdhrq, lx, yrq, fhyxj, fyth_czybh, jhpch, fytph, js, cgyj, lhbj,
						 cybh, bzr, jjbj, jsjs, zpdh)
						Select bjlsh, rqh, wcbj, pfrq, ywbmbh, ywpc, dh, 'JT', hw, agvbj, ybzbj,
									 bjfjbj, p_tph /*tph*/, lhrq, czybh, zpz, zcs, zmy, zsy, zzl, bzjs,
									 fhbmbh, fyjhpc, fyjhrq, fyjhpc1, jhrh, fyfsh, ch, yh, ywqrpc, yqrjs,
									 yjsje, zzbh, zzbh1, ktbj, ktjkfs, ktpch, ktrq, kt_czybh, zb, tihfs,
									 xgbj, fxjb, fyjb, ln_zp_no, bzjs, sum_xhao, kfbh, 'AJ', ywlx, frrq, 1,
									 '1', xjdbj, fyrh, p_bzrbh, Sysdate, jhrqh, cydw, cyr, cyr_tele, cyrq,
									 jkpzrq, psjs, shrq, ssjs, tylx, tynr, tyr, tyr_tele, tyrq, Sysdate + 10,
									 lx, yrq, fhyxj, fyth_czybh,  jhpch, fytph, bzjs, cgyj, lhbj,
									 cybh, p_bzrbh, jjbj, jsjs, dh
							From tm_dfbj_jt
						 Where rqh = p_rqh;
				Select all_flowid.nextval Into tmpVar From dual;
				-- 记包装工作量:
				v_bj := -6;
				Insert Into t_gzl
						(FLOWID, CZYBH, CZLX, CZRQ, JLS, CS, MY, JS, TABLE_NAME, FLOWID_TABLE, YWBMBH,
						 PROC_NAME)
						Select tmpVar, p_bzrbh, 'XJBZ', Sysdate, Count(*), Sum(nvl(jhcs, 0)) zcs,
									 Sum(dj * nvl(jhcs, 0)) zmy,
									 Sum(round(nvl(jhcs, 0) * dj / v_bzjmy, 2)) zjs, 't_khthmx_jt',
									 Min(bjlsh), Min(ywbmbh), 'proc_jt_bz'
							From t_khthmx_jt
						 Where rqh = p_rqh And sdsl > 0;
				-- 写工作量表(下架校核):
				Insert Into t_gzl
						(CZYBH, CZLX, CZRQ, JLS, CS, JS, FLOWID, MY, TABLE_NAME, FLOWID_TABLE, YWBMBH,
						 PROC_NAME)
						Select p_czybh, 'XJJH', Sysdate, Count(*), Sum(nvl(jhcs, 0)) zcs,
									 Sum(round(nvl(jhcs, 0) * dj / v_bzjmy, 2)) zjs, tmpVar,
									 Sum(dj * nvl(jhcs, 0)) zmy, 't_khthmx_jt', Min(bjlsh), Min(ywbmbh),
									 'proc_jt_bz'
							From t_khthmx_jt
						 Where rqh = p_rqh And sdsl > 0;
				v_bj := -5;
				Update t_khthmx_jt
					 Set bjlsh = v_bjlsh, rqh = '', jhczy = p_czybh
				 Where rqh = p_rqh;
		Else
				errno   := -1;
				errtext := '没有查询到该容器的拒退数据!';
				Rollback;
				Return;
		End If;
		errno   := 0;
		errtext := '';
Exception
		When Others Then
				errno   := -1;
				errtext := Sqlerrm || to_char(v_bj);
				Rollback;
				Return;
End PROC_JT_BZ;
CREATE OR REPLACE Procedure RF_SJHG3/*
 存储区及样本室上架差异写法：
 IF 非样本转入上架 THEN
 差异数按负的CY写t_crkls，kfbh=当前上架库房
 ELSE
 差异数按负的ZC写t_crkls，kfbh=转出库房（即：立库）
 差异数按负的CY写t_crkls，kfbh=转出库房（即：立库）
 END IF
 按实际数写库存
 */
    -- 2011-11-18 升级
(p_id  In Char,
 p_hw     In Char,
 p_sjsl    In Number,
 p_sjfs   in char,
 p_id_pmsjhz  In Char,
 p_cfbj  In Char, --拆分标记，1=拆分，默认是0
 ERRNO   Out Number,
 ERRTEXT Out Varchar2) As

    V_KFBH     T_CRKLS.KFBH%Type;
    V_LYBH     T_CRKLS.LYBH%Type;
    v_bj       Number;
    V_KFLX     Char(2);
    v_cclx     Char(4);
   v_allflowid number;
    v_dj       Number;
    v_hqlx     char(2);
    v_rows  number;
    v_sumsjsl  number;
    v_job  varchar2(10);
    v_pmsjhz t_pmsjhz%rowtype;
    v_sycs number;
    V_SJSL number;
    v_bccs number;
    V_CYSL number;
    v_hqbh     char(4);
Begin

    -- 2015-08-18 yangyi:
    If p_sjsl<0 Then
        ERRNO   := 1;
        ERRTEXT := '上架数量不能小于0!';
        Rollback;
        Return;
    End If;


   select * into v_pmsjhz from t_pmsjhz where flowid=p_id_pmsjhz;
    select kflx into v_kflx from t_dm where dh=v_pmsjhz.ywbmbh;
    if v_kflx='YX' then
      v_job:='YX';
    else
      v_job:='TS';
    end if ;

    select min(hqbh) into v_hqbh from t_hwdy where hw=p_hw;
    if  v_hqbh is null then
      ERRNO   := 1;
      ERRTEXT := p_hw||'没有这个货位';
      Return;
    end if;

    select sum(yssl-sjsl) into v_sycs from t_pmsjrwb where id=p_id and id_pmsjhz=p_id_pmsjhz;
    if v_sycs< p_sjsl then
      ERRNO   := 1;
      ERRTEXT := '实际上架数不能大于原始数';
      Return;
    end if ;

    if v_sycs =  p_sjsl and p_cfbj ='1' then
      ERRNO   := -1;
      ERRTEXT := '拆分数量和原数量相同';
      Return;
    end if ;

    Select Count(*) Into v_rows
      From t_hwdy
     Where hw = p_hw And  Exists
            (Select 1 From t_hqdy Where bh = t_hwdy.hqbh And ywbmbh = v_pmsjhz.ywbmbh );
    If v_rows = 0 Then
        errno   := -1;
        errtext := '该货位所在的货区不属于当前货主!';
        Return;
    End If;

    V_SJSL:=p_sjsl;
    For V_SJ In (Select flowid_sj, yssl-sjsl rwsl,dbbz,xbbz,zl,ID,pk,ysczybh
                  From t_pmsjrwb
                 Where id_pmsjhz=p_id_pmsjhz  And id = p_id   and yssl-sjsl>0
                 Order By yssl-sjsl)
    Loop

      If V_SJ.rwsl <= V_SJSL Then
          v_bccs:=V_SJ.rwsl;
          V_CYSL:=0;
      Else
          v_bccs:=V_SJSL;
          V_CYSL:=V_SJ.rwsl-V_SJSL;
      end if;

      --v_sycs := p_SJSL -v_bccs;
      Select NVL(KFLX, '0') Into V_KFLX From T_DM Where DH = '2001';

      If V_KFLX = 'LK' Then

              Update T_LTKF
                 Set kccs = kccs + v_bccs
               Where ID = V_SJ.ID And HW = p_hw And KFBH = v_pmsjhz.KFBH   and YWBMBH = v_pmsjhz.YWBMBH  ;
              If Sql%Notfound Then

                  Insert Into T_LTKF
                      (ID, HW, KFBH, DBBZ, XBBZ, KCCS, CYBH, ywbmbh, Zycs, zl,hqbh)
                  Values
                      (p_id, p_hw, '2001', v_sj.dbbz, v_sj.xbbz, v_bccs,
                       '3001', v_pmsjhz.ywbmbh, 0, v_sj.zl,v_hqbh);
              End If;

      End If;

    If  V_CYSL > 0 and p_cfbj ='0'  Then

          select ALL_FLOWID.Nextval into  v_allflowid from dual;
           insert into t_tree
            (tbid, tbname, pid, pname, note, id, cs,czy )
            values
            (v_allflowid, 't_wlccb', v_sj.flowid_sj, 't_pmsjrwb',
            '上架差异', v_sj.id,
             v_cysl ,trim(v_pmsjhz.sjczybh));

              Update T_KCSL
                 Set KCCS = KCCS - V_CYSL
               Where ID = V_SJ.ID And KFBH = '2001' And YWBMBH = v_pmsjhz.YWBMBH;

              v_cclx := v_pmsjhz.lxbh || 'FL';

              Insert Into t_wlccb
                  (rq, lx, czybh_err, czybh_chk, id, flowid, flowid_wl, pk,ywbmbh)
              Values
                  (Sysdate, v_cclx, v_sj.ysczybh, trim(v_pmsjhz.sjczybh), v_sj.id, v_allflowid,
                   v_sj.flowid_sj, v_sj.pk,v_pmsjhz.YWBMBH);
              Insert Into T_WLCCB_MX_XTW
                  (flowid, lx, id, yssl, sjsl, dqczy, sjczy, rq, flag,ywbmbh)
              Values
                  (v_sj.flowid_sj, 'DHSJ', v_sj.id, v_sj.rwsl, v_bccs, trim(v_pmsjhz.sjczybh),
                   v_sj.ysczybh, Sysdate, '0',v_pmsjhz.YWBMBH);


               V_KFBH := '2001';
               V_LYBH := '2001';


              proc_cycl(v_pmsjhz.YWBMBH, '2001', v_sj.id, -V_CYSL, null, 'SJHG', trim(v_pmsjhz.sjczybh),
                        '', '3001', '', '',null ,errno, errtext);
              If errno <> 0 Then
                  Rollback;
                  Return;
              End If;
     End If;

    Select dj Into v_dj From t_kcsm Where id = v_sj.id;

    if v_hqlx<>'DT'  then
      --update t_pmsjrwb set hwh=p_hw where  id=v_sj.id and ywbmbh=v_pmsjhz.YWBMBH and trim(hwh) is null;
      update t_sjrecord set hqbh=v_hqbh ,hw=p_hw,czybh=trim(v_pmsjhz.sjczybh),sjrq=sysdate
      where id=v_sj.id and ywbmbh=v_pmsjhz.YWBMBH;
      if sql%notfound then
        insert into t_sjrecord(id  ,hqbh  ,hw  ,czybh  ,sjrq ,ywbmbh  ) values
       (v_sj.id,v_hqbh,p_hw,trim(v_pmsjhz.sjczybh),sysdate,v_pmsjhz.YWBMBH);
      end if;
    end if;



    if v_bccs> 0 then

       select ALL_FLOWID.Nextval into  v_allflowid from dual;
       insert into t_gzltimes
             (czybh,   cs, my, id_job, proc, tablename, tablepk,ywbm)
             values
             (trim(v_pmsjhz.sjczybh), v_bccs, v_bccs*v_dj,  v_job||p_sjfs||v_hqlx||'SJ',
             'RF_SJHG2', 't_pmsjrwb',  v_sj.flowid_sj,v_pmsjhz.YWBMBH );

       Update t_pmsjrwb
       Set sjrq = Sysdate, sjhw = p_hw , sjsl = sjsl + v_bccs,sjfs=p_sjfs,hqlx=v_hqlx,sjczybh=trim(v_pmsjhz.sjczybh)
       Where flowid_sj = v_sj.flowid_sj;

        insert into t_tree
          (tbid, tbname, pid, pname, note, id, cs,czy )
          values
          (v_allflowid, 't_ltkf', v_sj.flowid_sj, 't_pmsjrwb',
          '上架到货位'||trim(p_hw)  , v_sj.id,
           v_bccs ,trim(v_pmsjhz.sjczybh));
    end if ;

     V_SJSL:=V_SJSL-v_bccs;
     if v_bccs=0 and p_cfbj='1' then
          exit;
     end if ;
   end loop ;

   if p_cfbj='1' then
    insert into t_pmsjrwb_bak (
    flowid_sj, lxbh, id, kfbh, ywbmbh, cybh, hqbh, hwh, tm, yssl,
     sjsl, sjrq, sjczybh, dh, ysczybh, zckf, dbbz, xbbz, flowid_dhfl,
     sjfs, zl, xrrq, pk, sjhw, sourcetable, sourceid, id_pmsjhz, cgdh_sl,
     fhdh_ghdw, taskid, hqlx, jhcs, sylx, zjxs,
     pjzk_jg, id_pmsjhz_old
    )
    select flowid_sj, lxbh, id, kfbh, ywbmbh, cybh, hqbh, hwh, tm, yssl,
     sjsl, sjrq, sjczybh, dh, ysczybh, zckf, dbbz, xbbz, flowid_dhfl,
     sjfs, zl, xrrq, pk, sjhw, sourcetable, sourceid, id_pmsjhz, cgdh_sl,
     fhdh_ghdw, taskid, hqlx, jhcs, sylx, zjxs,
     pjzk_jg, id_pmsjhz_old from t_pmsjrwb Where id_pmsjhz = p_id_pmsjhz and id=p_id and yssl=sjsl;

    delete t_pmsjrwb Where id_pmsjhz =p_id_pmsjhz  and id=p_id and yssl=sjsl;

   else
     insert into t_pmsjrwb_bak (
    flowid_sj, lxbh, id, kfbh, ywbmbh, cybh, hqbh, hwh, tm, yssl,
     sjsl, sjrq, sjczybh, dh, ysczybh, zckf, dbbz, xbbz, flowid_dhfl,
     sjfs, zl, xrrq, pk, sjhw, sourcetable, sourceid, id_pmsjhz, cgdh_sl,
     fhdh_ghdw, taskid, hqlx, jhcs, sylx, zjxs,
     pjzk_jg, id_pmsjhz_old
    )
    select flowid_sj, lxbh, id, kfbh, ywbmbh, cybh, hqbh, hwh, tm, yssl,
     sjsl, sjrq, sjczybh, dh, ysczybh, zckf, dbbz, xbbz, flowid_dhfl,
     sjfs, zl, xrrq, pk, sjhw, sourcetable, sourceid, id_pmsjhz, cgdh_sl,
     fhdh_ghdw, taskid, hqlx, jhcs, sylx, zjxs,
     pjzk_jg, id_pmsjhz_old from t_pmsjrwb Where id_pmsjhz = p_id_pmsjhz  and id=p_id ;

     delete t_pmsjrwb Where id_pmsjhz = p_id_pmsjhz  and id=p_id  ;
   end if ;

   update t_pmsjhz set sjsl = sjsl+p_sjsl  where flowid=p_Id_Pmsjhz  ;

   select count(*) into v_rows from T_PMSJRWB Where   Id_Pmsjhz=p_Id_Pmsjhz;
   if v_rows=0 then

      select sum(sjsl) into v_sumsjsl  from t_pmsjrwb_bak where Id_Pmsjhz=p_Id_Pmsjhz;
      if v_sumsjsl>0 then

        insert into t_gzl2
         (czybh,    pz, js, id_job, proc, tablename, tablepk,YWBM)
       select
          sjczybh  ,   count(distinct id),
          round (sum(sjsl)/v_sumsjsl,2),   v_job||sjfs||hqlx||'SJ',
           'RF_SJHG3', 't_pmsjhz' ,p_Id_Pmsjhz,v_pmsjhz.YWBMBH from t_pmsjrwb_bak where Id_Pmsjhz =p_Id_Pmsjhz
           AND sjsl>0
          group by sjczybh,sjfs,hqlx;
      end if ;

     update t_pmsjhz set finishdate=sysdate,finished=1,zt='4'
     where flowid=p_Id_Pmsjhz;

     delete t_rqzy where tbname='t_pmsjhz' and tableid=p_Id_Pmsjhz;


   end if;

    ERRNO   := 0;
    ERRTEXT := 'OK';
Exception
    When Others Then
        ERRNO   := V_BJ;
        ERRTEXT := to_char(V_BJ) || Sqlerrm;
        Rollback;
End;
CREATE OR REPLACE Procedure PROC_GOO_DHLR_FL_ZJS6
(p_flowid_dhmx Number,
 p_dhzxid Char,
 p_sjsl        Number, --实际数量
 p_czybh       Char, --分流操作员
 p_flag        Char, --正常分流为空，PS 表示是破损
 p_xhao        Char, --容器号
 p_bj_more     Char, --多书标记 0 代表正常 1 代表多书
 p_mac         varchar2,
 p_finish out varchar2,
 errno         Out Number, --为便于前台判断是否需要向高架库系统传送上架任务数据
 errtext       Out Varchar) As
    v_dhdj   tmp_dhdj%Rowtype;
    v_dhmx   tmp_dhmx%Rowtype;
    v_bccs   Number;
    v_bjlsh  Number;
    v_snswbj Char(1);
    v_zypch      Char(12);
    v_hqbh Char(4);
    v_hqlx       Char(2);
    v_hqmc       Char(60);
    v_rows       Number;
    v_bj         Number;
    --v_flqxmc     Char(60);
    v_sys        Number;
    v_sncrkcs    Number;
    v_sncrksy    Number;
    v_zjxs       Number;
    v_flowid_new Number;
    v_flqx       Char(2);
    s_hqbh       Char(4);
    s_hqmc       Char(60);
    ls_hw_hythq  Char(20);
    v_sysl Number;
    v_idpmsjhz number;
    ls_sj_flsg      char(1);
    v_jhzxid varchar2(30);
    v_dh_yfsj t_dh_yfsj%rowtype;
    v_flowid number;
    v_pmsjhz  t_pmsjhz%rowtype;
    v_zprwhz t_zprwhz%rowtype;
    v_jhtask t_jhtask%rowtype;
    v_yfsjid number;
    v_mxid number;
    v_flrqhid number;
Begin


    If Trim(p_xhao) Is Null Then
        errno   := -19;
        errtext := '容器号不能为空!';

        Return;
    End If;

    If p_sjsl <= 0 Then
        errno   := -12;
        errtext := '分流数量必须大于0!';

        Return;
    End If;

  select * into v_dh_yfsj from t_dh_yfsj where flowid_dhmx =p_flowid_dhmx
  and dhzxid=p_dhzxid and rownum=1;
  /*   If v_dh_yfsj.flqx <> 'FH' And p_sjsl = 0 Then
        errno   := -13;
        errtext := '分流数量不能为0!';
        Return;
    End If;
    If v_dh_yfsj.flqx = 'FH'  and v_dh_yfsj.sjsl+p_sjsl>v_dh_yfsj.yfsl Then
        errno   := -13;
        errtext := '超过了最大分流册数!';
        Return;
    End If;*/
    if v_dh_yfsj.flqx<>'CC' and p_flag<>'PS' then
      select sum(yfsl-sjsl) into v_sysl from t_dh_yfsj where flowid_DHMX= v_dh_yfsj.flowid_dhmx and flqx=
      v_dh_yfsj.flqx and  dhzxid=p_dhzxid;
      if  p_sjsl>v_sysl then
        errno   := -13;
        errtext := '超过了最大分流册数!';
        Return;
      end if ;
    end if ;


    Select * Into v_dhdj From tmp_dhdj Where flowid_dj = v_dh_yfsj.flowid_dj;
    Select * Into v_dhmx From tmp_dhmx Where flowid_DHMX = v_dh_yfsj.flowid_dhmx;
  --  select sum(sjsl) into v_zcs from t_dh_yfsj where flowid_DHMX = v_dh_yfsj.flowid_dhmx;



    Select  sj_flag
      Into ls_sj_flsg
      From t_wlsh
     Where id = v_dhdj.flowid_tldjhz;


    If v_dhmx.sylx = '0' Then
        v_zjxs := v_dhmx.dj;
    Else
        v_zjxs := 100;
    End If;

    v_flqx   := v_dh_yfsj.flqx;

    If UPPER(p_flag) = 'PS' Or upper(v_dh_yfsj.flqx) = 'ST' Then

        /* errno   := -1;
         errtext := '功能未开启!';
         Return;*/

         v_flqx   := 'ST';

          proc_chkrqh2(p_xhao, 't_thsjhz', errno, errtext);
          If errno <> 0 Then
              Rollback;
              Return;
          End If;

          select  mc into s_hqmc  from    t_ghdw where bh=v_dhdj.ghdwh;

          Select  min(hqbh) into s_hqbh   From t_ghdw_hythqhw
                       Where ghdwh = v_dhdj.ghdwh And ywbmbh = v_dhdj.ywbmbh ;

          if s_hqbh is null then
              errno:=-1;
              errtext:=s_hqmc||'没有在退货区绑定货位！'||v_dhdj.ywbmbh;
              Return;
          end if;

          select count(*) into v_rows from  T_THSJHZ where rqh= p_xhao  and zt='1' ;
          if v_rows >0 then
            errno   := -1;
            errtext := '箱子绑定的退货上架任务正在上架!';
            Return;
          end if ;

          select count(*) into v_rows from T_THSJHZ t where rqh= p_xhao and finished='0'
          and hqbh <>s_hqbh;
          if v_rows >0 then
             errno   := -1;
             errtext := '箱子中存在其他货区的上架任务!';
             Return;
          end if ;


          If v_dhmx.sylx = '0' Then
              v_zjxs := v_dhmx.dj;
          Else
              v_zjxs := 100;
          End If;



      select min(flowid) into v_yfsjid  from t_dh_yfsj t where Flowid_dhmx = v_dh_yfsj.flowid_dhmx And flqx = 'ST';
      if v_yfsjid is null then

         Select all_flowid.Nextval Into v_yfsjid From dual;

         insert into t_dh_yfsj
          (flowid, flowid_dhmx, flowid_dj, dh, id, yfsl, sjsl, flqx, flqxmc, detailqx,
            hw ,cgyj , cgyj_kh,xh,dhzxid)
          values
          (v_yfsjid,v_dhmx.flowid_dhmx,v_dhdj.flowid_dj,null,v_dhmx.id,0,p_sjsl,'ST',
          trim(s_hqmc),s_hqbh,ls_hw_hythq,v_dh_yfsj.cgyj,v_dh_yfsj.cgyj_kh,3,V_DHDJ.YWBMBH|| 'STH'||trim(s_hqbh));

        insert into t_tree
         (tbid, tbname, pid, pname, note, id, cs,  orderno, lf,rt,rid,dm)
         values
          (v_yfsjid, 't_dh_yfsj', -1, 't_sl_yfsj', 
          '到货分流指令,破损,'||trim(s_hqmc)||',任务号'||v_dhdj.flowid_tldjhz, v_dh_yfsj.id,
           0,  null,1,2,v_yfsjid,trim(s_hqmc));

      else
         Update t_dh_yfsj  Set sjsl = sjsl + p_sjsl
         Where Flowid =v_yfsjid;
      end if ;


      Update tmp_dhmx  Set pssl = pssl + p_sjsl
       Where Flowid_dhmx = v_dh_yfsj.flowid_dhmx ;

       select min(flowid) into v_flowid  from T_THSJHZ t where rqh= p_xhao and finished='0';

       if v_flowid is null then

           select  sq_thsjhz.Nextval into v_flowid from dual;

           insert into t_thsjhz
           (flowid, rqh, lxbh, kfbh, ywbmbh, yssl,  zpz, zmy, createczybh, createczyname,hqbh,sjzxid)
           select
           v_flowid, p_xhao, 'TH', '2002',  V_DHDJ.YWBMBH, p_sjsl,1, p_sjsl*v_dhmx.dj, p_czybh,
           trim(name), s_hqbh, V_DHDJ.YWBMBH||'STH'||trim(s_hqbh)
           from  t_user where usr_id=p_czybh;

           insert into t_rqzy
          (bh, zydate, czy, tbname, tableid, note,qx,zylx)
           values( p_xhao, sysdate, null, 't_thsjhz',
           v_flowid, '退货暂存区'||trim(s_hqbh) ||'上架任务' ,'THKSJ','s');
       else
           update  t_thsjhz set yssl=yssl+p_sjsl,zmy=zmy + v_dhmx.dj*p_sjsl
           where flowid=v_flowid;
       end if ;


        Select all_flowid.Nextval Into v_mxid From dual;
        Insert Into t_fjrwsjb
              (flowid, ywlx, xm, ghdwh, hqbh, ywbmbh, cybh, kfbh, id, dbbz, xbbz, ywsl,
               sylx, zjxs, thzk, czybh, hw, sjhw, flqxmc, rwrq, ywlx1,  Zl, cgyj, lybh,
               sl, pk,ID_THSJHZ,SOURCEID,sourcetable)
          Values
              (v_mxid, 'SJ', p_xhao, v_dhdj.ghdwh, s_hqbh, v_dhdj.ywbmbh,
               v_dhdj.cybh, '2002', v_dhmx.id, v_dhmx.dbbz, v_dhmx.xbbz, p_sjsl, v_dhmx.sylx,
               v_zjxs, v_dhmx.jhzk, p_czybh, ls_hw_hythq, ls_hw_hythq, s_hqmc, Sysdate,
               'DH',   v_dhmx.zl, 'J', v_dhdj.kfbh, v_dhdj.sl,
               v_dhmx.flowid_dhmx,v_flowid,v_yfsjid,'t_dh_yfsj');
      --End If;

       insert into t_tree
        (tbid, tbname, pid, pname, note, id, cs,czy )
        select
         v_mxid , 't_fjrwsjb', v_yfsjid, 't_dh_yfsj',
         '到货分流,退货暂存区上架,任务号'||v_flowid||'箱号'||trim(p_xhao),id,
         ywsl ,p_czybh
         from  t_fjrwsjb where ID_THSJHZ=v_flowid;

        DLGETLSH(v_dhdj.cybh, '2002', 'ZC', v_zypch);
        v_sys := round(p_sjsl * v_dhmx.jhzk * v_zjxs / 100, 2);
      -- t_crkls写备货库向退货库的转出
      Insert Into t_crkls
          (FLOWID_CRKLS, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH, ID, CRKCS,
           CRKSY, SYLX, ZK_JG, ZJXS, DBBZ, XBBZ, SN_CRKCS, SN_CRKSY, FGBJ, ysbbj, sl,
           flowid_wl, pk, bz)
      Values
          (v_mxid, v_zypch, v_zypch, Sysdate, 'ZC', v_dhdj.kfbh, '2002', v_dhdj.cybh,
           v_dhdj.ywbmbh, v_dhmx.id, p_sjsl, v_sys, v_dhmx.sylx, v_dhmx.jhzk, v_zjxs,
           v_dhmx.dbbz, v_dhmx.xbbz, 0, 0, '0', '0', v_dhdj.sl, v_dhmx.flowid_dhmx,
           v_dhmx.flowid_dhmx, '到货破损');
      -- 转出数据上报商流:
        Insert Into t_wl_zysjmx
            (flowid, id, ckkf, rkkf, cybh, ywbmbh, yssl, sjsl, ysbbj, lx, rq, ghdwh, zypch,
             senddate, sendbmbh, receflag, zk, zjxs, sylx, recebmbh, flowid_dhmx)
        Values
            (v_mxid, v_dhmx.id, v_dhdj.kfbh, '2002', v_dhdj.cybh, v_dhdj.ywbmbh, p_sjsl,
             p_sjsl, '9', 'TZ', Sysdate, v_dhdj.ghdwh, v_zypch, Sysdate, v_dhdj.cybh, '0',
             v_dhmx.jhzk, v_zjxs, v_dhmx.sylx, v_dhdj.ywbmbh, v_dhmx.flowid_dhmx);


     end if;


    If v_flqx = 'FH' Then

        proc_chkrqh2(p_xhao, 't_jhtask', errno, errtext);
        If errno <> 0 Then
            Rollback;
            Return;
        End If;

        v_sysl := p_sjsl;

      select min(tableid) into v_bjlsh from t_rqzy where bh= p_xhao and tbname='t_jhtask';
      if v_bjlsh is not null then
        select * into v_jhtask from t_jhtask where id=v_bjlsh;
        if v_jhtask.jhzxid <>v_dh_yfsj.dhzxid  then
           ERRTEXT := '容器被其他去向的书占用' || trim(errtext);
           Rollback;
           return;
        end if ;
        if v_jhtask.zt='2' then
           ERRTEXT := '箱子已经装箱完成，换其他箱子';
           Rollback;
           return;
        end if ;
      end if ;

      for cur in (select dh,fhzk,sdhrq,yxj,flowid,djly,cgyj,cgyj_kh ,yfsl-sjsl yfsl ,ttbz,zddh
                    from t_dh_yfsj where flowid_DHMX= v_dh_yfsj.flowid_dhmx
                     and  dhzxid=v_dh_yfsj.dhzxid  and yfsl-sjsl>0) loop

            If v_sysl >= cur.Yfsl Then
                v_bccs := cur.Yfsl;
            Else
                v_bccs := v_sysl;
            End If;
              Select all_flowid.Nextval Into v_flowid_new From dual;


            Select nvl(snswbj, '0') Into v_snswbj From t_dm Where dh = cur.dh;
            If v_dhmx.sylx = '0' Then
                v_sys := round(v_bccs * v_zjxs * cur.fhzk / 100, 2);
            Else
                v_sys := round(v_bccs * cur.fhzk, 2);
            End If;
            If v_snswbj = '0' Then
                v_sncrkcs := v_bccs;
                v_sncrksy := v_sys;
            Else
                v_sncrkcs := 0;
                v_sncrksy := 0;
            End If;

            if v_bjlsh is not null then
              Update t_jhtask
                 Set ZCS = zcs + v_bccs, ZMY = zmy + v_bccs * v_dhmx.dj,
                     ZSY = ZSY + v_sys, ZZL = zzl + v_bccs * v_dhmx.zl,
                     zb=nvl(cur.ttbz,zb)
               Where id=v_bjlsh ;
            else

                select sq_jhtask.nextval  into V_BJLSH from dual;
                 Insert Into t_jhtask
                    (id, RQH, zt, createdate,  YWBMBH,   DH,   ZPZ, ZCS, ZMY, ZSY,
                      ywlx, jxfs,   ZZL,  js,
                      yxj,  zddh,zb ,ddcdbj,tdpch,sjlx,isgp,isgz,jhzxid)
                Values
                    (V_BJLSH, p_xhao, '1', Sysdate, v_dhdj.ywbmbh,  cur.dh,
                       1, v_bccs, v_bccs * v_dhmx.dj, v_sys, 'FH', 'FL', v_bccs * v_dhmx.zl,   1,
                     NVL(cur.yxj, 'C'),  cur.zddh,cur.ttbz,v_dh_yfsj.ddcdbj,v_dh_yfsj.tdpch ,
                     'FH',v_dh_yfsj.isgp,v_dh_yfsj.isgz,v_dh_yfsj.dhzxid);

                      insert into t_rqzy
                    (bh, zydate, czy, tbname, tableid, note,qx,zylx)
                   values(   p_xhao, sysdate, null, 't_jhtask',
                   V_BJLSH, v_dh_yfsj.flqxmc||'的校核任务','FHJH','s');


             end if;

            Insert Into T_CRKLS
                (FLOWID_CRKLS, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH, CRKCS,
                 CRKSY, SYLX, ZK_JG, ZJXS, BZ, DBBZ, XBBZ, SL, sn_crkcs, sn_crksy, id,
                 flowid_wl, pk)
            Values
                (v_flowid_new, V_BJLSH, V_BJLSH, Sysdate, 'FH', v_dhdj.KFBH, cur.DH,
                 v_dhdj.cybh, v_dhdj.ywbmbh, v_bccs, v_sys, v_dhmx.sylx, cur.fhzk,
                 v_zjxs, 'DHZF', v_dhmx.dbbz, v_dhmx.xbbz, v_dhmx.sl, v_sncrkcs, v_sncrksy,
                 v_dhmx.id, v_dhmx.flowid_dhmx, cur.flowid);


             Insert Into t_fhjh
                (flowid, pxdh, bjlsh,   id, ywbmbh, kfbh, cybh, dh, pxcs, sylx, zjxs,
                 pxzk, sl, fhfs, thfs, djly, ZDH, DBBZ, XBBZ, sys, txy, cgyj, yscs,
                 cgyj_kh,   sdhrq, zl, pk,sourceid,sourcetable,zddh,pfrq)
            Values
                (v_flowid_new, v_bjlsh, v_bjlsh,    v_dhmx.id, v_dhdj.ywbmbh,
                 v_dhdj.kfbh, v_dhdj.cybh, cur.dh, v_bccs, v_dhmx.sylx, v_zjxs,
                 cur.fhzk, v_dhmx.sl, '01', '01', cur.djly, V_BJLSH, V_dhmx.DBBZ,
                 V_dhmx.XBBZ, v_sys, '', Trim(cur.cgyj),  v_bccs,
                 cur.cgyj_kh,  cur.sdhrq, v_dhmx.zl, cur.flowid,cur.flowid,'t_dh_yfsj',cur.zddh,sysdate);



              insert into t_tree
               (tbid, tbname, pid, pname, note, id, cs,czy )
              values
              (v_flowid_new, 't_fhjh', cur.flowid, 't_dh_yfsj',
               '到货分流到发货包装,校核任务号'||v_bjlsh||'箱号'||trim(p_xhao), v_dhmx.id,
               v_bccs ,p_czybh);


              Update t_dh_Yfsj
               Set sjsl = sjsl+ v_bccs
             Where flowid = cur.flowid;
            v_sysl := v_sysl - v_bccs;
            If v_sysl = 0 Then
                Exit;
            End If;


      end loop;
       v_flrqhid := v_bjlsh;
       
       if v_sysl> 0 then
              errno   := -13;
              errtext := '超过了最大分流册数!'||v_sysl;
              rollback;
          insert into T_FLRecord
           (rqh, flqx, flowid_tldjhz, flowid_dj, flowid_dhmx, id_DH_YFSJ,  czybh,id,cs)
              values
          (p_xhao, v_flqx, v_dhdj.flowid_tldjhz, v_dhdj.flowid_dj, v_dhmx.flowid_dhmx,
          v_dh_yfsj.flowid ,p_czybh ,v_dhmx.id ,p_sjsl);

              Return;
        end if ;

       /* -- 如果直发装箱时, 输入的是0, 则改变去向;
        else
            -- 如果分流记录中有'CC'去向的,
            -- 则将当前直发记录的计划分流数累加到'CC'去向中.
            -- 同时删除原去向的分流记录.
            -- 因为一条到货记录的分流数据, 对于'CC'去向的只有一条
            -- 所以就不用再取唯一主键了


             Update t_dh_yfsj
               Set active='0'
             Where flowid = p_id_dhyfsj;
        End If;*/


    end if;
      -- 2011-03-07 yangyi:
    -- 新增对播种去向的处理：
    if v_flqx = 'ZP' Then

        proc_chkrqh2(p_xhao, 't_zprwhz', errno, errtext);
        If errno <> 0 Then
            Rollback;
            Return;
        End If;

       select  min(tableid) into v_flowid  from t_rqzy where bh=p_xhao and  tbname='t_zprwhz';
       if v_flowid is not null then
         select * into v_zprwhz from T_ZPRWHZ where flowid=v_flowid;
         if v_zprwhz.dhzxid <> v_dh_yfsj.dhzxid  then
            errno := -1;
            errtext:='箱号中的任务不是同一条播撒线';
            Rollback;
            Return;
         end if;
         if v_zprwhz.zt<>'0' then
            errno := -1;
            errtext:='箱号已经开始播撒';
            Rollback;
            Return;
         end if;

       end if ;


        -- 增加库存数量(由于参与了播种，所以要同时增加库存占用数)：
        Update t_kcsl
           Set kccs = nvl(kccs, 0) + p_sjsl, zycs = nvl(zycs, 0) + p_sjsl
         Where id = v_dhmx.id And kfbh = v_dhdj.kfbh And ywbmbh = v_dhdj.ywbmbh;
        If Sql%Notfound Then
            Insert Into t_kcsl
                (id, kfbh, ywbmbh, kccs, cybh, dbbz, xbbz, zycs, change)
            Values
                (v_dhmx.id, v_dhdj.kfbh, v_dhdj.ywbmbh, p_sjsl, v_dhdj.cybh, v_dhmx.dbbz,
                 v_dhmx.xbbz, p_sjsl, '1');
        End If;

       --select min(flowid) into v_flowid from  t_zprwhz where rqh=p_xhao and  ywbmbh=v_dhdj.ywbmbh and zt='0';
       if v_flowid is null  then

           select  sq_zprwhz.Nextval into v_flowid from dual;
            insert into T_ZPRWHZ
            (flowid,zt, rqh, lxbh, kfbh, ywbmbh, yssl,sjsl  , zpz,   createdate,
            ysczybh, ysname,line,isgp,isgz,dhzxid,bz  )
            values
             (v_flowid,'0', p_xhao, 'FL', v_dhdj.kfbh, v_dhdj.ywbmbh,0,0,0,
                sysdate,  p_czybh, (select trim(name) from t_user where usr_id = p_czybh),
                v_dh_yfsj.line ,v_dh_yfsj.isgp,v_dh_yfsj.isgz,
                v_dhdj.ywbmbh||'ZP'||trim(v_dh_yfsj.line),v_dh_yfsj.ttbz);

         insert into t_rqzy
            (bh, zydate, czy, tbname, tableid, note,qx,zylx)
           values( p_xhao, sysdate, null, 't_zprwhz',
           v_flowid, '播撒线'||trim(v_dh_yfsj.line)||'播撒任务','BSRW','s' );

          /*   update t_transrecord set finished='9' where  rqh=trim(p_xhao) and finished='0';

           insert into t_transrecord
              (taskid, rqh, dest, finished,  tablepk, tablename, procname)
            values
              (SQ_TRANSRECORD.Nextval, trim(p_xhao),
              (select dest from t_line_group where GROUPNUM=trim(v_dh_yfsj.detailqx) ),
               '0',  v_flowid, 't_zprwhz', 'PROC_GOO_DHLR_FL_ZJS4');*/
       end if;


        v_flrqhid := v_flowid;
        v_sysl := p_sjsl;

        For c2 In( select f.dh,fhzk,yfsl-sjsl yfsl,djly,cgyj ,sdhrq,cgyj_kh,yxj,flowid,f.line
          ,isgp,isgz,zddh,ddcdbj,tdpch
          from t_dh_yfsj f   where f.flowid_dhmx=v_dh_yfsj.flowid_dhmx and dhzxid=v_dh_yfsj.dhzxid
          and yfsl-sjsl >0 order by yxj  )

        loop

             -- 预分数据当前记录够分：
            If v_sysl >= c2.Yfsl Then
                v_bccs := c2.Yfsl;
            Else
                v_bccs := v_sysl;
            End If;

          v_jhzxid :=v_dh_yfsj.ywbmbh||'FH';
          if c2.isgp='1' then
             v_jhzxid :=v_jhzxid||'P';
          else
            if c2.isgz='1' then
               v_jhzxid :=v_jhzxid||'G';
            else
               v_jhzxid :=v_jhzxid||'D';
            end if;
          end if ;

          v_jhzxid :=v_jhzxid||c2.zddh;
          if c2.ddcdbj ='1' then
              v_jhzxid :=v_jhzxid||'Y'||trim(c2.tdpch);
          else
             v_jhzxid :=v_jhzxid||'N';
          end if ;

          select  all_flowid.Nextval into v_flowid_new  from dual;
            Insert Into T_ZPRW
                (FLOWID_ZP, LXBH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ,   DH, ZPXYRQH,
                 YSSL, ZK, SYLX, ZJXS, YSCZYBH, LN_ZP_NO,   LN_ZP_HW,
                 sourceid, DJLY,   BZ, SL, YSPCH,
                  zl, cgyj, xszq, sdhrq, cgyj_kh,  fhyxj, pk, ddbj,ID_ZPRWHZ,zddh,isgp,isgz,jhzxid)
            Values
                (v_flowid_new, 'FL', v_dhmx.id, v_dhdj.kfbh, v_dhdj.ywbmbh,
                 v_dhdj.cybh, v_dhmx.dbbz, v_dhmx.xbbz,  c2.dh, p_xhao,
                 v_bccs, c2.Fhzk, v_dhmx.Sylx,v_Zjxs, p_czybh, c2.line,   null,
                 c2.flowid, c2.Djly,   Null, v_dhmx.sl,
                c2.cgyj, v_dhmx.Zl,
                 c2.cgyj, /*nvl(c2.Xszq, 120)*/120, c2.Sdhrq, c2.cgyj_kh,   c2.Yxj,
                 c2.flowid, ls_sj_flsg,v_flowid,c2.zddh,c2.isgp,c2.isgz,v_jhzxid);

           insert into t_tree
               (tbid, tbname, pid, pname, note, id, cs,czy )
              values
              (v_flowid_new, 't_zprw', c2.flowid, 't_dh_yfsj',
               '到货分流到播撒线'||trim(c2.line)||'任务号'||v_flowid||'箱号'||trim(p_xhao), v_dhmx.id,
               v_bccs ,p_czybh);

            Update t_dh_Yfsj
               Set sjsl = sjsl+ v_bccs
             Where flowid = c2.flowid;
            v_sysl := v_sysl - v_bccs;
            If v_sysl = 0 Then
                Exit;
            End If;



        end loop;

        -- 为保险，系统再判断一下（一般不会发生）：
        If v_sysl > 0 Then
            errno   := -300;
            errtext := '该品种本次分流数已经超过各店剩余预分数! PROC_GOO_DHLR_FL_ZJS';
            Rollback;
            Return;
        End If;

         update T_ZPRWhz set ( yssl,   zpz )=(select sum(yssl),count(distinct id)
        from t_zprw where ID_ZPRWHZ=v_flowid)
        where flowid=v_flowid;

    end if;
    -- 入库处理:
    -- 2012-09-22 modify by lv 增加样本室的分流去向
    If v_flqx = 'CC'  Then

       If p_bj_more = '0' Then
            --正常情况
            If v_dhmx.yssl < v_dhmx.bdcs + p_sjsl Then
                errno   := -149;
                errtext := '请选择多书按钮!';

                Return;
            End If;
       Elsif p_bj_more = '1' Then
            --多书情况
            If v_dhmx.yssl >v_dhmx.bdcs + p_sjsl Then
                errno   := -159;
                errtext := '已选择多书按钮,但是实际没有多书!';

                Return;
            End If;
       end if;

       Select hqlx, mc Into v_hqlx, v_hqmc From t_hqdy Where bh = v_dh_yfsj.hqbh;


        proc_chkrqh2(p_xhao, 't_pmsjhz', errno, errtext);
        If errno <> 0 Then
            Rollback;
            Return;
        End If;
  /*     select min(note) into v_zy from t_rqzy where bh=p_xhao and tbname<>'t_pmsjhz'  and rownum=1;
        if v_zy is not null then
           errno := -1;
           errtext:='箱号被占用'||v_zy;
           Rollback;
           Return;
        end if ;*/
        select min(tableid) into v_idpmsjhz  from t_rqzy where  bh=p_xhao and tbname='t_pmsjhz';
        if v_idpmsjhz is not null then
            select * into v_pmsjhz from t_pmsjhz where flowid=v_idpmsjhz;
            if v_pmsjhz.zt='1' then
              errno   := -1236;
              errtext := '箱子里的任务正在上架';
              Rollback;
              Return;
            end if ;

            if  v_pmsjhz.hqbh<> v_dh_yfsj.hqbh then
              errno   := -1236;
              errtext := '箱子里已有其它货区的品种';
              Rollback;
              Return;
            end if;

            --待开启
            if  v_pmsjhz.sjzxid<> v_dh_yfsj.dhzxid then
              errno   := -1236;
              errtext := '箱子里已有其它货区的品种';
              Rollback;
              Return;
            end if;
        end if;

       Update t_dh_Yfsj  Set sjsl = sjsl+ p_sjsl
        Where flowid = v_dh_yfsj.flowid;


     --select min(flowid) into v_idpmsjhz from t_pmsjhz  where rqh=p_xhao and ywbmbh=v_dhdj.ywbmbh and finished='0';
     if v_idpmsjhz is null then
      select  sq_pmsjhz.Nextval into v_idpmsjhz from dual;

      insert into t_pmsjhz
       (flowid, rqh, lxbh, kfbh, ywbmbh, yssl,  zpz, zmy, createczybh, createczyname,hqbh,sjzxid)
       values
       (v_idpmsjhz, p_xhao, 'DH', v_dhdj.kfbh, v_dhdj.ywbmbh, 0, 0,  0, p_czybh,
       (select trim(name) from t_user where usr_id=p_czybh),
       trim(v_dh_yfsj.hqbh),v_dh_yfsj.dhzxid );

        insert into t_rqzy
        (bh, zydate, czy, tbname, tableid, note,QX,zylx)
       values(   p_xhao, sysdate, null, 't_pmsjhz',
       v_idpmsjhz, '货区'||trim(v_dh_yfsj.hqbh) ||'上架任务','KFSJ','s' );


        ---------写上架流水线
       /*  update t_transrecord set finished='9' where  rqh=trim(p_xhao) and finished='0';

         insert into t_transrecord
            (taskid, rqh, dest, finished,  tablepk, tablename, procname)
        values
          (SQ_TRANSRECORD.Nextval, trim(p_xhao), '1004' ,
           '0',  v_idpmsjhz, 't_pmsjhz', 'PROC_GOO_DHLR_FL_ZJS4');*/
         ---------写上架流水线
     end if ;

      v_flrqhid := v_idpmsjhz;


    /*    Update t_pmsjrwb
           Set yssl =  yssl  + p_sjsl--, sjsl =  sjsl  + p_sjsl
         Where id = v_dhmx.id And tm = p_xhao And hqbh = v_dh_yfsj.detailqx;
        If Sql%Notfound Then*/
        select all_flowid.Nextval into v_flowid_new  from dual;  
        
        Insert  Into t_pmsjrwb
            (flowid_sj, id, kfbh, cybh, ywbmbh, hqbh, tm, lxbh, sjfs, yssl,   dh,
             dbbz, xbbz, sjsl,  zckf,  ysczybh, zl, hwh,
             flowid_dhfl, pk,sourceid,sourcetable,id_pmsjhz )
        Values
            (v_flowid_new, v_dhmx.id, v_dhdj.kfbh, v_dhdj.cybh, v_dhdj.ywbmbh,
            trim(v_dh_yfsj.hqbh), p_xhao, 'DH', 'ZD', P_SJSL,   v_dhdj.kfbh,
             v_dhmx.dbbz, v_dhmx.xbbz, 0,
             v_dhdj.kfbh,   p_czybh, v_dhmx.zl, v_dh_yfsj.hw,
             v_dhmx.flowid_dhmx, v_dhmx.flowid_dhmx,v_dh_yfsj.flowid,'t_dh_yfsj',v_idpmsjhz  );
        --End If;
        
        
       insert into t_tree
           (tbid, tbname, pid, pname, note, id, cs,czy )
          values
          (v_flowid_new, 't_pmsjrwb', v_dh_yfsj.flowid, 't_dh_yfsj',
           '到货分流到库房上架'||trim(v_dh_yfsj.detailqx)||',任务号'||v_idpmsjhz||',箱号'||trim(p_xhao), v_dhmx.id,
           p_sjsl ,p_czybh);
     /*     insert into t_tree
               (tbid, tbname, pid, pname, note, id, cs,czy )
          values
          (v_flowid_new, 't_zprw', c2.flowid, 't_dh_yfsj', '到货分流-上架去向', v_dhmx.id,
           v_bccs ,p_czybh);  */

         update t_pmsjhz a set yssl=yssl+p_sjsl,zmy=zmy+ p_sjsl * v_dhmx.dj,
         zpz=(select count(distinct id) from t_pmsjrwb where id_pmsjhz=a.flowid)
         where  flowid= v_idpmsjhz;

        Update t_kcsl
           Set kccs = nvl(kccs, 0) + p_sjsl
         Where id = v_dhmx.id And kfbh = v_dhdj.kfbh And ywbmbh = v_dhdj.ywbmbh;
        If Sql%Notfound Then
            Insert Into t_kcsl
                (id, kfbh, ywbmbh, kccs, cybh, dbbz, xbbz, zycs, change)
            Values
                (v_dhmx.id, v_dhdj.kfbh, v_dhdj.ywbmbh, p_sjsl, v_dhdj.cybh, v_dhmx.dbbz,
                 v_dhmx.xbbz, 0, '1');
        End If;


    End If;


      Update t_flrqh   Set CS =  CS + p_sjsl
       Where flowid_dhmx = v_dh_yfsj.flowid_dhmx And rqh = p_xhao And dhzxid = p_dhzxid;
      If Sql%Notfound Then

         insert into t_flrqh
        (rqh, flqx, flowid_tldjhz, flowid_dj, flowid_dhmx,  cs,dhzxid,FLQXMC,flowid_qx,zt_qx, czybh )
              values
        (p_xhao, v_dh_yfsj.flqx, v_dhdj.flowid_tldjhz, v_dhdj.flowid_dj,
         v_dhmx.flowid_dhmx,p_sjsl,p_dhzxid,v_dh_yfsj.flqxmc,v_flrqhid,'0',p_czybh);

      End If;

       update tmp_dhmx set bdcs=bdcs+p_sjsl where flowid_dhmx=v_dhmx.flowid_dhmx;

        insert into t_gzltimes
       (czybh,   cs, my, id_job, proc, tablename, tablepk,ywbm)
       values
       (p_czybh,    p_sjsl, p_sjsl*v_dhmx.dj, 'DHFL',
       'PROC_GOO_DHLR_FL_ZJS4', 't_dh_yfsj', v_dh_yfsj.flowid,v_dhdj.ywbmbh);

      insert into T_FLRecord
      (rqh, flqx, flowid_tldjhz, flowid_dj, flowid_dhmx, id_DH_YFSJ,  czybh,id,cs,dhzxid)
                values
       (p_xhao, v_flqx, v_dhdj.flowid_tldjhz, v_dhdj.flowid_dj, v_dhmx.flowid_dhmx,
       v_dh_yfsj.flowid ,p_czybh ,v_dhmx.id ,p_sjsl,v_dh_yfsj.dhzxid);



 -- t_dhfltask  0:未领取   1:已领取  2:正在分流   3:开始分流,已取消   4:完成,,9:分流任务异常
  update t_dhfltask set zt='2'  where flowid_tldjhz= v_dhdj.flowid_tldjhz and  zt='1'  ;
  update t_dhfltask set mac=p_mac where flowid_tldjhz= v_dhdj.flowid_tldjhz and mac is null;

    ERRNO   := 0;
    ERRTEXT := 'ok';
    Return;
Exception
    When Others Then
        ERRNO   := Sqlcode;
        ERRTEXT := 'PROC_GOO_DHLR_FL_ZJS6' || to_char(v_bj) || '-' || Sqlerrm;
        Rollback;
        Return;
End PROC_GOO_DHLR_FL_ZJS6;
CREATE OR REPLACE Procedure PROC_GOO_DHLR_YX_DJTJ_YY2
 -- 2010-08-01 YANGYI:
 -- 音像到货调拨改为整单提交了
 --
 -- 本过程由音像到货录入单据头提交按钮调用
(p_flowid_dj Number,
 p_czybh     Char,
 errno       Out Number,
 errtext     Out Varchar2) As
    v_ydpz     Number;
    v_ydsl     Number;
    v_ydmy     Number;
    v_ydsy     Number;

    v_dhdj     tmp_dhdj%Rowtype;
    v_thzq     Number;
    v_bzjmy    Number;
    v_rs       Number;
    v_kflx     t_dm.kflx%Type;
    v_khlxbh   t_dm.khlxbh%Type;
    RFDHQD_OFF t_sysset.sys_value%Type;
    v_rows Number;
   v_flowid number;
   v_bdfskxz number;

Begin


    -- 首先验证明细与汇总是否相符:
    Select * Into v_dhdj From tmp_dhdj Where flowid_dj = p_flowid_dj;

     -- 2018-06-07 add yangyi: 由于财务凭证中，传媒部门按税率区分不同科目，故增加限制:
  proc_chk_sl(v_dhdj.ywbmbh, v_dhdj.sl, errno, errtext);
  If errno<>0  Then
      Rollback;
      Return;
  End If;



    Select Count(*), Sum(yssl), Sum(yssl * dj), Sum(yssy)
      Into v_ydpz, v_ydsl, v_ydmy, v_ydsy
      From tmp_dhmx
     Where flowid_dj = p_flowid_dj And nvl(yssl, 0) > 0;

    -- 2018-11-07 yangyi: 增加参数设置：报订方式是否允许前台设置 0=不允许，1=允许
    select nvl(min(sys_value),0) into v_bdfskxz
      from t_sysset@c_link_wl_sl where sys_item='BDFSKXZ' AND sys_ywbmbh=v_dhdj.ywbmbh;

    if v_bdfskxz=0 and v_dhdj.zfzd<>'0' then
        errno   := -1;
        errtext := '当前部门已设置为只能按常规方式发货! 因此当前单据不能设置为绿通或直转!t_sysset@c_link_wl_sl.sys_item=BDFSKXZ';
        rollback;
        Return;
    end if;

   --2011-11-01 modify by lv 先根据业务部门取出第三方标记。t_dm表中kflx=‘3F’ 或者 khlxbh=‘1’的为第三方物流货主部门
    Select kflx, nvl(khlxbh,0) Into v_kflx, v_khlxbh From t_dm Where dh = v_dhdj.ywbmbh;
    If Trim(v_khlxbh) = '1' Or Trim(v_kflx) = '3F' Then
        If v_ydpz <> v_dhdj.ydpz Or v_ydsl <> v_dhdj.ydcs  Or v_ydmy <> v_dhdj.ydmy Then
            errno   := -1;
            errtext := '此单据的明细与汇总不符!';
            Return;
        End If;
    Else
        If v_ydpz <> v_dhdj.ydpz Or v_ydsl <> v_dhdj.ydcs Or   v_ydmy <> v_dhdj.ydmy or
           v_ydsy <> v_dhdj.ydsy Then
            errno   := -1;
            errtext := '此单据的明细与汇总不符!';
            Return;
        End If;
    End If;


    -------------------------------------------------------------------

    --2012-01-10 modify by lv 读取RF到货清点开关
    Select nvl(Max(sys_value), '0')
      Into RFDHQD_OFF
      From t_sysset
     Where sys_item = 'RFDHQD' And sys_ywbmbh = v_dhdj.ywbmbh;

    Select nvl(Min(sys_value), 900) Into v_bzjmy From t_sysset Where sys_item = 'GPBJBZ';


    Insert Into t_gzl
        (czybh, czlx, jls, cs, js, my,TABLE_NAME,FLOWID_TABLE,YWBMBH,PROC_NAME)
        Select lrczybh, 'DHLR', Count(*), Sum(djshsl),
               Sum(decode(dbbz, 0.1, round(djshsl * dj / v_bzjmy, 2),
                           round(djshsl / dbbz / xbbz, 2))), Sum(djshsl * dj),'tmp_dhdj',V_DHDJ.flowid_tldjhz,V_DHDJ.Ywbmbh,'PROC_GOO_DHLR_YX_DJTJ_YY2'
          From tmp_dhmx
         Where flowid_dj = p_flowid_dj
         Group By lrczybh;
         --BY ZYW
   insert into t_gzltimes
   (czybh,   cs, my, id_job, proc, tablename, tablepk,YWBM)
   Select lrczybh,  Sum(djshsl), Sum(djshsl * dj), 'WHYPDHLR', 'PROC_GOO_DHLR_YX_DJTJ_YY2', 'tmp_dhmx',V_DHDJ.flowid_tldjhz,V_DHDJ.Ywbmbh
          From tmp_dhmx
         Where flowid_dj = p_flowid_dj
         Group By lrczybh;
    -- 写备份表,并删除临时表数据:
    -- 2010-10-15 modify by yangyi:
    -- 为了音像商流也能利用到货审批功能来关联依据
    -- 暂不删除tmp_dhmx/tmp_dhdj了, 而是将tmp_dhdj.oklrbj='1'
    -- 为到货录入时能屏蔽掉这些数据.
    -- tmp_dhdj/tmp_dhmx改在商流到货审批时再删除了
    Update tmp_dhdj
       Set oklrbj = '1', oklrrq = Sysdate, sbbj = '1', lrqrzyczybh = p_czybh
     Where flowid_dj = p_flowid_dj;
    -- 2011-11-22 add by yangyi:
    -- 为便于到货审批，替换截止退货日期、销售周期、发货缓急、是否新品:
    -- 因为商流是根据实际收货数来进行主配的
    -- 而商流程序是根据yssl来显示的，所以，在提交商流审批时
    -- 需要将实际收货数量替换到yssl中，在替换前要将yssl备份到bdcs字段中
    -- 后期接收商流审批结果时，再将yssl从bdcs中折腾回来
    --2012-02-29 modify by lv 增加ydhcs=djshsl，物流接收商流审批数据时自动将djshsl备份到ydhcs
    Update tmp_dhmx
       Set bdcs = yssl, yssl = djshsl, ydhcs = djshsl, jzjtrq = Sysdate + 90, xszq = 120,
           FHFS = 'D',
           MFJCBJ = decode(nvl((Select Count(*)
                                  From t_kcsm
                                 Where isbn = tmp_dhmx.isbn And sm = tmp_dhmx.sm And
                                       dj = tmp_dhmx.dj And rownum = 1), 0), 0, '1', '0')
     Where flowid_dj = P_flowid_dj;
    -- 2010-05-30 add by yangyi:
    -- 为便于商流操作, 置默认截止进退日期和销售周期, 在审批时可手工修改
    -- 2012-02-02 yangyi:
    -- 改为默认进退截止日期为90天
    Update tmp_dhmx
       Set (jzjtrq, xszq) = (Select nvl(Min(jtqx), 90 /*180*/) + Sysdate,
                                     nvl(Min(xszq), 120)
                                From t_flszb@c_link_wl_sl
                               Where fl = tmp_dhmx.fl And ywbmbh = V_DHDJ.YWBMBH)
     Where flowid_dj = P_flowid_dj;


    --2014-01-13 modify by lv 增加推送
    PROC_GOO_YH_YX_DEAL(p_flowid_dj, errno, errtext);
    If errno <> 0 Then
        --errno   := -122;
        --errtext := '推送文化用品电子单失败！';
        Rollback;
        Return;
    End If;

     select count(*) into v_rows from t_tldjhz where flowid_tldjhz=v_dhdj.flowid_tldjhz and djsl=yldjsl;
     if v_rows >0 then
        update t_wl_monitor set zt='录入提交' ,lrtjczy=p_czybh ,lrtjrq=sysdate ,
          lrtjczynm=(select trim(name) from t_user where usr_id=p_czybh) where flowid=v_dhdj.flowid_tldjhz;
     end if;

    errno   := 0;
    errtext := 'OK';
    Return;
Exception
    When Others Then
        errno   := -1;
        errtext := 'PROC_GOO_DHLR_YX_DJTJ_YY2' || Sqlerrm;
        Rollback; -- 2014-04-18 add by yangyi
        Return;
End PROC_GOO_DHLR_YX_DJTJ_YY2;

CREATE OR REPLACE Procedure PROC_KFZYDD_DSFP_XTW
-----------------$active$
    --本过程是订数分配，取立体库房或者t_kcsl取货位，
    --将货位、货区、包装标准、重量等数据写到t_pf_temp，
    --并对t_ltkf或t_kcsl加占用，并对不满足的品种插入到
    --不满足单据表中以返回给商流。在调度时，首先调用本过程，
    --当返回值大于0时，要根据提示是否提交或者继续下一步操作，
    --返回值大于0的，都是因为有的品种不能满足，所以要给出提示
    --是否继续进行调度。执行完本过程后，调用PROC_KFZYDD_XTW进行实际的调度
    --首先读取立库数据，然后再读取存储库
    --对于需要手工拣选的，不能读取立库库存
(v_czybh Char,
 -- V_KFBH char,
 --V_KFLX char,
 V_YWBMBH1 Char,
 V_lxbh    Char,
 v_flag    Char, -- bdbj
 v_ddfs    Char, --  AP = 按店调度   AD =  按单调度
 errno     Out Number,
 errtext   Out Char)
--订数分配
 As
    errno1             Number;
    v_pf_temp          t_pf_temp%Rowtype;
    v_ltkf             Number(10);
    v_pmsjrwb          Number(10);
    s_error_id         Char(1000); --对于不满足库存的记录下id
    p_djsl             Number(10);
    p_cfbj             Char(1); --拆分标记
    p_hqbh             Char(4);
    p_bccs             Number(10);
    p_flowid_fhrwb_new Number(10);
    d_zl               Number(10, 2);
    p_hw               Char(20);
    p_kcsl             t_kcsl%Rowtype;
    v_bj               Number(4);
  --  p_jllx             Number(2);
    p_flowid_ys        Number(10);
    V_DHFL             Number(10);
  --  p_hqlx             Char(2);
  --  p_hqnm             Char(20);
    v_kfbh             Char(6);
    v_kflx             Char(2);
    V_YWBMBH           Char(6);
    vv_rows            Number(10);
    v_rows             Number(10);
    v_rqh              t_pmsjrwb.tm%Type;
    v_bz               t_wl_bmzdj.bz%Type;
    tmpVar             Number;
  --  v_errtext          Varchar2(4000);
   v_zddhbf char(6);
   v_zddh  char(6);
Begin

    s_error_id := '下列品种库存不能满足需求，是否继续下达?';
    errno1     := 0;

     DELETE FROM t_pf_temp
            WHERE trim(pfczybh) = v_czybh;

      DELETE FROM t_pf_temp_back
            WHERE trim(pfczybh) = v_czybh;

    If Trim(v_lxbh) = 'FH' Then
        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, FHFS, PFCZYBH, FYFSH, DJ, cgyj, sdhrq, xszq, QSCLFS, fhyxj,
             cgyj_kh, thl, PHBZ, Xz,  rq, pk,bdbj,zddh,ysdjh1)
            Select a.FLOWID_FHRW, a.YSDJH, a.DH, a.ID, a.KFBH, a.YWBMBH, a.CYBH, nvl(a.DBBZ,1),
                   nvl(a.XBBZ,1), a.DJSL, a.FHZK, a.SYLX, a.ZJXS, a.DJLY, a.QSTS, a.FHFS, V_czybh,
                   a.FYFSH, a.DJ, a.cgyj, a.sdhrq, a.xszq, a.qsclfs, a.fhyxj, a.cgyj_kh,
                   a.thl, a.PHBZ, 0,
                     rq, a.FLOWID_FHRW,v_flag,zddh,ysdjh1
              From T_FHRWB a, t_kcsm b
             Where a.id = b.id And Trim(a.ddczybh) = Trim(v_czybh);
    End if;

    if Trim(v_lxbh) = 'ST' Then
        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, PHBZ, FHFS, PFCZYBH, FYFSH, DJ, SDHRQ, cgyj, xz,   rq, pk,fhyxj,zddh,bdbj)
            Select flowid, ywpch, HYBH, T_THJH.ID, KFBH, YWBMBH, CYBH, nvl(DBBZ,1),
                   nvl(XBBZ,1), THCS, THZK, T_THJH.SYLX, T_THJH.ZJXS, '2', 0, T_THJH.BZ, ' ',
                   v_czybh, '01', T_KCSM.DJ, jhrq, cgyj, 0,
                 jhrq, T_THJH.FLOWID,yxj,HYBH,'0'
              From T_THJH, T_KCSM
             Where T_THJH.ID = T_KCSM.ID And Trim(ddczybh) = Trim(v_czybh) And
                   T_THJH.THCS > 0;
    end if;

    if Trim(v_lxbh) = 'ZY' Then
    --    select all_flowid.Nextval into p_flowid_fhrwb_new from dual;
         Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, PHBZ, FHFS, PFCZYBH, FYFSH, DJ, ZRCYBH, cgyj, xz, rq, pk,zddh,bdbj)
            Select a.flowid, a.jhpch, a.drkfbh, a.ID, a.dcKFBH, a.YWBMBH, a.zcCY,
                   4, 10, a.zycs, b.pjzk, a.sylx, a.zjxs, '1', 0, '', '01', ddczybh, '01',
                   0, a.ZRCY, a.cgyj, 0, jhrq, p_flowid_fhrwb_new,drkfbh,'0'
              From T_zyjh a, t_kcsm_ywbm b
             Where a.id = b.id And Trim(a.ddczybh) = Trim(v_czybh) And a.zycs > 0;
    end if;

    if Trim(v_lxbh) = 'BF' Then
      --  select  all_flowid.Nextval into p_flowid_fhrwb_new from dual;

/*        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH, DBBZ, XBBZ, DJSL, FHZK, SYLX,
             ZJXS, DJLY, QSTS, PHBZ, FHFS, PFCZYBH, FYFSH, DJ, ZRCYBH, cgyj, xz, rq, pk)
            Select a.flowid, A.ywpch, A.kfbh, A.ID, A.KFBH, A.YWBMBH, A.cybh,
                   nvl(B.DBBZ,1), nvl(B.XBBZ,1), A.bfcs, A.bfzk, B.sylx, DECODE(B.SYLX, '1', 100, B.DJ),
                   '1', 0, '', '01', A.ddczybh, '01', B.DJ, A.cybh, A.cgyj, 0, bfrq,
                   p_flowid_fhrwb_new
              From T_BFJHMX A, T_KCSM B
             Where Trim(ddczybh) = Trim(v_czybh) And A.ID = B.ID And BFCS > 0;
*/
        -- 2015-12-30 YANGYI:
        Insert Into T_PF_TEMP
            (FLOWID_FHRW, YSDJH, DH, ID, KFBH, YWBMBH, CYBH,
             DBBZ, XBBZ, DJSL, FHZK, SYLX, ZJXS,
             DJLY, QSTS, PHBZ, FHFS, PFCZYBH, FYFSH, DJ, ZRCYBH, cgyj, xz, rq, pk,zddh,bdbj)
            Select a.flowid, A.ywpch, A.kfbh, A.ID, A.KFBH, A.YWBMBH, A.cybh,
                   nvl(B.DBBZ,1), nvl(B.XBBZ,1), A.bfcs, A.bfzk, A.sylx, A.ZJXS,
                   '1', 0, '', '01', A.ddczybh, '01', B.DJ, A.cybh, A.cgyj, 0, bfrq, a.flowid, A.kfbh,'0'
              From t_bfjhmx a, t_kcsm b
             Where a.id = b.id And Trim(ddczybh) = Trim(v_czybh) And A.BFCS > 0;

    End If;


    For c1 In (Select * From t_pf_temp Where pfczybh = v_czybh Order By YWBMBH, ID)
    Loop
        v_bj := 999;
        Select * Into v_pf_temp From t_pf_temp
         Where t_pf_temp.flowid_fhrw = c1.flowid_fhrw;
        V_YWBMBH := C1.YWBMBH;
        v_kfbh   := c1.kfbh;
        v_bj     := 998;
        Select kflx Into v_kflx From t_dm Where dh = v_kfbh;
        p_flowid_ys := c1.flowid_fhrw;
        -- 2010-06-30 add by yangyi:
        -- 增加判断: 如果算过了就不再计算了
        -- 因为前台显示不满足记录时, 是按id+ywbmbh sum的
        -- 待上架的和待分流的只求一次就可以了
        Select Count(*) Into v_rows
          From t_pf_temp_QS_XTW
         Where id = c1.id And ywbmbh = v_ywbmbh And kfbh = v_kfbh;
        If v_rows = 0 Then
            Select nvl(Sum(yssl), 0) Into v_pmsjrwb
              From t_pmsjrwb
             Where id = c1.id And ywbmbh = v_ywbmbh And kfbh = v_kfbh;
            Select NVL(Sum(JHFLCS), 0) Into V_DHFL
              From T_DHFL1
             Where ID = C1.ID And YWBMBH = V_YWBMBH And KFBH = V_KFBH;
        Else
            v_pmsjrwb := 0;
            V_DHFL    := 0;
        End If;
        If v_kflx = 'LK' Then


            --如果是立库
            Select nvl(Sum(kccs - nvl(zycs, 0)), 0) Into v_ltkf
              From t_ltkf l,   t_hqdy q
             Where l.hqbh = q.bh and id = c1.id And l.kfbh = v_kfbh And l.ywbmbh = v_ywbmbh And l.cybh = c1.cybh
              and hqlx not in (decode(Trim(v_lxbh), 'FH', 'DT', 'ST','LK','x')  ,'PS' );
                  -- And Exists (Select 1 From t_dbfhw_clj151229 Where hw=t_ltkf.hw And ywbmbh=v_ywbmbh);

            p_djsl := c1.djsl;

            If p_djsl > 0 And V_LTKF > 0 Then

---------------------------------------------------------------------------------------------
-- 2015-12-31 yangyi:
-- 下边游标中屏蔽的条件是用于特殊的报废调度的
-- 其主要目的是限制t_ltkf中参与调度的货位
--
/*select id, l.hw, l.kfbh, l.dbbz, l.xbbz, l.ywbmbh, l.cybh, kccs, zycs, zl from t_ltkf l,t_hwdy w,t_hqdy q
      where l.hw=w.hw and w.hqbh=q.bh
      and  l.id = c1.id And l.kfbh = v_kfbh And l.cybh = c1.cybh And
       l.ywbmbh = v_ywbmbh And (kccs - nvl(zycs, 0)) > 0
      and hqlx not in  (decode(Trim(v_lxbh),'FH','DT','xx'))
      order by  hqyxj desc,(kccs - nvl(zycs, 0))  Desc*/
                For c2 In ( select id, l.hw, l.kfbh, l.dbbz, l.xbbz, l.ywbmbh, l.cybh, kccs, zycs, zl,jllx,q.bh
                      from t_ltkf l,   t_hqdy q
                     where  l.hqbh = q.bh
                       and l.id = c1.id
                       And l.kfbh = v_kfbh
                       And l.cybh = c1.cybh
                       And l.ywbmbh = v_ywbmbh
                       And (kccs - nvl(zycs, 0)) > 0
                       and hqlx not in (decode(Trim(v_lxbh), 'FH', 'DT', 'ST','LK','x')  ,'PS' )

                     order by hqyxj desc, (kccs - nvl(zycs, 0)) Desc for update )
--------------------------------------------------------------------------------------------------
                Loop
                    If c2.zycs Is Null Then
                        c2.zycs := 0;
                    End If;



                    If p_djsl <= (c2.kccs - c2.zycs) Then
                        p_bccs := p_djsl;
                        p_djsl := 0;
                        p_cfbj := '0';
                    Else
                        p_bccs := (c2.kccs - c2.zycs);
                        p_djsl := p_djsl - p_bccs;
                        p_cfbj := '1';
                    End If;
                    --2013-01-10 modify lv 根据包装标准重新计算异形情况
                    Update t_pf_temp
                       Set hw = c2.hw, /*dbbz = c2.dbbz, xbbz = c2.xbbz,*/ hqbh = c2.bh,
                           djsl = p_bccs, zl = c2.zl, jllx = c2.jllx, xz = 1 /*, hqlx = p_hqnm,*/
                           /*yx = (Case When(c2.dbbz * c2.xbbz) >= 1 Then '0' Else '1' End)*/
                     Where flowid_fhrw = c1.flowid_fhrw;

                    -- 2010-07-15 yangyi:
                    -- 注意: 高架库加占用时, 不需要加dbbz,xbbz,zl条件
                    --       因为它可能随时在变化, 否则, 有可能update不着了

                    Update t_ltkf
                       Set zycs = nvl(zycs, 0) + p_bccs
                     Where id = c1.id And kfbh = c2.kfbh And cybh = c1.cybh And
                           ywbmbh = c2.ywbmbh /*And dbbz = c2.dbbz And xbbz = c2.xbbz And
                           zl = c2.zl*/ And hw = c2.hw;

                    Update t_kcsl
                       Set zycs = nvl(zycs, 0) + p_bccs
                     Where id = c1.id And kfbh = C2.kfbh And ywbmbh = C2.ywbmbh And
                           cybh = C2.cybh;
                    If p_cfbj = '1' Then
                        Select all_flowid.Nextval Into p_flowid_fhrwb_new From dual;
                        Insert Into t_pf_temp
                            (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz,
                             djsl, fhzk, sylx, zjxs, djly, qsts, phbz, fyfsh, fhfs,
                             pfczybh, dj, zrcybh, cgyj, sdhrq, zl, FHYXJ, XSZQ, cgyj_kh,
                             thl, jllx, QSCLFS, xz, yx, rq, pk,bdbj,zddh)
                            Select p_flowid_fhrwb_new, ysdjh, dh, id, kfbh, ywbmbh, cybh,
                                   dbbz, xbbz, p_djsl, fhzk, sylx, zjxs, djly, qsts, phbz,
                                   fyfsh, fhfs, v_czybh, dj, zrcybh, cgyj, sdhrq, zl,
                                   FHYXJ, XSZQ, cgyj_kh, thl, jllx, QSCLFS, 0, yx, rq, pk,v_flag,zddh
                              From t_pf_temp
                             Where flowid_fhrw = c1.flowid_fhrw;
                        c1.flowid_fhrw := p_flowid_fhrwb_new;
                    End If;
                    If p_djsl = 0 Then
                        Exit;
                    End If;
                End Loop;
            End If;
            If P_DJSL > 0 Then
                If v_ddfs = 'AD' Then
                    Select Count(*)
                      Into vv_rows
                      From t_pmsjrwb
                     Where id = v_pf_temp.id And kfbh = v_pf_temp.kfbh And
                           ywbmbh = v_pf_temp.ywbmbh And cybh = v_pf_temp.cybh;
                    -- 2012-05-19 modify by lv 对于社退任务不再判断未上架任务
                    If vv_rows > 0 And Trim(v_lxbh) <> 'ST' Then
                        Select tm
                          Into v_rqh
                          From t_pmsjrwb
                         Where id = v_pf_temp.id And kfbh = v_pf_temp.kfbh And
                               ywbmbh = v_pf_temp.ywbmbh And cybh = v_pf_temp.cybh And
                               rownum = 1;
                        errno   := -1444;
                        errtext := '该单据中有的品种还没有上架，本次不能进行调度.品种id=' || Trim(v_pf_temp.id) ||
                                   ',容器:' || v_rqh;
                        Rollback;
                        Return;
                    End If;
                    --按单调度,退货等都是按单调度
                    If Trim(C1.QSCLFS) = '2' Or Trim(C1.QSCLFS) = '3' Then
                        errtext := '不满足单据，库存不足不能下达';
                        ERRNO   := -1333;
                        Rollback;
                        Return;
                    Else
                        If vv_rows > 0 Then
                            v_bz := '调度时还未上架';
                        Else
                            v_bz := '调度时库存不足';
                        End If;
                        --2011-11-07 modify by lv 将pfczybh插入到rkbh中
                        --2012-04-14 modify by lv 修改
                        Insert Into t_wl_bmzdj
                            (ysdjh, ywbmbh, dh, ckbh, rkbh, id, cs, sjkcs, qsclfs, lx,
                             FLOWID, bz, receflag, sendbmbh, senddate, recebmbh, zk,
                             djbh_sl)
                            Select cgyj, ywbmbh, dh, v_kfbh, pfczybh, id, p_djsl, 0,
                                   Trim(qsclfs), v_lxbh, flowid_fhrw, v_bz, '0', cybh,
                                   Sysdate, v_ywbmbh, fhzk, ysdjh
                              From t_pf_temp
                             Where flowid_fhrw = c1.flowid_fhrw;
                    End If;
                Else
                    --按店调度
                    Insert Into t_pf_temp_QS_XTW
                        (flowid_fhrw, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz, rq,
                         djsl, fhzk, sylx, zjxs, djly, qsts, phbz, fyfsh, fhfs, pfczybh,
                         dj, zrcybh, cgyj, sdhrq, zl, FHYXJ, XSZQ, cgyj_kh, thl, jllx,
                         QSCLFS, xz, PMSJRWB, DHFL, LTKF, pk,bdbj,zddh,ysdjh1)
                        Select --p_flowid_fhrwb_new
                         all_flowid.Nextval, ysdjh, dh, id, kfbh, ywbmbh, cybh, dbbz, xbbz,
                         rq, p_djsl, fhzk, sylx, zjxs, djly, qsts, phbz, fyfsh, fhfs,
                         v_czybh, dj, zrcybh, cgyj, sdhrq, zl, FHYXJ, XSZQ, cgyj_kh, thl,
                         jllx, QSCLFS, 0, v_pmsjrwb, V_DHFL, v_ltkf, pk,v_flag,zddh,ysdjh1
                          From t_pf_temp
                         Where flowid_fhrw = c1.flowid_fhrw;
                End If;
            End If;
        Else
            p_djsl := c1.djsl;
            p_bccs := 0;
            --如果出库是样本室
            Select zl Into d_zl From t_kcsm Where id = c1.id;
            Select Count(*)
              Into tmpVar
              From t_kcsl
             Where id = c1.id And kfbh = v_kfbh And ywbmbh = v_ywbmbh;
            If tmpVar > 0 Then
                Select *
                  Into p_kcsl
                  From t_kcsl
                 Where id = c1.id And kfbh = v_kfbh And ywbmbh = v_ywbmbh;
                If p_kcsl.zycs Is Null Then
                    p_kcsl.zycs := 0;
                End If;
                If P_djsl > (p_kcsl.kccs - p_kcsl.zycs) Then
                    p_bccs := p_kcsl.kccs - p_kcsl.zycs;
                    P_djsl := P_djsl - p_bccs;
                Else
                    p_bccs := P_djsl;
                    P_djsl := 0;
                End If;
                Select nvl(Min(Trim(hqbh)), '001')
                  Into p_hqbh
                  From t_hwdy
                 Where hw = p_kcsl.hw And kfbh = p_kcsl.kfbh;
                Update t_pf_temp
                   Set hw = p_kcsl.hw, zl = d_zl, djsl = p_bccs, xz = 1, hqbh = p_hqbh
                 Where flowid_fhrw = c1.flowid_fhrw;
                Update t_kcsl
                   Set zycs = nvl(zycs, 0) + p_bccs
                 Where id = p_kcsl.id And kfbh = p_kcsl.kfbh And ywbmbh = p_kcsl.ywbmbh And
                       cybh = p_kcsl.cybh;
            Else
                Update t_pf_temp
                   Set hw = '', zl = d_zl, djsl = p_bccs, xz = 1, hqbh = ''
                 Where flowid_fhrw = c1.flowid_fhrw;
            End If;
            If P_djsl > 0 Then
                --2011-11-07 modify by lv 将pfczybh插入到rkbh中
                --2012-04-14 modify by lv 修改
                Insert Into t_wl_bmzdj
                    (ysdjh, ywbmbh, dh, ckbh, rkbh, id, cs, sjkcs, qsclfs, lx, FLOWID, bz,
                     receflag, sendbmbh, senddate, recebmbh, zk, djbh_sl)
                    Select cgyj, ywbmbh, dh, v_kfbh, pfczybh, id, p_djsl, 0, Trim(qsclfs),
                           v_lxbh, flowid_fhrw, '调度时库存不足', '0', cybh, Sysdate, v_ywbmbh,
                           fhzk, ysdjh
                      From t_pf_temp
                     Where flowid_fhrw = c1.flowid_fhrw;
            End If;
            If p_bccs = 0 Then
                Delete From t_pf_temp Where flowid_fhrw = c1.flowid_fhrw;
            End If;
        End If;
    End Loop;

    if V_lxbh ='FH' then
       for cur in (Select dh From t_pf_temp Where pfczybh = v_czybh and YWBMBH='000001' group by dh) loop
           Select Count(*)   Into v_rows  From  t_guizu_fl
            Where dh =cur.dh And  enable = '1';
            if v_rows =0 then
             continue;
            end if;
           select min(gzbh) into v_zddhbf  from t_guizu_fl  where  dh=cur.dh;
           for cur2 in (select flowid_fhrw,s.fl from  t_pf_temp p,t_kcsm  s Where pfczybh = v_czybh and YWBMBH='000001'
               and dh=cur.dh and p.id=s.id) loop


                Select min(gzbh) into v_zddh
                 From  t_guizu_fl c
                Where flbh=cur2.fl And dh = cur.dh;
                if v_zddh is null then
                   update t_pf_temp set zddh=v_zddhbf where flowid_fhrw=cur2.flowid_fhrw;
                else
                  update t_pf_temp set zddh=v_zddh where flowid_fhrw=cur2.flowid_fhrw;
                end if ;


           end loop;
       end loop;
    end if;

    Insert Into t_pf_temp_lvb Select * From t_pf_temp Where pfczybh = v_czybh ;
  --  Insert Into t_pf_temp_qs_xtw_lvb Select * From t_pf_temp_qs_xtw;
    Delete From t_pf_temp Where pfczybh = v_czybh And hqbh Is Null And Exists
     (Select * From t_dm Where dh = t_pf_temp.kfbh And kflx = 'LK');
  --  Delete From t_pf_temp_back Where pfczybh = v_czybh;
  --  Insert Into t_pf_temp_back (pfczybh, id, cs)
   -- Select v_czybh, id, Sum(djsl) From t_pf_temp Where pfczybh = v_czybh Group By id;
    --Insert Into t_pf_temp_xtw Select * From t_pf_temp;
    If errno1 = 0 Then
        errno   := 0;
        errtext := 'OK';
    Else
        errno   := errno1;
        errtext := s_error_id;
    End If;
Exception
    When Others Then
        ERRNO   := Sqlcode;
        ERRTEXT := to_char(v_bj) || p_hw || Sqlerrm;
      --  v_errtext := to_char(v_bj) || p_hw || Sqlerrm;
        Rollback;
End PROC_KFZYDD_DSFP_XTW;
create or replace procedure RF_ADDTLDJHZ2(
p_djr char,
p_ghdw char,
p_ssjs number,
p_djlx char,
p_ywbmbh char,
p_djsl number,
p_id_wlfh char,
p_hw      char,
p_wlgs char,
p_wldh char,
p_stop char,
p_flowid out varchar2,
ERRNO   Out Number,
ERRTEXT Out varchar2
)
as

 v_flowid number(10);
begin

  select all_flowid.nextval into v_flowid from dual ;



  insert into t_wlsh (shrq,ysjs,ssjs, dh ,
  id,djlx,ywbmbh, shczy  ,djsl, zt,id_wlfh,cbtask,shhw,id_wlgs,wldh)
 values(sysdate,p_ssjs,p_ssjs, p_ghdw,
  v_flowid, p_djlx,p_ywbmbh,p_djr, p_djsl, '0',p_id_wlfh,'0',p_hw,p_wlgs,p_wldh);

  insert into t_tldjhz (tlrq,ysjs,ssjs, dh ,
      flowid_tldjhz,djlx,ywbmbh,cybh,TLLRYBH  ,djsl, shbj,id_wlfh ,xchw,kl_flag,yh)
    select shrq,ysjs,ssjs, dh ,
    id,djlx,ywbmbh,'3001' ,shczy  ,djsl, '2',id_wlfh, shhw,kl_flag,wldh
     from  t_wlsh where id=v_flowid;

 if p_djlx ='DH' then

  insert into t_tldjhz_state (flowid_tldjhz,insertdate,js)values(v_flowid,sysdate,p_ssjs);

 end if;
 
  if p_stop ='1' then
       update t_wlfh set zt='4' where id=p_id_wlfh;
  else
       update t_wlfh set zt='3' where id=p_id_wlfh;
  end if;
     
  p_flowid:=v_flowid;

exception
  when others then
    ERRNO:=-1;
    ERRTEXT:='RF_ADDTLDJHZ2'||sqlerrm;
    rollback;
end RF_ADDTLDJHZ2;
CREATE OR REPLACE Procedure PROC_SX_JSDHSJ_LSTDCL2
-- 2011-11-18 升级
    -- 2010-07-28 add by yangyi:
    -- 山西，根据商流的审批结果, 生成绿色通道的相关数据
    --
    -- 直发转单的数据, 在tmp_dhdj中体现为dh不为空,
    -- tmp_dhdj.ZFZD,  0=正常到货，1=直发转单，2=绿色通道
    -- 由于在订货时不一定能够确定是否为直发转单
    -- 直发转单到货在上报商流审批时, 只维护进货折扣,发货折扣,和分类等
    --
    -- 在物流上报商流到货审批数据时, 自动将已自动匹配采购依据标记(lsddh)置为1
    --
    -- 绿色通道和直发转单不影响批销底折(除非是新增品种).
    -- 具体处理方法:
    -- 生成到货数据, t_dhdj/t_dhls_jx/t_crkls
    -- 生成发货数据, t_agv_rw_xt_bak(单据来源=ZF,JXFD=SG)/t_dfbj/t_pxmx/t_crkls/t_dpls
    --               相当于手工拣选已回告的状态
    --
    -- 由于商流在接收物流上报的发货数据时, 必须要在t_dpls中找到才能接收
    -- 所以需要补写一下t_dpls
    --
    -- 在录入单据头时, 需要选择: 普通到货/绿色通道/直发转单
    -- 如果是绿色通道, 必须输入店号,包装人和容器号
    -- 如果是直发转单, 必须输入店号
    -- 2013-04-25 yangyi:
    -- 若为馆配部门且到货的折价类型与订货的折价类型相同，且为折扣方式，且原订单有发货折扣
    -- 则以原订单的发货折扣为准
(p_flowid_dj In Number,
 errno       Out Number,
 errtext     Out Char) As
    v_dhdj      tmp_dhdj%Rowtype;
    v_fjw       Char(3);
    v_id1       Char(21);
    v_id        Char(18);
    v_dhpch     Char(12);
    v_bjlsh     Char(12);
    v_sys       Number;
    v_fhsy      Number;
    v_fhzsy     Number;
    v_zzl       Number;
    v_zjxs      Number;
    v_zpz       Number;
    v_zcs       Number;
    v_zmy       Number;
    v_zsy       Number;
    v_qssl      Number;
    v_qsmy      Number;
    v_qssy      Number;
    v_ywybh     Char(4);
    v_flowid    Number;
    v_rows      Number;
    v_rs        Number;
    v_kcsm_sylx Char(1);
    v_fh_zj     Number;
    v_fh_zjxs   Number;
    v_zb        Char(30);
    v_fh_zj_new Number;
    row_kcsm    t_kcsm%Rowtype;
    v_ltkf      t_dm.dh%Type;
    v_pxcs      Number;
    v_tldjhz  number;
    v_wlsh t_wlsh%Rowtype;
    v_isgz char(1);
    v_isgp char(1);
    v_zddh char(6);
    v_jhzxid varchar2(30);
    v_cbname varchar2(10);
Begin
    v_zzl   := 0;
    v_fhzsy := 0;
    Select * Into v_dhdj From tmp_dhdj Where flowid_dj = p_flowid_dj;
    Select dh
      Into v_ltkf
      From t_dm
     Where lxbh = '2' And cybh = v_dhdj.cybh And kflx = 'LK' And rownum = 1;
    Update tmp_dhdj
       Set oklrrq = Sysdate
     Where flowid_dj = p_flowid_dj And oklrrq Is Null;
    Select ywybh
      Into v_ywybh
      From t_ghdw_ywbm
     Where ghdwh = v_dhdj.ghdwh And ywbmbh = v_dhdj.ywbmbh;
    -- 生成到货调拨批次号:
    If v_dhpch Is Null Then
        dlgetlsh(v_dhdj.cybh, v_dhdj.kfbh, 'DH', v_dhpch);
        If v_dhpch Is Null Then
            errno   := -1;
            errtext := 'PROC_SX_ZFZDCL 生成到货批次号错误!';
            Rollback;
            Return;
        End If;
    End If;
    -- 生成包件号:
  /*  proc_get_bjlsh('FH', v_dhdj.ywbmbh, v_bjlsh, errno, errtext);
    If errno <> 0 Then
        errtext := 'PROC_SX_ZFZDCL 取包件流水号失败' || errtext;
        Rollback;
        Return;
    End If;*/
    select sq_jhtask.nextval into v_bjlsh from dual;

    For c1 In (Select * From tmp_dhmx Where flowid_dj = p_flowid_dj)
    Loop
        -- 2013-07-11 yangyi:
        -- 为避免物流与商流生成的ID不一致，对于非第三方的到货，直接从tmp_dhmx_kcsm@c_link_wl_sl表中取得ID
        -- 正常到货的已经这样处理了，这里是因为漏改了，今天测试时才发现的
        -- 因为有可能同一【书号+书名+定价】的存在多个ID
        -- 物流不一定与商流取的完全一样。
        -- 一般发生在：一开始录入时，根据ISBN+SM+DJ生成了ID
        -- 后来商流又修改了书号或书名，使得t_kcsm中，会出现ISBN+SM+DJ相同而ID不同的情况
        -- 如果物流自主生成ID，则有可能会与商流取得的ID不一致！！！！
        -- select count(*) into v_rows from t_dm where dh=v_dhdj.ywbmbh And lxbh='1' and kflx='TS';
        -- 2015-06-03 YANGYI: 将kflx=’TS' 改为 kflx<>'3F', 目的是尽量从商流取得ID
        select count(*) into v_rows from t_dm where dh=v_dhdj.ywbmbh And lxbh='1' and kflx<>'3F'; -- ='TS';
        If v_rows>0 Then
            Select id
              Into v_id
              From tmp_dhmx_kcsm@c_link_wl_sl
             Where flowid_dhmx = c1.flowid_dhmx;
        Else
            --生成ID及书目信息:
            proc_getid_yangyi(c1.isbn, c1.sm, c1.dj, c1.zt, c1.wz, '01', 9999,
                              v_dhdj.ywbmbh, c1.fl, c1.bc, v_id1, errno, errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;
            v_fjw := substr(v_id1, 1, 3);
            v_id  := substr(v_id1, 4);
            --Update tmp_dhmx Set id = v_id Where flowid_dhmx = c1.flowid_dhmx;
            proc_write_id_xtw(c1.flowid_dhmx, v_dhdj.ywbmbh, '', 120, v_fjw, v_id, errno,
                              errtext);
            If errno <> 0 Then
                Rollback;
                Return;
            End If;
        End If;
        --2013-12-10 modify by zgm(lv 指示) dbbz和xbb用库存数目替换
        Select * Into row_kcsm From t_kcsm Where id = v_id;
        Update tmp_dhmx
           Set id = v_id, dbbz = row_kcsm.dbbz, xbbz = row_kcsm.xbbz
         Where flowid_dhmx = c1.flowid_dhmx;
        --Update tmp_dhmx Set id = v_id Where flowid_dhmx = c1.flowid_dhmx;
        -- 写正式到货数据
        If c1.sylx = '0' Then
            v_zjxs := c1.dj; -- 这是到货的折价系数
        Else
            v_zjxs := 100;
        End If;
        v_sys := round(c1.djshsl * v_zjxs * c1.jhzk / 100, 2);
        --2011-09-09修改 用v_dhdj中的进行税率来写
        --2013-12-16 modify by 用库存书目的包装标准来替换dbbz xbbz
        -- 2015-11-27 yangyi: shrq改为sysdate
        Insert Into t_dhls_jx
            (flowid_dj, flowid_dhmx, id, cybh, ywbmbh, ghdwh, kfbh, ysdj, ysrq, chych,
             flowid_tldjhz, thdh, yh, sl, jhfs, lsdzjhbj, lsddh, sylx, jhzk, fhzk, dbbz,
             xbbz, mkzl, yssl, djshsl, pssl, yjrq, cqjtbl, xszq, remark, lrczybh, oklrrq,
             shczybh, shqrrq, shrq, dhpch, zjxs, flowid, sys, jzjtrq)
        Values
            (c1.flowid_dj, c1.flowid_dhmx, v_id, v_dhdj.cybh, v_dhdj.ywbmbh, v_dhdj.ghdwh,
             v_dhdj.kfbh, v_dhdj.ysdj, v_dhdj.ysrq, '', v_dhdj.flowid_tldjhz, v_dhdj.thdh,
             v_dhdj.yh, v_dhdj.sl, nvl(c1.jhfs, '01'), v_dhdj.lsdzjhbj, v_dhdj.dh, c1.sylx,
             c1.jhzk, c1.fhzk, row_kcsm.dbbz, row_kcsm.xbbz, c1.mkzl, c1.yssl, c1.djshsl,
             c1.pssl, c1.yjrq, c1.cqjtbl, c1.xszq, c1.remark, c1.lrczybh, v_dhdj.oklrrq,
             c1.shczybh, v_dhdj.oklrrq, Sysdate/*v_dhdj.oklrrq*/, v_dhpch, v_zjxs, c1.flowid_dhmx,
             v_sys, c1.jzjtrq);
        If c1.djshsl > 0 Then
            -- 写一笔t_crkls的到货入库记录:
            -- 2015-11-27 yangyi: 将crkrq改为sysdate
            Insert Into t_crkls
                (FLOWID_CRKLS, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH, ID,
                 CRKCS, CRKSY, SYLX, ZK_JG, ZJXS, DBBZ, XBBZ, SN_CRKCS, SN_CRKSY, FGBJ, SL,
                 flowid_wl, pk)
            Values
                (c1.flowid_dhmx, v_dhpch, v_dhpch, Sysdate/*v_dhdj.oklrrq*/, 'DH', v_dhdj.kfbh,
                 v_dhdj.ghdwh, v_dhdj.cybh, v_dhdj.ywbmbh, v_id, c1.djshsl, v_sys, c1.sylx,
                 c1.jhzk, v_zjxs, c1.dbbz, c1.xbbz, 0, 0, '0', v_dhdj.sl, c1.flowid_dhmx,
                 c1.flowid_dhmx);
            -- 2010-12-23 yangyi:
            -- 为确保连锁店系统对于同一品种实洋类型一致性的要求
            -- 取得库存书目中的实洋类型,作为发货的实洋类型
            Select sylx
              Into v_kcsm_sylx
              From t_kcsm_ywbm
             Where id = v_id And ywbmbh = v_dhdj.ywbmbh;
            -- 如果库存书目中的实洋类型与到货的实洋类型一致
            -- 按到货录入时的发折或发价发货，否则
            -- 根据库存书目的实洋类型，将到货的发折/发价转换成相应的发价/发折
            If v_kcsm_sylx = '0' Then
                If c1.sylx = '0' Then
                    v_fh_zj := c1.fhzk;
                Else
                    v_fh_zj := round(c1.fhzk / c1.dj * 100, 0);
                End If;
                v_fh_zjxs := c1.dj;
            Else
                If c1.sylx = '1' Then
                    v_fh_zj := c1.fhzk;
                Else
                    v_fh_zj := round(c1.fhzk * c1.dj / 100, 1);
                End If;
                v_fh_zjxs := 100;
            End If;
            -- 循环t_dpls中的相关记录, 形成t_pxmx的发货数据
            For c2 In (Select *
                         From t_dpls
                        Where flowid_dhmx = c1.flowid_dhmx And xdcs > 0)
            Loop
                -------------------------------------------------------------------------------------
                -- 2013-04-25 add by yangyi:
                -- 若为馆配部门且到货的折价类型与订货的折价类型相同，且为折扣方式，且原订单有发货折扣
                -- 则以原订单的发货折扣为准
                -- 2013-12-05 yy  把 c2.ywbmbh='000002' 屏蔽,因为在特殊订单处会置上T_DPLS的FHZK
                -- 2014-11-20 jy comment 直发，转发的发货折扣全部来自TMP_DHMX 的 FHZK
                /*If \*c2.ywbmbh='000002' And*\ v_kcsm_sylx='0' And c2.sylx='0' And nvl(c2.fhzk,0)>0 Then
                v_fh_zj_new := c2.fhzk;
                Else
                v_fh_zj_new := v_fh_zj;
                End If;*/

                -------------------------------------------------------------------------------------
                -- 2020-07-29 yangyi: 以t_dpls.zk为优先
                --v_fh_zj_new := nvl(v_fh_zj, c2.fhzk);
                if nvl(c2.zk,0)>0 then
                   c2.fhzk := c2.zk;
                end if;
                v_fh_zj_new := nvl(c2.fhzk,v_fh_zj);
                -------------------------------------------------------------------------------------

                -------------------------------------------------------------------------------------
                -- 写一笔t_pxmx的发货出库记录:
                v_fhsy  := round(c2.xdcs * v_fh_zjxs * v_fh_zj_new / 100, 2);
                v_fhzsy := v_fhzsy + v_fhsy;
                v_zzl   := v_zzl + c1.djshsl * c1.zl;
                -- 2013-08-12 yangyi: 将到货流水号保存到t_pxmx.bzth
                -- 最终从t_pxmx转入t_fhmx时，带到t_fhmx.bzth中
                --
                Select all_flowid.Nextval Into v_flowid From dual;
                Insert Into t_fhjh
                    (flowid, pxdh, bjlsh,   id, ywbmbh, kfbh, cybh, dh, pxcs,jhcs, sylx,
                     zjxs, pxzk, sl, fhfs, thfs, djly, zdh,   sys, dbbz, xbbz, txy, zl,
                     cgyj, yscs, jzthrq, sdhrq, cgyj_kh,   bzth, pk,pfrq)
                Values
                    (v_flowid, v_bjlsh, v_bjlsh,   v_id, v_dhdj.ywbmbh,
                     v_dhdj.kfbh, v_dhdj.cybh, v_dhdj.dh, c2.xdcs,c2.xdcs ,v_kcsm_sylx, v_fh_zjxs,
                     v_fh_zj_new, c1.sl, '01', '01', c2.djly, v_bjlsh,  v_fhsy, c1.dbbz,
                     c1.xbbz, '', c1.zl, c2.dbdh, c2.xdcs, Sysdate + c1.xszq, Sysdate + 7,
                     c2.cgyj_kh,   c1.flowid_dhmx, c2.flowid_dhmx,sysdate);
                -- 写一笔t_crkls的发货出库记录:
                --2013-06-07 by lv 因为传过来的bz有可能超长，加substrb
                Insert Into t_crkls
                    (FLOWID_CRKLS, YWPCH, YSPCH, CRKRQ, YWLX, KFBH, LYBH, CYBH, YWBMBH,
                     ID, CRKCS, CRKSY, SYLX, BZ, ZK_JG, ZJXS, DBBZ, XBBZ, SN_CRKCS,
                     SN_CRKSY, FGBJ, SL, flowid_wl, pk)
                Values
                    (v_flowid, v_bjlsh, v_bjlsh, Sysdate, 'FH', v_dhdj.kfbh, v_dhdj.dh,
                     v_dhdj.cybh, v_dhdj.ywbmbh, v_id, c2.xdcs, v_fhsy, v_kcsm_sylx,
                     substrb(Trim(c2.bz), 1, 20), v_fh_zj_new, v_fh_zjxs, c1.dbbz, c1.xbbz,
                     0, 0, '0', c1.sl, c2.flowid_dhmx, c2.flowid_dhmx);
                -- 2011-08-11 yangyi:
                -- 为商流订单状态住追踪时能按依据看到物流的实际发货情况，
                -- 另外，为与其它数据统一，将t_dpls.tdpch写入t_agv_rw_xt_bak.ph中
                -- 修改之前是ph=t_dpls.dbdh, cgyj=''
                -- 修改之后是ph=t_dpls.tdpch, cgyj=t_dpls.dbdh
                -- 商流追踪时，是按TDPCH+DH+ID筛选物流的t_agv_rw_xt_bak表
                --2013-12-16 modify by 用库存书目的包装标准来替换dbbz xbbz
                Insert Into t_agv_rw_xt_bak
                    (flowid_xj, ph, id, lxbh, ln_zp, kfbh, ywbmbh, cybh, dh, phdh, xsdh,
                     tihfs, xhao, qshqbh, hqbh, hwh, pxhw, zrhq, zrhw, yssl, sjsl, sl, zk,
                     sylx, zjxs, cltz, xjrq, xjczybh, wcbj, ysczybh, dbbz, xbbz, cwh, jxfs,
                     djly, dbdh, zrcybh, lhqhw, xdrq, cgyj, sdhrq, zl, qsclfs, xszq, bch,
                     BZRQ, BZR, jhrq, jhczybh, pk)
                Values
                    (v_flowid, c2.tdpch, v_id, 'FH', '', v_dhdj.kfbh, v_dhdj.ywbmbh,
                     v_dhdj.cybh, v_dhdj.dh, v_bjlsh, v_bjlsh, '01', v_dhdj.rqh, '001',
                     '001', '', '', '', '', c2.xdcs, c2.xdcs, c1.sl, v_fh_zj_new,
                     v_kcsm_sylx, v_fh_zjxs, '', Sysdate, v_dhdj.bzr, '1', v_dhdj.bzr,
                     row_kcsm.dbbz, row_kcsm.xbbz, '1', 'SG', 'LT', '', '', '', Sysdate,
                     c2.dbdh, Sysdate + c1.xszq, c1.zl, '0', c1.xszq, '', Sysdate,
                     v_dhdj.bzr, Sysdate, v_dhdj.bzr, c2.flowid_dhmx);
                v_zb := c2.note_gp;
                -- 2011-06-14 yangyi add:
                -- 如果一次发不齐，则为下次到货分书做准备：所以把flowid_dhmx清除了
                -- 就不拆分t_dpls记录了。
                -- 2011-08-11 yangyi:
                -- 增加id=v_id.
                Update t_dpls Set /*flowid_dhmx = Null,*/ id = v_id Where dbdh = c2.dbdh;
                -- end add
            End Loop;
        End If;
    End Loop;
    -- 计算总体情况:
    Select Count(*), nvl(Sum(t_dhls_jx.djshsl), 0), Sum(t_dhls_jx.djshsl * t_kcsm.dj),
           Sum(t_dhls_jx.sys), Sum(t_dhls_jx.yssl - t_dhls_jx.djshsl),
           Sum((t_dhls_jx.yssl - t_dhls_jx.djshsl) * t_kcsm.dj),
           Sum(round((t_dhls_jx.yssl - t_dhls_jx.djshsl) * t_dhls_jx.zjxs *
                      t_dhls_jx.jhzk / 100, 2))
      Into v_zpz, v_zcs, v_zmy, v_zsy, v_qssl, v_qsmy, v_qssy
      From t_dhls_jx, t_kcsm
     Where t_kcsm.id = t_dhls_jx.id And t_dhls_jx.flowid_dj = p_flowid_dj;
    -- 生成待发包件数据:
    -- 利用t_dfbj.gkh=LT0来表示“绿通”的单据
    -- 增加一个功能用于监控绿通包件的打包情况
    -- 当GKH=LT0时，可修改包装人及包装件数，
    -- 保存的同时记打包工作量，并直接调打印窗口。
    -- 直接点[打印]，如果gkh=LT0, 则按包装人及包装件数记工作量，
    -- 并将gkh=LT1，调打印窗口
    If Trim(v_zb) Is Null Then
        v_zb := substrb(Trim(v_dhdj.remark), 1, 30);
    End If;
    --新增加绿通一包一单方式，在包装校核进行手工拆单，因此ybzbj区分对待
    --字段gkh='LT0'是为了原来绿通包装与监控用的，如果一包一单的就不走原来的
    --绿通包装与监控，因此字段gkh=''
    -- 2011-07-03 YANGYI: 将绿通的拣选方式改为LT, 改前为SG
    -- 2011-07-05 YANGYI: 将绿通的拣选方式改为SG, 改前为LT

    v_jhzxid:=v_dhdj.ywbmbh||'FH';

    select flowid_tldjhz into v_tldjhz  from tmp_dhdj where flowid_dj=p_flowid_dj;
    select   * into   v_wlsh from t_wlsh where id=v_tldjhz;
    if v_wlsh.fllx ='GP' then
      v_isgp:='1';
      v_isgz:='0';
      v_jhzxid:=v_jhzxid||'P';
      select zddh into v_zddh from t_sl_yfsj where flowid_dj=p_flowid_dj and rownum=1;
    else
      v_isgp:='0';
     Select Count(*)   Into v_rows  From  t_guizu_fl  Where dh = v_dhdj.dh And  enable = '1';
     if v_rows > 0 then
        v_isgz:='1';
        v_jhzxid:=v_jhzxid||'G';
         Select min(gzbh) into v_zddh  From  t_guizu_fl c,tmp_dhmx x
          Where x.flowid_dj=p_flowid_dj and c.flbh=x.fl And c.dh =v_dhdj.dh and rownum=1 ;
          if v_zddh is null then
            select min(gzbh) into v_zddh  from t_guizu_fl  where  dh=v_dhdj.dh;
          end if ;
     else
        v_isgz:='0';
        v_zddh:=v_dhdj.dh;
        v_jhzxid:=v_jhzxid||'D';
     end if;

    end if ;
    
    select splitczyname into v_cbname from t_splitbagtask where flowid_tldjhz=v_tldjhz; 
      
    insert into t_tree
     (tbid, tbname, pid, pname, note, id, cs,  orderno, lf,rt,rid,dm)
   select
      flowid, 't_fhjh', trim(cgyj), 't_dpls',
     '绿通发货包装,校核任务号,'||v_bjlsh||',任务号'||v_tldjhz||',拆包人'||v_cbname, id,
     pxcs, null ,1,2, flowid,
     (select trim(dm) from t_dm where dh=v_zddh)
   from  t_fhjh     where bjlsh=v_bjlsh;
   
    
    v_jhzxid:=v_jhzxid||'Y'||p_flowid_dj;

    Insert Into t_jhtask
        (id, rqh, zt, createdate, ywbmbh,  dh,  zpz, zcs, zmy, zsy, js,
          zb,   jxfs, ywlx, zzl, zddh, ddcdbj,tdpch,sjlx,isgp,isgz,jhzxid)
    Values
        (v_bjlsh, v_dhdj.rqh, '1', Sysdate, v_dhdj.ywbmbh, v_dhdj.dh,
           v_zpz, v_zcs, v_zmy, v_fhzsy, v_wlsh.ssjs,
          v_zb, 'LT', 'FH',v_zzl, v_zddh, '1',p_flowid_dj,'FH',v_isgp,v_isgz,
          v_jhzxid
         );
     insert into t_ltjh
    (id_wlsh, flowid_dj, id_jhtask, ghdwmc, ghdw,
    js, ywbmmc, ywbm, dh, zpz, zcs, zmy,wldh,ysdj)
   select
   v_tldjhz,p_flowid_dj,v_bjlsh,  trim(g.mc), v_wlsh.dh, v_wlsh.ssjs,
   (select trim(dm) from t_dm where dh=v_dhdj.ywbmbh),
   v_dhdj.ywbmbh,v_dhdj.dh, v_zpz, v_zcs, v_zmy,v_wlsh.wldh,v_dhdj.ysdj
     from  t_ghdw g where   g.bh= v_wlsh.dh;
    -- 生成正式到货单据数据:
    -- 2011-07-03 yangyi:
    -- 将主动结算批次号中写入绿通发货的包件号，
    -- 以便后期查询，但对于一包一单的就没啥意义了
    -- 商流并不接收这个字段，只用于物流备查
    -- 2011-11-18 yangyi: 增加写“进项税率”
    Insert Into t_dhdj_tmp
        (FLOWID_DJ, DHPCH, GHDWH, YSDJ, YSRQ, DBRQ, ZPZ, ZCS, ZMY, ZSY, QSSL, QSMY, QSSY,
         YWBMBH, KFBH, DHDJLSH, CHK_CZYBH, YH, REMARK, flowid_dj_ys, cybh, ysbbj, js, zfzd,
         dh, ZDJSPCH, sl)
    Values
        (p_flowid_dj, v_dhpch, v_dhdj.ghdwh, v_dhdj.ysdj, v_dhdj.ysrq, Sysdate, v_zpz,
         v_zcs, v_zmy, v_zsy, v_qssl, v_qsmy, v_qssy, v_dhdj.ywbmbh, v_dhdj.kfbh,
         v_dhdj.flowid_tldjhz, 'auto', v_dhdj.yh, v_dhdj.remark, p_flowid_dj, v_dhdj.cybh,
         '0', v_dhdj.zjs, v_dhdj.zfzd, v_dhdj.dh, v_bjlsh, v_dhdj.sl);
 
    -- 临时表到货数据写入备份表:
    Insert Into tmp_dhmx_xtw
        Select * From tmp_dhmx Where flowid_dj = p_flowid_dj;
    Delete From tmp_dhmx Where flowid_dj = p_flowid_dj;
    Insert Into tmp_dhdj_xtw
        Select * From tmp_dhdj Where flowid_dj = p_flowid_dj;
    Delete From tmp_dhdj Where flowid_dj = p_flowid_dj;

    insert into t_sl_yfsj_bak
            Select * From t_sl_yfsj Where flowid_dj = p_flowid_dj;
    delete t_sl_yfsj Where flowid_dj = p_flowid_dj;
    -- 如果当前运号的单子已全部完成,
    -- 则删除t_tldjmx中相应记录,
    -- t_tldjhz中相应记录置已分流标记
  /*  Select Count(*) Into v_rows From tmp_dhdj Where flowid_tldjhz = v_dhdj.flowid_tldjhz;
    If v_rows = 0 Then
        Insert Into t_tldjmx_bak
            Select * From t_tldjmx Where flowid_tldjhz = v_dhdj.flowid_tldjhz;
        Delete From t_tldjmx Where flowid_tldjhz = v_dhdj.flowid_tldjhz;
        Update t_tldjhz
           Set flbj = '1', flrq = Sysdate
         Where flowid_tldjhz = v_dhdj.flowid_tldjhz;
    End If;*/
    errno   := 0;
    errtext := 'OK';
    Return;
Exception
    When Others Then
        errno   := -1;
        errtext := 'PROC_SX_JSDHSJ_LSTDCL2' || Sqlerrm || ',' || p_flowid_dj;
        Rollback;
        Return;
End PROC_SX_JSDHSJ_LSTDCL2;

