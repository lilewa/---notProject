create or replace procedure PROC_SETJHCSBYWEIGHT_PT(p_bjlsh char, p_pass out varchar2,ERRNO   Out Number,
 ERRTEXT Out varchar) is
 v_rows number;
 v_rqh t_dfbj.rqh%type;
 v_rqzl number;
 v_numzl number;
 v_bagzl number;
 v_id t_pxmx.id%type;
 v_minzl number;
begin
    ERRNO:=0;
    ERRTEXT:='ok';
    
    update  T_WEIGHTRECORD set handledate=sysdate where  zt='0' and rqh=v_rqh; 
    
    select  rqh  into  v_rqh from t_dfbj where bjlsh=p_bjlsh;
    select nvl(zl,0) into v_rqzl  from t_rqbm where bh=v_rqh;
     if v_rqzl=0 then
        update T_WEIGHTRECORD set msg='容器重量为0',zt='2'  where zt='0' and rqh=v_rqh; 
        p_pass:='容器重量为0';
        return;
     end if;
     
    
     select min(id) into v_id  from t_pxmx where bjlsh=p_bjlsh and nvl(zl,0)=0;
     if v_id is not null then
          update T_WEIGHTRECORD set msg='包件中有重量为0的品种'||v_id,zt='2'  where zt='0' and rqh=v_rqh; 
          p_pass:='包件中有重量为0的品种'||v_id ; 
          return;
     end if;
     
      select sum(zl*pxcs) into v_bagzl from t_pxmx where bjlsh=p_bjlsh ;
      select min(zl) into v_minzl from t_pxmx where bjlsh=p_bjlsh ;
          
    for cur in(select zl,rowid  from  T_WEIGHTRECORD where rqh=v_rqh order by createdate desc )loop
      
        begin
         select   to_number(cur.zl) into v_numzl  from dual;
        exception
          when others then
           update T_WEIGHTRECORD set msg= '称重机写入重量数字无效' ,zt='2' where rowid=cur.rowid;
           if p_pass is null then
            p_pass:='称重机写入重量数字无效'||cur.zl;
           end if;
           continue; 
        end;
        
        if abs(v_bagzl + v_rqzl -v_numzl)< v_minzl then
            update T_WEIGHTRECORD set msg='通过,包件'||v_bagzl||',容器'||v_rqzl||',最轻品种'||v_minzl,  zt='3' 
            where rowid=cur.rowid;
            p_pass:='称重通过';
            exit;
        else
           update T_WEIGHTRECORD set msg='未通过,包件'||v_bagzl||',容器'||v_rqzl||',最轻品种'||v_minzl,  zt='2' 
            where rowid=cur.rowid;
            if p_pass is null then
             p_pass:='未通过';
            end if;
           
        end if;
          
    end loop;
    
    if p_pass ='称重通过' then
      update t_pxmx set jhcs=pxcs where bjlsh=p_bjlsh;
      update T_WEIGHTRECORD set zt='1'  where  zt='0' and rqh=v_rqh; 
    end if ;
   


exception
   when others then
    errno:=-1;
    errtext:=sqlerrm||'PROC_SETJHCSBYWEIGHT_PT';
    p_pass:='计算错误';
    rollback;
end PROC_SETJHCSBYWEIGHT_PT;
