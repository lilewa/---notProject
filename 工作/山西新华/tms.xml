<?xml version="1.0" standalone="yes" ?>
<root>
	<desc>
		一件理货 扫包件带出托盘有多少件
		出库清点 
		出库打印 一个收货单位一个出库批次号
		发运计划
		教材交接 点交接 进入发运计划
		发运计划保存，多个批次生成一个发运批次。确认发运界面。确认计划到发运清单
		发运清单打印，不同到站不能打到一起
		发运计划输入中转店就中转
		中转到侯马的，收侯马的签收单
		发运计划_发运回告
		发运回告查询，生成交接单
		承付计划，按发运计划批次做 生成承付批次
	</desc>
	<一键理货>
		<u_dw1 d="d_dfbj_yjlh">
			Select 
			'0' as xz,
			Bjlsh,
			Ywbmbh,
			(Select Dm From t_dm Where Dh = Ywbmbh) Ywbmmc,
			Bzjs,
			round(zzl/1000,5) Zzl,
			Dh,
			fun_getShdw(dh,ywlx,bjlx) Dm,
			jjrq  Jsrq,
			decode(ywlx,'FH',
				(Select mc From t_station Where bh = (select station from t_all_dmxx where dh = a.dh and ywbmbh=a.ywbmbh And ywlx = 'FH' And cybh = a.jsbmbh)),
				(Select mc From t_station Where bh = (select station from t_all_dmxx where dh = a.dh and ywbmbh=a.ywbmbh And ywlx = 'TH' And cybh = a.jsbmbh))
				) station_mc,
					tph,:p_station ab
				From t_Dfbj a
				Where  Lhbj = '0' and ywbmbh<>'3F'
				And Ywbmbh in (:p_Ywbmbh_Kh)
				And Ywlx In (:p_Ywlx)
				and dh like :p_dh || '%'

				and jjrq > to_date(:p_rq1,'yyyy-mm-dd') and jjrq < to_date(:p_rq2,'yyyy-mm-dd') + 1
				And (Nvl(jjbj,'0') = '1'
				or Exists (Select 1 From T_FY_BTP_JJ_QK  b Where a.bjlsh = b.bjlsh And Nvl(b.jjbj,'0') = '1')
				or
				decode(ywlx,'FH',
				(Select mc From t_station Where bh = (select station from t_dm_ywbm where dh = a.dh and ywbmbh=a.ywbmbh)),
				(Select mc From t_station Where bh = (select station from t_ghdw_ywbm where ghdwh = a.dh and ywbmbh=a.ywbmbh))
				) like trim(:p_station) || '%')
				union  
				Select 
					'0' as xz,
					Bjlsh,
					Ywbmbh,
					(Select Dm From t_dm Where Dh = Ywbmbh) Ywbmmc,
					Bzjs,
					round(zzl/1000,5) Zzl,
					Dh,
					fun_getShdw(dh,ywlx,bjlx)  Dm,
					jjrq  Jsrq,
					decode(ywlx,'FH',
				(Select mc From t_station Where bh = (select station from t_all_dmxx where dh = a.dh and ywbmbh=a.ywbmbh And ywlx = 'FH' And cybh = a.jsbmbh)),
				(Select mc From t_station Where bh = (select station from t_all_dmxx where dh = a.dh and ywbmbh=a.ywbmbh And ywlx = 'TH' And cybh = a.jsbmbh))
				)station_mc,
					tph,:p_station ab
				From t_Dfbj a
				Where  Lhbj = '0' and ywbmbh='3F'
				And Ywbmbh in (:p_Ywbmbh_Kh)
				And Ywlx In (:p_Ywlx)
				and dh like :p_dh || '%'
				and
				decode(ywlx,'FH',
				(Select mc From t_station Where bh =(select min(station) from t_all_dmxx where dh = a.dh and ywbmbh=a.ywbmbh and cybh=a.JSBMBH)),
				(Select mc From t_station Where bh = (select station from t_ghdw_ywbm where ghdwh = a.dh and ywbmbh=a.ywbmbh))
				) like trim(:p_station) || '%'
				and jjrq > to_date(:p_rq1,'yyyy-mm-dd') and jjrq < to_date(:p_rq2,'yyyy-mm-dd') + 1
				And Nvl(jjbj,'0') = '1' and wcbj='1'
	
		</u_dw1>
		<Lhbj = '0'  And Nvl(jjbj,'0') = '1' and wcbj='1'/>
		<一键理货 选包件理="proc_dfbj_yjlh">
			Update t_dfbj Set lhbj = '1',lhrq = Sysdate,hw = v_hwh.hwh,tph= v_tph Where bjlsh = rpad(trim(c1.column_value),12,' ');
		</一键理货>
	</一键理货>
	<出库清点>
		<u_dw1 d="d_ckpd">
			Select bjlsh,
			bzjs,
			hw,
			tph,
			lhrq,
			fun_getShdw(dh, ywlx, bjlx) shdw,
			round(zzl / 1000, 2) zzl,
			fun_tms_getstation(dh, ywbmbh, jsbmbh, ywlx) dz,
			ktpch,
			dh,
			decode(nvl((select jzfybj
							from v_dh_fydj
						where ywbmbh = a.ywbmbh
							and dh = a.dh
							and ywlx =
								decode(a.ywlx, 'ST', 'TH', 'SC', 'TH', 'FH')),
						'0'),
					'0',
					'1',
					'0') as xz,
			nvl((select jzfybj
					from v_dh_fydj
					where ywbmbh = a.ywbmbh
					and dh = a.dh
					and ywlx = decode(a.ywlx, 'ST', 'TH', 'SC', 'TH', 'FH')),
				'0') jzfybj

			From t_dfbj a
			Where nvl(trim(Fyjhpc), 'X') = 'X'
			And Ktpch Is Null
			and lhbj = '1'
			and cybh = :p_jsbmbh
			and ywlx in (:p_ywlx)
			and ywbmbh in (:p_ywbmbh)
			and lhrq > to_date(:p_rq1, 'yyyy-mm-dd')
			and lhrq <= to_date(:p_rq2, 'yyyy-mm_dd') + 1
			and (dh = nvl(:p_dh, dh) or
					(Dh, Ywbmbh, cybh) In
					(Select Dh, Ywbmbh, cybh
					From t_All_Dmxx
					Where 
					Cybh = :p_jsbmbh
					And Nvl(Station, 'X') In (:p_station)))

		</u_dw1>
		
		<按发运路线筛选到站>
			 select station, stationmc
				from (select distinct nvl(station, 'X') station,
								nvl((select trim(mc)
									from t_station
									where bh = a.station),
									'其他（未设置到站）') stationmc
						from t_all_dmxx a
						where cybh = :p_cybh
							and nvl(fylx, 'X') = :p_fylx
							and ywlx = :p_ywlx)
				order by stationmc, station
		</按发运路线筛选到站>
		<生成出库单>
			Update t_dfbj set ktpch = :p_ckpch,ktrq = sysdate 
			where bjlsh in (Select  rpad(Column_Value,12,' ') From Table(Split_Str2(:p_bjlsh, ',')))
		</生成出库单>
	</出库清点>

	<出库打印>
		<u_dw1 d="d_ckpd_hz">
			SELECT ktpch ckpch,
			round(Sum(zzl) / 1000, 2) zl,
			Sum(js) js,
			decode(min(ywlx), 'FH', '发货', 'SC', '退货', 'ST', '退货') as ywlxmc,
			min(bjlx) bjlx,
			max(jcqb) jcqb,
			min(dh) dh,
			Decode(Min(Ywlx),
					'FH',
					Decode(Min(Bjlx),
							'1',
							min((Select Dm
								From t_all_dmxx
								Where Dh = a.dh
									And ywbmbh = a.ywbmbh
									And hzlx = 'JC'
									And cybh = a.jsbmbh)),
							'0',
							min((Select Dm From t_Dm Where Dh = a.Dh)),
							'3',
							Decode(Min(Ywbmxd),
									'TS',
									min((Select Dm From t_Dm Where Dh = a.Dh)),
									'JC',
									min((Select Dm From t_dm_jc_all Where Dh = a.zzbh)),
									min((Select Dm From t_Dm_3f Where Dh = a.Dh)))),
					min((Select Mc From t_Ghdw Where Bh = a.Dh))) As dm,
			Min((Select Trim(Dm)
					From t_All_Dmxx
					Where Ywlx = decode(a.Ywlx, 'FH', 'FH', 'TH')
					And Dh = a.zzbh
					And Ywbmbh = a.Ywbmbh
					And Hzlx = Decode(Substr2(a.Ywbmbh, 0, 3), '900', 'JC', 'TS')
					And Cybh = a.jsbmbh)) zzdm,
			Min((Select Trim(mc)
					From t_station
					Where bh =
						(Select station
							From t_All_Dmxx
							Where Ywlx = decode(a.Ywlx, 'FH', 'FH', 'TH')
							And Dh = a.zzbh
							And Ywbmbh = a.Ywbmbh
							And Hzlx =
								Decode(Substr2(a.Ywbmbh, 0, 3), '900', 'JC', 'TS')
							And Cybh = a.jsbmbh))) stationmc
			FROM t_dfbj a
			where contract_id_root is null
			and jhpch is null
			And ktpch Is Not Null
			and lhbj = '1'
			And fyjhpc = 'X'
			And hw is not null 
			and ywlx in (:p_ywlx)
			And trim(jsbmbh) = trim(:p_jsbmbh)
			And ywbmbh in (:p_ywbmbh)
			And ktrq >= to_date(:p_rq1, 'yyyy-mm-dd')
			and ktrq < to_date(:p_rq2, 'yyyy-mm-dd') + 1
			And dh = nvl(:p_dh, dh) 
			group by ktpch

		</u_dw1>
		<where>
			FROM t_dfbj a
			where contract_id_root is null
			and jhpch is null
			And ktpch Is Not Null
			and lhbj = '1'
			And fyjhpc = 'X'
			And hw is not null 
			and ywlx in (:p_ywlx)
			And trim(jsbmbh) = trim(:p_jsbmbh)
			And ywbmbh in (:p_ywbmbh)
			And ktrq >= to_date(:p_rq1, 'yyyy-mm-dd')
			and ktrq < to_date(:p_rq2, 'yyyy-mm-dd') + 1
			And dh = nvl(:p_dh, dh) 
			group by ktpch
		</where >
		<u_dw2 d="d_ckpd_mx">
			Select bjlsh,
			bzjs,
			hw,
			tph,
			lhrq,
			fun_getShdw(dh, ywlx, bjlx) shdw,
			round(zzl / 1000, 2) zzl,
			fun_tms_getstation(dh, ywbmbh, cybh, ywlx) dz,
			ktpch,
			dh,
			
			nvl((select jzfybj
					from v_dh_fydj
					where ywbmbh = a.ywbmbh
					and dh = a.dh
					and ywlx = decode(a.ywlx, 'ST', 'TH', 'SC', 'TH', 'FH')),
				'0') jzfybj,
			a.ywbmbh 

			From t_dfbj a
			Where ktpch = :p_ckpch
			and ktpch is not null
		</u_dw2>
	</出库打印>

	<发运计划>
		<发运计划>
			<u_dw_dfbj_ckpch_hz d="d_dfbj_ckpch_hz">
				SELECT '0' as xz,
				ktpch ckpch,
				round(Sum(zzl) / 1000, 2) zl,
				Sum(js) js,
				decode(min(ywlx), 'FH', '发货', 'SC', '退货', 'ST', '退货') as ywlxmc,
				min(bjlx) bjlx,
				max(jcqb) jcqb,
				min(dh) dh,
				
				Min((Select Trim(Dm)
						From t_All_Dmxx
						Where Ywlx = decode(a.Ywlx, 'FH', 'FH', 'TH')
						And Dh = a.dh
						And Ywbmbh = a.Ywbmbh
						And Hzlx = Decode(Substr2(a.Ywbmbh, 0, 3), '900', 'JC', 'TS')
						And Cybh = a.jsbmbh)) as dm,
				Min((Select Trim(Dm)
						From t_All_Dmxx
						Where Ywlx = decode(a.Ywlx, 'FH', 'FH', 'TH')
						And Dh = a.zzbh
						And Ywbmbh = a.Ywbmbh
						And Hzlx = Decode(Substr2(a.Ywbmbh, 0, 3), '900', 'JC', 'TS')
						And Cybh = a.jsbmbh)) zzdm,
				Min((Select Trim(mc)
						From t_station
						Where bh =
							(Select station
								From t_All_Dmxx
								Where Ywlx = decode(a.Ywlx, 'FH', 'FH', 'TH')
								And Dh = a.zzbh
								And Ywbmbh = a.Ywbmbh
								And Hzlx =
									Decode(Substr2(a.Ywbmbh, 0, 3), '900', 'JC', 'TS')
								And Cybh = a.jsbmbh))) stationmc
				FROM t_dfbj a
				where contract_id_root is null
				and jhpch is null
				And ktpch Is Not Null
				and lhbj = '1'
				and decode(ywlx, 'BF', 'FH', 'SC', 'ST', ywlx) =
					decode(:p_ywlx, 'FH', 'FH', 'ST')
				And fyjhpc = 'X'
				And hw is not null
				And trim(jsbmbh) = trim(:p_jsbmbh)
				And ktpch = nvl(:p_ckpch, ktpch)

				group by ktpch

			</u_dw_dfbj_ckpch_hz>
			<设置中转店 p="proc_fyjh_ckpch_zzdh">
				Update t_dfbj Set zzbh = p_zzdh Where ktpch = p_ckpch And contract_id_root Is Null;
			</设置中转店 >
			<制定运输计划 p="proc_fyjh_ckpch">
				Select dh,ywbmbh From t_Dfbj Where Contract_Id_Root Is Null 
						And BJZY_CZY = p_cjr And ktpch = out_ckpch.ckpch  and fyjhpc='X'
								Group By dh,ywbmbh

				Update t_dfbj Set contract_id_root = v_contract_id,jhpch=v_jhpc Where bjlsh = v_dfbj.bjlsh;
				Update t_wcbj Set contract_id_root = v_contract_id Where bjlsh = v_dfbj.bjlsh;
				
				Insert Into t_ht(contract_id,contract_id_farther,contract_id_root,ywbmbh,ywbmbh_kh,ywbmmc_kh,tran_id,station_id_qs,
								station_id_md,sdrq,js,my,
								station,htrq,mode_id_act,mode_id,dh,dm,dz,tel,lxr,zl,bz,ywlx,zzbj,cjr,cjrq,flowid_car,jhpc,jhpcrq,cs,sy,yh,ywbmmc,zzbh)
							Values(v_contract_id,null,v_contract_id_root,p_ywbmbh,v_ywbm_kh,trim(v_dfbj_ywbm.dm),p_tran_id,nvl(v_yf_station_ywbm.station_id_qs,'2005'),
									v_station_id_md,v_sdrq,v_zjs,v_zmy,
									v_station,Sysdate,p_mode_id,v_mode_id,v_dh,v_dm,v_dz,v_tel,v_lxr,
									v_zzl,p_bz,out_ckpch.ywlx,v_zzbj,p_cjr,Sysdate,p_flowid_car,v_jhpc,sysdate,v_zcs,nvl(v_zsy,0),v_yh,
									(select trim(dm) from t_dm where dh=p_ywbmbh),v_zzbh);

			</制定运输计划>
		</发运计划>
		<发运确认>
			<u_dw_ht_hz d="d_ht_hz">
				Select '0' As Xz,
					Min(Ywbmbh) ywbmbh,
					Min(Ywbmbh_Kh) Ywbmbh_Kh,
					Min(Ywbmmc_Kh) Ywbmmc_Kh,
					Sum(Js) Js,
					Sum(Round(Nvl(Zl, 0) / 1000, 2)) Zl,
					Sum(My) My,
					Min(jhpcrq) Fyrq,
					Min((Select mc From t_ysdw Where trim(bh) = trim(a.Tran_Id))) As Tran_Mc,
					Min((Select Mode_Mc From t_Yf_Mode Where Mode_Id = Mode_Id_Act)) As Mode_Mc,
					Min(Ywlx) Ywlx,
					Min(Tran_Id) Tran_Id,
					Min(Mode_Id_Act) Mode_Id_Act,
					jhpc
				From t_Ht a
				Where Fyjhpc Is Null
				And Ywbmbh = :p_ywbmbh
				And Ywbmbh_Kh In (:p_ywbmbh_kh)
				And Ywlx In (:p_ywlx)
				And Cjr Like :p_cjr || '%'
				And Tran_Id like :p_tran_id || '%'
				Group By Jhpc

				Ywbmbh是3001
				Ywbmbh_Kh 是ywbmbh
				Jhpc 是调度生成的计划批次号，可以勾选多个ktpch 生成一个jhpc
				ktpch 是在出库清点 按dh 生成的
			</u_dw_ht_hz>

			<u_dw_ht d="d_ht"> 
				Select '0' as xz,
					CONTRACT_ID,
					ywbmbh,
					fyjhpc,
					ywbmbh_kh,
					ywbmmc_kh,
					dm || '(' || dh || ')' as dh,
					station,
					(select mc from t_station where bh = station_id_qs) as station_mc_qs,
					(select mc from t_station where bh = station) as station_mc,
					(select mc from t_station where bh = station_id_md) as station_id_md_mc,
					dz,
					tel,
					lxr,
					js,
					round(Nvl(zl, 0) / 1000, 2) zl,
					my,
					fyrq,
					sdrq,
					(select mc from t_ysdw where trim(bh) = trim(a.tran_id)) as tran_mc,
					(select mode_mc from t_yf_mode where mode_id = mode_id_act) as mode_mc,
					ywlx,
					tran_id,
					mode_id_act,
					(select dm from t_dm where dh = ywbmbh) ywbmmc,
					contract_id_root,
					yh,
					jhpc,
					station_id_md,
					dh dh_,
					dm,
					bz,
					zcr,
					(select decode(nvl(min(contract_id_farther), '0'), '0', '0', '1')
						from t_ht
						where contract_id_farther = a.contract_id) as flag,
					zl ld_zl,
					cs,
					sy
					From t_ht a
					where jhpc = :p_jhpc
					and contract_id_farther is null  

					t_ht 是上一步按 ktpch，ywmbjh，dh 生成的
			</u_dw_ht>

			<u_dw_ld d="d_ht_ld">
				Select CONTRACT_ID,
				ywbmbh,
				fyjhpc,
				ywbmbh_kh,
				ywbmmc_kh,
				dh,
				dm,
				station,
				(select mc from t_station where bh = station_id_qs) as station_mc_qs,
				(select mc from t_station where bh = station) as station_mc,
				(select mc from t_station where bh = station_id_md) as station_id_md_mc,
				dz,
				tel,
				lxr,
				js,
				zl zl,
				my,
				sy,
				fyrq,
				sdrq,
				(select mc from t_ysdw where trim(bh) = trim(a.tran_id)) as tran_mc,
				(select mode_mc from t_yf_mode where mode_id = mode_id_act) as mode_mc,
				ywlx,
				tran_id,
				mode_id_act,
				(select dm from t_dm where dh = ywbmbh) ywbmmc,
				contract_id_root,
				yh,
				jhpc,
				station_id_md,
				station_id_qs,
				contract_id_farther,
				htrq,
				mode_id,
				bz,
				cjrq,
				cjr,
				zcr,
				cs
				From t_ht a
				where contract_id_farther = :p_contract_id_farther
			</u_dw_ld>
			<合同确认 p="proc_yfjs" p="proc_fyjh_confirm">
				Update t_ht Set fyjhpc = jhpc,cph = p_cph,fyrq = Sysdate,car_zl = p_car_zl,zcr = p_zcr,yh=v_yh,sj=v_sj_bh
					,thr = p_thr  	Where contract_id = v_contract_id;

				   
				Update t_dfbj Set fyjhpc = trim(v_ht.jhpc),cydw = v_ht.tran_id,fyjhrq=Sysdate,jhpch=Null
						Where contract_id_root = v_contract_id;
				
				 Insert Into t_ht_print Values(v_contract_id,v_bjlsh_arr,c2.ywbmbh);
			</合同确认>
		</发运确认>
	</发运计划>

	<发运清单打印>
		<u_dw1 d="d_ht_hz_fyjhpc">
				Select Min(Ywbmbh) ywbmbh,
				Min(Ywbmbh_Kh) Ywbmbh_Kh,
				Min(Ywbmmc_Kh) Ywbmmc_Kh,
				Sum(Js) Js,
				Sum(Round(Zl / 1000, 2)) Zl,
				Sum(My) My,
				Min(Fyrq) Fyrq,
				Min((Select trim(mc) From t_ysdw Where trim(bh) = trim(a.Tran_Id))) As Tran_Mc,
				Min((Select Mode_Mc From t_Yf_Mode Where Mode_Id = Mode_Id_Act)) As Mode_Mc,
				Min(Ywlx) Ywlx,
				Min(Tran_Id) Tran_Id,
				Min(Mode_Id_Act) Mode_Id_Act,
				fyjhpc fyjhpc,
				jhpc
			From t_Ht a
			Where jhpc Is not Null
			And Ywbmbh = :p_ywbmbh
			And Ywbmbh_Kh In (:p_ywbmbh_kh)
			And Ywlx In (:p_ywlx)
			And Cjr Like :p_cjr || '%'
			And Tran_Id Like :p_tran_id || '%'
			and jhpc LIke :p_fyjhpc || '%'
			and fyrq >= to_date(:p_rq1, 'yyyy-mm-dd')
			and fyrq < to_date(:p_rq2, 'yyyy-mm-dd') + 1
			Group By jhpc, fyjhpc, tran_id
			Order by fyrq desc

		</u_dw1>
		
		<u_dw2 d="d_ht_hz_fyjhpc_mx">
				Select '0' as xz,
				CONTRACT_ID,
				ywbmbh,
				fyjhpc,
				ywbmbh_kh,
				ywbmmc_kh,
				dm || '(' || dh || ')' as dh,
				station,
				(select mc from t_station where bh = station) as station_mc,
				dz,
				tel,
				lxr,
				js,
				round(zl / 1000, 2) zl,
				my,
				fyrq,
				sdrq,
				(select trim(mc) from t_ysdw where trim(bh) = trim(a.tran_id)) as tran_mc,
				(select mode_mc from t_yf_mode where mode_id = mode_id_act) as mode_mc,
				ywlx,
				tran_id,
				mode_id_act,
				(select dm from t_dm where dh = ywbmbh) ywbmmc,
				contract_id_root,
				(select mc from t_station where bh = station_id_md) As station_id_mc,
				station_id_md,
				DH DH1
			From t_ht a
			where jhpc = :p_fyjhpc
			and tran_id = nvl(:p_tran_id, tran_id)
			order by yh, station_id_mc

		</u_dw2>

		<汇总清单打印 d="d_fyjhpc_hz">
				Select Fyjhpc,
				Contract_Id Xh,
				Dm,
				(Select Trim(Mc) From t_Station Where Bh = a.Station) Stationmc,
				Js,
				Round(Zl / 1000, 2) Zl,
				Ywbmmc_Kh,
				(Select ktpch
					From t_dfbj
					Where contract_id_root = a.contract_id
					And Rownum = 1
					And Substr2(ywbmbh, 0, 3) = '900') Jcjhpc,
				(Select mc From t_ysdw Where bh = rpad(a.tran_id, 6, ' ')) tranmc,
				(Select Name From t_ysdw_sj Where bh = a.sj) sjmc,
				(Select tel From t_ysdw_sj Where bh = a.sj) sjtel,
				fyrq
			From t_Ht a
			Where fyjhpc = :p_fyjhpc
			and tran_id = :p_tran_id

		</汇总清单打印>

		<发货清单打印 d="d_fhqd"> 
			Select min(a.Fyrq) fyrq,
				min(a.Fyjhpc) fyjhpc,
				
				(Select max(htbh)
					from (select wmsys.wm_concat(contract_id) over(partition by fyjhpc order by contract_id) htbh
							from t_ht
							where fyjhpc = :p_fyjhpc
							and contract_id in (:p_contract_id)
							and substr2(ywbmbh_kh, 0, 3) != '900')) yh,
				min((Select mc From t_station Where bh = a.Station_Id_Md)) As station_mc,
				(select dm
					from t_ht
					where fyjhpc = :p_fyjhpc
					and contract_id in (:p_contract_id)
					and rownum = 1) dm,
				(select tel
					from t_ht
					where fyjhpc = :p_fyjhpc
					and contract_id in (:p_contract_id)
					and rownum = 1) tel,
				(select dz
					from t_ht
					where fyjhpc = :p_fyjhpc
					and contract_id in (:p_contract_id)
					and rownum = 1) dz,
				(select lxr
					from t_ht
					where fyjhpc = :p_fyjhpc
					and contract_id in (:p_contract_id)
					and rownum = 1) lxr,
				
				wmsys.wm_concat(distinct a.ywbmbh_kh) As ywbmmc,
				'(' || min(trim((Select dm From t_dm Where dh = a.ywbmbh_kh))) || ')' As ywbmmckh,
				min((Select mc From t_ysdw Where trim(bh) = trim(a.tran_id))) As tran_mc,
				sum(a.js) js,
				min(a.contract_id_root) contract_id_root,
				min(cph) cph,
				trim(min(sj)) sj,
				min((Select tel From t_ysdw_sj Where bh = sj)) tell,
				min(bz) bz,
				sum(a.zl / 1000) zl
			From t_Ht a
			Where fyjhpc = :p_fyjhpc
			and substr2(ywbmbh_kh, 0, 3) != '900'
			and contract_id in (:p_contract_id)
			group by fyjhpc

		</发货清单打印>
		<派车单 d="d_zy_pcd">
				Select min((Select Trim(Mc) From t_Station Where Bh = Station_Id_Qs)) Station_Id_Qs,
				min(fyrq) fyrq,
				min(cph) cph,
				min(fyjhpc) fyjhpc,
				max((Select Trim(Mc) From t_Station Where Bh = Station)) Station_Id_md,
				min((Select Name From t_user Where usr_id = zcr)) zcr,
				min((Select Name From t_ysdw_sj Where bh = sj)) sj,
				max((Select jl * 2
						From t_yf_station_ywbm
						Where Station_Id_Qs = a.Station_Id_Qs
						And Station_Id_md = a.Station)) jl,
				sum(Round(zl / 1000, 2)) zl,
				fun_tms_get_stationmc_h(fyjhpc) station,
				sum(js) js,
				min(bz) bz
			From t_Ht a
			Where fyjhpc = :p_fyjhpc
			group by fyjhpc
		</派车单>

	</发运清单打印>

	<教材交接 w="JGWL.WindowsForm.Tms.Form_jc_ysjj">
		<u_dw1 d="d_jc_ysjj">
				Select Fypc,
				min(bjlsh) Bjlsh,
				Sum(bzjs) Bzjs,
				Sum(zpz) Zpz,
				Sum(zcs) Zcs,
				Sum(zmy) Zmy,
				Min(yh) Yh,
				Min(fyrq) Fyrq,
				Min((Select Dm From t_Dm@c_Link_Tms_Jc Where Dh = a.zzbh)) Dm

			From t_wcbj@c_link_tms_jc a
			Where fyrq > date '2018-11-01'
			and fypc = nvl(:p_fypc, fypc)
			And fyrq > to_date(:p_rq1, 'yyyy-mm-dd')
			And fyrq < to_date(:p_rq2, 'yyyy-mm-dd') + 1
			And yh = nvl(:p_yh, yh)
			and cybh = :p_ywbmbh
			And nvl(tmsjsflag, '0') = '0'
			Group By fypc
			union all
			select ywpch,
				ywpch,
				bjs,
				zpz,
				zcs,
				zmy,
				ywpch,
				thrq,
				(select mc from t_ghdw@c_link_tms_jc where bh = b.hybh) dm
			from t_hythhz@c_link_tms_jc b
			where not exists (select 1 from t_wcbj where bjlsh = b.ywpch)
			and cybh = :p_ywbmbh
			and ywpch = nvl(:p_yh, ywpch)
			and thrq > to_date(:p_rq1, 'yyyy-mm-dd')
			And thrq < to_date(:p_rq2, 'yyyy-mm-dd') + 1

		</u_dw1>
		<Form_jc_ysjj_confirm p="proc_ysjj">
		<Form_jc_ysjj_confirm>
	</教材交接>
	
	<rf托盘绑定 w="TayyShippBindForm">
		<包号回车>
			select t_dm.dh, bzjs js, pfrq, bjlsh, ywbmbh, t_dm.dm, b.dm bmmc
			from t_dfbj
			left join t_dm
			on t_dm.dh = t_dfbj.dh
			left join t_dm b
			on t_dfbj.ywbmbh = b.dh
		where bjlsh = '  bjlshOrYh  '
			and ywlx <> 'ST'
			and nvl(jjbj, '0') = '0'
			and ybzbj = '1';
		
		select t_dm.dh, bzjs js, pfrq, bjlsh, ywbmbh, t_dm.dm, b.dm bmmc
			from t_dfbj
			left join t_dm
			on t_dm.dh = t_dfbj.dh
			left join t_dm b
			on t_dfbj.ywbmbh = b.dh
		where yh = '  bjlshOrYh  '
			and ywlx <> 'ST'
			and nvl(jjbj, '0') = '0'
			and ybzbj = '1';
		</包号回车>
		<PROC_SX_DFBJ_BTP_XTW>
			UPDATE T_DFBJ SET TPH = P_TPH, bjfjbj='1' WHERE BJLSH = P_BJLSH;
		</PROC_SX_DFBJ_BTP_XTW>
	</rf托盘绑定>

	<rf包件交接 w="TayyExceForm">
	  select a.dh,
       a.js,
       a.pfrq,
       a.bjlsh,
       a.ywbmbh,
       a.dm,
       a.bmmc,
       a.jsjs,
       a.tph,
       c.zs
	from (select t_dfbj.dh,
				bzjs      js,
				pfrq,
				bjlsh,
				ywbmbh,
				t_dm.dm,
				b.dm      bmmc,
				jsjs,
				tph
			from t_dfbj
			left join t_dm
				on t_dm.dh = t_dfbj.dh
			left join t_dm b
				on t_dfbj.ywbmbh = b.dh
			where tph = '  tph  '
			and ywlx <> 'ST'
			and nvl(jjbj, '0') = '0'
			and ybzbj = '1') a,
		(select sum(bzjs) zs
			from t_dfbj
			where tph = '  tph  '
			and ywlx <> 'ST'
			and nvl(jjbj, '0') = '0'
			and ybzbj = '1') c;

		select a.dh,
			a.js,
			a.pfrq,
			a.bjlsh,
			a.ywbmbh,
			a.dm,
			a.bmmc,
			a.jsjs,
			a.tph,
			c.zs
		from (select t_dfbj.dh,
					bzjs      js,
					pfrq,
					bjlsh,
					ywbmbh,
					t_dm.dm,
					b.dm      bmmc,
					tph,
					jsjs
				from t_dfbj
				left join t_dm
					on t_dm.dh = t_dfbj.dh
				left join t_dm b
					on t_dfbj.ywbmbh = b.dh
				where (t_dfbj.bjlsh = '  bjlsh  ' or t_dfbj.yh = '  bjlsh  ')
				and ywlx <> 'ST'
				and nvl(jjbj, '0') = '0'
				and ybzbj = '1') a,
			(select sum(bzjs) zs
				from t_dfbj
				where (t_dfbj.bjlsh = '  bjlsh  ' or t_dfbj.yh = '  bjlsh  ')
				and ywlx <> 'ST'
				and nvl(jjbj, '0') = '0'
				and ybzbj = '1') c;
		
		<包号交接 p="PROC_SX_DFBJ_JJ_XTW"></包号交接>
		<托盘交接 p="PROC_SX_DFBJ_JJ_XTW_TP">
			Update t_dfbj
				Set jsjs = bzjs, jjbj = '1', bjfjbj = '1'
			Where bjlsh = c2.bjlsh;

			Insert Into t_dfbj_jj
					(bjlsh, cfczy, rfczy, rq, js)
			Values
					(c2.bjlsh, p_cfczybh, p_rfczybh, Sysdate, c2.bzjs);
		</托盘交接>
	</rf包件交接>

	<中转交接>
		<u_dw1 w="d_ht_zzjj">
			Select contract_id,
			fyjhpc,
			Station_Id_Md,
			Station,
			(Select Mc From t_Station Where Bh = Station_Id_Md) Station_Mc_Md,
			(Select Mc From t_Station Where Bh = Station) Station_Mc,
			dm,
			(Select dm From t_dm where dh = ywbmbh) sfd,
			fyrq,
			js,
			round(zl / 1000, 2) zl,
			(select min(zzbh)
				from t_dfbj
				where fyjhpc = rpad(t_ht.fyjhpc, 12, ' ')
				and contract_id_root = t_ht.contract_id) zzbh
		From t_Ht
		Where Nvl(jjbj, 0) = '0'
		and station_id_md <> station
		and (
				--榆次(从榆次中转)
				(Station_Id_Md = '2005' And ywbmbh in ('4001', '8001') and
				:p_ywbmbh = '3001')
				--侯马(从侯马中转)
				or
				(Station_Id_Md = '2007' And ywbmbh = '3001' and :p_ywbmbh = '8001' and
				(select trim(min(zzbh))
					from t_dfbj
					where fyjhpc = rpad(t_ht.fyjhpc, 12, ' ')
					and contract_id_root = t_ht.contract_id) = '8001'))
		And fyjhpc Like :p_fyjhpc || '%'
		And fyrq > to_date(:p_rq1, 'yyyy-mm-dd')
		And fyrq < to_date(:p_rq2, 'yyyy-mm-dd') + 1

		</u_dw1>
	</中转交接>
</root>



	
